# エリア5修正実装計画書 (Area 5 Correction Plan)

現状のエキスパートチェックにより判明した「設計書(`area5_map_spec.md`)と実装の乖離」を解消し、本来意図されたゲーム体験（港町での導入、航海、大陸への上陸）を完全に実装するための詳細作業計画です。

本計画書に基づき、漏れのない実装を進めます。

---

## 1. システム改修フェーズ (Core Engine Updates)
エリア5特有の「船によるマップ間移動」を実現するためのエンジン機能拡張です。

### Task 1.1: 船舶からの「上陸（マップ遷移）」機能の実装
「外海マップ上の島に触れてAボタンを押すと、上陸して村マップへ切り替わる」挙動を実装します。
- **対象ファイル**: `js/engine.js` (`interact` 関数)
- **実装内容**:
  - 現在の `checkWarp` は「踏んだ瞬間」の発動ですが、船利用時は「接岸して決定ボタン」が望ましいため、`interact` 内にワープ判定ロジックを追加します。
  - マップデータの `warps` 定義に `type: "landing"` 属性を追加し、船に乗っている場合のみ有効化されるワープ処理を作成します。
  - ワープ実行時に、自動的に `partyData.vehicle` を `'none'` (徒歩) にリセットする処理を含めます。

### Task 1.2: 「出港」処理の実装
港町から外海へ出る際の逆方向の処理です。
- **対象ファイル**: `js/engine.js`
- **実装内容**:
  - 港町の桟橋の先に `type: "embark"` のワープを配置。
  - このワープを踏む（または調べると）、`partyData.vehicle` を `'ship'` に変更した上で、外海マップの所定座標へワープさせます。

---

## 2. マップデータ作成フェーズ (Map Creation)
ファイルが存在しない、または仮実装のまま放置されているマップを、仕様書通りに作成します。

### Task 2.1: 拠点「港町ポルティア」の作成
エリア5の開始地点となる重要マップです。
- **作成ファイル**: `maps/town_portia.json`
- **仕様**:
  - サイズ: 30x30
  - 施設: 宿屋、教会、道具屋、武器屋、**造船所**、**町長の家**
  - NPC: 町長（船入手イベント）、船大工
  - ワープ: 北側の桟橋から「外海」へ接続。南側は「ポータルルーム（時空の間）」からの到着地点。

### Task 2.2: 「広大なる外海」の再構築
現在「ただの海」となっているマップに、上陸地点となる島々を配置します。
- **修正ファイル**: `maps/area5_ocean.json`
- **実装内容**:
  - **地形配置**: 設計書の座標に基づき、以下の島（上陸用タイル群）を描画します。
    - ポルティア周辺（実体は不要だが、出港時の見栄えのため）
    - 珊瑚の島 (X:45, Y:30)
    - 監獄島 (X:160, Y:170)
    - アトランティア/渦潮 (X:100, Y:100)
  - **ワープ設定**: 各島に対応する「上陸用ワープ（Task 1.1で仕様化）」を定義します。

### Task 2.3: ダンジョン・集落マップの作成
- **作成ファイル**:
  - `maps/coral_village.json` (珊瑚の村)
  - `maps/coral_maze.json` (珊瑚の迷宮)
  - `maps/prison_isle.json` (監獄島・外観/内部)
  - `maps/atlantis_ruins.json` (海底都市)

---

## 3. シナリオ・イベント実装フェーズ (Scenario & Events)
整合性が取れていないストーリー進行を修正します。

### Task 3.1: エリア4→5 遷移フローの正常化
「いきなり船を持って海に放り出される」状態を修正します。
- **修正対象**: `js/engine.js` (雪原の村長会話), `maps/portal_room.json`
- **実装手順**:
  1. 雪原の村長会話を修正：アイテム「船の呼び笛」を**削除**。「ポルティアへ行け」という誘導セリフに変更。
  2. 時空の間のワープ先変更：`town_portia.json` の入口座標に変更。

### Task 3.2: 船入手イベントの正規実装
本来の「ポルティアで船を譲り受ける」イベントを作成します。
- **実装場所**: `maps/town_portia.json` (町長NPC)
- **スクリプト**:
  - 町長に話しかけるとイベント進行。
  - アイテム `ship_key` (ID: 121) を付与。
  - フラグ `shipObtained` をON。

### Task 3.3: ボス・ギミックの実装
- **珊瑚の迷宮**: 音ギミック（簡易版：正解ルート以外でメッセージ表示など）とボス「セイレーン」配置。
- **監獄島**: 魔法禁止エリア（`battle.js` で `gameProgress.currentMapId === 'prison_isle'` の場合呪文コマンドを封印）。

---

## 4. 実行手順と品質保証 (Execution & QA)

### Step 1: エンジン改修 (Task 1.1 - 1.2)
まず「船で移動して上陸する」というメカニクスを確立させます。

### Step 2: マップデータ整備 (Task 2.1 - 2.4)
ポルティアと外海マップを作成し、相互に行き来できることを確認します。この時点で「歩いてポルティアへ→船入手→出港→外海航海→ポルティア帰港（上陸）」のサイクルを完成させます。

### Step 3: コンテンツ拡充 (Task 2.3, 3.1 - 3.3)
残りのダンジョンとストーリーイベントを実装し、ゲームとして通しプレイ可能な状態にします。

### Step 4: 最終確認
- エリア4クリアデータを用いてロード。
- 時空の間からポルティアへ移動できるか。
- 船を入手し、外海へ出られるか。
- 珊瑚の島へ上陸し、ダンジョンに入れるか。
