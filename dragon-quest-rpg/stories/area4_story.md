# エリア4 ストーリー設計書

## 概要

エリア4「氷雪の大陸」は、100年前の災厄で凍りついた王国を舞台とし、氷の女王を救い極光の宝珠を入手するストーリーです。

| 項目 | 内容 |
|------|------|
| エリア名 | 氷雪の大陸（フロストヘイム王国） |
| レベル帯 | Lv 35-50 |
| テーマ | 永久凍土、氷の王国、パズルダンジョン、救済 |
| キーワード | 凍結、孤独、失われた王国、謎解き |

---

## マップ構成

| マップ | 名称 | サイズ | タイプ | 説明 |
|--------|------|--------|--------|------|
| ice_field.json | 氷原 | 100x100 | field | メインフィールド |
| snow_village.json | 雪原の村 | 20x20 | town | 安全な拠点 |
| ice_cave_1f.json | 氷の洞窟・1階 | 30x30 | dungeon | 滑る床パズル（導入） |
| ice_cave_b1.json | 氷の洞窟・地下1階 | 35x35 | dungeon | 滑る床パズル（応用） |
| ice_cave_b2.json | 氷の洞窟・地下2階 | 25x25 | dungeon | 中ボス戦（氷のゴーレム） |
| frozen_lake.json | 凍りついた湖 | 40x40 | dungeon | 圧力スイッチ+滑る床 |
| ice_temple_1f.json | 氷の神殿・1階 | 30x30 | dungeon | 灯火パズル |
| ice_temple_2f.json | 氷の神殿・2階 | 25x25 | dungeon | 記憶パズル |
| ice_temple_3f.json | 氷の神殿・3階 | 20x20 | dungeon | 太陽の炎入手イベント |
| ice_castle_1f.json | 氷の城・1階 | 35x35 | dungeon | グラシオ加入、女王の日記1-2 |
| ice_castle_2f.json | 氷の城・2階 | 30x30 | dungeon | 女王の日記3、複合パズル |
| ice_castle_3f.json | 氷の城・3階 | 25x25 | dungeon | エリアボス戦（氷の女王） |

---

## 正しいストーリーフロー

### Phase 1: エリア3からエリア4への遷移

```
エリア3: 古の大地（surface_3.json）
    ↓
闇の守護者（shadowGuardian）撃破
    ↓
【セレンの星読みイベント】自動発生
セレン：「...星が動いた。」
セレン：「新しい運命の道が開かれたわ。」
セレン：「北の空を見て...あそこに凍りついた星がある。」
セレン：「100年前から、ずっとあの位置で動かない星...」
セレン：「あれはかつての女王の魂。助けを求めている。」
    ↓
フラグ設定: northPathOpened = true
    ↓
セレン：「古の大地の北に、山脈を越える道があるはず。」
セレン：「今まで吹雪で閉ざされていたけど...」
セレン：「闇の守護者が救われたことで、風向きが変わった。」
セレン：「今なら通れるかもしれない。」
```

### Phase 2: 北の山道（エリア4入口）

```
surface_3 北端 @(50, 0)
※ 実装時の注意:
  - surface_3.json の y=0（北端）は現在全て山タイルで塞がれている
  - x=48〜51 を草原タイルに変更する必要あり
  - ワープポイントに requiresFlag: "northPathOpened" を設定
    ↓
NPC: 旅人
「おお、信じられん！」
「100年間閉ざされていた北の峠が開いたのか！」
「この先は『氷雪の大陸』...」
「かつて栄えたフロストヘイム王国があった地だ。」
「だが今は全てが凍りついている...」
    ↓
ワープポイント → ice_field.json @(50, 99)
※ requiresFlag: "northPathOpened" 必須
```

### Phase 3: 氷原到着と雪原の村

```
氷原（ice_field.json）到着
    ↓
【セレンの星読みイベント】自動発生
セレン：「...やはりね。」
セレン：「この地の星は、100年前から凍りついている。」
セレン：「女王の意思が、星を通じて届いてくる...」
セレン：「『助けて』と言っている。でも同時に...」
セレン：「『近づくな』とも言っている。」
セレン：「彼女の中で、光と闇が戦っているのね。」
    ↓
フラグ設定: area4Entered = true
    ↓
雪原の村（snow_village.json）@(50, 50) で情報収集
```

### Phase 4: 氷の洞窟攻略（滑る床パズル）

```
ice_field @(30, 30) のワープポイント
    ↓
氷の洞窟・1階（ice_cave_1f.json）
  - 滑る床パズル（チュートリアル）
  - 一方向に滑るだけの簡単な構成
    ↓
氷の洞窟・地下1階（ice_cave_b1.json）
  - 滑る床パズル（応用）
  - 複数の氷床を組み合わせた経路
    ↓
氷の洞窟・地下2階（ice_cave_b2.json）
  - 中ボス戦：氷のゴーレム（iceGolem）
  - 穴あり、複雑な経路の最後にボス
    ↓
フラグ設定: iceGolemDefeated = true
```

### Phase 5: 凍りついた湖攻略（圧力スイッチパズル）

```
ice_field @(70, 40) のワープポイント
※ iceGolemDefeated フラグ必須
    ↓
凍りついた湖（frozen_lake.json）
  - 氷のブロックを押してスイッチの上に乗せる
  - ブロックは氷床の上では滑る
  - 全てのスイッチが押されると扉が開く
    ↓
氷の神殿への道が開く
フラグ設定: frozenLakeCleared = true
```

### Phase 6: 氷の神殿攻略（灯火・記憶パズル）

```
frozen_lake 奥のワープポイント
    ↓
氷の神殿・1階（ice_temple_1f.json）
  - 灯火パズル（ライツアウト式）
  - 隣接する燭台も連動して状態が変わる
    ↓
氷の神殿・2階（ice_temple_2f.json）
  - 記憶パズル
  - 4つの氷の祭壇を正しい順序で調べる
  - ヒント: 「北→東→南→西」
    ↓
氷の神殿・3階（ice_temple_3f.json）
  - 太陽の炎入手イベント
```

**【太陽の炎入手イベント】**

```
太陽の精霊：「勇者よ...ようやく来たか...」
太陽の精霊：「私は太陽の精霊...100年前にここに封じられた...」
太陽の精霊：「氷の女王を救うため、この炎を持っていくがいい...」
太陽の精霊：「ただし気をつけよ...女王の中には闇が巣食っている...」
太陽の精霊：「その闇を祓わねば、女王は救えぬ...」
    ↓
『太陽の炎』を手に入れた！
フラグ設定: sunFlameObtained = true
    ↓
セレン：「これで準備は整ったわ。」
セレン：「太陽の炎は、かつて女王自身が封印したもの。」
セレン：「彼女は知っていたのよ...」
セレン：「いつか誰かが来て、自分を救ってくれることを。」
セレン：「だから解放の鍵を残しておいた。」
```

### Phase 7: 氷の城攻略

```
ice_field @(50, 10) のワープポイント
※ sunFlameObtained フラグ必須
    ↓
氷の城・1階（ice_castle_1f.json）
  - グラシオ（凍りついた騎士）加入イベント
  - 女王の日記1・2発見
    ↓
氷の城・2階（ice_castle_2f.json）
  - 女王の日記3発見
  - 複合パズル（滑る床+スイッチ）
    ↓
氷の城・3階（ice_castle_3f.json）
  - 女王の日記4発見
  - エリアボス戦：氷の女王
```

### Phase 8: グラシオ加入イベント

```
氷の城・1階 @(15, 20) に凍りついた騎士の像がある
太陽の炎を持っていると、像が溶け始める...
    ↓
グラシオ：「...ぐ...ぅ...」
グラシオ：「こ...ここは...」
勇者：「大丈夫か!? 動けるか？」
グラシオ：「...お前たちは...何者だ...」
勇者：「俺たちは女王を救いに来た。」
グラシオ：「...女王様を...？」
    ↓
グラシオ：「...100年...経ったのか...」
グラシオ：「俺は...何もできなかった...」
グラシオ：「女王様を...守れなかった...」
    ↓
セレン：「あなたも100年間、凍りついていたのね...」
セレン：「でも今からでも遅くないわ。」
セレン：「一緒に女王を救いましょう。」
    ↓
グラシオ：「...お前たちが持っているのは『太陽の炎』...」
グラシオ：「女王様が自ら封印した、救済の鍵...」
グラシオ：「...頼む。俺も連れて行ってくれ。」
グラシオ：「今度こそ...女王様を守る。」
    ↓
【グラシオが仲間に加わった！】
フラグ設定: glacioJoined = true
```

### Phase 9: 氷の女王との対峙

```
氷の城・3階 @(12, 5) に氷の女王がいる
    ↓
【戦闘前・通常】
女王：「...あなたたちが、炎の心を持つ者...？」
女王：「100年...ずっとこの氷の中で苦しんできた...」
女王：「私を...止めて...お願い...」
女王：「でも体が言うことを聞かない...！」
女王：「来るな...来ないで...！」
    ↓
【戦闘前・グラシオがパーティにいる場合】
グラシオ：「女王様...俺だ、グラシオです。」
グラシオ：「100年前...俺はあなたを止められなかった。」
グラシオ：「でも今度は違う。必ず救ってみせる。」
女王：「グラシオ...あなたも...凍っていたの...？」
女王：「逃げて...私はもう...」
グラシオ：「逃げません！ 今度こそ、俺が守る！」
    ↓
【ボス戦】iceQueen
太陽の炎の力で闇を祓いながら戦う
```

### Phase 10: 女王救済とエリアクリア

```
ボス戦勝利
    ↓
【戦闘後・通常】
女王：「...ありがとう...ようやく解放された...」
女王：「太陽の炎が、私の中の闇を溶かしてくれた...」
女王：「あなたたちに、この宝珠を託します...」
女王：「『極光の宝珠』...これがあれば、海を渡れるでしょう...」
女王：「どうか...世界を救って...」
    ↓
【戦闘後・グラシオがパーティにいる場合】
女王：「グラシオ...生きていてくれたのね...」
グラシオ：「女王様...俺は...」
女王：「ありがとう。あなたがいてくれて...本当に良かった。」
グラシオ：「...っ...（涙を堪える）」
グラシオ：「これからも...お側に仕えさせてください。」
女王：「ええ...でも今度は、もっと気楽にね。」
    ↓
『極光の宝珠』を手に入れた！
フラグ設定: iceQueenDefeated, area4Completed, auroraOrbObtained = true
    ↓
セレン：「...星が動いた。」
セレン：「100年ぶりに、北の星が輝き始めた。」
セレン：「女王エリザの魂が、ようやく安らぎを得たのね。」
    ↓
氷原に光が戻り、エリア5への道が開かれる
```

---

## ワープ定義

### surface_3.json（エリア3→エリア4）

```json
{
  "x": 50,
  "y": 0,
  "targetMap": "maps/ice_field.json",
  "targetX": 50,
  "targetY": 99,
  "requiresFlag": "northPathOpened"
}
```

### ice_field.json（氷原）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (50, 99) | surface_3.json @(50, 1) | なし（帰還可能） |
| (50, 50) | snow_village.json @(10, 18) | なし |
| (30, 30) | ice_cave_1f.json @(15, 28) | なし |
| (70, 40) | frozen_lake.json @(20, 38) | iceGolemDefeated |
| (50, 10) | ice_castle_1f.json @(17, 33) | sunFlameObtained |

### ice_cave_1f.json（氷の洞窟・1階）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (15, 28) | ice_field.json @(30, 31) | なし |
| (15, 5) | ice_cave_b1.json @(17, 33) | なし |

### ice_cave_b1.json（氷の洞窟・地下1階）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (17, 33) | ice_cave_1f.json @(15, 6) | なし |
| (17, 5) | ice_cave_b2.json @(12, 23) | なし |

### ice_cave_b2.json（氷の洞窟・地下2階）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (12, 23) | ice_cave_b1.json @(17, 6) | なし |
| (12, 3) | ice_field.json @(31, 30) | iceGolemDefeated（ボス撃破後出口） |

### frozen_lake.json（凍りついた湖）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (20, 38) | ice_field.json @(70, 41) | なし |
| (20, 5) | ice_temple_1f.json @(15, 28) | frozenLakeCleared |

### ice_temple_1f.json（氷の神殿・1階）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (15, 28) | frozen_lake.json @(20, 6) | なし |
| (15, 5) | ice_temple_2f.json @(12, 23) | torchPuzzleCleared |

### ice_temple_2f.json（氷の神殿・2階）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (12, 23) | ice_temple_1f.json @(15, 6) | なし |
| (12, 5) | ice_temple_3f.json @(10, 18) | memoryPuzzleCleared |

### ice_temple_3f.json（氷の神殿・3階）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (10, 18) | ice_temple_2f.json @(12, 6) | なし |
| (10, 3) | ice_field.json @(70, 41) | sunFlameObtained（炎入手後出口） |

### ice_castle_1f.json（氷の城・1階）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (17, 33) | ice_field.json @(50, 11) | なし |
| (17, 5) | ice_castle_2f.json @(15, 28) | なし |

### ice_castle_2f.json（氷の城・2階）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (15, 28) | ice_castle_1f.json @(17, 6) | なし |
| (15, 5) | ice_castle_3f.json @(12, 23) | なし |

### ice_castle_3f.json（氷の城・3階）

| 座標 | 行き先 | 条件 |
|------|--------|------|
| (12, 23) | ice_castle_2f.json @(15, 6) | なし |
| (12, 3) | ice_field.json @(50, 11) | iceQueenDefeated（ボス撃破後出口） |

---

## NPC一覧

### snow_village.json（雪原の村）

| NPC ID | 名前 | 位置 | タイプ | 役割 |
|--------|------|------|--------|------|
| snow_elder | 村長 | (10, 5) | villager | ストーリー説明 |
| snow_oldwoman | 老婆 | (5, 8) | villager | 女王の過去 |
| snow_traveler | 旅人 | (15, 10) | villager | ダンジョンヒント |
| snow_shopkeeper | 武器屋 | (4, 4) | shopkeeper | 武器・防具販売 |
| snow_itemshop | 道具屋 | (16, 4) | shopkeeper | アイテム販売 |
| snow_innkeeper | 宿屋 | (10, 12) | innkeeper | 宿泊（80G） |
| snow_priest | 神官 | (10, 3) | healer | 回復・セーブ |

**NPC詳細セリフ**

```
【村長】snow_elder @(10, 5)
- 通常:
  「この村は100年前から、ずっとこうだ。」
  「氷の城には近づくな。あそこには呪われた女王がいる。」
  「彼女を救えるのは『太陽の炎』だけだと言い伝えられている。」

- sunFlameObtained後:
  「おお、その炎は...！」
  「まさか、伝説の太陽の炎を手に入れたのか！」
  「今こそ女王を救う時だ。頼んだぞ、勇者よ！」

【老婆】snow_oldwoman @(5, 8)
- 通常:
  「100年前、女王は自らを犠牲にして王国を守った。」
  「闇の波動から民を守るため、全てを凍らせたのじゃ。」
  「じゃが、その代償として女王の心には闇が...」

【旅人】snow_traveler @(15, 10)
- 通常:
  「氷の洞窟を抜ければ、凍りついた湖に出るらしい。」
  「洞窟の床は滑るから気をつけろ。」
  「壁にぶつかるまで止まれないって話だ。」

【神官】snow_priest @(10, 3)
- 通常:
  「氷の神殿には『太陽の炎』が眠っている。」
  「かつて女王自身が封印したと言われている。」
  「神殿には試練がある。心して挑むがよい。」
```

### ice_cave_b2.json（氷の洞窟・地下2階）

| NPC ID | 名前 | 位置 | タイプ | 役割 |
|--------|------|------|--------|------|
| ice_golem | 氷のゴーレム | (12, 5) | boss | 中ボス |

### ice_temple_3f.json（氷の神殿・3階）

| NPC ID | 名前 | 位置 | タイプ | 役割 |
|--------|------|------|--------|------|
| sun_spirit | 太陽の精霊 | (10, 5) | event | 太陽の炎授与 |

### ice_castle_1f.json（氷の城・1階）

| NPC ID | 名前 | 位置 | タイプ | 役割 |
|--------|------|------|--------|------|
| frozen_glacio | 凍りついたグラシオ | (15, 20) | event | 仲間加入イベント |
| diary_stand_1 | 女王の日記台1 | (25, 15) | event | 日記1発見 |
| diary_stand_2 | 女王の日記台2 | (8, 10) | event | 日記2発見 |

### ice_castle_2f.json（氷の城・2階）

| NPC ID | 名前 | 位置 | タイプ | 役割 |
|--------|------|------|--------|------|
| diary_stand_3 | 女王の日記台3 | (15, 15) | event | 日記3発見 |

### ice_castle_3f.json（氷の城・3階）

| NPC ID | 名前 | 位置 | タイプ | 役割 |
|--------|------|------|--------|------|
| diary_stand_4 | 女王の日記台4 | (8, 10) | event | 日記4発見 |
| ice_queen | 氷の女王 | (12, 5) | boss | エリアボス |

---

## ボス情報

### iceGolem（氷のゴーレム）- 中ボス

| パラメータ | 値 |
|------------|-----|
| ID | iceGolem |
| 日本語名 | こおりのゴーレム |
| HP | 800 |
| 攻撃力 | 75 |
| 防御力 | 60 |
| 速度 | 8 |
| レベル | 40 |
| 経験値 | 1500 |
| ゴールド | 900 |
| 属性耐性 | ice: 0（無効）, fire: 2.0（弱点）, lightning: 1.5 |
| 使用スキル | attack, iceBreath, strongAttack |
| 行動回数 | 1 |

**戦闘前セリフ**:
```
「...侵入者か。」
「この先に進むことは許さぬ。」
「永久の眠りにつくがいい！」
```

**撃破後セリフ**:
```
「...見事だ...」
「お前たちなら...女王様を...」
```

**JSON定義**:
```json
{
  "id": "iceGolem",
  "name": "こおりのゴーレム",
  "hp": 800,
  "atk": 75,
  "def": 60,
  "spd": 8,
  "level": 40,
  "exp": 1500,
  "gold": 900,
  "skills": ["attack", "iceBreath", "strongAttack"],
  "resistance": {
    "ice": 0,
    "fire": 2.0,
    "lightning": 1.5
  },
  "isBoss": true,
  "bossId": "iceGolem"
}
```

---

### iceQueen（氷の女王）- エリアボス

| パラメータ | 値 |
|------------|-----|
| ID | iceQueen |
| 日本語名 | こおりのじょおう |
| HP | 1500 |
| 攻撃力 | 95 |
| 防御力 | 70 |
| 速度 | 20 |
| レベル | 48 |
| 経験値 | 3000 |
| ゴールド | 1500 |
| 属性耐性 | ice: 0（無効）, fire: 2.0（弱点）, light: 0.5 |
| 使用スキル | attack, blizzard, iceBreath, absoluteZero, heal |
| 行動回数 | 2 |

**特殊行動パターン**:
- HP50%以下: absoluteZero（全体氷攻撃+凍結）の使用頻度上昇
- HP25%以下: heal使用開始（HP300回復）

**JSON定義**:
```json
{
  "id": "iceQueen",
  "name": "こおりのじょおう",
  "hp": 1500,
  "atk": 95,
  "def": 70,
  "spd": 20,
  "level": 48,
  "exp": 3000,
  "gold": 1500,
  "skills": ["attack", "blizzard", "iceBreath", "absoluteZero", "heal"],
  "actionsPerTurn": 2,
  "resistance": {
    "ice": 0,
    "fire": 2.0,
    "light": 0.5
  },
  "isBoss": true,
  "bossId": "iceQueen"
}
```

---

## 新規モンスター

### エンカウンターテーブル: area4_field

| ID | 名前 | Lv | HP | ATK | DEF | SPD | EXP | Gold | スキル | 耐性 |
|----|------|-----|-----|-----|-----|-----|-----|------|--------|------|
| snowSlime | ゆきスライム | 35 | 120 | 55 | 35 | 12 | 180 | 80 | attack, iceBreath | ice:0, fire:2.0 |
| iceBat | アイスバット | 36 | 90 | 60 | 25 | 25 | 200 | 90 | attack, drain | ice:0.5, fire:1.5 |
| snowWolf | スノーウルフ | 37 | 140 | 70 | 40 | 20 | 220 | 100 | attack, howl | ice:0.5, fire:1.5 |

### エンカウンターテーブル: area4_cave

| ID | 名前 | Lv | HP | ATK | DEF | SPD | EXP | Gold | スキル | 耐性 |
|----|------|-----|-----|-----|-----|-----|-----|------|--------|------|
| snowSlime | ゆきスライム | 35 | 120 | 55 | 35 | 12 | 180 | 80 | attack, iceBreath | ice:0, fire:2.0 |
| frozenKnight | こおりのきし | 38 | 180 | 75 | 55 | 10 | 280 | 150 | attack, iceSlash | ice:0, fire:1.5 |
| iceElemental | アイスエレメント | 40 | 160 | 65 | 45 | 15 | 300 | 130 | attack, blizzard | ice:0, fire:2.0 |

### エンカウンターテーブル: area4_temple

| ID | 名前 | Lv | HP | ATK | DEF | SPD | EXP | Gold | スキル | 耐性 |
|----|------|-----|-----|-----|-----|-----|-----|------|--------|------|
| iceElemental | アイスエレメント | 40 | 160 | 65 | 45 | 15 | 300 | 130 | attack, blizzard | ice:0, fire:2.0 |
| frostGiant | フロストジャイアント | 42 | 250 | 90 | 60 | 8 | 400 | 200 | attack, strongAttack | ice:0, fire:1.5 |

### エンカウンターテーブル: area4_castle

| ID | 名前 | Lv | HP | ATK | DEF | SPD | EXP | Gold | スキル | 耐性 |
|----|------|-----|-----|-----|-----|-----|-----|------|--------|------|
| frozenKnight | こおりのきし | 38 | 180 | 75 | 55 | 10 | 280 | 150 | attack, iceSlash | ice:0, fire:1.5 |
| frostGiant | フロストジャイアント | 42 | 250 | 90 | 60 | 8 | 400 | 200 | attack, strongAttack | ice:0, fire:1.5 |
| crystalDragon | クリスタルドラゴン | 45 | 300 | 100 | 70 | 18 | 500 | 300 | attack, iceBreath, blizzard | ice:0, fire:1.5 |

---

## 新キャラクター: グラシオ

### 基本情報

| 項目 | 内容 |
|------|------|
| ID | glacio |
| 名前 | グラシオ |
| ジョブ | iceKnight（氷騎士） |
| 種族 | 人間 |
| 年齢（外見） | 30歳（凍結時のまま） |
| 年齢（実際） | 130歳（100年間凍結） |
| 性格 | 寡黙、実直、忠義に厚い、自責の念が強い |

### ステータス

| パラメータ | 値 |
|------------|-----|
| HP | 90 |
| MP | 15 |
| 攻撃 | 45 |
| 防御 | 35 |
| 速度 | 5 |
| レベル | 38 |
| 初期スキル | strongAttack, iceSlash, guard |

**特徴**: 素早さが極端に低いが、HP・攻撃・防御が高いパワー系タンク

### JSON定義

```json
{
  "id": "glacio",
  "name": "グラシオ",
  "job": "iceKnight",
  "level": 38,
  "hp": 90,
  "maxHp": 90,
  "mp": 15,
  "maxMp": 15,
  "atk": 45,
  "def": 35,
  "spd": 5,
  "skills": ["strongAttack", "iceSlash", "guard"],
  "equipment": {
    "weapon": null,
    "armor": null,
    "accessory": null
  }
}
```

### 加入条件

| フラグ名 | 条件 |
|----------|------|
| glacioJoined | ice_castle_1f で凍りついた騎士像を調べる（sunFlameObtained必須） |

### 戦闘時セリフ

```
【通常攻撃】
「俺に任せろ。」

【strongAttack使用時】
「砕けろ！」

【iceSlash使用時】
「氷の刃よ...！」

【guard使用時】
「俺の盾となれ！」

【瀕死時】
「まだ...倒れるわけには...」

【戦闘勝利時】
「女王様のために...今度こそ。」
```

---

## パーティ構成（4人固定）

```
【最終パーティ】
- 勇者（固定）      : 物理+回復（バランス型）
- マリア（エリア2）  : 呪文系（火力）
- セレン（エリア3）  : 呪文系（補助・デバフ）
- グラシオ（エリア4）: 物理系（タンク・高火力・鈍足）

※ エリア5以降は新規仲間なし（4人で最終決戦へ）
```

---

## パズルシステム

### パズル1: 滑る床（氷の洞窟）

#### タイル定義

```javascript
TILE.ICE_FLOOR = 30;      // 滑る床
TILE.ICE_WALL = 31;       // 氷の壁（止まれる）
TILE.ICE_HOLE = 32;       // 穴（落ちると戻る）
```

#### 移動処理

```javascript
function handleIceFloorMovement(direction) {
    let sliding = true;
    while (sliding) {
        const nextPos = getNextPosition(player.x, player.y, direction);
        const nextTile = getTile(nextPos.x, nextPos.y);

        if (nextTile === TILE.ICE_WALL || nextTile === TILE.WALL) {
            sliding = false; // 壁で止まる
        } else if (nextTile === TILE.FLOOR || nextTile === TILE.GRASS) {
            player.x = nextPos.x;
            player.y = nextPos.y;
            sliding = false; // 通常床で止まる
        } else if (nextTile === TILE.ICE_HOLE) {
            showMessage("足を滑らせて穴に落ちてしまった！");
            teleportToEntrance();
            sliding = false;
        } else if (nextTile === TILE.ICE_FLOOR) {
            player.x = nextPos.x;
            player.y = nextPos.y;
            // 滑り続ける
        } else {
            sliding = false; // その他のタイルで止まる
        }
    }
}
```

#### 難易度段階

| 階層 | 難易度 | 要素 |
|------|--------|------|
| 1階 | ★☆☆ | 一方向に滑るだけ（チュートリアル） |
| 地下1階 | ★★☆ | 複数の氷床を組み合わせ |
| 地下2階 | ★★★ | 穴あり、複雑な経路 |

---

### パズル2: 圧力スイッチ（凍りついた湖）

#### オブジェクト定義

```javascript
OBJECT.ICE_BLOCK = 50;    // 押せる氷ブロック
OBJECT.SWITCH = 51;       // 圧力スイッチ
OBJECT.RESET_SWITCH = 52; // リセットスイッチ
```

#### ブロック押し処理

```javascript
function pushIceBlock(block, direction) {
    const nextPos = getNextPosition(block.x, block.y, direction);

    if (getTile(nextPos.x, nextPos.y) === TILE.ICE_FLOOR) {
        // 氷床の場合は滑る
        slideBlock(block, direction);
    } else if (isWalkable(nextPos)) {
        block.x = nextPos.x;
        block.y = nextPos.y;
    }

    checkAllSwitches();
}

function slideBlock(block, direction) {
    let sliding = true;
    while (sliding) {
        const nextPos = getNextPosition(block.x, block.y, direction);
        const nextTile = getTile(nextPos.x, nextPos.y);

        if (nextTile === TILE.ICE_FLOOR) {
            block.x = nextPos.x;
            block.y = nextPos.y;
        } else {
            sliding = false;
        }
    }
}

function checkAllSwitches() {
    const allPressed = switches.every(sw => {
        return blocks.some(b => b.x === sw.x && b.y === sw.y);
    });

    if (allPressed) {
        openDoor();
        showMessage("全てのスイッチが押された！扉が開いた！");
        setFlag('frozenLakeCleared', true);
    }
}
```

---

### パズル3: 灯火パズル（氷の神殿・1階）

#### 燭台定義

```javascript
const torches = [
    { id: 0, x: 10, y: 5, lit: false, links: [1, 2] },
    { id: 1, x: 20, y: 5, lit: false, links: [0, 3] },
    { id: 2, x: 10, y: 15, lit: false, links: [0, 3] },
    { id: 3, x: 20, y: 15, lit: false, links: [1, 2] },
];
```

#### トグル処理

```javascript
function toggleTorch(torchId) {
    const torch = torches.find(t => t.id === torchId);
    torch.lit = !torch.lit;

    // 連動する燭台も切り替え
    torch.links.forEach(linkedId => {
        const linked = torches.find(t => t.id === linkedId);
        linked.lit = !linked.lit;
    });

    if (torches.every(t => t.lit)) {
        openDoor();
        showMessage("全ての燭台に火が灯った！扉が開いた！");
        setFlag('torchPuzzleCleared', true);
    }
}
```

#### 正解手順
- 0→3 または 1→2

---

### パズル4: 記憶パズル（氷の神殿・2階）

#### 祭壇定義

```javascript
const altars = [
    { id: 'north', x: 12, y: 5 },
    { id: 'east', x: 20, y: 12 },
    { id: 'south', x: 12, y: 20 },
    { id: 'west', x: 5, y: 12 },
];

const correctOrder = ['north', 'east', 'south', 'west'];
let playerOrder = [];
```

#### ヒント（1階の書庫）

```
「氷の封印を解く者よ、星の導きに従え。
 まず北極星を仰ぎ、次に東の暁を迎えよ。
 南の十字を経て、西の夕暮れに至れ。」

→ 正解: 北→東→南→西
```

#### 祭壇タッチ処理

```javascript
function touchAltar(altarId) {
    playerOrder.push(altarId);

    for (let i = 0; i < playerOrder.length; i++) {
        if (playerOrder[i] !== correctOrder[i]) {
            showMessage("祭壇が冷たく光り、魔物が現れた！");
            startBattle('iceElemental');
            playerOrder = [];
            return;
        }
    }

    if (playerOrder.length === correctOrder.length) {
        showMessage("祭壇が温かく輝き、封印が解けた！");
        openSealedDoor();
        setFlag('memoryPuzzleCleared', true);
    }
}
```

---

## 女王の日記

### 日記1（氷の城1階・書斎）

```
【日記 1：闇の波動到来】
「北の空に不吉な星が現れた。
 星読みたちは『7日後に闇が来る』と言う。
 民を守るため、私は決断しなければならない...」
```

### 日記2（氷の城1階・私室）

```
【日記 2：禁呪の準備】
「太陽の炎を封印し、禁呪の準備を整えた。
 この術を使えば、時を止められる。
 だが代償は...私自身の全て。」
```

### 日記3（氷の城2階・礼拝堂）

```
【日記 3：最後の夜】
「明日、私は禁呪を発動する。
 愛する民よ、どうか許してほしい。
 いつか誰かが私たちを救いに来てくれると信じて...
 100年でも、1000年でも、私は待ち続ける。」
```

### 日記4（氷の城3階・玉座の間）

```
【日記 4：凍結後（精神のみ）】
「...声が聞こえる。闇の囁きが。
 『お前の犠牲は無駄だった』と。
 違う...そんなはずはない...
 誰か...助けて...」
```

---

## アイテム・装備

### 消費アイテム

| ID | 名前 | 効果 | 買値 | 売値 |
|----|------|------|------|------|
| 60 | ほかほかスープ | 凍結状態回復、3ターン凍結耐性 | 100G | 50G |
| 61 | たいまつ | 暗所を照らす（一部エリアで必要） | 50G | 25G |
| 62 | ふぶきよけの薬 | 戦闘中、氷属性ダメージ50%軽減（3ターン） | 200G | 100G |

### 武器

| ID | 名前 | ATK | 装備可能 | 入手方法 | 買値 |
|----|------|-----|----------|----------|------|
| 70 | こおりのつるぎ | +55 | hero, iceKnight | snow_village | 12000G |
| 71 | ブリザードソード | +70 | hero, iceKnight | ice_castle 宝箱 | - |
| 72 | こおりのつえ | +45 | mage, seer | snow_village | 10000G |
| 73 | ダイヤモンドロッド | +60 | mage, seer | ice_temple 宝箱 | - |

### 防具

| ID | 名前 | DEF | 装備可能 | 入手方法 | 買値 |
|----|------|-----|----------|----------|------|
| 80 | ふゆごもりのふく | +45 | all | snow_village | 8000G |
| 81 | ブリザードメイル | +60 | hero, iceKnight | ice_castle 宝箱 | - |
| 82 | ゆきのローブ | +40 | mage, seer | snow_village | 7000G |
| 83 | クリスタルローブ | +55 | mage, seer | ice_temple 宝箱 | - |

### アクセサリ

| ID | 名前 | 効果 | 入手方法 |
|----|------|------|----------|
| 90 | こおりのゆびわ | 氷属性ダメージ25%軽減 | snow_village（5000G） |
| 91 | ほのおのペンダント | 炎属性呪文威力+20% | ice_cave 宝箱 |
| 92 | じょおうのティアラ | MP+30、全状態異常耐性+10% | iceQueen撃破報酬 |

---

## ショップ定義

### snow_village_weapon（雪原の村・武器屋）

```json
{
  "shopId": "snow_village_weapon",
  "items": [
    { "itemId": 70, "price": 12000 },
    { "itemId": 72, "price": 10000 },
    { "itemId": 80, "price": 8000 },
    { "itemId": 81, "price": 7000 },
    { "itemId": 90, "price": 5000 }
  ]
}
```

### snow_village_item（雪原の村・道具屋）

```json
{
  "shopId": "snow_village_item",
  "items": [
    { "itemId": 1, "price": 10 },
    { "itemId": 2, "price": 80 },
    { "itemId": 3, "price": 30 },
    { "itemId": 60, "price": 100 },
    { "itemId": 61, "price": 50 },
    { "itemId": 62, "price": 200 }
  ]
}
```

---

## 宝箱配置

### ice_field.json（氷原）

| 座標 | 中身 | 備考 |
|------|------|------|
| (20, 80) | 500G | 南東の隠し場所 |
| (80, 20) | ほかほかスープ x3 | 北東の雪原 |

### ice_cave_1f.json（氷の洞窟・1階）

| 座標 | 中身 | 備考 |
|------|------|------|
| (25, 10) | ちからのたね | パズル後 |

### ice_cave_b1.json（氷の洞窟・地下1階）

| 座標 | 中身 | 備考 |
|------|------|------|
| (5, 5) | ほのおのペンダント | 隠し通路の先 |
| (30, 25) | 800G | 通常ルート脇 |

### ice_cave_b2.json（氷の洞窟・地下2階）

| 座標 | 中身 | 備考 |
|------|------|------|
| (20, 15) | すばやさのたね | ボス手前 |

### frozen_lake.json（凍りついた湖）

| 座標 | 中身 | 備考 |
|------|------|------|
| (35, 20) | まもりのたね | パズルクリア後 |
| (10, 30) | ふぶきよけの薬 x3 | 隠し場所 |

### ice_temple_1f.json（氷の神殿・1階）

| 座標 | 中身 | 備考 |
|------|------|------|
| (25, 20) | 1200G | 灯火パズル報酬 |

### ice_temple_2f.json（氷の神殿・2階）

| 座標 | 中身 | 備考 |
|------|------|------|
| (5, 10) | ダイヤモンドロッド | 記憶パズル報酬 |
| (20, 20) | クリスタルローブ | 隠し部屋 |

### ice_castle_1f.json（氷の城・1階）

| 座標 | 中身 | 備考 |
|------|------|------|
| (30, 25) | エリクサー | 東翼の部屋 |
| (5, 15) | 1500G | 西翼の部屋 |

### ice_castle_2f.json（氷の城・2階）

| 座標 | 中身 | 備考 |
|------|------|------|
| (25, 10) | ブリザードソード | 隠し通路の先 |
| (5, 20) | ブリザードメイル | パズル報酬 |

### ice_castle_3f.json（氷の城・3階）

| 座標 | 中身 | 備考 |
|------|------|------|
| (20, 15) | いのちのきのみ | ボス手前 |

---

## クエストフラグ一覧

### メインフラグ

| フラグ名 | 説明 | 設定タイミング |
|----------|------|----------------|
| northPathOpened | 北の山道開通 | エリア3クリア後・セレンイベント |
| area4Entered | エリア4に入った | 氷原に初めて入った時 |
| iceGolemDefeated | 氷のゴーレム撃破 | 中ボス戦勝利時 |
| frozenLakeCleared | 凍りついた湖クリア | 圧力スイッチパズル完了時 |
| torchPuzzleCleared | 灯火パズルクリア | 神殿1階パズル完了時 |
| memoryPuzzleCleared | 記憶パズルクリア | 神殿2階パズル完了時 |
| sunFlameObtained | 太陽の炎入手 | 神殿3階イベント後 |
| glacioJoined | グラシオ加入 | 氷の城1階・グラシオイベント後 |
| queenDiary1 | 女王の日記1発見 | 氷の城1階・書斎 |
| queenDiary2 | 女王の日記2発見 | 氷の城1階・私室 |
| queenDiary3 | 女王の日記3発見 | 氷の城2階・礼拝堂 |
| queenDiary4 | 女王の日記4発見 | 氷の城3階・玉座の間 |
| iceQueenDefeated | 氷の女王撃破 | ボス戦勝利時 |
| area4Completed | エリア4クリア | 極光の宝珠入手時 |
| auroraOrbObtained | 極光の宝珠入手 | 女王救出後 |

### エリア3からの引き継ぎフラグ

| フラグ名 | 必要条件 | 用途 |
|----------|----------|------|
| shadowGuardianDefeated | エリア3クリア | 北の山道開通の前提条件 |
| serenJoined | セレン加入済み | エリア4の星読みイベント発生条件 |

---

## 世界観設定

### 100年前の災厄 ― 世界規模の闇の波動

エリア3で語られた「光の守護者の暴走」は、実は世界規模の災厄の一部だった。

```
【100年前の出来事・時系列】

Day 0: 魔界から「闇の波動」が世界中に放たれる
    ↓
Day 3: 各地で異変が発生
    - セレスティア王国: 光の守護者が闇に蝕まれ始める
    - フロストヘイム王国: 北の空に不吉な黒い星が現れる
    ↓
Day 5: 闇の侵食が加速
    - セレスティア: 守護者が完全に暴走、地底への封印を決断
    - フロストヘイム: 女王エリザが禁呪の準備を開始
    ↓
Day 7: 封印の日
    - セレスティア: 4つの楔で守護者を封印、王国は地底に沈む
    - フロストヘイム: 女王が「永久凍結」を発動、王国ごと時を止める
```

### エリア3とエリア4の対比

| 要素 | エリア3（セレスティア） | エリア4（フロストヘイム） |
|------|------------------------|--------------------------|
| 災厄への対応 | 守護者を封印 | 王国ごと凍結 |
| 犠牲者 | 光の守護者 | 氷の女王 |
| 封印方法 | 4つの楔 | 永久凍結の禁呪 |
| 救済方法 | 楔を集めて戦う | 太陽の炎で闇を祓う |
| 共通テーマ | 「救済」 | 「救済」 |
| キーパーソン | セレン（星読み） | セレン（星読み） |

### 闇の波動の正体（伏線）

```
エリア3・4で語られる断片的な情報：

「100年前、魔界から闇の波動が放たれた」
「その波動は世界中の守護者や王を蝕んだ」
「フロストヘイムの女王、セレスティアの守護者...」
「彼らは皆、同じ闇に侵された被害者だった」

→ これはエリア7（魔界）への伏線となる
→ 魔王が100年前に世界征服を試みた最初の一手
→ 勇者たちは、その後始末をしながら魔王へ近づいていく
```

---

## 氷の女王エリザ・フロストヘイム

### 基本情報

| 項目 | 内容 |
|------|------|
| 本名 | エリザ・フロストヘイム |
| 称号 | 氷華の女王、永久凍結の守護者 |
| 年齢（外見） | 25歳（凍結時のまま） |
| 年齢（実際） | 125歳（100年間凍結） |
| 性格 | 聡明、責任感が強い、自己犠牲的 |
| 好きなもの | 民の笑顔、オーロラ、温かいお茶 |
| 嫌いなもの | 争い、不正、民を傷つける者 |

### 人物像

```
【若き日のエリザ】
- 20歳で父王を病で亡くし、若くして即位
- 聡明な統治で王国を繁栄に導いた「名君」
- 民からは「氷華様」と呼ばれ慕われていた
- 氷魔法の才能に恵まれ、歴代最強の魔力を持つ

【禁呪を使った理由】
- 闇の波動が王国に迫り、民が次々と闇に蝕まれていく
- 「このままでは全員が闇の眷属になってしまう」
- 唯一の手段として「時を止める禁呪」を発動
- 自らの命と引き換えに、王国ごと凍結させた

【100年間の苦しみ】
- 肉体は凍結したが、意識だけは保ち続けている
- 禁呪の代償として闇が心に侵食し続けている
- 正気と狂気の間で100年間苦しみ続けた
- 「終わらせてほしい」と願いながらも体が言うことを聞かない
```

---

## フロストヘイム王国の歴史

| 時代 | 出来事 |
|------|--------|
| 500年前 | 氷の精霊と契約し、王国建国 |
| 300年前 | 「極光の宝珠」を海神から授かる |
| 200年前 | 氷の魔法学院設立、魔法文化の最盛期 |
| 150年前 | エリザ王女誕生 |
| 120年前 | エリザ、若くして女王に即位 |
| 100年前 | 闇の波動により王国ごと凍結 |
| 現在 | 勇者による救済を待つ |

### 王国の特徴

- **立地**: 北の大陸、永久凍土に覆われた極寒の地
- **文化**: 氷の精霊と共存し、氷魔法に長けた民族
- **交易品**: 永久氷、氷晶石、極光の布（オーロラを織り込んだ布）
- **信仰**: 太陽神と氷の精霊の二重信仰
- **国宝**: 「極光の宝珠」（海を渡る力を持つ）

---

## 実装優先度

### Phase 1（必須）
- [ ] 基本マップ作成（ice_field, snow_village, ice_cave）
- [ ] 滑る床システム実装（TILE.ICE_FLOOR, ICE_WALL, ICE_HOLE）
- [ ] 新規モンスター追加（area4_field, area4_cave テーブル）
- [ ] 中ボス（iceGolem）実装
- [ ] surface_3.json の北端修正（山→草原、ワープ追加）

### Phase 2（パズル）
- [ ] 圧力スイッチシステム（frozen_lake）
- [ ] 灯火パズル実装（ice_temple_1f）
- [ ] 記憶パズル実装（ice_temple_2f）

### Phase 3（キャラクター・イベント）
- [ ] グラシオ加入イベント実装
- [ ] 女王の日記システム実装
- [ ] セレンの星読みイベント実装

### Phase 4（ボス・エンディング）
- [ ] エリアボス（iceQueen）実装
- [ ] 女王救出演出
- [ ] 極光の宝珠入手
- [ ] エリア5への導線

---

## 更新履歴

- 2026-01-04: ドラフト版から正式設計書に昇格
- 2026-01-04: 詳細なJSON定義、座標、ワープ定義を追加
- 2026-01-04: NPC一覧を詳細化（ID、座標、セリフ）
- 2026-01-04: エンカウンターテーブルを追加
- 2026-01-04: ショップ定義を追加
- 2026-01-04: 宝箱配置を追加
- 2026-01-03: 新キャラクターをパワー系「凍りついた騎士グラシオ」に変更
- 2026-01-03: ストーリー深掘り（女王の人物像、王国の歴史、エリア3との繋がり）
- 2026-01-03: 100年前の災厄の世界観設定追加（エリア7への伏線）
- 2026-01-03: 初版作成（パズル要素を含むシナリオ案）
