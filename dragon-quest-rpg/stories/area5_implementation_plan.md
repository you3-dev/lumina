# エリア5 実装計画書

## 概要
本ドキュメントでは、`area5_story.md` に記載された設計内容の実装可能性を検討し、具体的な実装計画を策定します。

---

## 1. 機能分類と実装難易度

### 凡例
- ⭐: 既存システムの設定追加のみ（低工数）
- ⭐⭐: 既存システムの小規模拡張（中工数）
- ⭐⭐⭐: 新規ロジックの実装が必要（高工数）
- ⭐⭐⭐⭐: 大規模な新規システム実装（非常に高工数）

---

## 2. マップ・移動システム

| 機能 | 難易度 | 既存システム活用 | 備考 |
|------|--------|------------------|------|
| 200x200の海マップ（JSON） | ⭐ | ✅ 既存マップ読み込み | ファイルサイズ注意（約400KB想定） |
| 循環（ループ）システム | ⭐⭐ | ⚠️ 移動ロジック拡張 | `movePlayer()` に端到達時のラップ処理追加 |
| 船の表示（絵文字変更） | ⭐ | ✅ プレイヤースプライト | 海上時に `🚢` を表示 |
| 船の高速移動 | ⭐ | ✅ 移動速度変数 | `moveSpeed` を1.5〜2倍に |
| 上陸/乗船システム | ⭐⭐⭐ | ⚠️ ワープ拡張 | 「向き」による遷移先座標の分岐ロジックが必要 |
| 潮流タイル（強制移動） | ⭐⭐ | ⚠️ タイル処理拡張 | 氷床（滑る床）の応用で実装可能 |
| 船の強化パーツ | ⭐⭐ | ⚠️ フラグ管理 | `gameProgress` に船強化フラグ追加 |

### 実装リスク
- **循環マップ**: 端到達判定と座標ラップは単純だが、表示の「つなぎ目」処理（10x10の視野に両端のタイルが映る）がやや複雑。
- **上陸システム**: 「島のどこから」「どの向きで」という情報を保持・伝達する仕組みが必要。

---

## 3. 新規タイル・ギミック

| 機能 | 難易度 | 既存システム活用 | 備考 |
|------|--------|------------------|------|
| 海タイル（SEA拡張） | ⭐ | ✅ 既存TILE定義 | 通行不可を通行可（船時のみ）に変更 |
| 酸素ゲージ（歩数ダメージ） | ⭐⭐ | ⚠️ 新規変数 | `gameProgress.oxygenSteps` で歩数を管理 |
| 空気の泡タイル | ⭐ | ✅ タイル判定 | 踏むと酸素ゲージリセット |
| 呪文封印エリア | ⭐⭐ | ⚠️ マップ属性 | マップに `spellSealed: true` を追加、呪文選択時に判定 |
| 看守の視界（ステルス） | ― | ✅ **代替案採用** | 「話しかけると戦闘」にシンプル化 |
| 移動する島（ギガント） | ― | ✅ **代替案採用** | 固定位置＋セレンのイベントで出現 |

### 実装リスク
- **看守の視界**: リアルタイムでNPCが動き、前方3マスの判定を行うのは既存システムにない概念。工数が大きい。
- **移動する島**: 「海マップ上でNPC（島）が動く」処理と、「その島を発見して乗り込む」処理が必要。これも既存システムにない。

### 代替案
- **看守の視界** → 「巡回兵に話しかけると戦闘」にシンプル化。視界判定は見送り。
- **移動する島** → 位置は固定だが、「特定のアイテム/情報がないと見えない（ワープポイントが出現しない）」にシンプル化。

---

## 4. 戦闘システム拡張

| 機能 | 難易度 | 既存システム活用 | 備考 |
|------|--------|------------------|------|
| 状態異常（眠り/幻惑/沈黙） | ⭐ | ✅ 完全実装済み | 敵のスキルに設定するだけ |
| 毒状態（ダメージ） | ⭐ | ✅ 完全実装済み | 同上 |
| MP吸収攻撃 | ⭐⭐ | ⚠️ 新規スキル | `drain` タイプに `targetMp: true` を追加 |
| 属性変化ボス | ⭐⭐⭐ | ⚠️ ボスAI拡張 | ターン経過で `resistances` を動的に変更 |
| 召喚（手下追加） | ⭐⭐⭐ | ⚠️ 敵追加ロジック | 戦闘中に `battle.enemies` へ追加 |
| 怯え（行動不能） | ⭐⭐ | ⚠️ 新規状態異常 | `STATUS_EFFECTS` に `fear` を追加 |
| 水中戦闘ダメージ | ⭐⭐ | ⚠️ 戦闘ループ拡張 | 毎ターン終了時に全員微ダメージ |

### 実装リスク
- **属性変化ボス**: ボスAIに「ターンカウント」の概念を持たせ、属性と耐性を切り替える処理が必要。
- **召喚**: 戦闘中に敵を追加する処理は未実装。`battle.enemies.push()` と描画の再計算が必要。

---

## 5. モンスター・ボスデータ

| 機能 | 難易度 | 既存システム活用 | 備考 |
|------|--------|------------------|------|
| 通常モンスター追加 | ⭐ | ✅ `monsters` オブジェクト | データ追加のみ |
| エンカウンターテーブル追加 | ⭐ | ✅ `encounterTables` | データ追加のみ |
| ボススキル追加 | ⭐⭐ | ✅ `bossSkills` | 新規スキル定義 |
| ボス撃破フラグ追加 | ⭐ | ✅ `gameProgress.bossDefeated` | データ追加のみ |

### 実装リスク
- **低リスク**: データ追加が主体のため、既存パターンに従えば問題なし。

---

## 6. アイテム・装備

| 機能 | 難易度 | 既存システム活用 | 備考 |
|------|--------|------------------|------|
| 新規アイテム追加 | ⭐ | ✅ `items` オブジェクト | データ追加のみ |
| 船強化パーツ（フラグ系） | ⭐⭐ | ⚠️ 特殊アイテム | 使用時に `gameProgress` を更新 |
| 酸素ボンベ（歩数追加） | ⭐⭐ | ⚠️ 特殊アイテム | 使用時に酸素ゲージ上限を変更 |

### 実装リスク
- **低リスク**: 既存のクエストアイテムと同様の処理で対応可能。

---

## 7. ストーリー・イベント

| 機能 | 難易度 | 既存システム活用 | 備考 |
|------|--------|------------------|------|
| NPC追加（セリフ） | ⭐ | ✅ マップJSON | データ追加のみ |
| 条件付きセリフ | ⭐ | ✅ `conditionalMessages` | データ追加のみ |
| 船入手イベント | ⭐⭐ | ⚠️ イベント処理 | NPC会話後にフラグ設定 |
| 3宝玉を捧げるイベント | ⭐⭐ | ⚠️ イベント処理 | 祭壇NPC + アイテム所持判定 |
| ボス撃破後の演出 | ⭐ | ✅ 既存ボス演出 | 既存パターン流用 |

### 実装リスク
- **低リスク**: イベントの流れは既存の「仲間加入」「クエストアイテム」と同構造。

---

## 8. 推奨実装順序

### フェーズ1：基盤整備（必須・低リスク）
1. 新規タイル定義（海、潮流、空気の泡など）
2. 新規モンスター・ボスデータの追加
3. 新規アイテム・装備の追加
4. ストーリーフラグの追加

### フェーズ2：コア機能（中リスク）
5. 船の表示と海上移動の実装
6. 循環マップの実装
7. 上陸/乗船システムの実装
8. 酸素ゲージシステムの実装
9. 呪文封印エリアの実装

### フェーズ3：ボス戦拡張（中〜高リスク）
10. MP吸収スキルの実装
11. 召喚（手下追加）の実装
12. 属性変化ボスの実装
13. 怯え状態の実装

### フェーズ4：代替案で対応済み（実装不要）
→ ステルスや移動島のリアルタイム処理は**採用見送り**。代替案（話しかけ戦闘・フラグ出現）はフェーズ1。2で対応。

---

## 9. 工数見積もり（概算）

| フェーズ | 内容 | 想定工数 |
|----------|------|----------|
| フェーズ1 | データ追加 | 2〜3時間 |
| フェーズ2 | コア機能 | 8〜12時間 |
| フェーズ3 | ボス戦拡張 | 4〜6時間 |
| **合計** | 全実装 | **14〜21時間** |

※ テスト・デバッグ時間は別途必要。

---

## 10. 結論と推奨事項

### 実装可能性
- **フェーズ1〜3は十分に実装可能**。既存システムの延長線上にあり、リスクも管理可能。
- **高難度ギミックは代替案で対応済み**。工数とバグリスクを大幅に削減。

### 最終推奨
1. フェーズ1〜3を順に実装し、**遊べる状態**を作る。
2. 代替案により、ステルスや移動島の「雰囲気」は、ダンジョン設計やNPCセリフで演出する。

---

## 更新履歴
- 2026-01-16: 初版作成
