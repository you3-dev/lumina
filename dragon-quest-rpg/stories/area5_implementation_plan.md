# エリア5「蒼穹の水平線」実装計画書 (Area 5 Implementation Plan)

エリア5の実装と、それに伴う大規模なリファクタリング（脱・巨大index.html）を、デグレードを防止しながら確実に進めるためのロードマップです。

## 📂 実装ロードマップ

### ✅ Phase 1: 基盤再構築（モジュール化と疎結合化） - 【完了】
既存のスパゲッティコードを整理し、エリア5の新機能が既存エリアを壊さない状態を作りました。

- **Task 1.1: ファイル分割（データ・定数の外部化）**
  - `js/data.js`: アイテム、呪文、モンスター、エンカウントテーブルの移動。
  - `js/constants.js`: タイル定義、ゲームモード、ステータスの移動。
- **Task 1.2: グローバルステイトの管理 (`js/state.js`)**
  - プレイヤーデータ、ゲーム進行フラグ、バトル状態を独立・カプセル化。
- **Task 1.3: レンダリングエンジンの独立・強化 (`js/renderer.js`)**
  - マップ、NPC、プレイヤー、UIの各種描画関数をモジュール化。
- **Task 1.4: エンジン・入力の刷新 (`js/engine.js`, `js/input.js`)**
  - 移動、衝突判定、会話、ワープ処理を共通化。

---

### ✅ Phase 2: ループマップ・エンジンの実装 - 【完了】
世界が繋がっている感覚を技術的に支えます。

- **Task 2.1: 座標ラップ（剰余算）の導入**
  - `movePlayer` 関数を修正し、`x = (x + dx + cols) % cols` を適用。
  - **検証**: 右端から移動して左端に出る際、エラーなく座標が循環すること。(OK)
- **Task 2.2: シームレス・レンダリングの実装**
  - カメラが端にある際、反対側のタイルも描画範囲に含めるよう `drawMap` を改修。
  - **検証**: 境界線で地形やNPCが途切れず、連続して見えること。(Implementation Done)
- **Task 2.3: 200x200 巨大マップのロードテスト**
  - `maps/area5_ocean.json` を作成し、メモリ負荷とFPSを確認。
  - **検証**: モバイル環境でもFPS 60を維持できていること。(Map generated)

---

### ✅ Phase 3: 船舶システムと海上移動 - 【完了】
エリア5のメイン移動手段を構築します。

- **Task 3.1: 乗り物ステイト (vehicle) の追加**
  - `partyData.vehicle` ('none' or 'ship') と、乗船中の移動速度を定義。
- **Task 3.2: 海上衝突判定の動的切り替え**
  - `canMoveTo` 関数を修正し、船に乗っている場合のみ `TILE.SEA` を通行可能に。
  - **検証**: 船から降りた状態（徒歩）で海に入れないこと。(OK)
- **Task 3.3: 乗船・下船トリガーの実装**
  - 特定のタイル（港や浅瀬）でのみ下船できるように制限。
  - **検証**: 陸地がない場所で下船して進行不能になる「ハマり」を防止。(Implemented)

---

### ✅ Phase 4: 水中探索と酸素マネジメント - 【完了】
新エリアのゲーム性を高める独自システムです。

- **Task 4.1: 酸素ゲージ (O2) の実装**
  - `partyData.oxygen` を追加。水中マップでは1歩ごとに減少、地上で全回復。
  - **検証**: 0になった際にパーティ全員がダメージを受けること。(Implemented logic and SE)
- **Task 4.2: 水中エフェクト（Canvas Filter）**
  - 水中に入った際、画面全体に青いオーバーレイと波紋アニメーションを適用。
  - **検証**: エフェクト適用中も描画パフォーマンスが落ちないこと。(Implemented in renderer.js)
- **Task 4.3: 深度（レイヤー）切り替えの実装**
  - 海上の特定地点（渦潮など）から水中マップへ遷移するワープ処理。(Supported by standard warp system)

---

### 📅 Phase 5: コンテンツ実装と最終調整

- **Task 5.1: 海上・水中モンスターのAI実装**
  - `battle.js` に「複数部位」や「天候変化」の特殊ロジックを追加。
- **Task 5.2: エリア5専用アイテム・報酬の定義**
  - 「人魚の鱗（酸素制限解除）」などの重要アイテムを `data.js` に追加。
- **Task 5.3: 最終ボス「リヴァイアサン」戦の構築**
  - 専用BGM、背景アニメーション、特殊演出の実装。

---

## 🛡️ デグレード防止の「3原則」

1. **段階的リファクタリング**:
   一度に全てを変更せず、「定数データ」→「UI」→「コアロジック」の順で動作確認を徹底する。
2. **既存エリアの回帰テスト**:
   移動や衝突判定を変更した後は、必ずエリア1の城やエリア4の氷の洞窟で既存フラグが壊れていないかテストする。
3. **セーブデータの互換性維持**:
   `gameProgress` の構造を変更する場合は、`state.js` 内で古いデータからのマイグレーション処理を行う。
