# エリア3 ストーリー設計書

## 概要

エリア3「古の大地 / 地底世界」は、100年前に闇に覆われた世界を舞台とし、闇の守護者を救い光を取り戻すストーリーです。

---

## マップ構成

| マップ | 名称 | サイズ | タイプ | 説明 |
|--------|------|--------|--------|------|
| desert_portal_room.json | 砂漠の時空の間 | - | portal | エリア2からの出発点 |
| sealed_shrine.json | 封印の祠 | - | shrine | 地底への入口、帰還不可 |
| underworld_3.json | 地底世界 | 100x100 | underworld | メインフィールド |
| underworld_village.json | 地底の村 | 15x15 | town | 安全な拠点 |
| area3_castle.json | 古城セレスティア | 21x21 | dungeon | ボスダンジョン |
| surface_3.json | 古の大地 | 100x100 | field | 地上フィールド（ボス後に解放） |
| hidden_sanctuary.json | 隠れ宿 | 10x10 | town | ザオリク習得拠点（ルーラ可） |

---

## 正しいストーリーフロー

### Phase 1: エリア2からエリア3への遷移

```
エリア2: 太陽の城塞（desert_castle.json）
    ↓
砂漠の守護者（desertGuardian）撃破
    ↓
砂漠の王：「北の旅の扉を開いておいた。新たなる大地へ進むがよい！」
    ↓
砂漠の時空の間（desert_portal_room.json）へ
```

### Phase 2: 封印の発動（帰還不可）

```
砂漠の時空の間のNPC：
- 「この扉の先は『古の大地』...かつて闇に覆われ、封じられた地じゃ。」
- 「扉をくぐれば封印の祠に着く。その先は地底世界が広がっておる。」
- 「一度くぐれば、二度とこの地には戻れぬ。覚悟はできておるか？」
    ↓
ポータル通過
    ↓
【封印イベント発動】
画面が赤く脈動
「扉が激しく輝き始めた！
 古の封印が発動した...
 もうこの扉は二度と開かない...」
    ↓
フラグ設定: area3Entered, area3SealActivated
ルーラ制限: 他エリアへの移動は不可（エリア3内での移動は可能）
```

### Phase 3: 封印の祠から地底世界へ

```
封印の祠（sealed_shrine.json）到着
    ↓
祠の賢者：
「ようこそ...そして、さらばだ。」
「この祠の扉は今、永遠に封じられた。」
「外へ出れば、地底の世界が広がっておる。」
「かつてこの地上を覆った闇から逃れた者たちが暮らしておる。」
    ↓
地底世界（underworld_3.json）へ
```

### Phase 4: 地底の村との出会い

```
地底世界探索
    ↓
underworld_3 @(50, 77) のワープポイント
    ↓
地底の村（underworld_village.json）到着
```

**村のNPCと世界観**

| NPC | セリフ要約 |
|-----|-----------|
| 長老 | 「我々は100年前、地上から逃れてきた者たちの末裔だ」「空から光が消え、闇の影が大地を覆った」 |
| 女性 | 「地上に帰りたい...でも、帰る方法がないの」「本物の星空を見てみたい」 |
| 子供 | 「『星』ってどんなもの？」「ぼく、見たことないんだ」 |
| 警備兵 | 「光の石の力が弱まっている。このままでは...」 |

### Phase 5: セレンとの出会い

**Stage 1: 初回遭遇**
```
セレン @(11, 8) に初めて話しかける
    ↓
「......」
「ああ、あなたが...」
「星の導きが示していた者ね。」
「私はセレン。この地底で星を読む者。」
    ↓
フラグ: serenJoin.stage1_met = true
```

**Stage 2: 楔クエストの説明**
```
セレンに再度話しかける
    ↓
「地上の光は失われても、星の光だけは変わらず輝いている。」
「星々は教えてくれるの...未来の道筋を。」
「あなたの未来には、4つの光が見える。」
「北、東、南、西...失われた楔を取り戻す運命ね。」
    ↓
フラグ: serenJoin.stage2_helped = true
```

### Phase 6: 4つの楔収集

地底世界の4方位の祭壇で楔を収集。各楔に100年前の記憶が刻まれている。

**北の楔の記憶**
```
――100年前の記憶――
星読みの長老：「星が...黒く染まっていく...」
長老：「あと7日で、影が目覚める...」
長老：「急げ！ 封印の準備を！」
```

**東の楔の記憶**
```
星読みの女性：「封印は完璧じゃない...」
女性：「いつか必ず、誰かが真実に辿り着く。」
女性：「その時、影の...本当の姿を知るでしょう。」
```

**南の楔の記憶**
```
星読みの戦士：「影は...元々この世界の守護者だった。」
戦士：「だが何かが歪み、暴走してしまった。」
戦士：「破壊するのではなく、救う方法があるはず...」
```

**西の楔の記憶**
```
星読みの大賢者：「後世の勇者よ、聞いてくれ。」
賢者：「影の核には、純粋な光がある。」
賢者：「その光を解放できれば、影は本来の姿に戻る。」
賢者：「我らにはその力がなかった...」
賢者：「だが未来の勇者なら...きっと。」
```

**4つ全て収集時**
```
「4つの楔が揃った！」
「古の封印が解かれる音が聞こえる...」
「古城の最上階への道が開かれた！」
    ↓
フラグ: ancientCastleUnlocked = true
楔1つ収集時: serenJoin.stage3_completed = true
```

### Phase 7: セレン仲間加入

```
stage3_completed 後にセレンに話しかける
    ↓
「セレンを仲間にしますか？」
    ├─ はい →
    │   「...決めたわ。」
    │   「私も一緒に行かせて。」
    │   「この運命を、見届けたい。」
    │   → セレン加入、serenJoined = true
    │
    └─ いいえ →
        「...そう。」
        「でも、いつでも声をかけてね。」
```

### Phase 8: 古城セレスティアへ

```
underworld_3 @(50, 10) のワープポイント
※ ancientCastleUnlocked フラグ必須
    ↓
古城セレスティア（area3_castle.json）到着
```

**城内NPC**

| NPC | セリフ |
|-----|--------|
| 古き賢者 | 「この城は、かつてセレスティア王国の中心だった...」「最奥に眠る者...それは敵ではない。救いを求めている者だ。」 |
| 警告する老人 | 「4つの楔が揃わなければ、最奥には進めぬ。」「楔は地底の東西南北の祭壇にある。」 |

### Phase 9: 闇の守護者との戦い

```
ancient_guardian @(10, 2) に接触
    ↓
【戦闘前】
「...来たか。星に導かれし者よ。」
「我は...光の守護者...だった者。」
「この闇が...我を蝕む...」
「100年...ずっと苦しんできた...」
「頼む...終わらせてくれ...」
「だが...我にもまだ力がある...」
「お前たちが本当に救えるかどうか...」
「この戦いで証明してみせろ！」
    ↓
【ボス戦】shadowGuardian
HP:1000, ATK:110, DEF:65, SPD:25
使用呪文: giragura, mahoton, hyados
    ↓
【戦闘後】
「...ありがとう...」
「ようやく...光が見える...」
「長い闇の時代が...終わる...」
「我の核にある光を...解放してくれ...」
「そうすれば...この地に星の光が戻る...」
    ↓
フラグ: shadowGuardianDefeated, area3Completed
```

### Phase 10: 地上への帰還と報酬

```
ボス撃破後
    ↓
地底世界の4つのポータルが使用可能になる
（shadowGuardianDefeated フラグで解放）
    ↓
地上（surface_3.json）へ
```

**【オプション】古き魔術師からザオリク習得**
```
surface_3 @(85, 15) のワープポイントから隠れ宿へ
    ↓
hidden_sanctuary 内の古き魔術師 @(7, 2)
    ↓
「おお...その光、確かに感じる。」
「闘の守護者を救い、光を取り戻したのじゃな。」
「約束通り、古代呪文を授けよう。」
「これは『ザオリク』...確実に命を蘇らせる究極の復活呪文じゃ。」
「この呪文は代々、王国の守護者にのみ伝えられてきた。」
「今、その資格を持つのはお主だけじゃ。」
    ↓
フラグ: ancientSpellReceived = true
パーティ全員がザオリク習得

※ 隠れ宿は isSettlement: true なのでルーラ登録可能
```

---

## ストーリーフラグ一覧

### メインフラグ

| フラグ名 | 説明 | 設定タイミング |
|----------|------|----------------|
| area3Entered | エリア3進入 | 封印の祠通過時 |
| area3SealActivated | 封印発動（ルーラ不可） | area3Enteredと同時 |
| serenJoined | セレン加入 | セレン加入処理完了時 |
| ancientCastleUnlocked | 古城開放 | 4つの楔収集時 |
| shadowGuardianDefeated | ボス撃破 | ボス戦勝利時 |
| area3Completed | エリア3クリア | ボス撃破時 |
| ancientSpellReceived | ザオリク習得 | 古き魔術師から習得時 |

### セレン加入クエストフラグ

| フラグ名 | 説明 | 設定条件 |
|----------|------|----------|
| serenJoin.stage1_met | 初回遭遇 | セレンに初めて話しかけた |
| serenJoin.stage2_helped | クエスト説明聞いた | セレンに2回目話しかけた |
| serenJoin.stage3_completed | 条件達成 | 楔を1つ以上収集 |
| serenJoin.joined | 正式加入 | 「仲間にする？」で「はい」 |

### 楔フラグ

| フラグ名 | 説明 |
|----------|------|
| wedges.wedge_north | 北の楔収集済み |
| wedges.wedge_east | 東の楔収集済み |
| wedges.wedge_south | 南の楔収集済み |
| wedges.wedge_west | 西の楔収集済み |
| wedges.allCollected | 4つ全て収集済み |

---

## NPC一覧

### desert_portal_room（砂漠の時空の間）

| NPC ID | 名前 | 役割 |
|--------|------|------|
| desert_portal_sage | ポータル賢者 | 警告：帰還不可 |
| desert_portal_warning | 警告者 | 準備を促す |

### sealed_shrine（封印の祠）

| NPC ID | 名前 | 役割 |
|--------|------|------|
| shrine_sage | 祠の賢者 | 世界観説明 |
| shrine_healer | 祠の癒し手 | HP/MP回復 |

### underworld_3（地底世界）

| NPC ID | 名前 | 位置 | 役割 |
|--------|------|------|------|
| hermit_underworld | 隠者 | (25, 22) | 地底湖の警告 |
| explorer | 探検家 | (70, 30) | 古代遺跡の噂 |

### underworld_village（地底の村）

| NPC ID | 名前 | 位置 | 役割 |
|--------|------|------|------|
| underworld_elder | 長老 | (7, 5) | 100年前の歴史 |
| underworld_shop | 雑貨屋 | (4, 2) | ショップ |
| underworld_woman | 村の女性 | (3, 8) | 地上への想い |
| underworld_child | 村の子供 | (10, 9) | 星への憧れ |
| underworld_guard | 警備兵 | (7, 12) | 光の石の警告 |
| seren | セレン | (11, 8) | **仲間キャラ** |
| underworld_healer | 癒し手 | (5, 5) | HP/MP回復 |

### area3_castle（古城セレスティア）

| NPC ID | 名前 | 位置 | 役割 |
|--------|------|------|------|
| castle_sage | 古き賢者 | (5, 10) | ヒント：守護者は敵ではない |
| castle_warning | 警告する老人 | (15, 10) | ヒント：4つの楔が必要 |
| ancient_guardian | 闇の守護者 | (10, 2) | **ボス** |

### surface_3（古の大地）

| NPC ID | 名前 | 位置 | 役割 |
|--------|------|------|------|
| surface3_traveler1 | 旅の商人 | (40, 50) | ヒント：4つの祭壇について |
| surface3_traveler2 | 冒険者 | (60, 50) | 世界観説明 |
| surface3_traveler3 | 賢者 | (50, 50) | 警告：古城について |

※ 隠れ宿へのワープポイント: (85, 15)

### hidden_sanctuary（隠れ宿）

| NPC ID | 名前 | 位置 | 役割 |
|--------|------|------|------|
| hidden_innkeeper | 隠れ宿の主 | (3, 2) | 宿屋（10G） |
| ancient_hermit | 古き魔術師 | (7, 2) | ザオリク習得クエスト |
| sanctuary_guide | 老人 | (5, 5) | 聖域の説明 |

---

## ボス情報

### shadowGuardian（闇の守護者）

| パラメータ | 値 |
|------------|-----|
| 日本語名 | やみのしゅごしゃ |
| HP | 1000 |
| 攻撃力 | 110 |
| 防御力 | 65 |
| 速度 | 25 |
| レベル | 35 |
| 経験値 | 2500 |
| ゴールド | 1200 |
| 使用呪文 | giragura, mahoton, hyados |

**背景**: 元々は「光の守護者」だったが、100年前に何かが歪み暴走。闇に蝕まれながらも救いを求めている。倒すのではなく「救う」ことが目的。

---

## セレン ステータス

| パラメータ | 値 |
|------------|-----|
| 名前 | セレン |
| ジョブ | seer（星読み） |
| HP | 35 |
| MP | 60 |
| 攻撃 | 8 |
| 防御 | 6 |
| 速度 | 14 |
| レベル | 15 |
| 初期呪文 | rukani, rariho, piorimu |

---

## ストーリーの核心テーマ

1. **救済** - 敵を倒すのではなく「救う」
2. **100年の時** - 過去と現在を繋ぐ楔の記憶
3. **光と闇** - 守護者の堕落と救済
4. **希望** - 地底の民の地上への想い
5. **運命** - 星の導きによる勇者の旅

---

## 現在の実装確認事項

### 正常に動作している部分
- [x] エリア2→3の遷移（封印イベント）
- [x] 地底の村へのアクセス
- [x] セレンの段階的会話
- [x] 楔収集イベント
- [x] 古城へのワープ条件（ancientCastleUnlocked）
- [x] ボス戦後の地上解放（shadowGuardianDefeated）

### 確認・修正が必要な箇所
- [ ] ワープ座標とポータルタイルの一致（一部修正済み）
- [ ] 楔の祭壇の視覚的な表現
- [ ] セレン加入条件（楔1つ vs 4つ）の統一
- [ ] castle_warning NPCの配置（古城内だと遅すぎる）

---

## 楔のダンジョン設計（新規追加）

### 概要

各楔の祭壇は地下3階構造のダンジョンへの入口となる。ダンジョンの最深部には楔の守護者がおり、倒すことで楔を入手できる。

### ダンジョン一覧

| マップ | 名称 | サイズ | 入口座標 | テーマ |
|--------|------|--------|----------|--------|
| wedge_dungeon_north_b1.json | 北の祭壇・地下1階 | 25x25 | (50, 25) | 氷の迷宮 |
| wedge_dungeon_north_b2.json | 北の祭壇・地下2階 | 30x30 | - | 氷の試練 |
| wedge_dungeon_north_b3.json | 北の祭壇・地下3階 | 20x20 | - | 氷の守護者の間 |
| wedge_dungeon_east_b1.json | 東の祭壇・地下1階 | 25x25 | (75, 50) | 炎の迷宮 |
| wedge_dungeon_east_b2.json | 東の祭壇・地下2階 | 30x30 | - | 炎の試練 |
| wedge_dungeon_east_b3.json | 東の祭壇・地下3階 | 20x20 | - | 炎の守護者の間 |
| wedge_dungeon_south_b1.json | 南の祭壇・地下1階 | 25x25 | (50, 75) | 風の迷宮 |
| wedge_dungeon_south_b2.json | 南の祭壇・地下2階 | 30x30 | - | 風の試練 |
| wedge_dungeon_south_b3.json | 南の祭壇・地下3階 | 20x20 | - | 風の守護者の間 |
| wedge_dungeon_west_b1.json | 西の祭壇・地下1階 | 25x25 | (25, 50) | 雷の迷宮 |
| wedge_dungeon_west_b2.json | 西の祭壇・地下2階 | 30x30 | - | 雷の試練 |
| wedge_dungeon_west_b3.json | 西の祭壇・地下3階 | 20x20 | - | 雷の守護者の間 |

### ダンジョン構造

```
underworld_3 の祭壇 (TILE.WEDGE_ALTAR)
    ↓ 調べる
地下1階 (25x25) - 探索・エンカウント
    ↓ 階段
地下2階 (30x30) - 複雑な迷路・強敵エンカウント
    ↓ 階段
地下3階 (20x20) - ボスエリア
    ↓ ボス撃破
楔入手 + 100年前の記憶フラッシュバック
```

### 楔の守護者（4体）

各ダンジョンの最深部には属性を持った守護者がいる。

#### 北の守護者（氷）

| パラメータ | 値 |
|------------|-----|
| ID | wedgeGuardian_north |
| 日本語名 | こおりのしゅごしゃ |
| HP | 650 |
| 攻撃力 | 85 |
| 防御力 | 55 |
| 速度 | 18 |
| レベル | 28 |
| 経験値 | 900 |
| ゴールド | 600 |
| 使用呪文 | hyado, hyados |
| 耐性 | 氷無効、炎弱点 |

**戦闘前セリフ**:
```
「...侵入者か。」
「100年もの間、この楔を守り続けてきた。」
「お前たちが真に資格ある者か...試させてもらう！」
```

**撃破後**:
```
「...見事だ。」
「お前たちなら...闇の守護者を救えるかもしれぬ。」
「この楔を持っていけ。」
```

#### 東の守護者（炎）

| パラメータ | 値 |
|------------|-----|
| ID | wedgeGuardian_east |
| 日本語名 | ほのおのしゅごしゃ |
| HP | 600 |
| 攻撃力 | 95 |
| 防御力 | 45 |
| 速度 | 22 |
| レベル | 29 |
| 経験値 | 950 |
| ゴールド | 620 |
| 使用呪文 | gira, giragura |
| 耐性 | 炎無効、氷弱点 |

**戦闘前セリフ**:
```
「燃え盛る炎の試練...お前たちに耐えられるか？」
「100年の孤独が...この炎をさらに激しくした。」
「来い！ 我が炎で焼き尽くしてくれる！」
```

#### 南の守護者（風）

| パラメータ | 値 |
|------------|-----|
| ID | wedgeGuardian_south |
| 日本語名 | かぜのしゅごしゃ |
| HP | 550 |
| 攻撃力 | 75 |
| 防御力 | 50 |
| 速度 | 35 |
| レベル | 28 |
| 経験値 | 880 |
| ゴールド | 580 |
| 使用呪文 | bagima, piorimu |
| 耐性 | 即死無効、素早さ高い |

**戦闘前セリフ**:
```
「風のように素早く...風のように容赦なく...」
「捕まえられるものなら、捕まえてみろ！」
```

#### 西の守護者（雷）

| パラメータ | 値 |
|------------|-----|
| ID | wedgeGuardian_west |
| 日本語名 | いかずちのしゅごしゃ |
| HP | 700 |
| 攻撃力 | 90 |
| 防御力 | 60 |
| 速度 | 20 |
| レベル | 30 |
| 経験値 | 1000 |
| ゴールド | 650 |
| 使用呪文 | dein, raiden |
| 耐性 | 雷無効、マヒ無効 |

**戦闘前セリフ**:
```
「天の裁きを受けよ！」
「雷の力は全てを貫く...お前たちの覚悟も試されるぞ！」
```

### ダンジョン内エンカウント

#### 地下1階（推奨Lv25-27）

| モンスター | HP | ATK | DEF |
|------------|-----|-----|-----|
| シャドウスライム | 60 | 35 | 20 |
| ダークバット | 45 | 40 | 15 |
| 骨戦士 | 80 | 45 | 30 |

#### 地下2階（推奨Lv27-29）

| モンスター | HP | ATK | DEF |
|------------|-----|-----|-----|
| ダークナイト | 120 | 55 | 40 |
| 呪いの魔術師 | 70 | 30 | 25 |
| 地底ドラゴン | 150 | 60 | 45 |

#### 地下3階（ボスエリアのみ）

エンカウントなし（ボス戦に集中）

### フロー変更

```
【旧】
祭壇に向かって調べる → 即座に楔入手 + 記憶フラッシュバック

【新】
祭壇に向かって調べる
    ↓
「古代の祭壇だ...地下へ続く階段がある。降りますか？」
    ├─ はい → ダンジョン地下1階へワープ
    └─ いいえ → キャンセル

地下3階でボス撃破
    ↓
楔入手 + 記憶フラッシュバック
    ↓
「光に包まれ、祭壇の前に戻された。」
```

---

## 古城セレスティア拡張設計（新規追加）

### 概要

現在21x21の1フロアから、地下2階＋地上3階の5フロア構成に拡張。各階に試練と謎解きを配置。

### フロア構成

| フロア | 名称 | サイズ | 内容 |
|--------|------|--------|------|
| area3_castle_b2.json | 古城・地下2階 | 30x30 | 封印の間（入口） |
| area3_castle_b1.json | 古城・地下1階 | 30x30 | 牢獄・隠し通路 |
| area3_castle_1f.json | 古城・1階 | 35x35 | 大広間・エントランス |
| area3_castle_2f.json | 古城・2階 | 30x30 | 図書室・魔法の間 |
| area3_castle_3f.json | 古城・3階 | 25x25 | 王の間・最終ボス |

### 各フロアの詳細

#### 地下2階（封印の間）
- underworld_3からの入口
- 封印の結界が張られた通路
- 4つの楔が揃っていないと先に進めない扉
- 隠し宝箱：まもりのたね

#### 地下1階（牢獄）
- かつての囚人の亡霊との戦闘
- 隠し通路を見つけて進む必要がある
- NPC：囚われの魂（ヒント提供）
- 宝箱：ちからのたね

#### 1階（大広間）
- 最大のフロア
- 中央に巨大な噴水（かつての栄華の象徴）
- 左右に分かれる通路（どちらからでも進める）
- エンカウント率高め
- NPC：古き賢者（移動）

#### 2階（図書室・魔法の間）
- 魔法に関する書物が並ぶ
- 魔法の罠（床を踏むとダメージ or 戦闘）
- 中ボス戦：「図書室の守護者」
- 宝箱：すばやさのたね

#### 3階（王の間）
- 最終ボス「闇の守護者」との対決
- 戦闘前の演出イベント
- ボス撃破後、光が戻る演出
- 地上への転送ポータル出現

### 中ボス：図書室の守護者

| パラメータ | 値 |
|------------|-----|
| ID | libraryGuardian |
| 日本語名 | としょしつのばんにん |
| HP | 350 |
| 攻撃力 | 70 |
| 防御力 | 55 |
| 速度 | 15 |
| レベル | 32 |
| 経験値 | 1200 |
| ゴールド | 700 |
| 使用呪文 | mahoton, rariho |

**戦闘前セリフ**:
```
「この図書室には...王国の秘密が眠っている。」
「それを守るのが...我が使命。」
「たとえ100年経とうとも...誰も通さぬ！」
```

### 古城エンカウントテーブル

| モンスター | HP | ATK | DEF | 出現フロア |
|------------|-----|-----|-----|-----------|
| ゴースト | 50 | 35 | 20 | B2, B1 |
| スケルトン | 70 | 45 | 30 | B1, 1F |
| ダークアーマー | 130 | 60 | 50 | 1F, 2F |
| デスマジシャン | 90 | 40 | 30 | 2F |
| 呪われた騎士 | 160 | 70 | 55 | 2F, 3F |

---

## 更新履歴

- 2026-01-03: ボスHP調整（楔守護者: 550-700、闇の守護者: 1000）
- 2026-01-03: 楔のダンジョン設計を追加（地下3階構造、4属性ボス）
- 2026-01-03: 古城セレスティア拡張設計を追加（5フロア構成）
- 2026-01-03: hidden_sanctuary.json を新規作成（隠れ宿を拠点化）
- 2026-01-03: エリア3内でのルーラ移動を可能にする設計に変更
- 2026-01-03: NPCセリフに基づいてストーリーフローを修正
