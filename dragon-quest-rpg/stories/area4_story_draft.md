# エリア4 シナリオ案（ドラフト）

> **注意**: これは初期構想段階のドキュメントです。内容は変更される可能性があります。

---

## 概要

| 項目 | 内容 |
|------|------|
| エリア名 | 氷雪の大陸 |
| レベル帯 | Lv 35-50 |
| テーマ | 永久凍土、氷の王国、パズルダンジョン |
| キーワード | 凍結、孤独、失われた王国、謎解き |

---

## ストーリー概要

### 背景
100年前の災厄で、氷の王国「フロストヘイム」は女王ごと凍りついた。
女王は闇の力から王国を守るため、自らを含む全てを凍らせる禁呪を使った。
しかしその代償として、女王は氷の呪いに蝕まれ、今も苦しみ続けている。

### 勇者の目的
- 氷の女王を呪いから解放する
- 王国に眠る「極光の宝珠」を入手する（エリア5への鍵）

### ストーリーの流れ
```
エリア3クリア後
    ↓
古の大地の北に氷の大陸への道が開く
    ↓
雪原の村で情報収集
「氷の城に囚われた女王を救えるのは、炎の心を持つ者だけ」
    ↓
氷の洞窟（パズルダンジョン1）
    ↓
凍りついた湖（パズルダンジョン2）
    ↓
氷の神殿で「太陽の炎」を入手
    ↓
氷の城で女王を救出
    ↓
極光の宝珠を受け取り、エリア5へ
```

---

## マップ構成

| マップID | 名称 | サイズ | タイプ | パズル要素 |
|----------|------|--------|--------|------------|
| ice_field | 氷原 | 100x100 | field | なし（探索） |
| snow_village | 雪原の村 | 20x20 | town | なし（拠点） |
| ice_cave_1f | 氷の洞窟・1階 | 30x30 | dungeon | 滑る床（導入） |
| ice_cave_b1 | 氷の洞窟・地下1階 | 35x35 | dungeon | 滑る床（応用） |
| ice_cave_b2 | 氷の洞窟・地下2階 | 25x25 | dungeon | 中ボス戦 |
| frozen_lake | 凍りついた湖 | 40x40 | dungeon | 圧力スイッチ+滑る床 |
| ice_temple_1f | 氷の神殿・1階 | 30x30 | dungeon | 灯火パズル |
| ice_temple_2f | 氷の神殿・2階 | 25x25 | dungeon | 記憶パズル |
| ice_temple_3f | 氷の神殿・3階 | 20x20 | dungeon | 太陽の炎入手 |
| ice_castle_1f | 氷の城・1階 | 35x35 | dungeon | 複合パズル |
| ice_castle_2f | 氷の城・2階 | 30x30 | dungeon | 複合パズル |
| ice_castle_3f | 氷の城・3階 | 25x25 | dungeon | ボス戦 |

---

## パズル詳細設計

### パズル1: 滑る床（氷の洞窟）

#### 基本ルール
- 氷床タイルの上では、進んだ方向に壁か通常床にぶつかるまで滑り続ける
- 途中で方向転換はできない
- 穴に落ちると入口に戻される

#### 実装案
```javascript
// タイルタイプ
TILE.ICE_FLOOR = 30;      // 滑る床
TILE.ICE_WALL = 31;       // 氷の壁（止まれる）
TILE.ICE_HOLE = 32;       // 穴（落ちると戻る）

// 移動処理
function handleIceFloorMovement(direction) {
    while (true) {
        const nextTile = getNextTile(player.x, player.y, direction);
        if (nextTile === TILE.ICE_WALL || nextTile === TILE.NORMAL_FLOOR) {
            break; // 止まる
        }
        if (nextTile === TILE.ICE_HOLE) {
            // 穴に落ちた
            showMessage("足を滑らせて穴に落ちてしまった！");
            teleportToEntrance();
            break;
        }
        movePlayer(direction);
    }
}
```

#### 難易度段階
| 階層 | 難易度 | 要素 |
|------|--------|------|
| 1階 | ★☆☆ | 一方向に滑るだけ（チュートリアル） |
| 地下1階 | ★★☆ | 複数の氷床を組み合わせ |
| 地下2階 | ★★★ | 穴あり、複雑な経路 |

---

### パズル2: 圧力スイッチ（凍りついた湖）

#### 基本ルール
- 氷のブロックを押してスイッチの上に乗せる
- 全てのスイッチが押されると扉が開く
- ブロックは氷床の上では滑る
- リセットスイッチで最初からやり直せる

#### 実装案
```javascript
// オブジェクトタイプ
OBJECT.ICE_BLOCK = 50;    // 押せる氷ブロック
OBJECT.SWITCH = 51;       // 圧力スイッチ
OBJECT.RESET_SWITCH = 52; // リセットスイッチ

// ブロック押し処理
function pushIceBlock(block, direction) {
    const nextPos = getNextPosition(block.x, block.y, direction);

    // 氷床の場合は滑る
    if (getTile(nextPos.x, nextPos.y) === TILE.ICE_FLOOR) {
        slideBlock(block, direction);
    } else if (isWalkable(nextPos)) {
        block.x = nextPos.x;
        block.y = nextPos.y;
    }

    checkAllSwitches();
}
```

#### パズル例
```
🧱🧱🧱🧱🧱🧱🧱🧱
🧱🧊🧊🧊🧊🧊🧊🧱
🧱🧊📦🧊🔘🧊🧊🧱  📦=氷ブロック
🧱🧊🧊🧊🧊📦🧊🧱  🔘=スイッチ
🧱🧊🔘🧊🧊🧊🧊🧱  🚪=扉
🧱🧊🧊🧊🧊🧊🚪🧱
🧱🧱🧱👤🧱🧱🧱🧱
```

---

### パズル3: 灯火パズル（氷の神殿・1階）

#### 基本ルール
- 部屋に複数の燭台がある
- 燭台を調べると火がつく/消える（トグル）
- 隣接する燭台も連動して状態が変わる（ライツアウト式）
- 全ての燭台に火を灯すと扉が開く

#### 実装案
```javascript
// 燭台の状態管理
const torches = [
    { id: 0, x: 5, y: 3, lit: false, links: [1, 2] },
    { id: 1, x: 10, y: 3, lit: false, links: [0, 3] },
    { id: 2, x: 5, y: 8, lit: false, links: [0, 3] },
    { id: 3, x: 10, y: 8, lit: false, links: [1, 2] },
];

function toggleTorch(torchId) {
    const torch = torches[torchId];
    torch.lit = !torch.lit;

    // 連動する燭台も切り替え
    torch.links.forEach(linkedId => {
        torches[linkedId].lit = !torches[linkedId].lit;
    });

    if (torches.every(t => t.lit)) {
        openDoor();
        showMessage("全ての燭台に火が灯った！扉が開いた！");
    }
}
```

#### パズル配置例
```
      🕯️(0)----🕯️(1)
        |   ✕   |
        |   ✕   |
      🕯️(2)----🕯️(3)

※ 線で繋がった燭台は連動する
※ 正解手順: 0→3 または 1→2
```

---

### パズル4: 記憶パズル（氷の神殿・2階）

#### 基本ルール
- 4つの氷の祭壇がある（北・東・南・西）
- 正しい順序で調べると扉が開く
- 順序のヒントは別の部屋にある
- 間違えると敵が出現してやり直し

#### ヒントの配置
```
【1階の書庫にある古文書】
「氷の封印を解く者よ、星の導きに従え。
 まず北極星を仰ぎ、次に東の暁を迎えよ。
 南の十字を経て、西の夕暮れに至れ。」

→ 正解: 北→東→南→西
```

#### 実装案
```javascript
const correctOrder = ['north', 'east', 'south', 'west'];
let playerOrder = [];

function touchAltar(direction) {
    playerOrder.push(direction);

    // 正解チェック
    for (let i = 0; i < playerOrder.length; i++) {
        if (playerOrder[i] !== correctOrder[i]) {
            // 間違い
            showMessage("祭壇が冷たく光り、魔物が現れた！");
            startBattle('iceElemental');
            playerOrder = [];
            return;
        }
    }

    if (playerOrder.length === correctOrder.length) {
        showMessage("祭壇が温かく輝き、封印が解けた！");
        openSealedDoor();
    }
}
```

---

## ボス設計

### 中ボス: 氷のゴーレム（氷の洞窟B2）

| パラメータ | 値 |
|------------|-----|
| ID | iceGolem |
| 名前 | こおりのゴーレム |
| HP | 800 |
| 攻撃力 | 75 |
| 防御力 | 60 |
| 速度 | 8 |
| レベル | 40 |
| 経験値 | 1500 |
| ゴールド | 900 |
| 属性耐性 | ice: 0（無効）, fire: 2.0（弱点）, lightning: 1.5 |
| 使用スキル | attack, iceBreath, strongAttack |

**戦闘前セリフ**:
```
「...侵入者か。」
「この先に進むことは許さぬ。」
「永久の眠りにつくがいい！」
```

---

### エリアボス: 氷の女王（氷の城3F）

| パラメータ | 値 |
|------------|-----|
| ID | iceQueen |
| 名前 | こおりのじょおう |
| HP | 1500 |
| 攻撃力 | 95 |
| 防御力 | 70 |
| 速度 | 20 |
| レベル | 48 |
| 経験値 | 3000 |
| ゴールド | 1500 |
| 属性耐性 | ice: 0（無効）, fire: 2.0（弱点）, light: 0.5 |
| 使用スキル | attack, blizzard, iceBreath, absoluteZero, heal |
| 行動回数 | 2 |

**戦闘前セリフ**:
```
「...あなたたちが、炎の心を持つ者...？」
「100年...ずっとこの氷の中で苦しんできた...」
「私を...止めて...お願い...」
「でも体が言うことを聞かない...！」
「来るな...来ないで...！」
```

**戦闘後セリフ**:
```
「...ありがとう...ようやく解放された...」
「太陽の炎が、私の中の闇を溶かしてくれた...」
「あなたたちに、この宝珠を託します...」
「『極光の宝珠』...これがあれば、海を渡れるでしょう...」
「どうか...世界を救って...」
```

---

## 新規モンスター

| ID | 名前 | Lv | HP | ATK | DEF | 属性耐性 |
|----|------|-----|-----|-----|-----|----------|
| snowSlime | ゆきスライム | 35 | 120 | 55 | 35 | ice:0, fire:2.0 |
| iceBat | アイスバット | 36 | 90 | 60 | 25 | ice:0.5, fire:1.5 |
| frozenKnight | こおりのきし | 38 | 180 | 75 | 55 | ice:0, fire:1.5, lightning:1.5 |
| snowWolf | スノーウルフ | 37 | 140 | 70 | 40 | ice:0.5, fire:1.5 |
| iceElemental | アイスエレメント | 40 | 160 | 65 | 45 | ice:0, fire:2.0, lightning:0.5 |
| frostGiant | フロストジャイアント | 42 | 250 | 90 | 60 | ice:0, fire:1.5 |
| crystalDragon | クリスタルドラゴン | 45 | 300 | 100 | 70 | ice:0, fire:1.5, light:0.5 |

---

## 新規アイテム・装備

### 消費アイテム
| 名前 | 効果 | 価格 |
|------|------|------|
| ほかほかスープ | 凍結状態を回復、一時的に凍結耐性 | 100G |
| たいまつ | 一部エリアで必要、暗所を照らす | 50G |

### 武器
| 名前 | ATK | 装備可能 | 入手方法 |
|------|-----|----------|----------|
| こおりのつるぎ | +55 | hero | 雪原の村（12000G） |
| ブリザードソード | +70 | hero | 氷の城・宝箱 |
| こおりの杖 | +45 | mage, seer | 雪原の村（10000G） |
| ダイヤモンドロッド | +60 | mage, seer | 氷の神殿・宝箱 |

### 防具
| 名前 | DEF | 装備可能 | 入手方法 |
|------|-----|----------|----------|
| ふゆごもりのふく | +45 | all | 雪原の村（8000G） |
| ブリザードメイル | +60 | hero | 氷の城・宝箱 |
| ゆきのローブ | +40 | mage, seer | 雪原の村（7000G） |

---

## NPC・イベント

### 雪原の村

| NPC | セリフ要約 |
|-----|-----------|
| 村長 | 「氷の城には近づくな。あそこには呪われた女王がいる」 |
| 老婆 | 「100年前、女王は自らを犠牲にして王国を守った」 |
| 旅人 | 「氷の洞窟を抜ければ、凍りついた湖に出るらしい」 |
| 武器屋 | 「この地では炎の魔法が重宝するぞ」 |
| 神官 | 「氷の神殿には『太陽の炎』が眠っている」 |

### 氷の神殿（太陽の炎入手イベント）

```
【3階・祭壇にて】
古代の祭壇に近づくと、温かな光が溢れ出す...

「勇者よ...ようやく来たか...」
「私は太陽の精霊...100年前にここに封じられた...」
「氷の女王を救うため、この炎を持っていくがいい...」
「ただし気をつけよ...女王の中には闇が巣食っている...」
「その闘を祓わねば、女王は救えぬ...」

→ 『太陽の炎』を手に入れた！
```

---

## クエストフラグ

| フラグ名 | 説明 | 設定タイミング |
|----------|------|----------------|
| area4Entered | エリア4に入った | 氷原に初めて入った時 |
| iceGolemDefeated | 氷のゴーレム撃破 | 中ボス戦勝利時 |
| sunFlameObtained | 太陽の炎入手 | 神殿3階イベント後 |
| iceQueenDefeated | 氷の女王撃破 | ボス戦勝利時 |
| area4Completed | エリア4クリア | 極光の宝珠入手時 |
| auroraOrbObtained | 極光の宝珠入手 | 女王救出後 |

---

## 実装優先度

### Phase 1（必須）
- [ ] 基本マップ作成（氷原、村、洞窟）
- [ ] 滑る床システム実装
- [ ] 新規モンスター追加
- [ ] 中ボス・エリアボス実装

### Phase 2（パズル）
- [ ] 圧力スイッチシステム
- [ ] 灯火パズル実装
- [ ] 記憶パズル実装

### Phase 3（演出）
- [ ] ストーリーイベント
- [ ] 女王救出演出
- [ ] エリア5への導線

---

## 更新履歴

- 2026-01-03: 初版作成（パズル要素を含むシナリオ案）
