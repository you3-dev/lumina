<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éâ„É©„ÇØ„Ç®È¢®RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -ms-touch-action: manipulation;
        }

        body {
            background: #000;
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', 'Yu Gothic', sans-serif;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #fadeOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.3s ease-in-out;
        }

        #fadeOverlay.active {
            opacity: 1;
        }

        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #mapNameArea {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 12px;
            border-radius: 4px;
            pointer-events: auto;
        }

        #mapName {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .map-pin-btn {
            font-size: 1.1rem;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .map-pin-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .map-pin-btn:active {
            transform: scale(0.95);
        }

        .map-pin-btn.hidden {
            display: none;
        }

        #dpad {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            pointer-events: auto;
        }

        .dpad-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: background 0.1s;
        }

        .dpad-btn:active, .dpad-btn.pressed {
            background: rgba(255, 255, 255, 0.4);
        }

        #dpad-up { top: 0; left: 50px; }
        #dpad-down { bottom: 0; left: 50px; }
        #dpad-left { top: 50px; left: 0; }
        #dpad-right { top: 50px; right: 0; }

        #dpad-center {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
        }

        #action-buttons {
            position: absolute;
            bottom: 30px;
            right: 20px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }

        .action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: background 0.1s;
        }

        .action-btn:active, .action-btn.pressed {
            background: rgba(255, 255, 255, 0.4);
        }

        #btn-b {
            margin-top: 30px;
        }

        /* „Çø„Ç§„Éà„É´ÁîªÈù¢ */
        #titleScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #0a0a2e 0%, #1a1a4e 50%, #2a2a6e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #titleScreen.hidden {
            display: none;
        }

        .title-content {
            text-align: center;
            color: #fff;
        }

        .game-title {
            font-size: 2.5rem;
            color: #ffd700;
            text-shadow:
                0 0 10px #ffd700,
                0 0 20px #ff8c00,
                3px 3px 0 #8b4513;
            margin-bottom: 10px;
            animation: titleGlow 2s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00, 3px 3px 0 #8b4513; }
            50% { text-shadow: 0 0 20px #ffd700, 0 0 40px #ff8c00, 3px 3px 0 #8b4513; }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #87ceeb;
            margin-bottom: 60px;
        }

        .title-menu {
            margin-bottom: 40px;
        }

        .menu-item {
            font-size: 1.4rem;
            padding: 15px 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .menu-item:hover {
            color: #ffd700;
            transform: scale(1.05);
        }

        .menu-item .cursor {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .menu-item.selected .cursor,
        .menu-item:hover .cursor {
            opacity: 1;
        }

        .menu-item.selected {
            color: #ffd700;
        }

        .press-start {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .title-menu.active ~ .press-start {
            display: none;
        }

        /* „ÉØ„Éº„É´„Éâ„Éû„ÉÉ„ÉóË°®Á§∫ */
        #worldMapOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        #worldMapOverlay.active {
            display: flex;
        }

        .map-frame {
            background: linear-gradient(135deg, #d4a574 0%, #c9956c 25%, #e6c9a8 50%, #c9956c 75%, #d4a574 100%);
            border: 8px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            box-shadow:
                inset 0 0 30px rgba(139, 69, 19, 0.3),
                0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            max-width: 90vw;
            max-height: 85vh;
        }

        .map-frame::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 2px solid rgba(139, 69, 19, 0.4);
            border-radius: 5px;
            pointer-events: none;
        }

        .map-title {
            text-align: center;
            font-size: 1.3rem;
            color: #4a2c0a;
            margin-bottom: 15px;
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.5);
            font-weight: bold;
        }

        #worldMapCanvas {
            display: block;
            border: 3px solid #5c3317;
            border-radius: 5px;
            background: #1a1a2e;
        }

        .map-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: #4a2c0a;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border: 1px solid #5c3317;
            border-radius: 2px;
        }

        .map-close-hint {
            text-align: center;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #6b4423;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="fadeOverlay"></div>

    <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
    <div id="titleScreen">
        <div class="title-content">
            <h1 class="game-title">„Éâ„É©„Ç¥„É≥„ÇØ„Ç®„Çπ„Éà</h1>
            <p class="subtitle">„Äú ÂãáËÄÖ„ÅÆÂÜíÈô∫ „Äú</p>
            <div class="title-menu">
                <div class="menu-item" id="menu-continue" style="display: none;">
                    <span class="cursor">‚ñ∂</span>
                    <span>„Å§„Å•„Åç„Åã„Çâ</span>
                </div>
                <div class="menu-item" id="menu-newgame">
                    <span class="cursor">‚ñ∂</span>
                    <span>„ÅØ„Åò„ÇÅ„Åã„Çâ</span>
                </div>
            </div>
            <p class="press-start" id="pressStart">Press ENTER or Tap to Start</p>
        </div>
    </div>

    <!-- „ÉØ„Éº„É´„Éâ„Éû„ÉÉ„Éó„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="worldMapOverlay">
        <div class="map-frame">
            <div class="map-title" id="worldMapTitle">„Éï„Ç£„Éº„É´„Éâ</div>
            <canvas id="worldMapCanvas"></canvas>
            <div class="map-legend">
                <div class="legend-item"><div class="legend-color" style="background: #44aa44;"></div>ËçâÂéü</div>
                <div class="legend-item"><div class="legend-color" style="background: #886644;"></div>Â±±</div>
                <div class="legend-item"><div class="legend-color" style="background: #2244aa;"></div>Êµ∑</div>
                <div class="legend-item"><div class="legend-color" style="background: #116611;"></div>Ê£Æ</div>
                <div class="legend-item"><div class="legend-color" style="background: #ffffff;"></div>Âª∫Áâ©</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff3333;"></div>ÁèæÂú®Âú∞</div>
            </div>
            <div class="map-close-hint">M„Ç≠„Éº „Åæ„Åü„ÅØ „Çø„ÉÉ„Éó„ÅßÈñâ„Åò„Çã</div>
        </div>
    </div>

    <div id="hud">
        <div id="mapNameArea">
            <span id="mapName">„Éï„Ç£„Éº„É´„Éâ</span>
            <span id="floorDisplay" style="color: #aaddff; margin-left: 8px;"></span>
            <span id="mapPinBtn" class="map-pin-btn">üìç</span>
        </div>

        <!-- „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫ÔºàÈñãÁô∫Áî®„ÄÅ„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„ÅßÈùûË°®Á§∫Ôºâ
        <div id="encounterDebug" style="position: fixed; top: 40px; right: 10px; background: rgba(0,0,0,0.7); color: #0f0; padding: 5px 10px; font-size: 12px; font-family: monospace; border-radius: 4px; z-index: 1000;"></div>
        -->

        <div id="dpad">
            <div class="dpad-btn" id="dpad-up">‚ñ≤</div>
            <div class="dpad-btn" id="dpad-left">‚óÄ</div>
            <div id="dpad-center"></div>
            <div class="dpad-btn" id="dpad-right">‚ñ∂</div>
            <div class="dpad-btn" id="dpad-down">‚ñº</div>
        </div>

        <div id="action-buttons">
            <div class="action-btn" id="btn-b">B</div>
            <div class="action-btn" id="btn-a">A</div>
        </div>
    </div>

    <script>
        // ========================================
        // „Ç≤„Éº„É†Ë®≠ÂÆö
        // ========================================
        const VISIBLE_TILES = 10;
        const SAVE_KEY = 'dragonquest_rpg_save';

        // „Ç≤„Éº„É†„É¢„Éº„Éâ
        const MODE = {
            TITLE: 'title',
            FIELD: 'field',
            BATTLE: 'battle',
            MENU: 'menu',
            INN: 'inn',
            SHOP: 'shop',
            DIALOG: 'dialog',
            ENDING: 'ending',
            MAP_VIEW: 'map_view'
        };

        let gameMode = MODE.TITLE;
        let titleMenuIndex = 0;
        let titleMenuActive = false;
        let hasSaveData = false;

        // „Çø„Ç§„É´„Çø„Ç§„Éó
        const TILE = {
            GRASS: 0,
            MOUNTAIN: 1,
            SEA: 2,
            CASTLE: 3,
            TOWN: 4,
            STAIRS: 5,
            FLOOR: 6,
            WALL: 7,
            PORTAL: 8,       // ÊóÖ„ÅÆÊââ
            STAIRS_UP: 9,    // ‰∏ä„ÇäÈöéÊÆµ
            STAIRS_DOWN: 10, // ‰∏ã„ÇäÈöéÊÆµ
            // Á†ÇÊº†„Çø„Ç§„É´
            SAND: 11,        // Á†ÇÊº†
            OASIS: 12,       // „Ç™„Ç¢„Ç∑„Çπ
            PYRAMID: 13,     // „Éî„É©„Éü„ÉÉ„ÉâÂÖ•Âè£
            QUICKSAND: 14,   // ÊµÅÁ†ÇÔºà„ÉØ„Éº„ÉóÁî®Ôºâ
            HIDDEN_WALL: 15  // Èö†„ÅóÂ£ÅÔºàË™ø„Åπ„Çã„Å®ÈÄöË∑Ø„Å´„Å™„ÇãÔºâ
        };

        // „Éû„ÉÉ„Éó„Çø„Ç§„ÉóÂà•„ÅÆ„Çø„Ç§„É´Ëâ≤
        const MAP_TILE_COLORS = {
            field: {
                [TILE.GRASS]: '#2d5a27',
                [TILE.MOUNTAIN]: '#6b4423',
                [TILE.SEA]: '#1a4a7a',
                [TILE.CASTLE]: '#2d5a27',
                [TILE.TOWN]: '#2d5a27',
                [TILE.STAIRS]: '#4a4a4a',
                [TILE.FLOOR]: '#8b7355',
                [TILE.WALL]: '#4a4a5a'
            },
            castle: {
                [TILE.FLOOR]: '#5a5a6a',
                [TILE.WALL]: '#3a3a4a',
                [TILE.STAIRS]: '#4a4a4a'
            },
            town: {
                [TILE.FLOOR]: '#a0a0a0',
                [TILE.WALL]: '#6a6a7a',
                [TILE.STAIRS]: '#4a4a4a'
            },
            dungeon: {
                [TILE.FLOOR]: '#4a4a3a',
                [TILE.WALL]: '#2a2a2a',
                [TILE.STAIRS]: '#5a5a4a'
            }
        };

        const DEFAULT_TILE_COLORS = {
            [TILE.GRASS]: '#2d5a27',
            [TILE.MOUNTAIN]: '#6b4423',
            [TILE.SEA]: '#1a4a7a',
            [TILE.CASTLE]: '#2d5a27',
            [TILE.TOWN]: '#2d5a27',
            [TILE.STAIRS]: '#4a4a4a',
            [TILE.FLOOR]: '#8b7355',
            [TILE.WALL]: '#4a4a5a',
            [TILE.PORTAL]: '#6a2a8a',      // ÊóÖ„ÅÆÊââÔºàÁ¥´Ôºâ
            [TILE.STAIRS_UP]: '#5a5a4a',   // ‰∏ä„ÇäÈöéÊÆµ
            [TILE.STAIRS_DOWN]: '#4a4a3a', // ‰∏ã„ÇäÈöéÊÆµ
            // Á†ÇÊº†„Çø„Ç§„É´
            [TILE.SAND]: '#d4a559',        // Á†ÇÊº†ÔºàÈªÑÂúüËâ≤Ôºâ
            [TILE.OASIS]: '#2d8a57',       // „Ç™„Ç¢„Ç∑„ÇπÔºàÁ∑ëÔºâ
            [TILE.PYRAMID]: '#c4a040',     // „Éî„É©„Éü„ÉÉ„ÉâÔºàÈáëËâ≤Ôºâ
            [TILE.QUICKSAND]: '#b89050',   // ÊµÅÁ†ÇÔºàÊöó„ÅÑÁ†ÇËâ≤Ôºâ
            [TILE.HIDDEN_WALL]: '#2a2a2a'  // Èö†„ÅóÂ£ÅÔºàÂ£Å„Å®Âêå„ÅòËâ≤Ôºâ
        };

        const WALKABLE_TILES = [TILE.GRASS, TILE.CASTLE, TILE.TOWN, TILE.STAIRS, TILE.FLOOR, TILE.PORTAL, TILE.STAIRS_UP, TILE.STAIRS_DOWN, TILE.SAND, TILE.OASIS, TILE.PYRAMID, TILE.QUICKSAND];
        const ENCOUNTER_TILES = [TILE.GRASS, TILE.FLOOR, TILE.SAND]; // „Ç®„É≥„Ç´„Ç¶„É≥„Éà„ÅåÁô∫Áîü„Åô„Çã„Çø„Ç§„É´ÔºàËçâÂéü„ÄÅ„ÉÄ„É≥„Ç∏„Éß„É≥Â∫ä„ÄÅÁ†ÇÊº†Ôºâ

        // ========================================
        // „Ç¢„Ç§„ÉÜ„É†„Éá„Éº„Çø
        // ========================================
        const items = {
            // Ê∂àË≤ª„Ç¢„Ç§„ÉÜ„É†
            1: { id: 1, name: 'Ëñ¨Ëçâ', description: 'HP„Çí30ÂõûÂæ©„Åô„Çã', type: 'heal', value: 30, price: 8 },
            2: { id: 2, name: 'ÊØíÊ∂à„ÅóËçâ', description: 'ÊØí„ÇíÊ≤ªÁôÇ„Åô„Çã', type: 'cure', price: 10 },
            3: { id: 3, name: 'ËÅñÊ∞¥', description: 'Âº±„ÅÑÊïµ„ÇíÈÄÄ„Åë„Çã', type: 'holy', price: 20 },
            8: { id: 8, name: 'È≠îÊ≥ï„ÅÆÈçµ', description: 'Êââ„ÇíÈñã„Åë„Çã„Åì„Å®„Åå„Åß„Åç„Çã', type: 'key', price: 0 },
            // Ê≠¶Âô® (equippable: Ë£ÖÂÇôÂèØËÉΩ„Å™„Ç∏„Éß„Éñ„É™„Çπ„Éà)
            10: { id: 10, name: '„Åì„Çì„Åº„ÅÜ', type: 'weapon', value: 2, price: 10, equippable: ['hero'] },
            11: { id: 11, name: '„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 10, price: 100, equippable: ['hero'] },
            12: { id: 12, name: '„Å¶„Å§„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 20, price: 300, equippable: ['hero'] },
            13: { id: 13, name: '„ÅØ„Åå„Å≠„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 35, price: 700, equippable: ['hero'] },
            14: { id: 14, name: '„Åª„ÅÆ„Åä„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 40, price: 0, equippable: ['hero'] },
            // Èò≤ÂÖ∑
            20: { id: 20, name: '„Åü„Å≥„Å≥„Å®„ÅÆ„Åµ„Åè', type: 'armor', value: 1, price: 10, equippable: ['hero'] },
            21: { id: 21, name: '„Åã„Çè„ÅÆ„Çà„Çç„ÅÑ', type: 'armor', value: 5, price: 80, equippable: ['hero'] },
            22: { id: 22, name: '„Åè„Åï„Çä„Åã„Åü„Å≥„Çâ', type: 'armor', value: 12, price: 250, equippable: ['hero'] },
            23: { id: 23, name: '„Å¶„Å§„ÅÆ„Çà„Çç„ÅÑ', type: 'armor', value: 22, price: 600, equippable: ['hero'] },
            24: { id: 24, name: '„Åæ„Åª„ÅÜ„ÅÆ„Çà„Çç„ÅÑ', type: 'armor', value: 35, price: 1200, equippable: ['hero'] },
            // „Ç®„É™„Ç¢2 Ê≠¶Âô®„ÉªÈò≤ÂÖ∑
            15: { id: 15, name: '„Åï„Å∞„Åè„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 45, price: 1500, equippable: ['hero'] },
            16: { id: 16, name: '„Éï„Ç°„É©„Ç™„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 55, price: 3000, equippable: ['hero'] },
            17: { id: 17, name: '„Åä„ÅÜ„Åî„Çì„ÅÆ„Å§„ÇÅ', type: 'weapon', value: 65, price: 0, equippable: ['hero'] }, // Èö†„ÅóÈÄöË∑Ø„ÅÆÂÆùÁÆ±
            25: { id: 25, name: '„Åï„Å∞„Åè„ÅÆ„Çà„Çç„ÅÑ', type: 'armor', value: 40, price: 1800, equippable: ['hero'] },
            26: { id: 26, name: '„Éï„Ç°„É©„Ç™„ÅÆ„Çà„Çç„ÅÑ', type: 'armor', value: 50, price: 3500, equippable: ['hero'] },
            // „ÇØ„Ç®„Çπ„Éà„Ç¢„Ç§„ÉÜ„É†Ôºà„Ç®„É™„Ç¢2Ôºâ
            30: { id: 30, name: 'Ê∏Ö„Çâ„Åã„Å™Ê∞¥', description: '„Ç™„Ç¢„Ç∑„Çπ„ÅÆÊùë„ÇíÊïë„ÅÜËÅñ„Å™„ÇãÊ∞¥', type: 'quest', price: 0 },
            31: { id: 31, name: 'ÁéãÂÆ∂„ÅÆÁ¥ãÁ´†', description: 'Â§™ÈôΩ„ÅÆÂüéÂ°û„Å∏„ÅÆÂÖ•ÂüéË®±ÂèØË®º', type: 'quest', price: 0 },
            32: { id: 32, name: 'ÈÄöË°åÊâãÂΩ¢', description: '„Éê„Ç∂„Éº„É´„ÅÆÁî∫„Å∏„ÅÆÈÄöË°åË®±ÂèØË®º', type: 'quest', price: 0 },
            33: { id: 33, name: 'Â§™ÈôΩ„ÅÆË≠∑Á¨¶', description: 'Á†ÇÊº†„ÅÆÂÆàË≠∑ËÄÖ„ÅÆÂäõ„ÇíÂ∞Å„Åò„ÅüË≠∑Á¨¶', type: 'quest', price: 0 },
            // ÂõûÂæ©„Ç¢„Ç§„ÉÜ„É†Ôºà‰∏ä‰ΩçÔºâ
            4: { id: 4, name: '‰∏äËñ¨Ëçâ', description: 'HP„Çí100ÂõûÂæ©„Åô„Çã', type: 'heal', value: 100, price: 50 },
            5: { id: 5, name: '‰∏ñÁïåÊ®π„ÅÆËëâ', description: 'Êà¶Èóò‰∏çËÉΩ„ÇíÂõûÂæ©„Åô„Çã', type: 'revive', price: 500 },
            9: { id: 9, name: '„Ç≠„É°„É©„ÅÆ„Å§„Å∞„Åï', description: 'ÊúÄÂæå„Å´Ë®™„Çå„ÅüÁî∫„Å´Êàª„Çã', type: 'escape', price: 25 }
        };

        // „Ç∑„Éß„ÉÉ„ÉóÂïÜÂìÅ„É™„Çπ„ÉàÔºà„Ç®„É™„Ç¢Âà•ÂØæÂøúÔºâ
        const shopItemsByArea = {
            default: [11, 12, 13, 21, 22, 23], // „Å©„ÅÜ„ÅÆ„Å§„Çã„Åé„Äú„Å¶„Å§„ÅÆ„Çà„Çç„ÅÑ
            area2_shop: [12, 13, 14, 22, 23, 24, 1, 2, 3], // „Çà„ÇäÂº∑„ÅÑË£ÖÂÇô + ÂõûÂæ©„Ç¢„Ç§„ÉÜ„É†
            // Á†ÇÊº†„Ç®„É™„Ç¢„ÅÆ„Ç∑„Éß„ÉÉ„Éó
            oasis_shop: [1, 2, 4, 9, 12, 13, 22, 23], // „Ç™„Ç¢„Ç∑„Çπ„ÅÆÊùëÔºöÂü∫Êú¨Ë£ÖÂÇô„Å®ÂõûÂæ©
            bazaar_shop: [1, 2, 4, 5, 9, 13, 15, 23, 25], // „Éê„Ç∂„Éº„É´„ÅÆÁî∫Ôºö‰∏≠Á¥öË£ÖÂÇô
            hidden_shop: [4, 5, 15, 16, 25, 26] // Èö†„ÇåÈáåÔºöÈ´òÁ¥öË£ÖÂÇô
        };
        let currentShopId = 'default';
        const shopItems = shopItemsByArea.default; // ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÁ∂≠ÊåÅ

        // ÁèæÂú®„ÅÆ„Ç∑„Éß„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„ÇíÂèñÂæó
        function getShopItems() {
            return shopItemsByArea[currentShopId] || shopItemsByArea.default;
        }

        // ========================================
        // „Ç§„É≥„Éô„É≥„Éà„É™ÁÆ°ÁêÜ„Éò„É´„Éë„ÉºÈñ¢Êï∞
        // ========================================
        const MAX_STACK_SIZE = 99;

        // „Çπ„Çø„ÉÉ„ÇØÂèØËÉΩ„Åã„Å©„ÅÜ„ÅãÂà§ÂÆöÔºàË£ÖÂÇôÂìÅ‰ª•Â§ñ„ÅØ„Çπ„Çø„ÉÉ„ÇØÂèØËÉΩÔºâ
        function isStackable(itemId) {
            const item = items[itemId];
            if (!item) return false;
            return item.type !== 'weapon' && item.type !== 'armor';
        }

        // „Ç¢„Ç§„ÉÜ„É†„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Å´ËøΩÂä†
        function addItem(itemId, quantity = 1) {
            const item = items[itemId];
            if (!item) return false;

            if (isStackable(itemId)) {
                const existing = player.inventory.find(slot => slot.id === itemId);
                if (existing) {
                    existing.quantity = Math.min(existing.quantity + quantity, MAX_STACK_SIZE);
                } else {
                    player.inventory.push({ id: itemId, quantity: quantity });
                }
            } else {
                // Ë£ÖÂÇôÂìÅ„ÅØ1„Å§„Åö„Å§ËøΩÂä†
                for (let i = 0; i < quantity; i++) {
                    player.inventory.push({ id: itemId, quantity: 1 });
                }
            }
            return true;
        }

        // „Ç¢„Ç§„ÉÜ„É†„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
        function removeItem(itemId, quantity = 1) {
            const index = player.inventory.findIndex(slot => slot.id === itemId);
            if (index === -1) return false;

            const slot = player.inventory[index];
            slot.quantity -= quantity;

            if (slot.quantity <= 0) {
                player.inventory.splice(index, 1);
            }
            return true;
        }

        // „Ç¢„Ç§„ÉÜ„É†„ÅÆÊâÄÊåÅÊï∞„ÇíÂèñÂæó
        function getItemCount(itemId) {
            const slot = player.inventory.find(slot => slot.id === itemId);
            return slot ? slot.quantity : 0;
        }

        // „Ç¢„Ç§„ÉÜ„É†„ÇíÊåÅ„Å£„Å¶„ÅÑ„Çã„ÅãÂà§ÂÆö
        function hasItem(itemId, quantity = 1) {
            return getItemCount(itemId) >= quantity;
        }

        // ========================================
        // „É¢„É≥„Çπ„Çø„Éº„Éá„Éº„Çø
        // ========================================
        const monsters = {
            // ===== Â∫èÁõ§„ÅÆÊïµÔºà„Éï„Ç£„Éº„É´„Éâ„ÉªÊ£Æ Lv1~3ÊÉ≥ÂÆöÔºâ=====
            slime: {
                name: '„Çπ„É©„Ç§„É†',
                sprite: 'üü¢',
                level: 1,
                hp: 8,
                atk: 5,
                def: 2,
                speed: 3,
                exp: 2,
                gold: 2,
                resistances: { sleep: 1.0, blind: 1.0, poison: 1.0 }
            },
            dracky: {
                name: '„Éâ„É©„Ç≠„Éº',
                sprite: 'ü¶á',
                level: 2,
                hp: 10,
                atk: 7,
                def: 3,
                speed: 6,
                exp: 3,
                gold: 3,
                resistances: { sleep: 0.8, blind: 0.6, poison: 1.0 }
            },
            bat: {
                name: '„Åä„Åä„Åì„ÅÜ„ÇÇ„Çä',
                sprite: 'ü¶á',
                hueRotate: 180, // Ëâ≤ÈÅï„ÅÑÔºàÈùíÁ≥ªÔºâ
                level: 3,
                hp: 14,
                atk: 9,
                def: 4,
                speed: 8,
                exp: 5,
                gold: 5,
                resistances: { sleep: 0.8, blind: 0.5, poison: 1.0 }
            },
            // ===== ‰∏≠Áõ§„ÅÆÊïµÔºàÊ¥ûÁ™üB1„ÉªÊ£Æ„ÅÆÂ•• Lv4~6ÊÉ≥ÂÆöÔºâ=====
            ghost: {
                name: '„Ç¥„Éº„Çπ„Éà',
                sprite: 'üëª',
                level: 4,
                hp: 18,
                atk: 12,
                def: 5,
                speed: 5,
                exp: 10,
                gold: 8,
                resistances: { sleep: 0.3, blind: 1.0, poison: 0 }
            },
            scorpion: {
                name: '„Åä„Åä„Åï„Åù„Çä',
                sprite: 'ü¶Ç',
                level: 5,
                hp: 22,
                atk: 14,
                def: 8,
                speed: 7,
                exp: 15,
                gold: 12,
                resistances: { sleep: 0.7, blind: 0.8, poison: 0 } // ÊØíÁÑ°Âäπ
            },
            // ===== ÂæåÂçä„ÅÆÊïµÔºàÊ¥ûÁ™üÊ∑±ÈÉ® Lv7~9ÊÉ≥ÂÆöÔºâ=====
            skeleton: {
                name: '„Åå„ÅÑ„Åì„Å§',
                sprite: 'üíÄ',
                level: 6,
                hp: 28,
                atk: 18,
                def: 10,
                speed: 4,
                exp: 25,
                gold: 20,
                resistances: { sleep: 0, blind: 0.8, poison: 0 }
            },
            armoredKnight: {
                name: '„Åï„Åæ„Çà„ÅÜ„Çà„Çç„ÅÑ',
                sprite: 'üõ°Ô∏è',
                level: 7,
                hp: 40,
                atk: 22,
                def: 18,
                speed: 3,
                exp: 35,
                gold: 30,
                resistances: { sleep: 0.2, blind: 0.5, poison: 0 }
            },
            deathKnight: {
                name: '„Åó„Çä„Çá„ÅÜ„ÅÆ„Åç„Åó',
                sprite: 'üõ°Ô∏è',
                hueRotate: 270, // Ëâ≤ÈÅï„ÅÑÔºàÁ¥´Á≥ªÔºâ
                level: 8,
                hp: 55,
                atk: 28,
                def: 22,
                speed: 5,
                exp: 50,
                gold: 45,
                resistances: { sleep: 0, blind: 0.3, poison: 0 }
            },
            // ===== ‰∏≠„Éú„ÇπÁ¥ö =====
            midBoss: {
                name: 'Ê¥ûÁ™ü„ÅÆÁï™‰∫∫',
                sprite: 'üóø',
                level: 9,
                hp: 100,
                atk: 35,
                def: 18,
                speed: 6,
                exp: 80,
                gold: 100,
                isBoss: true,
                resistances: { sleep: 0.1, blind: 0.2, poison: 0.3 }
            },
            // ========================================
            // „Ç®„É™„Ç¢2: Â§™ÈôΩ„Å®Á†Ç„ÅÆÁéãÂõΩÔºàLv10~25ÊÉ≥ÂÆöÔºâ
            // ========================================
            // ===== Á†ÇÊº†„Éï„Ç£„Éº„É´„ÉâÔºàLv10~13Ôºâ=====
            sandSlime: {
                name: '„Çµ„É≥„Éâ„Çπ„É©„Ç§„É†',
                sprite: 'üü°',
                level: 10,
                hp: 35,
                atk: 22,
                def: 12,
                speed: 5,
                exp: 30,
                gold: 25,
                resistances: { sleep: 1.0, blind: 1.0, poison: 0.5 }
            },
            desertScorpion: {
                name: '„Çµ„É≥„Éâ„Çπ„Ç≥„Éº„Éî„Ç™„É≥',
                sprite: 'ü¶Ç',
                hueRotate: 30,
                level: 11,
                hp: 45,
                atk: 28,
                def: 18,
                speed: 9,
                exp: 40,
                gold: 35,
                canPoison: true,
                resistances: { sleep: 0.5, blind: 0.7, poison: 0 }
            },
            cactusMan: {
                name: '„Çµ„Éú„ÉÜ„É≥„Éû„É≥',
                sprite: 'üåµ',
                level: 11,
                hp: 40,
                atk: 25,
                def: 15,
                speed: 4,
                exp: 35,
                gold: 30,
                resistances: { sleep: 0.8, blind: 0.6, poison: 0 }
            },
            desertVulture: {
                name: '„Éá„Ç∂„Éº„Éà„Éê„É´„ÉÅ„É£„Éº',
                sprite: 'ü¶Ö',
                level: 12,
                hp: 38,
                atk: 30,
                def: 10,
                speed: 14,
                exp: 45,
                gold: 40,
                resistances: { sleep: 0.6, blind: 0.4, poison: 1.0 }
            },
            // ===== Á†ÇÊº†‰∏≠Áõ§ÔºàLv13~16Ôºâ=====
            desertMummy: {
                name: '„Éá„Ç∂„Éº„Éà„Éü„Ç§„É©',
                sprite: 'üßü',
                level: 13,
                hp: 55,
                atk: 32,
                def: 20,
                speed: 4,
                exp: 55,
                gold: 50,
                weakToFire: true,
                resistances: { sleep: 0.2, blind: 0.8, poison: 0 }
            },
            sandDevil: {
                name: '„Åô„Å™„Åò„Åî„Åè',
                sprite: 'üåÄ',
                hueRotate: 40,
                level: 14,
                hp: 50,
                atk: 35,
                def: 16,
                speed: 8,
                exp: 60,
                gold: 55,
                resistances: { sleep: 0.3, blind: 0.5, poison: 0.5 }
            },
            pyramidGuard: {
                name: '„Éî„É©„Éü„ÉÉ„Éâ„Ç¨„Éº„Éâ',
                sprite: 'üóø',
                hueRotate: 180,
                level: 15,
                hp: 70,
                atk: 38,
                def: 28,
                speed: 5,
                exp: 75,
                gold: 70,
                resistances: { sleep: 0, blind: 0.5, poison: 0 }
            },
            cursedPharaoh: {
                name: '„ÅÆ„Çç„ÅÑ„ÅÆ„Éï„Ç°„É©„Ç™',
                sprite: 'üëë',
                hueRotate: 270,
                level: 15,
                hp: 65,
                atk: 35,
                def: 22,
                speed: 7,
                exp: 70,
                gold: 65,
                resistances: { sleep: 0, blind: 0.3, poison: 0 }
            },
            // ===== „ÉÄ„É≥„Ç∏„Éß„É≥Ê∑±ÈÉ®ÔºàLv16~19Ôºâ=====
            desertGolem: {
                name: '„Éá„Ç∂„Éº„Éà„Ç¥„Éº„É¨„É†',
                sprite: 'ü™®',
                level: 16,
                hp: 90,
                atk: 42,
                def: 35,
                speed: 3,
                exp: 90,
                gold: 85,
                resistances: { sleep: 0, blind: 0, poison: 0 }
            },
            sandWorm: {
                name: '„Çµ„É≥„Éâ„ÉØ„Éº„É†',
                sprite: 'üêõ',
                hueRotate: 40,
                level: 17,
                hp: 85,
                atk: 45,
                def: 25,
                speed: 6,
                exp: 100,
                gold: 95,
                resistances: { sleep: 0.4, blind: 0.6, poison: 0.3 }
            },
            banditLeader: {
                name: '„Å®„ÅÜ„Åû„Åè„ÅÆ„Åã„Åó„Çâ',
                sprite: 'ü•∑',
                level: 17,
                hp: 75,
                atk: 48,
                def: 22,
                speed: 12,
                exp: 95,
                gold: 150,
                resistances: { sleep: 0.5, blind: 0.4, poison: 0.8 }
            },
            ancientSoldier: {
                name: '„ÅÑ„Å´„Åó„Åà„ÅÆ„Å∏„ÅÑ„Åó',
                sprite: '‚öîÔ∏è',
                level: 18,
                hp: 80,
                atk: 50,
                def: 30,
                speed: 7,
                exp: 110,
                gold: 100,
                resistances: { sleep: 0, blind: 0.5, poison: 0 }
            },
            // ===== È´ò„É¨„Éô„É´ÔºàLv19~22Ôºâ=====
            sphinxMinor: {
                name: '„Çπ„Éï„Ç£„É≥„ÇØ„Çπ',
                sprite: 'ü¶Å',
                level: 19,
                hp: 100,
                atk: 52,
                def: 32,
                speed: 10,
                exp: 130,
                gold: 120,
                resistances: { sleep: 0.2, blind: 0.3, poison: 0.5 }
            },
            djinn: {
                name: '„É©„É≥„Éó„ÅÆ„Åæ„Åò„Çì',
                sprite: 'üßû',
                level: 20,
                hp: 95,
                atk: 55,
                def: 28,
                speed: 11,
                exp: 140,
                gold: 130,
                resistances: { sleep: 0.1, blind: 0.2, poison: 0.3 }
            },
            mummyKing: {
                name: '„Éü„Ç§„É©„Åä„Å®„Åì',
                sprite: 'üßü',
                hueRotate: 180,
                level: 21,
                hp: 110,
                atk: 58,
                def: 35,
                speed: 5,
                exp: 160,
                gold: 150,
                weakToFire: true,
                resistances: { sleep: 0, blind: 0.5, poison: 0 }
            },
            // ===== „Ç®„É™„Ç¢2 „Éú„ÇπÁ¥ö =====
            quicksandBoss: {
                name: 'ÊµÅÁ†Ç„ÅÆ‰∏ª',
                sprite: 'üåä',
                hueRotate: 40,
                level: 18,
                hp: 180,
                atk: 45,
                def: 30,
                speed: 8,
                exp: 200,
                gold: 300,
                isBoss: true,
                resistances: { sleep: 0, blind: 0.2, poison: 0 }
            },
            banditKing: {
                name: 'ÁõóË≥äÁéã',
                sprite: 'üë§',
                level: 19,
                hp: 200,
                atk: 52,
                def: 28,
                speed: 14,
                exp: 250,
                gold: 500,
                isBoss: true,
                resistances: { sleep: 0.1, blind: 0.3, poison: 0.5 }
            },
            pyramidGuardian: {
                name: '„Éî„É©„Éü„ÉÉ„Éâ„ÅÆÂÆàË≠∑ËÄÖ',
                sprite: 'ü¶Ö',
                hueRotate: 300,
                level: 22,
                hp: 280,
                atk: 60,
                def: 40,
                speed: 10,
                exp: 400,
                gold: 400,
                isBoss: true,
                resistances: { sleep: 0, blind: 0.1, poison: 0 }
            },
            desertGuardian: {
                name: 'Á†ÇÊº†„ÅÆÂÆàË≠∑ËÄÖ',
                sprite: 'üóø',
                hueRotate: 45,
                level: 25,
                hp: 400,
                atk: 70,
                def: 50,
                speed: 12,
                exp: 600,
                gold: 800,
                isBoss: true,
                actions: 2,
                resistances: { sleep: 0, blind: 0, poison: 0 }
            },
            // ===== „Éú„ÇπÁ¥ö =====
            dragon: {
                name: '„Éâ„É©„Ç¥„É≥',
                sprite: 'üêâ',
                level: 10,
                hp: 80,
                atk: 35,
                def: 20,
                speed: 10,
                exp: 100,
                gold: 150,
                resistances: { sleep: 0.1, blind: 0.3, poison: 0.5 }
            },
            maou: {
                name: 'È≠îÁéã',
                sprite: 'üëø',
                hp: 200,
                mp: 100,
                atk: 50,
                def: 30,
                speed: 15,
                exp: 500,
                gold: 0,
                isBoss: true,
                actions: 2, // 2ÂõûË°åÂãï
                resistances: { sleep: 0, blind: 0, poison: 0 }, // ÂÆåÂÖ®ËÄêÊÄß
                // È≠îÁéãÂ∞ÇÁî®„Çπ„Ç≠„É´
                skills: ['attack', 'hageshiiHonoo', 'behoma', 'ionazun']
            }
        };

        // È≠îÁéãÂ∞ÇÁî®„Çπ„Ç≠„É´
        const bossSkills = {
            hageshiiHonoo: { name: '„ÅØ„Åí„Åó„ÅÑ„Åª„ÅÆ„Åä', type: 'attack', power: 40, flashColor: 'rgba(255, 50, 0, 0.7)' },
            behoma: { name: '„Éô„Éõ„Éû', type: 'heal', power: 9999, flashColor: 'rgba(0, 255, 100, 0.5)' },
            ionazun: { name: '„Ç§„Ç™„Éä„Ç∫„É≥', type: 'attack', power: 55, flashColor: 'rgba(255, 255, 0, 0.7)' }
        };

        // „Ç®„É™„Ç¢Âà•„Ç®„É≥„Ç´„Ç¶„É≥„Éà„ÉÜ„Éº„Éñ„É´ÔºàmapId„Éô„Éº„ÇπÔºâ
        // Âêå„Åò„É¢„É≥„Çπ„Çø„Éº„ÇíË§áÊï∞ÂõûÂÖ•„Çå„Çã„Å®Âá∫ÁèæÁéá„Åå‰∏ä„Åå„Çã
        const encounterTables = {
            // „Ç®„É™„Ç¢1: ÊúÄÂàù„ÅÆÂ§ßÈô∏
            // „Éï„Ç£„Éº„É´„ÉâÔºàLv1~3Ôºâ- ÂàùÂøÉËÄÖÂêë„Åë
            field: ['slime', 'slime', 'slime', 'dracky', 'dracky', 'bat'],
            // Ê∑±„ÅÑÊ£ÆÔºàLv3~5Ôºâ- „ÇÑ„ÇÑÂº∑„ÇÅ
            forest: ['dracky', 'bat', 'bat', 'ghost', 'scorpion'],
            // ÊöóÈªí„ÅÆÊ¥ûÁ™üÔºàLv5~8Ôºâ- ‰∏≠Áõ§„ÄúÂæåÂçä
            dungeon: ['ghost', 'scorpion', 'skeleton', 'skeleton', 'armoredKnight', 'deathKnight'],

            // „Ç®„É™„Ç¢2: Â§™ÈôΩ„Å®Á†Ç„ÅÆÁéãÂõΩÔºàLv10~25Ôºâ
            // Á†ÇÊº†„Éï„Ç£„Éº„É´„ÉâÔºàLv10~14Ôºâ
            desert_field: ['sandSlime', 'sandSlime', 'desertScorpion', 'cactusMan', 'desertVulture', 'desertMummy'],
            // Á†ÇÊº†„Éï„Ç£„Éº„É´„ÉâÂ••Âú∞ÔºàLv13~17Ôºâ
            desert_deep: ['desertMummy', 'sandDevil', 'sandDevil', 'pyramidGuard', 'cursedPharaoh', 'desertGolem'],
            // ÊµÅÁ†Ç„ÅÆÊ¥ûÁ™üÔºàLv14~18Ôºâ
            quicksand_cave: ['sandDevil', 'sandDevil', 'sandWorm', 'sandWorm', 'desertGolem'],
            // ÁõóË≥ä„ÅÆ„Ç¢„Ç∏„ÉàÔºàLv15~18Ôºâ
            bandit_hideout: ['banditLeader', 'banditLeader', 'banditLeader', 'desertScorpion', 'cactusMan'],
            // „Éî„É©„Éü„ÉÉ„ÉâÔºàLv16~22Ôºâ
            pyramid: ['pyramidGuard', 'cursedPharaoh', 'desertMummy', 'ancientSoldier', 'mummyKing'],
            pyramid_deep: ['ancientSoldier', 'mummyKing', 'sphinxMinor', 'djinn'],
            // Á†ÇÊº†„ÅÆÂüéÔºàLv20~25Ôºâ
            desert_castle: ['sphinxMinor', 'djinn', 'mummyKing', 'ancientSoldier'],
            // Êóß„Ç®„É™„Ç¢2‰∫íÊèõ
            area2_field: ['sandSlime', 'sandSlime', 'desertScorpion', 'cactusMan', 'desertVulture', 'desertMummy'],
            area2_dungeon: ['pyramidGuard', 'cursedPharaoh', 'desertGolem', 'sandWorm']
        };

        // ÊóßtypeÂêç„Å®„ÅÆ‰∫íÊèõÁî®„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        const encounterTableFallback = {
            field: 'field',
            dungeon: 'dungeon'
        };

        // ========================================
        // Âë™Êñá„Éá„Éº„Çø
        // ========================================
        const spells = {
            // ÂõûÂæ©Âë™Êñá
            hoimi: { id: 'hoimi', name: '„Éõ„Ç§„Éü', mp: 3, type: 'heal', power: 30, learnLevel: 2, element: 'heal', flashColor: 'rgba(0, 255, 100, 0.5)' },
            behoimi: { id: 'behoimi', name: '„Éô„Éõ„Ç§„Éü', mp: 6, type: 'heal', power: 80, learnLevel: 12, element: 'heal', flashColor: 'rgba(0, 255, 100, 0.6)' },
            behoma: { id: 'behoma', name: '„Éô„Éõ„Éû', mp: 12, type: 'heal', power: 999, learnLevel: 32, element: 'heal', flashColor: 'rgba(0, 255, 100, 0.8)' },
            behomazun: { id: 'behomazun', name: '„Éô„Éõ„Éû„Ç∫„É≥', mp: 40, type: 'heal', power: 999, learnLevel: 60, element: 'heal', flashColor: 'rgba(0, 255, 100, 1.0)' },
            // Âæ©Ê¥ªÂë™Êñá
            zaoraru: { id: 'zaoraru', name: '„Ç∂„Ç™„É©„É´', mp: 10, type: 'revive', successRate: 0.5, learnLevel: 22, element: 'heal', flashColor: 'rgba(255, 255, 200, 0.7)' },
            // ÊîªÊíÉÂë™ÊñáÔºàÂçò‰ΩìÔºâ
            mera: { id: 'mera', name: '„É°„É©', mp: 2, type: 'attack', target: 'single', power: 15, learnLevel: 3, element: 'fire', flashColor: 'rgba(255, 100, 0, 0.6)' },
            merami: { id: 'merami', name: '„É°„É©„Éü', mp: 8, type: 'attack', target: 'single', power: 80, learnLevel: 28, element: 'fire', flashColor: 'rgba(255, 100, 0, 0.8)' },
            merazoma: { id: 'merazoma', name: '„É°„É©„Çæ„Éº„Éû', mp: 15, type: 'attack', target: 'single', power: 200, learnLevel: 45, element: 'fire', flashColor: 'rgba(255, 50, 0, 1.0)' },
            hyado: { id: 'hyado', name: '„Éí„É£„Éâ', mp: 4, type: 'attack', target: 'single', power: 25, learnLevel: 6, element: 'ice', flashColor: 'rgba(100, 200, 255, 0.6)' },
            // ÊîªÊíÉÂë™ÊñáÔºàÂÖ®‰ΩìÔºâ
            gira: { id: 'gira', name: '„ÇÆ„É©', mp: 5, type: 'attack', target: 'all', power: 35, learnLevel: 8, element: 'fire', flashColor: 'rgba(255, 255, 100, 0.6)' },
            begirama: { id: 'begirama', name: '„Éô„ÇÆ„É©„Éû', mp: 10, type: 'attack', target: 'all', power: 70, learnLevel: 18, element: 'fire', flashColor: 'rgba(255, 200, 50, 0.8)' },
            begiragon: { id: 'begiragon', name: '„Éô„ÇÆ„É©„Ç¥„É≥', mp: 20, type: 'attack', target: 'all', power: 150, learnLevel: 40, element: 'fire', flashColor: 'rgba(255, 150, 0, 1.0)' },
            gigadein: { id: 'gigadein', name: '„ÇÆ„Ç¨„Éá„Ç§„É≥', mp: 30, type: 'attack', target: 'all', power: 300, learnLevel: 50, element: 'light', flashColor: 'rgba(255, 255, 100, 1.0)' },
            minadein: { id: 'minadein', name: '„Éü„Éä„Éá„Ç§„É≥', mp: 50, type: 'attack', target: 'all', power: 1000, learnLevel: 99, element: 'light', flashColor: 'rgba(255, 255, 255, 1.0)' },
            // Áä∂ÊÖãÁï∞Â∏∏Âë™Êñá
            rariho: { id: 'rariho', name: '„É©„É™„Éõ„Éº', mp: 3, type: 'status', statusEffect: 'sleep', successRate: 0.7, learnLevel: 5, element: 'status', flashColor: 'rgba(150, 100, 200, 0.5)' },
            manusa: { id: 'manusa', name: '„Éû„Éå„Éº„Çµ', mp: 4, type: 'status', statusEffect: 'blind', successRate: 0.6, learnLevel: 9, element: 'status', flashColor: 'rgba(150, 100, 200, 0.5)' },
            // Ë£úÂä©Âë™Êñá
            sukuruto: { id: 'sukuruto', name: '„Çπ„ÇØ„É´„Éà', mp: 4, type: 'buff', buffType: 'defense', buffRate: 1.5, learnLevel: 25, element: 'buff', flashColor: 'rgba(100, 200, 255, 0.5)' },
            baikiruto: { id: 'baikiruto', name: '„Éê„Ç§„Ç≠„É´„Éà', mp: 6, type: 'buff', buffType: 'attack', buffRate: 2.0, learnLevel: 35, element: 'buff', flashColor: 'rgba(255, 100, 100, 0.6)' },
            // ÁßªÂãïÂë™Êñá
            riremito: { id: 'riremito', name: '„É™„É¨„Éü„Éà', mp: 4, type: 'escape', learnLevel: 12, element: 'move', flashColor: 'rgba(200, 200, 255, 0.5)' },
            rura: { id: 'rura', name: '„É´„Éº„É©', mp: 8, type: 'warp', learnLevel: 15, element: 'move', flashColor: 'rgba(100, 200, 255, 0.7)' }
        };

        // Áä∂ÊÖãÁï∞Â∏∏„ÅÆÂÆöÁæ©
        const STATUS_EFFECTS = {
            sleep: { name: 'Áú†„Çä', icon: 'üí§', badge: 'Áú†', duration: { min: 2, max: 3 } },
            poison: { name: 'ÊØí', icon: '‚ò†Ô∏è', badge: 'ÊØí', damageRate: 0.1 },
            blind: { name: 'ÂπªÊÉë', icon: 'üí´', badge: 'Âπª', hitRateModifier: 0.5 }
        };

        // Âë™Êñá„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫Áî®
        let spellFlash = { active: false, color: '', alpha: 0 };

        // „Éú„ÇπÊà¶ÊºîÂá∫Áî®
        let screenShake = { active: false, intensity: 0, duration: 0 };
        let gameCleared = false;  // È≠îÁéãË®é‰ºê„Éï„É©„Ç∞ÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÁ∂≠ÊåÅÔºâ
        let endingPhase = null;   // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÈÄ≤Ë°åÁä∂ÊÖã

        // ========================================
        // „Ç≤„Éº„É†ÈÄ≤Ë°å„Éï„É©„Ç∞ÁÆ°ÁêÜ
        // ========================================
        const gameProgress = {
            // „Éú„ÇπÊíÉÁ†¥„Éï„É©„Ç∞
            bossDefeated: {
                midBoss: false,     // ‰∏≠„Éú„ÇπÔºàÊ¥ûÁ™ü„ÅÆÁï™‰∫∫Ôºâ
                maou: false,        // È≠îÁéã
                // „Ç®„É™„Ç¢2„Éú„Çπ
                quicksandBoss: false,    // ÊµÅÁ†Ç„ÅÆ‰∏ª
                banditKing: false,       // ÁõóË≥äÁéã
                pyramidGuardian: false,  // „Éî„É©„Éü„ÉÉ„Éâ„ÅÆÂÆàË≠∑ËÄÖ
                desertGuardian: false    // Á†ÇÊº†„ÅÆÂÆàË≠∑ËÄÖÔºàÂüé„ÅÆ‰∏≠„Éú„ÇπÔºâ
            },
            // „Çπ„Éà„Éº„É™„ÉºÈÄ≤Ë°å„Éï„É©„Ç∞
            storyFlags: {
                reportedMidBossDefeat: false,  // ‰∏≠„Éú„ÇπÊíÉÁ†¥„ÇíÁéãÊßò„Å´Â†±Âëä
                portalRoomUnlocked: false,     // ÊóÖ„ÅÆÊââ„ÅÆÈÉ®Â±ã„Å∏„ÅÆÈÄöË°åË®±ÂèØ
                bazaarUnlocked: false,         // „Éê„Ç∂„Éº„É´„ÅÆÁî∫„Å∏„ÅÆÈÄöË°åË®±ÂèØ
                desertPortalUnlocked: false,   // Á†ÇÊº†„ÅÆÊóÖ„ÅÆÊââÈñãÊîæ
                desertCastleUnlocked: false,   // Â§™ÈôΩ„ÅÆÂüéÂ°û„Å∏„ÅÆÈÄöË°åË®±ÂèØ
                mageJoined: false              // È≠îÊ≥ï‰Ωø„ÅÑ„Åå‰ª≤Èñì„Å´„Å™„Å£„Åü
            },
            // „ÇØ„Ç®„Çπ„Éà„Éï„É©„Ç∞Ôºà„Ç®„É™„Ç¢2Ôºâ
            quests: {
                // Ê∞¥‰∏çË∂≥„ÅÆËß£Ê∂à„ÇØ„Ç®„Çπ„Éà
                waterShortage: {
                    started: false,      // „ÇØ„Ç®„Çπ„ÉàÈñãÂßã
                    bossDefeated: false, // ÊµÅÁ†Ç„ÅÆ‰∏ª„ÇíÂÄí„Åó„Åü
                    itemObtained: false, // Ê∏Ö„Çâ„Åã„Å™Ê∞¥„ÇíÂÖ•Êâã
                    completed: false     // ÊùëÈï∑„Å´Ê∏°„Åó„Å¶ÂÆå‰∫Ü
                },
                // ÈÄöË°åÊâãÂΩ¢„ÅÆÂ•™ÈÇÑ„ÇØ„Ç®„Çπ„Éà
                passportRecovery: {
                    started: false,      // „ÇØ„Ç®„Çπ„ÉàÈñãÂßã
                    bossDefeated: false, // ÁõóË≥äÁéã„ÇíÂÄí„Åó„Åü
                    completed: false     // „Éê„Ç∂„Éº„É´„Å´ÂÖ•„Çå„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü
                },
                // ÁéãÂÆ∂„ÅÆÁ¥ãÁ´†„ÇØ„Ç®„Çπ„Éà
                royalCrest: {
                    started: false,      // „ÇØ„Ç®„Çπ„ÉàÈñãÂßã
                    bossDefeated: false, // „Éî„É©„Éü„ÉÉ„Éâ„ÅÆÂÆàË≠∑ËÄÖ„ÇíÂÄí„Åó„Åü
                    itemObtained: false, // Á¥ãÁ´†„ÇíÂÖ•Êâã
                    completed: false     // Âüé„ÅÆÈñÄ„ÅåÈñã„ÅÑ„Åü
                }
            },
            // „Ç®„É™„Ç¢Âà•ÈÄ≤Ë°åÁä∂ÊÖã
            areas: {},
            // Áô∫Ë¶ãÊ∏à„ÅøÈö†„ÅóÈÄöË∑ØÔºà„Éû„ÉÉ„ÉóID -> Â∫ßÊ®ôÈÖçÂàóÔºâ
            openedPassages: {},
            // „É´„Éº„É©Áî®ÔºöË®™ÂïèÊ∏à„ÅøÊã†ÁÇπ„É™„Çπ„Éà
            visitedLocations: [],
            // „É™„É¨„Éü„ÉàÁî®Ôºö„ÉÄ„É≥„Ç∏„Éß„É≥ÈÄ≤ÂÖ•Áõ¥Ââç„ÅÆ‰ΩçÁΩÆ
            lastEntrance: null
        };

        // „Éï„É©„Ç∞Êìç‰Ωú„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function setStoryFlag(flagName, value = true) {
            if (gameProgress.storyFlags.hasOwnProperty(flagName)) {
                gameProgress.storyFlags[flagName] = value;
            }
        }

        function getStoryFlag(flagName) {
            return gameProgress.storyFlags[flagName] || false;
        }

        function setBossDefeated(bossName, value = true) {
            if (gameProgress.bossDefeated.hasOwnProperty(bossName)) {
                gameProgress.bossDefeated[bossName] = value;
                // È≠îÁéãÊíÉÁ†¥„ÅØÊó¢Â≠ò„Éï„É©„Ç∞„Å®ÈÄ£Âãï
                if (bossName === 'maou') {
                    gameCleared = value;
                }
            }
        }

        function isBossDefeated(bossName) {
            return gameProgress.bossDefeated[bossName] || false;
        }

        function resetGameProgress() {
            gameProgress.bossDefeated.midBoss = false;
            gameProgress.bossDefeated.maou = false;
            gameProgress.bossDefeated.quicksandBoss = false;
            gameProgress.bossDefeated.banditKing = false;
            gameProgress.bossDefeated.pyramidGuardian = false;
            gameProgress.bossDefeated.desertGuardian = false;
            gameProgress.storyFlags.reportedMidBossDefeat = false;
            gameProgress.storyFlags.portalRoomUnlocked = false;
            gameProgress.storyFlags.mageJoined = false;
            // „ÇØ„Ç®„Çπ„Éà„É™„Çª„ÉÉ„Éà
            Object.keys(gameProgress.quests).forEach(questName => {
                Object.keys(gameProgress.quests[questName]).forEach(flag => {
                    gameProgress.quests[questName][flag] = false;
                });
            });
            gameProgress.areas = {};
            gameProgress.openedPassages = {};
        }

        // Èö†„ÅóÈÄöË∑ØÊìç‰Ωú„Éò„É´„Éë„Éº
        function isPassageOpened(mapId, x, y) {
            const passages = gameProgress.openedPassages[mapId];
            if (!passages) return false;
            return passages.some(p => p.x === x && p.y === y);
        }

        function openPassage(mapId, x, y) {
            if (!gameProgress.openedPassages[mapId]) {
                gameProgress.openedPassages[mapId] = [];
            }
            if (!isPassageOpened(mapId, x, y)) {
                gameProgress.openedPassages[mapId].push({ x, y });
            }
        }

        // „Éû„ÉÉ„ÉóË™≠„ÅøËæº„ÅøÊôÇ„Å´Áô∫Ë¶ãÊ∏à„ÅøÈö†„ÅóÈÄöË∑Ø„ÇíÈÅ©Áî®
        function applyOpenedPassages(mapData) {
            const mapId = mapData.mapId;
            const passages = gameProgress.openedPassages[mapId];
            if (!passages || !mapData.data) return;

            passages.forEach(p => {
                if (mapData.data[p.y] && mapData.data[p.y][p.x] === TILE.HIDDEN_WALL) {
                    mapData.data[p.y][p.x] = TILE.FLOOR;
                }
            });
        }

        // „É´„Éº„É©Áî®ÔºöË®™ÂïèÊ∏à„ÅøÊã†ÁÇπ„ÅÆÁôªÈå≤
        function registerVisitedLocation(mapData) {
            if (!mapData.isSettlement) return;

            // Êó¢„Å´ÁôªÈå≤Ê∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const exists = gameProgress.visitedLocations.some(loc => loc.mapId === mapData.mapId);
            if (exists) return;

            // Êã†ÁÇπ„ÇíÁôªÈå≤
            gameProgress.visitedLocations.push({
                mapId: mapData.mapId,
                displayName: mapData.name,
                arrivalX: mapData.arrivalX || 0,
                arrivalY: mapData.arrivalY || 0
            });
        }

        // „É™„É¨„Éü„ÉàÁî®Ôºö„ÉÄ„É≥„Ç∏„Éß„É≥ÈÄ≤ÂÖ•Ââç„ÅÆ‰ΩçÁΩÆ„ÇíË®òÊÜ∂
        function recordDungeonEntrance(prevMapData, prevX, prevY, prevMapPath) {
            // Â±ãÂ§ñ„Åã„ÇâÂ±ãÂÜÖ/„ÉÄ„É≥„Ç∏„Éß„É≥„Å∏ÁßªÂãï„Åó„ÅüÂ†¥Âêà„ÅÆ„ÅøË®òÊÜ∂
            if (prevMapData && prevMapData.isOutdoor === true) {
                gameProgress.lastEntrance = {
                    mapId: prevMapData.mapId,
                    mapPath: prevMapPath,
                    x: prevX,
                    y: prevY,
                    name: prevMapData.name
                };
            }
        }

        // „ÉÄ„É≥„Ç∏„Éß„É≥ÂÖ•Âè£ÊÉÖÂ†±„ÇíÂèñÂæó
        function getLastEntrance() {
            return gameProgress.lastEntrance;
        }

        // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„ÅåÂ±ãÂ§ñ„Åã„Å©„ÅÜ„Åã
        function isCurrentMapOutdoor() {
            return currentMap && currentMap.isOutdoor === true;
        }

        // „ÇØ„Ç®„Çπ„Éà„Éï„É©„Ç∞Êìç‰Ωú
        function setQuestFlag(questName, flagName, value = true) {
            if (gameProgress.quests[questName] && gameProgress.quests[questName].hasOwnProperty(flagName)) {
                gameProgress.quests[questName][flagName] = value;
            }
        }

        function getQuestFlag(questName, flagName) {
            if (gameProgress.quests[questName]) {
                return gameProgress.quests[questName][flagName] || false;
            }
            return false;
        }

        function isQuestCompleted(questName) {
            return getQuestFlag(questName, 'completed');
        }

        function areAllDesertQuestsCompleted() {
            const allCompleted = isQuestCompleted('waterShortage') &&
                   isQuestCompleted('passportRecovery') &&
                   isQuestCompleted('royalCrest');
            // ÂÖ®„ÇØ„Ç®„Çπ„ÉàÂÆå‰∫ÜÊôÇ„Å´Á†ÇÊº†„ÅÆÂüé„ÇíÈñãÊîæ
            if (allCompleted && !getStoryFlag('desertCastleUnlocked')) {
                setStoryFlag('desertCastleUnlocked', true);
                saveGame();
            }
            return allCompleted;
        }

        // ========================================
        // „Éû„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†ÔºàÂ§ñÈÉ®JSON„Éï„Ç°„Ç§„É´ÈÄ£Êê∫Ôºâ
        // ========================================

        // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„Éë„Çπ„Çí‰øùÊåÅ
        let currentMapPath = 'maps/castle.json';

        // „Éû„ÉÉ„Éó„É≠„Éº„ÉâÁä∂ÊÖã
        let mapLoadState = {
            loading: false,
            fadeAlpha: 0,
            targetMapPath: null,
            targetX: 0,
            targetY: 0
        };

        // „É≠„Éº„ÉâÊ∏à„Åø„Éû„ÉÉ„Éó„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
        const maps = {
            field: {
                mapId: 'field',
                name: '„É´„Éü„Éä„ÇπÂ§ßÈô∏',
                type: 'field',
                cols: 20,
                rows: 20,
                encounterRate: 0.08,
                isSafe: false,
                data: [
                    [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
                    [2,2,2,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,2,2],
                    [2,2,0,0,0,0,0,0,0,2,2,0,0,0,0,1,1,0,0,2],
                    [2,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,1,0,0,2],
                    [2,0,0,1,1,1,1,0,0,0,0,0,0,0,0,1,0,0,0,2],
                    [2,0,0,0,1,1,0,0,0,3,0,0,0,0,0,0,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
                    [2,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,2],
                    [2,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
                    [2,0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,2],
                    [2,0,0,1,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
                    [2,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,2],
                    [2,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,2,2],
                    [2,2,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,2,2,2],
                    [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]
                ],
                warps: [
                    { x: 9, y: 5, targetMap: 'maps/castle.json', targetX: 7, targetY: 12 },
                    { x: 4, y: 10, targetMap: 'maps/town.json', targetX: 7, targetY: 13 },
                    { x: 16, y: 10, targetMap: 'maps/dungeon.json', targetX: 1, targetY: 1 }
                ],
                npcs: [],
                chests: []
            },
            castle: {
                mapId: 'castle',
                name: '„Ç∞„É©„É≥„Éá„Ç£„Ç¢Âüé',
                type: 'castle',
                cols: 15,
                rows: 15,
                encounterRate: 0,
                isSafe: true,
                data: [
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,7,7,7,6,6,6,7,7,7,6,6,7],
                    [7,6,6,7,6,6,6,6,6,6,6,7,6,6,7],
                    [7,6,6,7,6,6,6,6,6,6,6,7,6,6,7],
                    [7,6,6,7,6,6,6,6,6,6,6,7,6,6,7],
                    [7,6,6,7,7,6,6,6,6,6,7,7,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,5,6,6,6,6,6,6,7],
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7]
                ],
                warps: [
                    { x: 7, y: 12, targetMap: 'maps/field.json', targetX: 9, targetY: 6 }
                ],
                npcs: [
                    { id: 'king', x: 7, y: 2, sprite: 'üëë', type: 'king', messages: ['„Åä„Åä„ÄÅÂãáËÄÖ„ÇàÔºÅ', '„Çà„Åè„ÅûÂèÇ„Å£„Åü„ÄÇ', 'È≠îÁéã„Åå‰∏ñÁïå„ÇíÈóò„ÅßË¶Ü„Åä„ÅÜ„Å®„Åó„Å¶„Åä„Çã„ÄÇ', '„Å©„ÅÜ„Åã‰∏ñÁïå„ÇíÊïë„Å£„Å¶„Åè„ÇåÔºÅ', 'Êù±„ÅÆÊ¥ûÁ™ü„Å´„Åª„ÅÆ„Åä„ÅÆ„Å§„Çã„Åé„Åå„ÅÇ„Çã„Å®„ÅÑ„ÅÜ„ÄÇ', 'ÊóÖÁ´ã„Å§„Åå„Çà„ÅÑÔºÅ'], clearedMessages: ['„Åä„Åä„ÄÅÂãáËÄÖ„ÇàÔºÅ', '„Çà„Åè„ÅûÈ≠îÁéã„ÇíÂÄí„Åó„Å¶„Åè„Çå„ÅüÔºÅ', '„Åì„Çå„Åß‰∏ñÁïå„Å´Âπ≥Âíå„ÅåÊàª„Å£„Åü„ÄÇ', '„Åù„Å™„Åü„ÅØÁúü„ÅÆËã±ÈõÑ„Åò„ÇÉÔºÅ'] },
                    { id: 'guard1', x: 3, y: 10, sprite: 'üíÇ', type: 'guard', messages: ['ÁéãÊßò„Çí„ÅäÂÆà„Çä„Åô„Çã„ÅÆ„Åå', 'Êàë„ÄÖ„ÅÆÂãô„ÇÅ„Åß„Åô„ÄÇ'], clearedMessages: ['ÂãáËÄÖÊßòÔºÅ', '„ÅÇ„Å™„Åü„ÅÆ„Åä„Åã„Åí„ÅßÂπ≥Âíå„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ'] },
                    { id: 'guard2', x: 11, y: 10, sprite: 'üíÇ', type: 'guard', messages: ['„Åì„ÅÆÂüé„ÅØÂÆâÂÖ®„Åß„Åô„ÄÇ', '„ÅîÂÆâÂøÉ„Åè„Å†„Åï„ÅÑ„ÄÇ'], clearedMessages: ['È≠îÁéã„ÅåÂÄí„Åï„Çå„Åü„Å®ËÅû„Åç„Åæ„Åó„ÅüÔºÅ', '„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÅÂãáËÄÖÊßòÔºÅ'] }
                ],
                chests: [
                    { id: 'castle_chest1', x: 4, y: 5, itemId: 8, isOpened: false }
                ]
            },
            town: {
                mapId: 'town',
                name: '„Ç¢„É´„Ç´„Éá„Ç£„Ç¢„ÅÆË°ó',
                type: 'town',
                cols: 15,
                rows: 15,
                encounterRate: 0,
                isSafe: true,
                data: [
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,7,7,6,6,6,6,6,6,6,7,7,6,7],
                    [7,6,7,7,6,6,6,6,6,6,6,7,7,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,7,7,7,6,6,6,6,6,7],
                    [7,6,6,6,6,6,7,7,7,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,7,7,6,6,6,6,6,6,6,7,7,6,7],
                    [7,6,7,7,6,6,6,6,6,6,6,7,7,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,5,6,6,6,6,6,6,7],
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7]
                ],
                warps: [
                    { x: 7, y: 13, targetMap: 'maps/field.json', targetX: 4, targetY: 11 }
                ],
                npcs: [
                    { id: 'villager1', x: 5, y: 4, sprite: 'üë®', type: 'villager', messages: ['„Çà„ÅÜ„Åì„ÅùÊàë„ÅåË°ó„Å∏ÔºÅ', 'Êù±„ÅÆÊ¥ûÁ™ü„Å´„ÅØÈ≠îÁâ©„Åå„ÅÑ„Çã„Çâ„Åó„ÅÑ„ÄÇ', 'Ê∞ó„Çí„Å§„Åë„Å¶„Å™„ÄÇ'], clearedMessages: ['Âπ≥Âíå„Å´„Å™„Å£„Åü„Å™„ÅÇÔºÅ', '„Åì„Çå„ÇÇ„ÅÇ„Çì„Åü„ÅÆ„Åä„Åã„Åí„Å†ÔºÅ', '„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÅÂãáËÄÖ„Åï„ÅæÔºÅ'] },
                    { id: 'villager2', x: 10, y: 4, sprite: 'üë©', type: 'villager', messages: ['„ÅÇ„Çâ„ÄÅÊóÖ„ÅÆÊñπÔºü', 'Âüé„ÅÆÁéãÊßò„Å´‰ºö„ÅÑ„Åæ„Åó„Åü„ÅãÔºü', 'Â§ßÂàá„Å™Ë©±„Åå„ÅÇ„Çã„Åù„ÅÜ„Åß„Åô„Çà„ÄÇ'], clearedMessages: ['„ÅÇ„Çâ„ÄÅÂãáËÄÖÊßòÔºÅ', 'È≠îÁéã„ÇíÂÄí„Åó„Åü„Å£„Å¶Êú¨ÂΩìÔºü', '„Åô„Åî„ÅÑ„ÇèÔºÅ„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ'] },
                    { id: 'innkeeper', x: 12, y: 2, sprite: 'üè®', type: 'inn', innCost: 10, messages: [] },
                    { id: 'shopkeeper', x: 2, y: 2, sprite: '‚öîÔ∏è', type: 'shop', messages: [] },
                    { id: 'child', x: 3, y: 11, sprite: 'üë¶', type: 'villager', messages: ['„Å≠„Åà„Å≠„Åà„ÄÅÂãáËÄÖ„Åï„ÇìÔºü', '„Åº„Åè„ÇÇÂ§ß„Åç„Åè„Å™„Å£„Åü„Çâ', 'ÂãáËÄÖ„Å´„Å™„Çä„Åü„ÅÑ„Å™ÔºÅ'], clearedMessages: ['„Çè„ÅÇÔºÅÊú¨Áâ©„ÅÆÂãáËÄÖ„Å†ÔºÅ', 'È≠îÁéã„ÇíÂÄí„Åó„Åü„Çì„Åß„Åó„ÇáÔºü', '„Åã„Å£„Åì„ÅÑ„ÅÑÔΩûÔºÅ'] }
                ],
                chests: [
                    { id: 'town_chest1', x: 13, y: 1, itemId: 1, isOpened: false },
                    { id: 'town_chest2', x: 1, y: 12, itemId: 2, isOpened: false }
                ]
            },
            dungeon: {
                mapId: 'dungeon',
                name: 'ÁÅºÁÜ±„ÅÆÊ¥ûÁ™ü',
                type: 'dungeon',
                cols: 12,
                rows: 12,
                encounterRate: 0.12,
                isSafe: false,
                data: [
                    [7,7,7,7,7,7,7,7,7,7,7,7],
                    [7,5,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,7,7,7,6,6,7,7,6,7],
                    [7,6,6,7,6,6,6,6,6,7,6,7],
                    [7,6,6,7,6,7,7,7,6,7,6,7],
                    [7,6,6,6,6,6,6,6,6,6,5,7],
                    [7,7,7,7,6,7,7,7,6,6,6,7],
                    [7,6,6,6,6,6,6,7,6,7,6,7],
                    [7,6,7,7,7,7,6,7,6,7,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,7],
                    [7,7,7,7,7,7,7,7,7,7,7,7]
                ],
                warps: [
                    { x: 1, y: 1, targetMap: 'maps/field.json', targetX: 16, targetY: 11 },
                    { x: 10, y: 5, targetMap: 'maps/maou_room.json', targetX: 7, targetY: 12 }
                ],
                npcs: [
                    { id: 'hermit', x: 10, y: 10, sprite: 'üßô', type: 'hermit', messages: ['„Åª„Åª„ÅÜ„ÄÅ„Åì„Åì„Åæ„ÅßÊù•„Åü„Åã„ÄÇ', '„Çè„Åó„ÅØÊòî„ÄÅÂãáËÄÖ„Å†„Å£„Åü„ÄÇ', '„Åì„ÅÆÂ••„Å´„Åª„ÅÆ„Åä„ÅÆ„Å§„Çã„Åé„Åå„ÅÇ„Çã„ÄÇ', 'Ê¥ûÁ™ü„ÅÆÁï™‰∫∫„ÇíÂÄí„Åô„ÅÆ„Å´ÂøÖË¶Å„Åò„ÇÉ„ÄÇ', 'ÂøÉ„Åó„Å¶ÈÄ≤„ÇÄ„Åå„Çà„ÅÑ„ÄÇ'] }
                ],
                chests: [
                    { id: 'dungeon_chest1', x: 4, y: 3, itemId: 1, isOpened: false },  // Ëñ¨Ëçâ
                    { id: 'dungeon_chest2', x: 1, y: 7, itemId: 14, isOpened: false }  // „Åª„ÅÆ„Åä„ÅÆ„Å§„Çã„Åé
                ]
            },
            maouRoom: {
                mapId: 'maouRoom',
                name: 'ÊöóÈªí„ÅÆÁéâÂ∫ß',
                type: 'dungeon',
                cols: 11,
                rows: 10,
                encounterRate: 0,
                isSafe: false,
                data: [
                    [7,7,7,7,7,7,7,7,7,7,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,5,6,6,6,6,7],
                    [7,7,7,7,7,7,7,7,7,7,7]
                ],
                warps: [
                    { x: 5, y: 8, targetMap: 'maps/dungeon.json', targetX: 23, targetY: 21 }
                ],
                npcs: [
                    { id: 'maou', x: 5, y: 2, sprite: 'üëø', type: 'maou', messages: [] }
                ],
                chests: []
            }
        };

        // ========================================
        // „Ç≤„Éº„É†Áä∂ÊÖã
        // ========================================
        let currentMapId = 'field';
        let currentMap = maps[currentMapId];
        let isTransitioning = false;

        // „Ç®„É≥„Ç´„Ç¶„É≥„Éà„Ç∑„Çπ„ÉÜ„É†
        let stepsSinceLastBattle = 0;  // ÂâçÂõû„Éê„Éà„É´Âæå„Åã„Çâ„ÅÆÊ≠©Êï∞
        const SAFE_STEPS = 5;          // ‰∏çÊÑüÂú∞Â∏ØÔºà„Åì„ÅÆÊ≠©Êï∞„Åæ„Åß„ÅØ„Ç®„É≥„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑÔºâ
        const ENCOUNTER_RATE_PER_STEP = 0.02;  // Ê≠©Êï∞„ÅÇ„Åü„Çä„ÅÆÁ¢∫Áéá‰∏äÊòáÁéáÔºà2%Ôºâ
        const MAX_ENCOUNTER_RATE = 0.95;       // ÊúÄÂ§ß„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÁéá

        // ÈÄ£Á∂öÁßªÂãï„Ç∑„Çπ„ÉÜ„É†ÔºàÊäº„ÅóÁ∂ö„Åë„Å¶ÁßªÂãïÔºâ
        let moveInterval = null;
        let currentMoveDirection = { dx: 0, dy: 0 };
        const CONTINUOUS_MOVE_DELAY = 150;  // ÈÄ£Á∂öÁßªÂãï„ÅÆÈñìÈöîÔºà„Éü„É™ÁßíÔºâ

        // ========================================
        // „Éë„Éº„ÉÜ„Ç£„Ç∑„Çπ„ÉÜ„É†
        // ========================================

        // „Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„Çí‰ΩúÊàê„Åô„ÇãÈñ¢Êï∞
        function createPartyMember(config) {
            return {
                // Ë≠òÂà•ÊÉÖÂ†±
                id: config.id || 'hero',
                name: config.name || '„ÇÜ„ÅÜ„Åó„ÇÉ',
                job: config.job || 'hero',
                sprite: config.sprite || 'üßô',

                // HP/MP
                hp: config.hp || 50,
                maxHp: config.maxHp || 50,
                mp: config.mp || 20,
                maxMp: config.maxMp || 20,

                // Âü∫Á§é„Çπ„ÉÜ„Éº„Çø„Çπ
                baseAtk: config.baseAtk || 10,
                baseDef: config.baseDef || 5,
                speed: config.speed || 6,

                // „É¨„Éô„É´„ÉªÁµåÈ®ìÂÄ§
                level: config.level || 1,
                exp: config.exp || 0,

                // Âë™Êñá
                spells: config.spells || [],

                // Ë£ÖÂÇô
                equipment: config.equipment || {
                    weapon: null,
                    armor: null
                },

                // Ë®àÁÆóÊ∏à„Åø„Çπ„ÉÜ„Éº„Çø„Çπ
                actualAtk: config.baseAtk || 10,
                actualDef: config.baseDef || 5,

                // Áä∂ÊÖãÁï∞Â∏∏ÔºàÊÆã„Çä„Çø„Éº„É≥Êï∞Ôºâ
                status: {
                    sleep: 0,
                    poison: 0,
                    blind: 0
                },

                // Êà¶Èóò‰∏çËÉΩ„Éï„É©„Ç∞
                isAlive: true
            };
        }

        // „Éë„Éº„ÉÜ„Ç£ÈÖçÂàóÔºàÊúÄÂ§ß4‰∫∫Ôºâ
        const MAX_PARTY_SIZE = 4;
        const party = [];

        // ÂãáËÄÖÔºàÂàùÊúü„É°„É≥„Éê„ÉºÔºâ„Çí‰ΩúÊàê„Åó„Å¶„Éë„Éº„ÉÜ„Ç£„Å´ËøΩÂä†
        party.push(createPartyMember({
            id: 'hero',
            name: '„ÇÜ„ÅÜ„Åó„ÇÉ',
            job: 'hero',
            sprite: 'ü¶∏',
            hp: 50,
            maxHp: 50,
            mp: 20,
            maxMp: 20,
            baseAtk: 10,
            baseDef: 5,
            speed: 6,
            level: 1,
            exp: 0,
            spells: ['hoimi', 'mera'],
            equipment: {
                weapon: 10,  // „Åì„Çì„Åº„ÅÜ
                armor: 20    // „Åü„Å≥„Å≥„Å®„ÅÆ„Åµ„Åè
            }
        }));

        // ÂæåÊñπ‰∫íÊèõÊÄßÔºöplayer„ÅØÂ∏∏„Å´party[0]„ÇíÂèÇÁÖß
        // Ê≥®ÊÑèÔºöplayer„ÇíÂÜç‰ª£ÂÖ•„Åó„Å™„ÅÑ„Åì„Å®Ôºàconst„Åß„ÅØ„Å™„Åèlet„ÅßÂÆ£Ë®Ä„Åó„ÄÅÂèÇÁÖß„ÇíÁ∂≠ÊåÅÔºâ
        let player = party[0];

        // „Éë„Éº„ÉÜ„Ç£ÂÖ±Êúâ„Éá„Éº„ÇøÔºà‰ΩçÁΩÆ„ÄÅ„Ç¥„Éº„É´„Éâ„ÄÅ„Ç¢„Ç§„ÉÜ„É†Ôºâ
        const partyData = {
            x: 3,
            y: 3,
            direction: 'down',
            moving: false,
            moveDelay: 120,
            gold: 0,
            inventory: []
        };

        // ‰ΩçÁΩÆÊÉÖÂ†±„Å®„Ç¥„Éº„É´„Éâ„Éª„Ç§„É≥„Éô„É≥„Éà„É™„ÅØpartyData„Çí‰ΩøÁî®
        // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅplayer„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´„Éó„É≠„Éë„ÉÜ„Ç£„ÇíËøΩÂä†
        // Ê≥®ÊÑè: playerÂÜç‰ª£ÂÖ•Âæå„ÅØÂøÖ„Åö„Åì„ÅÆÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åô„Åì„Å®
        function setupPlayerProxy() {
            Object.defineProperties(player, {
                x: {
                    get: () => partyData.x,
                    set: (v) => { partyData.x = v; },
                    configurable: true
                },
                y: {
                    get: () => partyData.y,
                    set: (v) => { partyData.y = v; },
                    configurable: true
                },
                direction: {
                    get: () => partyData.direction,
                    set: (v) => { partyData.direction = v; },
                    configurable: true
                },
                moving: {
                    get: () => partyData.moving,
                    set: (v) => { partyData.moving = v; },
                    configurable: true
                },
                moveDelay: {
                    get: () => partyData.moveDelay,
                    set: (v) => { partyData.moveDelay = v; },
                    configurable: true
                },
                gold: {
                    get: () => partyData.gold,
                    set: (v) => { partyData.gold = v; },
                    configurable: true
                },
                inventory: {
                    get: () => partyData.inventory,
                    set: (v) => { partyData.inventory = v; },
                    configurable: true
                }
            });
        }

        // ÂàùÊúüÂåñÊôÇ„Å´„Éó„É≠„Ç≠„Ç∑„ÇíË®≠ÂÆö
        setupPlayerProxy();

        // „Éë„Éº„ÉÜ„Ç£„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function getAlivePartyMembers() {
            return party.filter(m => m.isAlive && m.hp > 0);
        }

        function getPartyMember(index) {
            return party[index] || null;
        }

        function addPartyMember(config) {
            if (party.length >= MAX_PARTY_SIZE) {
                console.warn('„Éë„Éº„ÉÜ„Ç£„ÅØÊúÄÂ§ß4‰∫∫„Åæ„Åß„Åß„Åô');
                return false;
            }
            const member = createPartyMember(config);
            updateMemberActualStats(member);
            party.push(member);
            return true;
        }

        function isPartyAlive() {
            return party.some(m => m.isAlive && m.hp > 0);
        }

        // „É°„É≥„Éê„ÉºÂÄãÂà•„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        function updateMemberActualStats(member) {
            const weapon = items[member.equipment.weapon];
            const armor = items[member.equipment.armor];
            member.actualAtk = member.baseAtk + (weapon ? weapon.value : 0);
            member.actualDef = member.baseDef + (armor ? armor.value : 0);
        }

        // ÊúÄÂæå„Å´Ë®™„Çå„ÅüÁî∫Ôºà„Ç≠„É°„É©„ÅÆ„Å§„Å∞„ÅïÁî®Ôºâ
        let lastTown = {
            mapPath: 'maps/town.json',
            x: 9,
            y: 9,
            name: '„Ç¢„É´„Ç´„Éá„Ç£„Ç¢„ÅÆË°ó'
        };

        // Ë£ÖÂÇôËæº„Åø„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®àÁÆó„Åó„Å¶Êõ¥Êñ∞ÔºàÂÖ®„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„ÉºÔºâ
        function updateActualStats() {
            party.forEach(member => updateMemberActualStats(member));
        }

        // Ë£ÖÂÇôËæº„Åø„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèñÂæó
        function getPlayerAtk() {
            return player.actualAtk;
        }

        function getPlayerDef() {
            return player.actualDef;
        }

        // ========================================
        // Áä∂ÊÖãÁï∞Â∏∏„Ç∑„Çπ„ÉÜ„É†
        // ========================================

        // Áä∂ÊÖãÁï∞Â∏∏„Çí‰ªò‰∏é
        function applyStatusEffect(target, effect) {
            if (effect === 'sleep') {
                const duration = STATUS_EFFECTS.sleep.duration;
                target.status.sleep = duration.min + Math.floor(Math.random() * (duration.max - duration.min + 1));
                return true;
            } else if (effect === 'poison') {
                target.status.poison = 99; // ÊØí„ÅØÊà¶ÈóòÁµÇ‰∫Ü„Åæ„ÅßÁ∂ôÁ∂ö
                return true;
            } else if (effect === 'blind') {
                target.status.blind = 99; // ÂπªÊÉë„ÅØÊà¶ÈóòÁµÇ‰∫Ü„Åæ„ÅßÁ∂ôÁ∂ö
                return true;
            }
            return false;
        }

        // Áä∂ÊÖãÁï∞Â∏∏„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
        function getStatusIcons(target) {
            let icons = '';
            if (target.status.sleep > 0) icons += STATUS_EFFECTS.sleep.icon;
            if (target.status.poison > 0) icons += STATUS_EFFECTS.poison.icon;
            if (target.status.blind > 0) icons += STATUS_EFFECTS.blind.icon;
            return icons;
        }

        // „Éê„ÉÉ„Ç∏ÂΩ¢Âºè„ÅÆÁä∂ÊÖãÁï∞Â∏∏Ë°®Á§∫Ôºà„ÄåÁú†„Äç„ÄåÊØí„Äç„Å™„Å©Ôºâ
        function getStatusBadges(target) {
            let badges = [];
            if (target.status.sleep > 0) badges.push(STATUS_EFFECTS.sleep.badge);
            if (target.status.poison > 0) badges.push(STATUS_EFFECTS.poison.badge);
            if (target.status.blind > 0) badges.push(STATUS_EFFECTS.blind.badge);
            return badges.length > 0 ? 'Ôºà' + badges.join('') + 'Ôºâ' : '';
        }

        // „Éê„ÉïÁä∂ÊÖã„ÅÆ„Éê„ÉÉ„Ç∏„ÇíÂèñÂæó
        function getBuffBadges() {
            if (!battle.active) return '';
            let badges = [];
            if (battle.buffs.attackUp > 0) badges.push('Êîª‚Üë' + (battle.buffs.attackUp > 1 ? '√ó2' : ''));
            if (battle.buffs.defenseUp > 0) badges.push('ÂÆà‚Üë' + (battle.buffs.defenseUp > 1 ? '√ó2' : ''));
            return badges.length > 0 ? '(' + badges.join(' ') + ')' : '';
        }

        // Áú†„Çä„Åã„ÇâËµ∑„Åç„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çø„Éº„É≥ÈñãÂßãÊôÇÔºâ
        function checkWakeUp(target, name) {
            if (target.status.sleep > 0) {
                target.status.sleep--;
                if (target.status.sleep <= 0) {
                    return { awake: true, message: `${name} „ÅØ „ÇÅ„Çí„Åï„Åæ„Åó„ÅüÔºÅ` };
                } else {
                    return { awake: false, message: `${name} „ÅØ „Å≠„ÇÄ„Å£„Å¶„ÅÑ„Çã...` };
                }
            }
            return { awake: true, message: null };
        }

        // ÊØí„ÉÄ„É°„Éº„Ç∏„ÇíÂá¶ÁêÜÔºà„Çø„Éº„É≥ÁµÇ‰∫ÜÊôÇÔºâ
        function processPoisonDamage(target, name, maxHp) {
            if (target.status.poison > 0) {
                const damage = Math.max(1, Math.floor(maxHp * STATUS_EFFECTS.poison.damageRate));
                target.hp = Math.max(1, target.hp - damage); // ÊØí„Åß„ÅØÊ≠ª„Å™„Å™„ÅÑ
                return { damage, message: `${name} „ÅØ „Å©„Åè„ÅÆ „ÉÄ„É°„Éº„Ç∏„Çí „ÅÜ„Åë„ÅüÔºÅÔºà${damage}Ôºâ` };
            }
            return null;
        }

        // ÊîªÊíÉÂëΩ‰∏≠Áéá„ÇíÂèñÂæóÔºàÂπªÊÉëËÄÉÊÖÆÔºâ
        function getHitRate(attacker) {
            const baseRate = 0.9; // ÈÄöÂ∏∏90%
            if (attacker.status && attacker.status.blind > 0) {
                return baseRate * STATUS_EFFECTS.blind.hitRateModifier;
            }
            return baseRate;
        }

        // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Å´ÂøÖË¶Å„Å™ÁµåÈ®ìÂÄ§ÔºàÊåáÊï∞Èñ¢Êï∞ÁöÑÂ¢óÂä†Ôºâ
        // Ë®àÁÆóÂºè: Math.floor(10 * Math.pow(2.2, level-1))
        function getExpForLevel(level) {
            if (level <= 1) return 0;
            return Math.floor(10 * Math.pow(2.2, level - 2));
        }

        // „É¨„Éô„É´1-10„ÅÆÂøÖË¶ÅÁµåÈ®ìÂÄ§„ÉÜ„Éº„Éñ„É´ÔºàÁ¥ØÁ©çÔºâ
        const expTable = [];
        let totalExp = 0;
        for (let i = 0; i <= 10; i++) {
            expTable[i] = totalExp;
            totalExp += getExpForLevel(i + 1);
        }
        // expTable = [0, 0, 10, 35, 97, 253, 643, 1618, 4056, 10150, 25386]

        // ‰ºöË©±Áä∂ÊÖã
        const dialog = {
            active: false,
            messages: [],
            currentIndex: 0,
            displayedText: '',
            charIndex: 0,
            isTyping: false,
            typingSpeed: 50,
            onComplete: null  // „ÉÄ„Ç§„Ç¢„É≠„Ç∞ÁµÇ‰∫ÜÊôÇ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
        };

        // „É°„Éã„É•„ÉºÁä∂ÊÖã
        const menu = {
            active: false,
            selectedIndex: 0,
            mode: 'status', // 'status', 'items', 'spells', 'map'
            itemCursor: 0,  // „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà‰∏ä„ÅÆ„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ
            spellCursor: 0, // Âë™Êñá„É™„Çπ„Éà‰∏ä„ÅÆ„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ
            showItemAction: false, // „Ç¢„Ç§„ÉÜ„É†„Ç¢„ÇØ„Ç∑„Éß„É≥„Çµ„Éñ„É°„Éã„É•„ÉºË°®Á§∫
            itemActionIndex: 0, // 0: „Å§„Åã„ÅÜ/„Åù„ÅÜ„Å≥„Åô„Çã, 1: „Åô„Å¶„Çã, 2: „ÇÑ„ÇÅ„Çã
            // „Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„ÉºÈÅ∏Êäû
            memberCursor: 0, // ÈÅ∏Êäû‰∏≠„ÅÆ„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº
            selectingMember: false, // „É°„É≥„Éê„ÉºÈÅ∏Êäû„É¢„Éº„ÉâÔºàÂë™Êñá/„Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®ÂØæË±°ÈÅ∏ÊäûÔºâ
            selectingSpellCaster: false, // Âë™ÊñáË©†Âî±ËÄÖÈÅ∏Êäû„É¢„Éº„Éâ
            targetMemberCursor: 0 // ‰ΩøÁî®ÂØæË±°„ÅÆ„É°„É≥„Éê„Éº
        };

        // ÂÆøÂ±ãÁä∂ÊÖã
        const inn = {
            active: false,
            cost: 0,
            selectedIndex: 0 // 0: „ÅØ„ÅÑ, 1: „ÅÑ„ÅÑ„Åà
        };

        // „Ç∑„Éß„ÉÉ„ÉóÁä∂ÊÖã
        const shop = {
            active: false,
            mode: 'menu',  // 'menu', 'buy', 'sell'
            phase: 'list', // 'list', 'confirm', 'equip', 'sold'
            menuIndex: 0,  // 0: „Åã„ÅÜ, 1: „ÅÜ„Çã, 2: „ÇÑ„ÇÅ„Çã
            selectedIndex: 0,
            confirmIndex: 0, // 0: „ÅØ„ÅÑ, 1: „ÅÑ„ÅÑ„Åà
            equipIndex: 0,   // 0: „ÅØ„ÅÑ, 1: „ÅÑ„ÅÑ„Åà
            selectedItem: null,
            sellableItems: [] // Â£≤Âç¥ÂèØËÉΩ„Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà
        };

        // „Éê„Éà„É´Áä∂ÊÖã
        const battle = {
            active: false,
            enemy: null,              // ÂæåÊñπ‰∫íÊèõÁî®ÔºàÂçò‰ΩìÂèÇÁÖßÔºâ
            enemies: [],              // Ë§áÊï∞Êïµ„ÅÆÈÖçÂàó
            currentEnemyIndex: 0,     // Êïµ„Çø„Éº„É≥‰∏≠„ÅÆÂá¶ÁêÜÂØæË±°„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
            targetIndex: 0,           // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû
            isSelectingTarget: false, // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû„É¢„Éº„Éâ‰∏≠
            phase: 'start', // start, command, partyCommand, target, playerTurn, partyTurn, enemyTurn, result
            commandIndex: 0,
            spellIndex: 0,
            showSpells: false,
            showItems: false,
            itemCursor: 0,
            message: '',
            messageQueue: [],
            animationFrame: 0,
            flashCount: 0,
            result: null, // 'win', 'lose', 'escape'
            pendingAction: null,      // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏ÊäûÂæå„Å´ÂÆüË°å„Åô„Çã„Ç¢„ÇØ„Ç∑„Éß„É≥
            // „Éê„ÉïÁä∂ÊÖãÔºàÊà¶Èóò‰∏≠„ÅÆ„ÅøÊúâÂäπÔºâ
            buffs: {
                attackUp: 0,   // „Éê„Ç§„Ç≠„É´„ÉàÈáç„Å≠„Åå„ÅëÂõûÊï∞ÔºàÊúÄÂ§ß2Ôºâ
                defenseUp: 0   // „Çπ„ÇØ„É´„ÉàÈáç„Å≠„Åå„ÅëÂõûÊï∞ÔºàÊúÄÂ§ß2Ôºâ
            },
            // „Éë„Éº„ÉÜ„Ç£„Éê„Éà„É´Áî®
            currentPartyIndex: 0,     // ÁèæÂú®„Ç≥„Éû„É≥„ÉâÂÖ•Âäõ‰∏≠„ÅÆ„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº
            partyActions: [],         // ÂêÑ„É°„É≥„Éê„Éº„ÅÆÈÅ∏Êäû„Ç¢„ÇØ„Ç∑„Éß„É≥ [{type, target, spellId, itemId}, ...]
            executingActionIndex: 0,  // ÂÆüË°å‰∏≠„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
            // Âë≥ÊñπÈÅ∏ÊäûÁî®ÔºàÂõûÂæ©Âë™Êñá„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„Å™„Å©Ôºâ
            isSelectingAlly: false,
            allyTargetIndex: 0
        };

        // „Éê„Éï„ÅÆÊúÄÂ§ßÈáç„Å≠„Åå„ÅëÂõûÊï∞
        const MAX_BUFF_STACK = 2;

        // Êïµ„Ç∞„É´„Éº„ÉóÁîüÊàêÁî®„ÅÆ„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà
        const ENEMY_SUFFIXES = ['A', 'B', 'C', 'D', 'E', 'F'];

        // ÁîüÂ≠ò„Åó„Å¶„ÅÑ„ÇãÊïµ„ÇíÂèñÂæó
        function getAliveEnemies() {
            return battle.enemies.filter(e => e.currentHp > 0);
        }

        // ÊúÄÂàù„ÅÆÁîüÂ≠òÊïµ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó
        function getFirstAliveEnemyIndex() {
            return battle.enemies.findIndex(e => e.currentHp > 0);
        }

        // Ê¨°„ÅÆÁîüÂ≠òÊïµ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó
        // wrap=true: UI„Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏ÊäûÁî®ÔºàÂæ™Áí∞„Åô„ÇãÔºâ
        // wrap=false: „Çø„Éº„É≥Âá¶ÁêÜÁî®Ôºà-1„ÇíËøî„ÅôÔºâ
        function getNextAliveEnemyIndex(currentIndex, wrap = true) {
            for (let i = currentIndex + 1; i < battle.enemies.length; i++) {
                if (battle.enemies[i].currentHp > 0) return i;
            }
            if (!wrap) return -1;  // „Çø„Éº„É≥Âá¶ÁêÜÁî®ÔºöÊ¨°„Åå„ÅÑ„Å™„Åë„Çå„Å∞-1
            for (let i = 0; i < currentIndex; i++) {
                if (battle.enemies[i].currentHp > 0) return i;
            }
            return currentIndex;
        }

        // Ââç„ÅÆÁîüÂ≠òÊïµ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó
        function getPrevAliveEnemyIndex(currentIndex) {
            for (let i = currentIndex - 1; i >= 0; i--) {
                if (battle.enemies[i].currentHp > 0) return i;
            }
            for (let i = battle.enemies.length - 1; i > currentIndex; i--) {
                if (battle.enemies[i].currentHp > 0) return i;
            }
            return currentIndex;
        }

        // „Ç®„É™„Ç¢1„ÅÆ„Ç®„É≥„Ç´„Ç¶„É≥„Çø„Éº„ÉÜ„Éº„Éñ„É´ÔºàÂçò‰Ωì„ÅÆ„ÅøÔºâ
        const AREA1_ENCOUNTER_TABLES = ['field', 'forest', 'dungeon'];

        // Êïµ„Ç∞„É´„Éº„Éó„ÇíÁîüÊàêÔºà1„Äú4‰ΩìÔºâ
        function generateEnemyGroup(encounterTable) {
            const enemies = [];
            const monsterPool = encounterTables[encounterTable] || encounterTables.field;

            // „Ç®„É™„Ç¢1„ÅØÂ∏∏„Å´1‰Ωì„ÄÅ„Ç®„É™„Ç¢2‰ª•Èôç„ÅØË§áÊï∞Âá∫Áèæ
            let enemyCount;
            if (AREA1_ENCOUNTER_TABLES.includes(encounterTable)) {
                enemyCount = 1;
            } else {
                // Âá∫ÁèæÊï∞„ÇíÊ±∫ÂÆöÔºà1„Äú4‰Ωì„ÄÅÈáç„Åø‰ªò„ÅëÔºâ
                const countRoll = Math.random();
                if (countRoll < 0.3) enemyCount = 1;       // 30%: 1‰Ωì
                else if (countRoll < 0.6) enemyCount = 2; // 30%: 2‰Ωì
                else if (countRoll < 0.85) enemyCount = 3; // 25%: 3‰Ωì
                else enemyCount = 4;                       // 15%: 4‰Ωì
            }

            // „É¢„É≥„Çπ„Çø„Éº„Çí„Ç´„Ç¶„É≥„ÉàÔºàÂêåÁ®Æ„ÅÆ„Çµ„Éï„Ç£„ÉÉ„ÇØ„ÇπÁî®Ôºâ
            const monsterCounts = {};

            for (let i = 0; i < enemyCount; i++) {
                const monsterType = monsterPool[Math.floor(Math.random() * monsterPool.length)];
                const monsterData = monsters[monsterType];
                if (!monsterData) continue;

                // ÂêåÁ®Æ„Ç´„Ç¶„É≥„Éà
                if (!monsterCounts[monsterType]) {
                    monsterCounts[monsterType] = 0;
                }
                const suffix = monsterCounts[monsterType] > 0 ? ENEMY_SUFFIXES[monsterCounts[monsterType] - 1] : '';
                monsterCounts[monsterType]++;

                enemies.push({
                    ...monsterData,
                    id: `${monsterType}_${i}`,
                    type: monsterType,
                    displayName: monsterCounts[monsterType] > 1 || enemyCount > 1 ?
                        `${monsterData.name}${suffix || 'A'}` : monsterData.name,
                    currentHp: monsterData.hp,
                    currentMp: monsterData.mp || 0,
                    status: { sleep: 0, poison: 0, blind: 0 },
                    index: i
                });
            }

            // ÂêåÁ®Æ„Åå2‰Ωì‰ª•‰∏ä„ÅÑ„ÇãÂ†¥Âêà„ÄÅÊúÄÂàù„ÅÆÂÄã‰Ωì„Å´„ÇÇ„Çµ„Éï„Ç£„ÉÉ„ÇØ„Çπ„Çí‰ªò„Åë„Çã
            for (const type in monsterCounts) {
                if (monsterCounts[type] > 1) {
                    const firstOfType = enemies.find(e => e.type === type && !e.displayName.match(/[A-F]$/));
                    if (firstOfType) {
                        firstOfType.displayName = `${monsters[type].name}A`;
                    }
                }
            }

            return enemies;
        }

        // ========================================
        // Canvas & „Ç´„É°„É©
        // ========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const fadeOverlay = document.getElementById('fadeOverlay');
        const mapNameElement = document.getElementById('mapName');
        const mapNameArea = document.getElementById('mapNameArea');

        let tileSize = 32;
        let cameraX = 0;
        let cameraY = 0;
        let canvasWidth = 0;
        let canvasHeight = 0;

        function resize() {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            tileSize = Math.floor(canvasWidth / VISIBLE_TILES);
            updateCamera();
        }

        function updateCamera() {
            cameraX = player.x * tileSize - canvasWidth / 2 + tileSize / 2;
            cameraY = player.y * tileSize - canvasHeight / 2 + tileSize / 2;
            const mapPixelWidth = currentMap.cols * tileSize;
            const mapPixelHeight = currentMap.rows * tileSize;
            cameraX = Math.max(0, Math.min(cameraX, mapPixelWidth - canvasWidth));
            cameraY = Math.max(0, Math.min(cameraY, mapPixelHeight - canvasHeight));
        }

        // ========================================
        // „Çª„Éº„Éñ/„É≠„Éº„Éâ
        // ========================================
        function saveGame() {
            const chestStates = {};
            for (const mapId in maps) {
                if (maps[mapId].chests) {
                    chestStates[mapId] = maps[mapId].chests.map(c => ({ id: c.id, isOpened: c.isOpened }));
                }
            }

            // „Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„ÅÆ„Çª„Éº„Éñ„Éá„Éº„Çø„Çí‰ΩúÊàê
            const savedParty = party.map(member => ({
                id: member.id,
                name: member.name,
                job: member.job,
                sprite: member.sprite,
                hp: member.hp,
                maxHp: member.maxHp,
                mp: member.mp,
                maxMp: member.maxMp,
                baseAtk: member.baseAtk,
                baseDef: member.baseDef,
                speed: member.speed,
                level: member.level,
                exp: member.exp,
                spells: [...member.spells],
                equipment: { ...member.equipment },
                isAlive: member.isAlive
            }));

            const saveData = {
                // „Éë„Éº„ÉÜ„Ç£„Ç∑„Çπ„ÉÜ„É†Áî®ÔºàÊñ∞ÂΩ¢ÂºèÔºâ
                party: savedParty,
                partyData: {
                    x: partyData.x,
                    y: partyData.y,
                    direction: partyData.direction,
                    gold: partyData.gold,
                    inventory: JSON.parse(JSON.stringify(partyData.inventory))
                },
                // ÂæåÊñπ‰∫íÊèõÁî®ÔºàÊóßÂΩ¢Âºè„ÇÇ‰øùÊåÅÔºâ
                player: {
                    x: partyData.x, y: partyData.y, direction: partyData.direction,
                    hp: party[0].hp, maxHp: party[0].maxHp, mp: party[0].mp, maxMp: party[0].maxMp,
                    baseAtk: party[0].baseAtk, baseDef: party[0].baseDef, speed: party[0].speed,
                    level: party[0].level, exp: party[0].exp, gold: partyData.gold,
                    inventory: partyData.inventory, spells: party[0].spells,
                    equipment: party[0].equipment
                },
                currentMapId: currentMapId,
                currentMapPath: currentMapPath,
                chestStates: chestStates,
                gameCleared: gameCleared,
                // „Ç≤„Éº„É†ÈÄ≤Ë°å„Éï„É©„Ç∞
                gameProgress: {
                    bossDefeated: { ...gameProgress.bossDefeated },
                    storyFlags: { ...gameProgress.storyFlags },
                    areas: { ...gameProgress.areas },
                    quests: JSON.parse(JSON.stringify(gameProgress.quests)),
                    openedPassages: JSON.parse(JSON.stringify(gameProgress.openedPassages)),
                    visitedLocations: JSON.parse(JSON.stringify(gameProgress.visitedLocations)),
                    lastEntrance: gameProgress.lastEntrance ? { ...gameProgress.lastEntrance } : null
                },
                // „Ç≠„É°„É©„ÅÆ„Å§„Å∞„ÅïÁî®ÔºöÊúÄÂæå„Å´Ë®™„Çå„ÅüÁî∫
                lastTown: { ...lastTown }
            };

            try {
                localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
            } catch (e) {
                console.error('„Çª„Éº„Éñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', e);
            }
        }

        async function loadGame() {
            try {
                const savedData = localStorage.getItem(SAVE_KEY);
                if (!savedData) return false;

                const data = JSON.parse(savedData);

                // Êñ∞ÂΩ¢ÂºèÔºà„Éë„Éº„ÉÜ„Ç£„Ç∑„Çπ„ÉÜ„É†Ôºâ„ÅÆ„É≠„Éº„Éâ
                if (data.party && Array.isArray(data.party)) {
                    // „Éë„Éº„ÉÜ„Ç£ÈÖçÂàó„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÜçÊßãÁØâ
                    party.length = 0;
                    data.party.forEach(memberData => {
                        const member = createPartyMember({
                            id: memberData.id,
                            name: memberData.name,
                            job: memberData.job,
                            sprite: memberData.sprite,
                            hp: memberData.hp,
                            maxHp: memberData.maxHp,
                            mp: memberData.mp,
                            maxMp: memberData.maxMp,
                            baseAtk: memberData.baseAtk,
                            baseDef: memberData.baseDef,
                            speed: memberData.speed,
                            level: memberData.level,
                            exp: memberData.exp,
                            spells: memberData.spells || [],
                            equipment: memberData.equipment
                        });
                        member.isAlive = memberData.isAlive !== false;
                        party.push(member);
                    });

                    // partyData„ÅÆÂæ©ÂÖÉ
                    if (data.partyData) {
                        partyData.x = data.partyData.x;
                        partyData.y = data.partyData.y;
                        partyData.direction = data.partyData.direction || 'down';
                        partyData.gold = data.partyData.gold || 0;
                        partyData.inventory = data.partyData.inventory || [];
                    }

                    // player„ÅÆÂèÇÁÖß„ÇíÊõ¥Êñ∞„Åó„ÄÅ„Éó„É≠„Ç≠„Ç∑„ÇíÂÜçË®≠ÂÆö
                    player = party[0];
                    setupPlayerProxy();

                    // ÂêÑ„É°„É≥„Éê„Éº„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂÜçË®àÁÆó
                    party.forEach(member => {
                        const weapon = items[member.equipment?.weapon];
                        const armor = items[member.equipment?.armor];
                        member.actualAtk = member.baseAtk + (weapon ? weapon.atk : 0);
                        member.actualDef = member.baseDef + (armor ? armor.def : 0);
                    });
                } else {
                    // ÊóßÂΩ¢ÂºèÔºàÂçò‰∏Ä„Éó„É¨„Ç§„É§„ÉºÔºâ„ÅÆ„É≠„Éº„Éâ
                    // Êóß„Çª„Éº„Éñ„Éá„Éº„Çø„Å®„ÅÆ‰∫íÊèõÊÄßÔºàatk/def„ÇíbaseAtk/baseDef„Å´Â§âÊèõÔºâ
                    if (data.player.atk !== undefined && data.player.baseAtk === undefined) {
                        data.player.baseAtk = data.player.atk;
                        delete data.player.atk;
                    }
                    if (data.player.def !== undefined && data.player.baseDef === undefined) {
                        data.player.baseDef = data.player.def;
                        delete data.player.def;
                    }

                    // ÊóßË£ÖÂÇôÂΩ¢Âºè„Åã„Çâ„ÅÆÂ§âÊèõÔºàequippedWeapon/equippedArmor ‚Üí equipmentÔºâ
                    if (data.player.equipment === undefined) {
                        data.player.equipment = {
                            weapon: data.player.equippedWeapon || 10,  // „Åì„Çì„Åº„ÅÜ
                            armor: data.player.equippedArmor || 20     // „Åü„Å≥„Å≥„Å®„ÅÆ„Åµ„Åè
                        };
                        delete data.player.equippedWeapon;
                        delete data.player.equippedArmor;
                    }

                    // Êóß„Ç§„É≥„Éô„É≥„Éà„É™ÂΩ¢Âºè„Åã„Çâ„ÅÆÂ§âÊèõÔºà[1, 1, 2] ‚Üí [{ id: 1, quantity: 2 }, { id: 2, quantity: 1 }]Ôºâ
                    if (data.player.inventory && Array.isArray(data.player.inventory) && data.player.inventory.length > 0) {
                        if (typeof data.player.inventory[0] === 'number') {
                            const migrated = [];
                            data.player.inventory.forEach(itemId => {
                                const existing = migrated.find(s => s.id === itemId);
                                if (existing) {
                                    existing.quantity++;
                                } else {
                                    migrated.push({ id: itemId, quantity: 1 });
                                }
                            });
                            data.player.inventory = migrated;
                        }
                    }

                    // Âë™ÊñáÁøíÂæó„É¨„Éô„É´Â§âÊõ¥„Å´ÂØæÂøúÔºöÁèæÂú®„ÅÆ„É¨„Éô„É´‰ª•‰∏ã„ÅßÁøíÂæó„Åô„Åπ„ÅçÂë™Êñá„ÇíË£úÂÆå
                    if (data.player.spells && data.player.level) {
                        for (const spellId in spells) {
                            const spell = spells[spellId];
                            if (spell.learnLevel <= data.player.level && !data.player.spells.includes(spellId)) {
                                data.player.spells.push(spellId);
                            }
                        }
                    }

                    // Êóß„Éá„Éº„Çø„Çíparty[0]„Å´Â§âÊèõ
                    party.length = 0;
                    const heroData = data.player;
                    const hero = createPartyMember({
                        id: 'hero',
                        name: heroData.name || '„ÇÜ„ÅÜ„Åó„ÇÉ',
                        job: 'hero',
                        sprite: 'üßô',
                        hp: heroData.hp,
                        maxHp: heroData.maxHp,
                        mp: heroData.mp,
                        maxMp: heroData.maxMp,
                        baseAtk: heroData.baseAtk,
                        baseDef: heroData.baseDef,
                        speed: heroData.speed || 6,
                        level: heroData.level,
                        exp: heroData.exp,
                        spells: heroData.spells || [],
                        equipment: heroData.equipment
                    });
                    hero.isAlive = heroData.hp > 0;
                    party.push(hero);
                    player = party[0];
                    setupPlayerProxy();

                    // partyData„ÅÆÂæ©ÂÖÉ
                    partyData.x = heroData.x;
                    partyData.y = heroData.y;
                    partyData.direction = heroData.direction || 'down';
                    partyData.gold = heroData.gold || 0;
                    partyData.inventory = heroData.inventory || [];

                    // „Çπ„ÉÜ„Éº„Çø„ÇπÂÜçË®àÁÆó
                    const weapon = items[hero.equipment?.weapon];
                    const armor = items[hero.equipment?.armor];
                    hero.actualAtk = hero.baseAtk + (weapon ? weapon.atk : 0);
                    hero.actualDef = hero.baseDef + (armor ? armor.def : 0);
                }
                currentMapId = data.currentMapId;

                // „Éû„ÉÉ„Éó„Éë„Çπ„ÅÆË™≠„ÅøËæº„ÅøÔºàÊñ∞ÂΩ¢ÂºèÂØæÂøúÔºâ
                if (data.currentMapPath) {
                    currentMapPath = data.currentMapPath;
                } else {
                    // Êóß„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆÂ†¥Âêà„ÅØID„Åã„Çâ„Éë„Çπ„ÇíÁîüÊàê
                    currentMapPath = `maps/${currentMapId}.json`;
                }

                // „Éû„ÉÉ„Éó„ÅÆË™≠„ÅøËæº„ÅøÔºàÂ§ñÈÉ®JSON„ÇíÂÑ™ÂÖà„Åó„Å¶„É≠„Éº„ÉâÔºâ
                try {
                    const mapData = await loadMapFromDatabase(currentMapPath);
                    // Â§ñÈÉ®JSON„Éû„ÉÉ„Éó„Åß„ÅÇ„Çã„Åì„Å®„Çí„Éû„Éº„ÇØ
                    mapData._isExternal = true;
                    currentMap = {
                        data: mapData.data.map(row => [...row]),
                        cols: mapData.cols,
                        rows: mapData.rows,
                        npcs: JSON.parse(JSON.stringify(mapData.npcs || [])),
                        chests: JSON.parse(JSON.stringify(mapData.chests || [])),
                        warps: mapData.warps ? [...mapData.warps] : [],
                        name: mapData.name,
                        type: mapData.type,
                        encounterRate: mapData.encounterRate,
                        mapId: mapData.mapId,
                        _isExternal: true
                    };
                    maps[mapData.mapId] = mapData;
                    currentMapId = mapData.mapId;
                } catch (err) {
                    console.error('„Éû„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº„ÄÅÂÜÖËîµ„Éû„ÉÉ„Éó„Çí‰ΩøÁî®:', err);
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂÜÖËîµ„Éû„ÉÉ„Éó„Çí‰ΩøÁî®
                    if (maps[currentMapId]) {
                        const sourceMap = maps[currentMapId];
                        currentMap = {
                            data: sourceMap.data.map(row => [...row]),
                            cols: sourceMap.cols,
                            rows: sourceMap.rows,
                            npcs: JSON.parse(JSON.stringify(sourceMap.npcs || [])),
                            chests: JSON.parse(JSON.stringify(sourceMap.chests || [])),
                            warps: sourceMap.warps ? [...sourceMap.warps] : [],
                            name: sourceMap.name,
                            type: sourceMap.type,
                            encounterRate: sourceMap.encounterRate
                        };
                    } else {
                        const fieldMap = maps['field'];
                        currentMap = {
                            data: fieldMap.data.map(row => [...row]),
                            cols: fieldMap.cols,
                            rows: fieldMap.rows,
                            npcs: JSON.parse(JSON.stringify(fieldMap.npcs || [])),
                            chests: JSON.parse(JSON.stringify(fieldMap.chests || [])),
                            warps: fieldMap.warps ? [...fieldMap.warps] : [],
                            name: fieldMap.name,
                            type: fieldMap.type,
                            encounterRate: fieldMap.encounterRate
                        };
                        currentMapId = 'field';
                    }
                }
                mapNameElement.textContent = currentMap.name;

                if (data.chestStates) {
                    for (const mapId in data.chestStates) {
                        // mapsÂÅ¥„Å´Âæ©ÂÖÉ
                        if (maps[mapId] && maps[mapId].chests) {
                            for (const savedChest of data.chestStates[mapId]) {
                                const chest = maps[mapId].chests.find(c => c.id === savedChest.id);
                                if (chest) chest.isOpened = savedChest.isOpened;
                            }
                        }
                        // currentMapÂÅ¥„Å´„ÇÇÂæ©ÂÖÉÔºàÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„ÅÆÂ†¥ÂêàÔºâ
                        if (mapId === currentMapId && currentMap && currentMap.chests) {
                            for (const savedChest of data.chestStates[mapId]) {
                                const chest = currentMap.chests.find(c => c.id === savedChest.id);
                                if (chest) chest.isOpened = savedChest.isOpened;
                            }
                        }
                    }
                }

                // È≠îÁéãË®é‰ºê„Éï„É©„Ç∞„ÅÆË™≠„ÅøËæº„Åø
                if (data.gameCleared !== undefined) {
                    gameCleared = data.gameCleared;
                }

                // „Ç≤„Éº„É†ÈÄ≤Ë°å„Éï„É©„Ç∞„ÅÆË™≠„ÅøËæº„ÅøÔºàÂæåÊñπ‰∫íÊèõÊÄßÂØæÂøúÔºâ
                if (data.gameProgress) {
                    // ‰øùÂ≠ò„Åï„Çå„Åü„Éï„É©„Ç∞„ÇíÂæ©ÂÖÉ
                    if (data.gameProgress.bossDefeated) {
                        Object.assign(gameProgress.bossDefeated, data.gameProgress.bossDefeated);
                    }
                    if (data.gameProgress.storyFlags) {
                        Object.assign(gameProgress.storyFlags, data.gameProgress.storyFlags);
                    }
                    if (data.gameProgress.areas) {
                        gameProgress.areas = { ...data.gameProgress.areas };
                    }
                    // „ÇØ„Ç®„Çπ„Éà„Éï„É©„Ç∞„ÅÆÂæ©ÂÖÉ
                    if (data.gameProgress.quests) {
                        for (const questName in data.gameProgress.quests) {
                            if (gameProgress.quests[questName]) {
                                Object.assign(gameProgress.quests[questName], data.gameProgress.quests[questName]);
                            }
                        }
                    }
                    // Èö†„ÅóÈÄöË∑Ø„ÅÆÂæ©ÂÖÉ
                    if (data.gameProgress.openedPassages) {
                        gameProgress.openedPassages = JSON.parse(JSON.stringify(data.gameProgress.openedPassages));
                    }
                    // „É´„Éº„É©Áî®ÔºöË®™ÂïèÊ∏à„ÅøÊã†ÁÇπ„ÅÆÂæ©ÂÖÉ
                    if (data.gameProgress.visitedLocations) {
                        gameProgress.visitedLocations = JSON.parse(JSON.stringify(data.gameProgress.visitedLocations));
                    }
                    // „É™„É¨„Éü„ÉàÁî®Ôºö„ÉÄ„É≥„Ç∏„Éß„É≥ÂÖ•Âè£„ÅÆÂæ©ÂÖÉ
                    if (data.gameProgress.lastEntrance) {
                        gameProgress.lastEntrance = { ...data.gameProgress.lastEntrance };
                    }
                } else {
                    // Êóß„Çª„Éº„Éñ„Éá„Éº„Çø„Åã„Çâ„ÅÆÁßªË°åÔºögameCleared„Åã„ÇâmaouÊíÉÁ†¥„Éï„É©„Ç∞„ÇíÊé®Ê∏¨
                    gameProgress.bossDefeated.maou = gameCleared;
                    gameProgress.storyFlags.reportedMidBossDefeat = false;
                    gameProgress.storyFlags.portalRoomUnlocked = false;
                }

                // „Ç≠„É°„É©„ÅÆ„Å§„Å∞„ÅïÁî®ÔºöÊúÄÂæå„Å´Ë®™„Çå„ÅüÁî∫„ÇíÂæ©ÂÖÉ
                if (data.lastTown) {
                    lastTown = { ...data.lastTown };
                }

                // „É≠„Éº„ÉâÂæå„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂÜçË®àÁÆó
                updateActualStats();
                return true;
            } catch (e) {
                console.error('„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', e);
                return false;
            }
        }

        // ========================================
        // ÊèèÁîªÈñ¢Êï∞
        // ========================================
        function getTileColor(tile) {
            const mapColors = MAP_TILE_COLORS[currentMap.type];
            if (mapColors && mapColors[tile] !== undefined) return mapColors[tile];
            return DEFAULT_TILE_COLORS[tile] || '#333';
        }

        let drawMapDebugCount = 0;
        function drawMap() {
            if (drawMapDebugCount < 3) {
                console.log('[DEBUG drawMap] tileSize:', tileSize, 'cameraX:', cameraX, 'cameraY:', cameraY);
                console.log('[DEBUG drawMap] currentMap.cols:', currentMap.cols, 'currentMap.rows:', currentMap.rows);
                drawMapDebugCount++;
            }

            // tileSize„Åå0„ÅÆÂ†¥Âêà„ÅØÊèèÁîª„Åó„Å™„ÅÑ
            if (tileSize <= 0) {
                console.warn('[DEBUG drawMap] tileSize is 0 or negative!');
                return;
            }

            const startCol = Math.floor(cameraX / tileSize);
            const startRow = Math.floor(cameraY / tileSize);
            const endCol = Math.min(currentMap.cols, startCol + Math.ceil(canvasWidth / tileSize) + 2);
            const endRow = Math.min(currentMap.rows, startRow + Math.ceil(canvasHeight / tileSize) + 2);

            for (let row = Math.max(0, startRow); row < endRow; row++) {
                for (let col = Math.max(0, startCol); col < endCol; col++) {
                    const tile = currentMap.data[row][col];
                    const screenX = col * tileSize - cameraX;
                    const screenY = row * tileSize - cameraY;
                    ctx.fillStyle = getTileColor(tile);
                    ctx.fillRect(screenX, screenY, tileSize + 1, tileSize + 1);
                    drawTileDecoration(tile, screenX, screenY, col, row);
                }
            }
        }

        function drawTileDecoration(tile, x, y, col, row) {
            ctx.save();
            ctx.font = `${tileSize * 0.7}px serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            if (tile === TILE.GRASS) {
                const seed = (col * 7 + row * 13) % 100;
                if (seed < 25) {
                    ctx.font = `${tileSize * 0.3}px serif`;
                    ctx.fillText('üåø', x + tileSize * 0.5, y + tileSize * 0.5);
                }
            } else if (tile === TILE.MOUNTAIN) {
                ctx.fillText('‚õ∞Ô∏è', x + tileSize / 2, y + tileSize / 2);
            } else if (tile === TILE.SEA) {
                ctx.strokeStyle = 'rgba(100, 180, 255, 0.4)';
                ctx.lineWidth = 2;
                const waveOffset = (Date.now() / 500) % (Math.PI * 2);
                for (let i = 0; i < 3; i++) {
                    const waveY = y + tileSize * (0.3 + i * 0.25);
                    ctx.beginPath();
                    ctx.moveTo(x, waveY);
                    for (let wx = 0; wx <= tileSize; wx += 4) {
                        ctx.lineTo(x + wx, waveY + Math.sin(waveOffset + wx * 0.1 + i) * 2);
                    }
                    ctx.stroke();
                }
            } else if (tile === TILE.CASTLE) {
                ctx.fillText('üè∞', x + tileSize / 2, y + tileSize / 2);
            } else if (tile === TILE.TOWN) {
                ctx.fillText('üèòÔ∏è', x + tileSize / 2, y + tileSize / 2);
            } else if (tile === TILE.STAIRS) {
                ctx.fillText('ü™ú', x + tileSize / 2, y + tileSize / 2);
            } else if (tile === TILE.FLOOR) {
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.15)';
                ctx.strokeRect(x + 2, y + 2, tileSize - 4, tileSize - 4);
            } else if (tile === TILE.WALL) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(x, y + tileSize - 4, tileSize, 4);
            } else if (tile === TILE.PORTAL) {
                // ÊóÖ„ÅÆÊââÔºöÊ∏¶Â∑ª„Åç„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                const time = Date.now() / 500;
                ctx.save();
                ctx.translate(x + tileSize / 2, y + tileSize / 2);
                ctx.rotate(time % (Math.PI * 2));
                ctx.font = `${tileSize * 0.8}px serif`;
                ctx.fillText('üåÄ', 0, 0);
                ctx.restore();
            } else if (tile === TILE.STAIRS_UP) {
                ctx.fillText('‚¨ÜÔ∏è', x + tileSize / 2, y + tileSize / 2);
            } else if (tile === TILE.STAIRS_DOWN) {
                ctx.fillText('‚¨áÔ∏è', x + tileSize / 2, y + tileSize / 2);
            }
            ctx.restore();
        }

        function drawChests() {
            if (!currentMap.chests) return;
            for (const chest of currentMap.chests) {
                const screenX = chest.x * tileSize - cameraX;
                const screenY = chest.y * tileSize - cameraY;
                if (screenX < -tileSize || screenX > canvasWidth || screenY < -tileSize || screenY > canvasHeight) continue;
                ctx.font = `${tileSize * 0.7}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(chest.isOpened ? 'üì¶' : 'üéÅ', screenX + tileSize / 2, screenY + tileSize / 2);
            }
        }

        function drawNPCs() {
            if (!currentMap.npcs) return;
            for (const npc of currentMap.npcs) {
                const pos = getNpcEffectivePosition(npc);
                const screenX = pos.x * tileSize - cameraX;
                const screenY = pos.y * tileSize - cameraY;
                if (screenX < -tileSize || screenX > canvasWidth || screenY < -tileSize || screenY > canvasHeight) continue;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.ellipse(screenX + tileSize / 2, screenY + tileSize * 0.9, tileSize * 0.3, tileSize * 0.1, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = `${tileSize * 0.7}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(npc.sprite, screenX + tileSize / 2, screenY + tileSize / 2);
            }
        }

        function drawPlayer() {
            const screenX = player.x * tileSize - cameraX;
            const screenY = player.y * tileSize - cameraY;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.ellipse(screenX + tileSize / 2, screenY + tileSize * 0.9, tileSize * 0.35, tileSize * 0.12, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#ffcc00';
            ctx.fillRect(screenX + tileSize * 0.25, screenY + tileSize * 0.2, tileSize * 0.5, tileSize * 0.6);
            ctx.fillStyle = '#000';
            if (player.direction !== 'up') {
                ctx.fillRect(screenX + tileSize * 0.35, screenY + tileSize * 0.35, tileSize * 0.08, tileSize * 0.08);
                ctx.fillRect(screenX + tileSize * 0.55, screenY + tileSize * 0.35, tileSize * 0.08, tileSize * 0.08);
            }
            ctx.font = `${tileSize * 0.4}px serif`;
            ctx.textAlign = 'center';
            ctx.fillText('‚öîÔ∏è', screenX + tileSize / 2, screenY + tileSize * 0.15);
        }

        function drawMessageWindow() {
            if (!dialog.active) return;
            const padding = 20;
            const textPadding = 20;
            const windowX = padding;
            const windowWidth = canvasWidth - padding * 2;
            const maxTextWidth = windowWidth - textPadding * 2;

            // „Éï„Ç©„É≥„ÉàË®≠ÂÆö
            const fontSize = Math.floor(tileSize * 0.42);
            const lineHeight = fontSize * 1.4;
            const font = `${fontSize}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;

            // „ÉÜ„Ç≠„Çπ„Éà„ÅÆË°åÊï∞„ÇíË®àÁÆó„Åó„Å¶„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅÆÈ´ò„Åï„ÇíÂãïÁöÑ„Å´Ê±∫ÂÆö
            const lines = wrapText(dialog.displayedText, maxTextWidth, font);
            const minLines = 2;
            const numLines = Math.max(minLines, lines.length);
            const windowHeight = textPadding * 2 + lineHeight * numLines + 10;
            const windowY = canvasHeight - windowHeight - 180;

            drawWindow(windowX, windowY, windowWidth, windowHeight);

            ctx.fillStyle = '#fff';
            ctx.font = font;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            // Êäò„ÇäËøî„Åó„ÉÜ„Ç≠„Çπ„Éà„ÇíÊèèÁîª
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], windowX + textPadding, windowY + textPadding + i * lineHeight);
            }

            if (!dialog.isTyping && dialog.currentIndex < dialog.messages.length - 1) {
                const blinkAlpha = Math.sin(Date.now() / 200) * 0.5 + 0.5;
                ctx.fillStyle = `rgba(255, 255, 255, ${blinkAlpha})`;
                ctx.font = `${tileSize * 0.4}px serif`;
                ctx.textAlign = 'right';
                ctx.fillText('‚ñº', windowX + windowWidth - 20, windowY + windowHeight - 25);
            }
        }

        function drawWindow(x, y, w, h) {
            ctx.fillStyle = 'rgba(0, 0, 50, 0.95)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.strokeRect(x + 2, y + 2, w - 4, h - 4);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.strokeRect(x + 8, y + 8, w - 16, h - 16);
        }

        // „ÉÜ„Ç≠„Çπ„Éà„ÇíÊåáÂÆöÂπÖ„ÅßÊäò„ÇäËøî„Åó„Å¶Ë°å„ÅÆÈÖçÂàó„ÇíËøî„Åô
        function wrapText(text, maxWidth, font) {
            ctx.font = font;
            const words = [];
            // Êó•Êú¨Ë™û„ÅØÊñáÂ≠óÂçò‰Ωç„ÄÅËã±Êï∞Â≠ó„ÅØÂçòË™ûÂçò‰Ωç„ÅßÂàÜÂâ≤
            let currentWord = '';
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                // Êó•Êú¨Ë™ûÊñáÂ≠óÂà§ÂÆöÔºà„Å≤„Çâ„Åå„Å™„ÄÅ„Ç´„Çø„Ç´„Éä„ÄÅÊº¢Â≠ó„ÄÅÂÖ®ËßíË®òÂè∑Ôºâ
                if (/[\u3000-\u9FFF\uFF00-\uFFEF]/.test(char)) {
                    if (currentWord) {
                        words.push(currentWord);
                        currentWord = '';
                    }
                    words.push(char);
                } else if (char === ' ') {
                    if (currentWord) {
                        words.push(currentWord);
                        currentWord = '';
                    }
                } else {
                    currentWord += char;
                }
            }
            if (currentWord) words.push(currentWord);

            const lines = [];
            let currentLine = '';

            for (const word of words) {
                const testLine = currentLine + word;
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }
            if (currentLine) lines.push(currentLine);

            return lines.length > 0 ? lines : [''];
        }

        // Ë§áÊï∞Ë°å„ÉÜ„Ç≠„Çπ„Éà„ÇíÊèèÁîª
        function drawWrappedText(text, x, y, maxWidth, lineHeight, font) {
            ctx.font = font;
            const lines = wrapText(text, maxWidth, font);
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], x, y + i * lineHeight);
            }
            return lines.length;
        }

        function drawMenu() {
            if (!menu.active) return;
            const menuWidth = canvasWidth * 0.85;
            const menuHeight = canvasHeight * 0.75;
            const menuX = (canvasWidth - menuWidth) / 2;
            const menuY = (canvasHeight - menuHeight) / 2;

            drawWindow(menuX, menuY, menuWidth, menuHeight);

            // „Çø„ÉñË°®Á§∫Ôºà4„Çø„ÉñÔºö„Å§„Çà„Åï„ÄÅ„Åò„ÇÖ„ÇÇ„Çì„ÄÅ„ÇÇ„Å°„ÇÇ„ÅÆ„ÄÅ„Å°„ÅöÔºâ
            const tabY = menuY + 10;
            ctx.font = `${tileSize * 0.32}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            // „Å§„Çà„Åï„Çø„Éñ
            ctx.fillStyle = menu.mode === 'status' ? '#ffd700' : 'rgba(255, 255, 255, 0.5)';
            ctx.fillText('„Å§„Çà„Åï', menuX + menuWidth * 0.125, tabY);

            // „Åò„ÇÖ„ÇÇ„Çì„Çø„Éñ
            ctx.fillStyle = menu.mode === 'spells' ? '#ffd700' : 'rgba(255, 255, 255, 0.5)';
            ctx.fillText('„Åò„ÇÖ„ÇÇ„Çì', menuX + menuWidth * 0.375, tabY);

            // „ÇÇ„Å°„ÇÇ„ÅÆ„Çø„Éñ
            ctx.fillStyle = menu.mode === 'items' ? '#ffd700' : 'rgba(255, 255, 255, 0.5)';
            ctx.fillText('„ÇÇ„Å°„ÇÇ„ÅÆ', menuX + menuWidth * 0.625, tabY);

            // „Å°„Åö„Çø„Éñ
            ctx.fillStyle = menu.mode === 'map' ? '#ffd700' : 'rgba(255, 255, 255, 0.5)';
            ctx.fillText('„Å°„Åö', menuX + menuWidth * 0.875, tabY);

            // Âå∫Âàá„ÇäÁ∑ö
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.moveTo(menuX + 15, tabY + tileSize * 0.5);
            ctx.lineTo(menuX + menuWidth - 15, tabY + tileSize * 0.5);
            ctx.stroke();

            const contentY = tabY + tileSize * 0.7;
            const lineHeight = tileSize * 0.5;

            if (menu.mode === 'status') {
                // „Å§„Çà„ÅïÔºà„Çπ„ÉÜ„Éº„Çø„ÇπÁîªÈù¢Ôºâ
                ctx.fillStyle = '#fff';
                ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.textAlign = 'left';

                // Ë§áÊï∞„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØ„É°„É≥„Éê„ÉºÈÅ∏ÊäûË°®Á§∫
                if (party.length > 1) {
                    // „Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº‰∏ÄË¶ßÔºàÂ∑¶ÂÅ¥Ôºâ
                    const memberListX = menuX + 15;
                    const memberListY = contentY + 5;
                    const memberListWidth = menuWidth * 0.28;

                    ctx.font = `${tileSize * 0.32}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    party.forEach((member, idx) => {
                        const isSelected = idx === menu.memberCursor;
                        const isDead = !member.isAlive || member.hp <= 0;

                        if (isSelected) {
                            ctx.fillStyle = 'rgba(255, 215, 0, 0.2)';
                            ctx.fillRect(memberListX - 5, memberListY + idx * lineHeight * 0.9 - 3, memberListWidth, lineHeight * 0.85);
                        }

                        ctx.fillStyle = isSelected ? '#ffd700' : (isDead ? '#888' : '#fff');
                        const cursor = isSelected ? '‚ñ∂' : ' ';
                        ctx.fillText(`${cursor}${member.name}`, memberListX, memberListY + idx * lineHeight * 0.9);
                    });

                    // Âå∫Âàá„ÇäÁ∑ö
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.beginPath();
                    ctx.moveTo(menuX + memberListWidth + 20, contentY);
                    ctx.lineTo(menuX + memberListWidth + 20, menuY + menuHeight - 35);
                    ctx.stroke();
                }

                // ÈÅ∏Êäû‰∏≠„ÅÆ„É°„É≥„Éê„Éº„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
                const selectedMember = party[menu.memberCursor] || party[0];
                const col1X = party.length > 1 ? menuX + menuWidth * 0.32 : menuX + 20;
                const col2X = party.length > 1 ? menuX + menuWidth * 0.75 : menuX + menuWidth * 0.55;
                let y = contentY + 10;

                ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.fillStyle = '#ffd700';
                ctx.fillText(selectedMember.name, col1X, y);
                ctx.fillStyle = '#fff';
                ctx.fillText(`Lv ${selectedMember.level}`, col2X, y);
                y += lineHeight * 1.3;

                ctx.fillText(`HP`, col1X, y);
                const hpColor = selectedMember.hp <= selectedMember.maxHp * 0.25 ? '#f44' :
                               selectedMember.hp <= selectedMember.maxHp * 0.5 ? '#ff4' : '#fff';
                ctx.fillStyle = hpColor;
                ctx.fillText(`${selectedMember.hp} / ${selectedMember.maxHp}`, col2X, y);
                ctx.fillStyle = '#fff';
                y += lineHeight;

                ctx.fillText(`MP`, col1X, y);
                ctx.fillText(`${selectedMember.mp} / ${selectedMember.maxMp}`, col2X, y);
                y += lineHeight * 1.3;

                ctx.fillText(`„Å°„Åã„Çâ`, col1X, y);
                ctx.fillText(`${selectedMember.baseAtk}`, col2X, y);
                y += lineHeight;

                ctx.fillText(`„Åø„ÅÆ„Åæ„ÇÇ„Çä`, col1X, y);
                ctx.fillText(`${selectedMember.baseDef}`, col2X, y);
                y += lineHeight;

                ctx.fillText(`„Åô„Å∞„ÇÑ„Åï`, col1X, y);
                ctx.fillText(`${selectedMember.speed}`, col2X, y);
                y += lineHeight;

                // „Åì„ÅÜ„Åí„ÅçÂäõ„Éª„Åó„ÇÖ„Å≥ÂäõÔºàË£ÖÂÇôËæº„ÅøÔºâ
                ctx.fillStyle = '#4f4';
                ctx.fillText(`„Åì„ÅÜ„Åí„ÅçÂäõ`, col1X, y);
                ctx.fillText(`${selectedMember.actualAtk}`, col2X, y);
                y += lineHeight;

                ctx.fillText(`„Åó„ÇÖ„Å≥Âäõ`, col1X, y);
                ctx.fillText(`${selectedMember.actualDef}`, col2X, y);
                ctx.fillStyle = '#fff';
                y += lineHeight * 0.8;

                ctx.fillText(`„Åë„ÅÑ„Åë„Çì„Å°`, col1X, y);
                ctx.fillText(`${selectedMember.exp}`, col2X, y);
                y += lineHeight;

                // Ê¨°„ÅÆ„É¨„Éô„É´„Åæ„Åß„ÅÆÁµåÈ®ìÂÄ§
                const nextLevelExp = selectedMember.level < expTable.length - 1 ? expTable[selectedMember.level + 1] : null;
                if (nextLevelExp !== null) {
                    const needed = nextLevelExp - selectedMember.exp;
                    ctx.fillText(`„Å§„Åé„ÅÆLv„Åæ„Åß`, col1X, y);
                    ctx.fillText(`„ÅÇ„Å® ${needed}`, col2X, y);
                } else {
                    ctx.fillText(`„Åï„ÅÑ„Å†„ÅÑ„É¨„Éô„É´`, col1X, y);
                }
                y += lineHeight * 1.3;

                ctx.fillStyle = '#ffd700';
                ctx.fillText(`„Ç¥„Éº„É´„Éâ`, col1X, y);
                ctx.fillStyle = '#fff';
                ctx.fillText(`${partyData.gold} G`, col2X, y);
                y += lineHeight * 1.5;

                // Ë£ÖÂÇôË°®Á§∫
                ctx.fillStyle = '#aaa';
                ctx.fillText('‚îÄ „Åù„ÅÜ„Å≥ ‚îÄ', col1X, y);
                y += lineHeight;

                const weapon = items[selectedMember.equipment?.weapon];
                const armor = items[selectedMember.equipment?.armor];
                ctx.fillStyle = '#fff';
                ctx.fillText(`‚öîÔ∏è E: ${weapon ? weapon.name : '„Å™„Åó'}`, col1X, y);
                y += lineHeight;
                ctx.fillText(`üõ°Ô∏è E: ${armor ? armor.name : '„Å™„Åó'}`, col1X, y);

            } else if (menu.mode === 'spells') {
                // „Åò„ÇÖ„ÇÇ„ÇìÔºàÂë™ÊñáÁîªÈù¢Ôºâ
                ctx.fillStyle = '#fff';
                ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.textAlign = 'left';

                // Ë§áÊï∞„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØ„É°„É≥„Éê„ÉºÈÅ∏ÊäûË°®Á§∫
                if (party.length > 1) {
                    // „Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº‰∏ÄË¶ßÔºàÂ∑¶ÂÅ¥Ôºâ
                    const memberListX = menuX + 15;
                    const memberListY = contentY + 5;
                    const memberListWidth = menuWidth * 0.28;

                    ctx.font = `${tileSize * 0.32}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    party.forEach((member, idx) => {
                        const isSelected = idx === menu.memberCursor;
                        const isDead = !member.isAlive || member.hp <= 0;

                        if (isSelected) {
                            ctx.fillStyle = 'rgba(255, 215, 0, 0.2)';
                            ctx.fillRect(memberListX - 5, memberListY + idx * lineHeight * 0.9 - 3, memberListWidth, lineHeight * 0.85);
                        }

                        ctx.fillStyle = isSelected ? '#ffd700' : (isDead ? '#888' : '#fff');
                        const cursor = isSelected ? '‚ñ∂' : ' ';
                        ctx.fillText(`${cursor}${member.name}`, memberListX, memberListY + idx * lineHeight * 0.9);
                    });

                    // Âå∫Âàá„ÇäÁ∑ö
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.beginPath();
                    ctx.moveTo(menuX + memberListWidth + 20, contentY);
                    ctx.lineTo(menuX + memberListWidth + 20, menuY + menuHeight - 35);
                    ctx.stroke();
                }

                // ÈÅ∏Êäû‰∏≠„ÅÆ„É°„É≥„Éê„Éº„ÅÆÂë™ÊñáË°®Á§∫
                const selectedMember = party[menu.memberCursor] || party[0];
                const spellListX = party.length > 1 ? menuX + menuWidth * 0.32 : menuX + 30;
                const spellStartY = contentY + 10;

                ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;

                if (selectedMember.spells.length === 0) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    const centerX = party.length > 1 ? menuX + menuWidth * 0.65 : canvasWidth / 2;
                    ctx.textAlign = 'center';
                    ctx.fillText('Âë™Êñá„ÇíË¶ö„Åà„Å¶„ÅÑ„Å™„ÅÑ', centerX, spellStartY);
                } else {
                    ctx.textAlign = 'left';
                    selectedMember.spells.forEach((spellId, i) => {
                        const spell = spells[spellId];
                        if (spell) {
                            const isSelected = (i === menu.spellCursor);
                            const canUseInField = spell.type === 'heal' || spell.type === 'travel';

                            // „Éï„Ç£„Éº„É´„Éâ„Åß‰Ωø„Åà„Å™„ÅÑÂë™Êñá„ÅØÊöó„ÅèË°®Á§∫
                            if (canUseInField) {
                                ctx.fillStyle = isSelected ? '#ffd700' : '#fff';
                            } else {
                                ctx.fillStyle = isSelected ? '#aa8800' : 'rgba(255, 255, 255, 0.4)';
                            }

                            const cursor = isSelected ? '‚ñ∂' : '„Éª';
                            ctx.fillText(`${cursor}${spell.name}`, spellListX, spellStartY + i * lineHeight);

                            // MPË°®Á§∫
                            ctx.fillStyle = selectedMember.mp >= spell.mp ? '#88f' : '#f44';
                            ctx.fillText(`${spell.mp}MP`, menuX + menuWidth - 70, spellStartY + i * lineHeight);
                        }
                    });

                    // „É°„É≥„Éê„ÉºÈÅ∏Êäû„É¢„Éº„ÉâÊôÇÔºàÂõûÂæ©Âë™Êñá„ÅÆÂØæË±°ÈÅ∏ÊäûÔºâ
                    if (menu.selectingMember) {
                        const targetWindowWidth = menuWidth * 0.35;
                        const targetWindowHeight = tileSize * (party.length * 0.6 + 0.5);
                        const targetWindowX = menuX + menuWidth - targetWindowWidth - 15;
                        const targetWindowY = menuY + menuHeight - targetWindowHeight - 40;

                        drawWindow(targetWindowX, targetWindowY, targetWindowWidth, targetWindowHeight);

                        ctx.font = `${tileSize * 0.32}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                        ctx.fillStyle = '#ffd700';
                        ctx.textAlign = 'center';
                        ctx.fillText('„Å†„Çå„Å´Ôºü', targetWindowX + targetWindowWidth / 2, targetWindowY + 12);

                        ctx.textAlign = 'left';
                        party.forEach((member, idx) => {
                            const isTarget = idx === menu.targetMemberCursor;
                            ctx.fillStyle = isTarget ? '#ffd700' : '#fff';
                            const cursor = isTarget ? '‚ñ∂' : ' ';
                            ctx.fillText(`${cursor}${member.name}`, targetWindowX + 15, targetWindowY + 35 + idx * lineHeight * 0.8);
                        });
                    }
                }
            } else if (menu.mode === 'items') {
                // „ÇÇ„Å°„ÇÇ„ÅÆÔºà„Ç¢„Ç§„ÉÜ„É†ÁîªÈù¢Ôºâ
                ctx.fillStyle = '#fff';
                ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.textAlign = 'left';
                const itemStartY = contentY + 10;

                if (player.inventory.length === 0) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.textAlign = 'center';
                    ctx.fillText('„Ç¢„Ç§„ÉÜ„É†„ÇíÊåÅ„Å£„Å¶„ÅÑ„Å™„ÅÑ', canvasWidth / 2, itemStartY);
                } else {
                    player.inventory.forEach((slot, i) => {
                        const item = items[slot.id];
                        if (item) {
                            // ÈÅ∏Êäû‰∏≠„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅØ„Éè„Ç§„É©„Ç§„Éà
                            const isSelected = (i === menu.itemCursor);
                            ctx.fillStyle = isSelected ? '#ffd700' : '#fff';
                            const cursor = isSelected ? '‚ñ∂' : '„Éª';

                            // ÂÄãÊï∞Ë°®Á§∫Ôºà2ÂÄã‰ª•‰∏ä„ÅÆÂ†¥ÂêàÔºâ
                            let displayName = item.name;
                            if (slot.quantity > 1) {
                                displayName += ` x ${slot.quantity}`;
                            }
                            ctx.fillText(`${cursor}${displayName}`, menuX + 30, itemStartY + i * lineHeight);

                            // Ë£ÖÂÇôÂìÅ„Å´„ÅØ„Çø„Ç§„ÉóË°®Á§∫
                            if (item.type === 'weapon') {
                                ctx.fillStyle = '#88f';
                                ctx.fillText('‚öîÔ∏è', menuX + menuWidth - 50, itemStartY + i * lineHeight);
                            } else if (item.type === 'armor') {
                                ctx.fillStyle = '#8f8';
                                ctx.fillText('üõ°Ô∏è', menuX + menuWidth - 50, itemStartY + i * lineHeight);
                            }
                        }
                    });

                    // „Ç¢„Ç§„ÉÜ„É†„Ç¢„ÇØ„Ç∑„Éß„É≥„Çµ„Éñ„É°„Éã„É•„Éº
                    if (menu.showItemAction && player.inventory.length > 0) {
                        const slot = player.inventory[menu.itemCursor];
                        const selectedItemId = slot ? slot.id : null;
                        const selectedItem = selectedItemId ? items[selectedItemId] : null;
                        if (selectedItem) {
                            const subMenuWidth = tileSize * 3.5;
                            const subMenuHeight = tileSize * 2;
                            const subMenuX = menuX + menuWidth - subMenuWidth - 20;
                            const subMenuY = itemStartY + menu.itemCursor * lineHeight - 5;

                            drawWindow(subMenuX, subMenuY, subMenuWidth, subMenuHeight);

                            ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                            ctx.textAlign = 'left';

                            // „Ç¢„ÇØ„Ç∑„Éß„É≥ÈÅ∏ÊäûËÇ¢
                            let actions = [];
                            if (selectedItem.type === 'weapon' || selectedItem.type === 'armor') {
                                actions = ['„Åù„ÅÜ„Å≥„Åô„Çã', '„Åô„Å¶„Çã', '„ÇÑ„ÇÅ„Çã'];
                            } else {
                                actions = ['„Å§„Åã„ÅÜ', '„Åô„Å¶„Çã', '„ÇÑ„ÇÅ„Çã'];
                            }

                            actions.forEach((action, i) => {
                                const isActionSelected = (i === menu.itemActionIndex);
                                ctx.fillStyle = isActionSelected ? '#ffd700' : '#fff';
                                const actionCursor = isActionSelected ? '‚ñ∂' : ' ';
                                ctx.fillText(`${actionCursor}${action}`, subMenuX + 15, subMenuY + 20 + i * (tileSize * 0.45));
                            });
                        }
                    }
                }
            } else if (menu.mode === 'map') {
                // „Å°„ÅöÔºà„Éû„ÉÉ„ÉóÁîªÈù¢„Å∏„ÅÆÊ°àÂÜÖÔºâ
                ctx.fillStyle = '#fff';
                ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.textAlign = 'center';

                const mapInfoY = contentY + 30;
                ctx.fillStyle = '#ffd700';
                ctx.fillText(`üìç ${currentMap.name || '„Éï„Ç£„Éº„É´„Éâ'}`, canvasWidth / 2, mapInfoY);

                ctx.fillStyle = '#fff';
                ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.fillText('A„Éú„Çø„É≥„ÅßÂú∞Âõ≥„ÇíÈñã„Åè', canvasWidth / 2, mapInfoY + lineHeight * 2);

                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.font = `${tileSize * 0.3}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.fillText('ÔºàM„Ç≠„Éº„Åß„ÅÑ„Å§„Åß„ÇÇÈñã„Åë„Åæ„ÅôÔºâ', canvasWidth / 2, mapInfoY + lineHeight * 3.5);
            }

            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = `${tileSize * 0.3}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.textAlign = 'center';
            if ((menu.mode === 'items' && player.inventory.length > 0) ||
                (menu.mode === 'spells' && player.spells.length > 0)) {
                ctx.fillText('‚Üë‚ÜìÈÅ∏Êäû / AÊ±∫ÂÆö / BÊàª„Çã', canvasWidth / 2, menuY + menuHeight - 25);
            } else if (menu.mode === 'map') {
                ctx.fillText('AÊ±∫ÂÆö / ‚Üê ‚Üí „Çø„ÉñÂàáÊõø / B„ÅßÈñâ„Åò„Çã', canvasWidth / 2, menuY + menuHeight - 25);
            } else {
                ctx.fillText('‚Üê ‚Üí „Çø„ÉñÂàáÊõø / B„ÅßÈñâ„Åò„Çã', canvasWidth / 2, menuY + menuHeight - 25);
            }
        }

        function drawInn() {
            if (!inn.active) return;

            const windowWidth = canvasWidth * 0.8;
            const windowHeight = tileSize * 3.5;
            const windowX = (canvasWidth - windowWidth) / 2;
            const windowY = (canvasHeight - windowHeight) / 2;

            drawWindow(windowX, windowY, windowWidth, windowHeight);

            ctx.fillStyle = '#fff';
            ctx.font = `${tileSize * 0.45}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            ctx.fillText(`„Åä„Å®„Åæ„Çä„Åß„Åô„ÅãÔºüÔºà${inn.cost}„Ç¥„Éº„É´„ÉâÔºâ`, windowX + 20, windowY + 20);

            // ÈÅ∏ÊäûËÇ¢
            const choiceY = windowY + tileSize * 1.5;
            const choices = ['„ÅØ„ÅÑ', '„ÅÑ„ÅÑ„Åà'];

            choices.forEach((choice, i) => {
                const choiceX = windowX + 40 + i * tileSize * 2.5;
                if (i === inn.selectedIndex) {
                    ctx.fillStyle = '#ffd700';
                    ctx.fillText('‚ñ∂', choiceX - tileSize * 0.5, choiceY);
                }
                ctx.fillStyle = '#fff';
                ctx.fillText(choice, choiceX, choiceY);
            });

            // ÊâÄÊåÅÈáëË°®Á§∫
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.fillText(`ÊâÄÊåÅÈáë: ${player.gold} G`, windowX + 20, windowY + windowHeight - tileSize * 0.6);
        }

        function drawPartyJoinConfirm() {
            if (!partyJoinConfirm.active) return;

            const windowWidth = canvasWidth * 0.7;
            const windowHeight = tileSize * 2.5;
            const windowX = (canvasWidth - windowWidth) / 2;
            const windowY = (canvasHeight - windowHeight) / 2;

            drawWindow(windowX, windowY, windowWidth, windowHeight);

            ctx.fillStyle = '#fff';
            ctx.font = `${tileSize * 0.45}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            ctx.fillText('‰ª≤Èñì„Å´„Åó„Åæ„Åô„ÅãÔºü', windowX + 20, windowY + 20);

            // ÈÅ∏ÊäûËÇ¢
            const choiceY = windowY + tileSize * 1.3;
            const choices = ['„ÅØ„ÅÑ', '„ÅÑ„ÅÑ„Åà'];

            choices.forEach((choice, i) => {
                const choiceX = windowX + 40 + i * tileSize * 2.5;
                if (i === partyJoinConfirm.selectedIndex) {
                    ctx.fillStyle = '#ffd700';
                    ctx.fillText('‚ñ∂', choiceX - tileSize * 0.5, choiceY);
                }
                ctx.fillStyle = '#fff';
                ctx.fillText(choice, choiceX, choiceY);
            });
        }

        function drawShop() {
            if (!shop.active) return;

            const windowWidth = canvasWidth * 0.9;
            const windowHeight = canvasHeight * 0.75;
            const windowX = (canvasWidth - windowWidth) / 2;
            const windowY = (canvasHeight - windowHeight) / 2;

            drawWindow(windowX, windowY, windowWidth, windowHeight);

            ctx.fillStyle = '#ffd700';
            ctx.font = `${tileSize * 0.5}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText('‚öîÔ∏è „Å∂„Åç„Åº„ÅÜ„Åê„ÇÑ üõ°Ô∏è', canvasWidth / 2, windowY + 15);

            // ÊâÄÊåÅÈáëË°®Á§∫
            ctx.fillStyle = '#fff';
            ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.textAlign = 'right';
            ctx.fillText(`üí∞ ${player.gold} G`, windowX + windowWidth - 20, windowY + 15);

            const listY = windowY + tileSize * 1.2;
            const lineHeight = tileSize * 0.55;

            if (shop.mode === 'menu') {
                // „É°„Éã„É•„ÉºÈÅ∏Êäû
                ctx.font = `${tileSize * 0.45}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.textAlign = 'left';
                const menuItems = ['„Åã„ÅÜ', '„ÅÜ„Çã', '„ÇÑ„ÇÅ„Çã'];
                menuItems.forEach((menuItem, i) => {
                    const y = listY + i * lineHeight * 1.5;
                    if (i === shop.menuIndex) {
                        ctx.fillStyle = '#ffd700';
                        ctx.fillText('‚ñ∂', windowX + 30, y);
                    }
                    ctx.fillStyle = '#fff';
                    ctx.fillText(menuItem, windowX + 60, y);
                });

            } else if (shop.mode === 'buy') {
                if (shop.phase === 'list') {
                    // Ë≥ºÂÖ•„É™„Çπ„Éà
                    ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.textAlign = 'left';

                    getShopItems().forEach((itemId, i) => {
                        const item = items[itemId];
                        const y = listY + i * lineHeight;

                        if (i === shop.selectedIndex) {
                            ctx.fillStyle = '#ffd700';
                            ctx.fillText('‚ñ∂', windowX + 15, y);
                        }

                        const icon = item.type === 'weapon' ? '‚öîÔ∏è' : 'üõ°Ô∏è';
                        ctx.fillStyle = player.gold >= item.price ? '#fff' : '#666';
                        ctx.fillText(`${icon} ${item.name}`, windowX + 40, y);
                        ctx.fillText(`${item.price} G`, windowX + windowWidth * 0.55, y);

                        if (i === shop.selectedIndex) {
                            const statChange = getStatChangePreview(item);
                            ctx.fillStyle = statChange > 0 ? '#4f4' : (statChange < 0 ? '#f44' : '#fff');
                            const sign = statChange > 0 ? '+' : '';
                            const statLabel = item.type === 'weapon' ? '„Åì„ÅÜ„Åí„Åç' : '„Åó„ÇÖ„Å≥';
                            ctx.fillText(`${statLabel} ${sign}${statChange}`, windowX + windowWidth * 0.78, y);
                        }
                    });

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.font = `${tileSize * 0.3}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('‚Üë‚Üì ÈÅ∏Êäû / A Ë≥ºÂÖ• / B Êàª„Çã', canvasWidth / 2, windowY + windowHeight - 25);

                } else if (shop.phase === 'confirm') {
                    const item = shop.selectedItem;
                    ctx.fillStyle = '#fff';
                    ctx.font = `${tileSize * 0.45}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${item.name} „Çí „Åã„ÅÑ„Åæ„Åô„ÅãÔºü`, windowX + 30, listY);
                    ctx.fillText(`Ôºà${item.price} „Ç¥„Éº„É´„ÉâÔºâ`, windowX + 30, listY + lineHeight);

                    const choiceY = listY + lineHeight * 3;
                    ['„ÅØ„ÅÑ', '„ÅÑ„ÅÑ„Åà'].forEach((choice, i) => {
                        const choiceX = windowX + 50 + i * tileSize * 2.5;
                        if (i === shop.confirmIndex) {
                            ctx.fillStyle = '#ffd700';
                            ctx.fillText('‚ñ∂', choiceX - tileSize * 0.5, choiceY);
                        }
                        ctx.fillStyle = '#fff';
                        ctx.fillText(choice, choiceX, choiceY);
                    });

                } else if (shop.phase === 'equip') {
                    const item = shop.selectedItem;
                    ctx.fillStyle = '#fff';
                    ctx.font = `${tileSize * 0.45}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${item.name} „Çí „Å¶„Å´„ÅÑ„Çå„ÅüÔºÅ`, windowX + 30, listY);
                    ctx.fillText('„Åù„ÅÜ„Å≥ „Åó„Åæ„Åô„ÅãÔºü', windowX + 30, listY + lineHeight);

                    const choiceY = listY + lineHeight * 3;
                    ['„ÅØ„ÅÑ', '„ÅÑ„ÅÑ„Åà'].forEach((choice, i) => {
                        const choiceX = windowX + 50 + i * tileSize * 2.5;
                        if (i === shop.equipIndex) {
                            ctx.fillStyle = '#ffd700';
                            ctx.fillText('‚ñ∂', choiceX - tileSize * 0.5, choiceY);
                        }
                        ctx.fillStyle = '#fff';
                        ctx.fillText(choice, choiceX, choiceY);
                    });
                }

            } else if (shop.mode === 'sell') {
                if (shop.phase === 'list') {
                    // Â£≤Âç¥„É™„Çπ„Éà
                    ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.textAlign = 'left';

                    if (shop.sellableItems.length === 0) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.textAlign = 'center';
                        ctx.fillText('„ÅÜ„Çå„Çã„ÇÇ„ÅÆ„Åå „ÅÇ„Çä„Åæ„Åõ„Çì', canvasWidth / 2, listY + lineHeight);
                    } else {
                        shop.sellableItems.forEach((slot, i) => {
                            const item = items[slot.id];
                            const y = listY + i * lineHeight;
                            const sellPrice = Math.floor(item.price / 2);

                            if (i === shop.selectedIndex) {
                                ctx.fillStyle = '#ffd700';
                                ctx.fillText('‚ñ∂', windowX + 15, y);
                            }

                            const icon = item.type === 'weapon' ? '‚öîÔ∏è' : (item.type === 'armor' ? 'üõ°Ô∏è' : 'üì¶');
                            ctx.fillStyle = '#fff';
                            // ÂÄãÊï∞Ë°®Á§∫Ôºà2ÂÄã‰ª•‰∏ä„ÅÆÂ†¥ÂêàÔºâ
                            let displayName = item.name;
                            if (slot.quantity > 1) {
                                displayName += ` x ${slot.quantity}`;
                            }
                            ctx.fillText(`${icon} ${displayName}`, windowX + 40, y);
                            ctx.fillText(`${sellPrice} G`, windowX + windowWidth * 0.65, y);
                        });
                    }

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.font = `${tileSize * 0.3}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('‚Üë‚Üì ÈÅ∏Êäû / A Â£≤Âç¥ / B Êàª„Çã', canvasWidth / 2, windowY + windowHeight - 25);

                } else if (shop.phase === 'confirm') {
                    const item = shop.selectedItem;
                    const sellPrice = Math.floor(item.price / 2);
                    ctx.fillStyle = '#fff';
                    ctx.font = `${tileSize * 0.45}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${item.name} „Çí „ÅÜ„Çä„Åæ„Åô„ÅãÔºü`, windowX + 30, listY);
                    ctx.fillText(`Ôºà${sellPrice} „Ç¥„Éº„É´„ÉâÔºâ`, windowX + 30, listY + lineHeight);

                    const choiceY = listY + lineHeight * 3;
                    ['„ÅØ„ÅÑ', '„ÅÑ„ÅÑ„Åà'].forEach((choice, i) => {
                        const choiceX = windowX + 50 + i * tileSize * 2.5;
                        if (i === shop.confirmIndex) {
                            ctx.fillStyle = '#ffd700';
                            ctx.fillText('‚ñ∂', choiceX - tileSize * 0.5, choiceY);
                        }
                        ctx.fillStyle = '#fff';
                        ctx.fillText(choice, choiceX, choiceY);
                    });

                } else if (shop.phase === 'sold') {
                    const item = shop.selectedItem;
                    const sellPrice = Math.floor(item.price / 2);
                    ctx.fillStyle = '#fff';
                    ctx.font = `${tileSize * 0.45}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${item.name} „Çí „ÅÜ„Çä„Åæ„Åó„ÅüÔºÅ`, windowX + 30, listY);
                    ctx.fillText(`${sellPrice} „Ç¥„Éº„É´„Éâ „Å¶„Å´„ÅÑ„Çå„ÅüÔºÅ`, windowX + 30, listY + lineHeight);
                }
            }
        }

        // Ë£ÖÂÇôÂ§âÊõ¥ÊôÇ„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÂåñ„Çí„Éó„É¨„Éì„É•„Éº
        function getStatChangePreview(item) {
            if (item.type === 'weapon') {
                const currentWeapon = items[player.equipment.weapon];
                const currentValue = currentWeapon ? currentWeapon.value : 0;
                return item.value - currentValue;
            } else if (item.type === 'armor') {
                const currentArmor = items[player.equipment.armor];
                const currentValue = currentArmor ? currentArmor.value : 0;
                return item.value - currentValue;
            }
            return 0;
        }

        // ========================================
        // „Éê„Éà„É´ÊèèÁîª
        // ========================================
        // Âë™Êñá„Éï„É©„ÉÉ„Ç∑„É•„ÇíÈñãÂßã
        function startSpellFlash(color, isUltimate = false) {
            spellFlash.active = true;
            spellFlash.color = color;
            spellFlash.alpha = 1.0;

            if (isUltimate) {
                // Á©∂Ê•µÈ≠îÊ≥ï„ÅÆË±™ËèØÊºîÂá∫ÔºöË§áÊï∞ÂõûÁÇπÊªÖ + ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ
                let flashCount = 0;
                const maxFlashes = 4;

                // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ„ÇÇÁô∫Âãï
                screenShake.active = true;
                screenShake.intensity = 12;
                screenShake.duration = 30;

                const ultimateFlash = () => {
                    if (flashCount >= maxFlashes) {
                        // ÊúÄÂæå„Å´ÁôΩ„ÅÑ„Éï„É©„ÉÉ„Ç∑„É•„ÅßÁ∑†„ÇÅ
                        spellFlash.color = 'rgba(255, 255, 255, 1.0)';
                        spellFlash.alpha = 1.0;

                        const finalFade = () => {
                            spellFlash.alpha -= 0.05;
                            if (spellFlash.alpha <= 0) {
                                spellFlash.active = false;
                                spellFlash.alpha = 0;
                            } else {
                                setTimeout(finalFade, 30);
                            }
                        };
                        setTimeout(finalFade, 150);
                        return;
                    }

                    // ÁÇπÊªÖ„Ç®„Éï„Çß„ÇØ„Éà
                    spellFlash.alpha = 1.0;
                    setTimeout(() => {
                        spellFlash.alpha = 0.3;
                        setTimeout(() => {
                            flashCount++;
                            ultimateFlash();
                        }, 80);
                    }, 100);
                };
                ultimateFlash();
            } else {
                // ÈÄöÂ∏∏Âë™Êñá„ÅÆ„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
                const fadeOut = () => {
                    spellFlash.alpha -= 0.1;
                    if (spellFlash.alpha <= 0) {
                        spellFlash.active = false;
                        spellFlash.alpha = 0;
                    } else {
                        setTimeout(fadeOut, 50);
                    }
                };
                setTimeout(fadeOut, 100);
            }
        }

        // Á©∂Ê•µÈ≠îÊ≥ï„ÅÆ„É™„Çπ„Éà
        const ULTIMATE_SPELLS = ['merazoma', 'gigadein', 'minadein', 'begiragon', 'behomazun'];

        function drawBattle() {
            // ËÉåÊôØ
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Êà¶ÈóòÈñãÂßã„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            if (battle.flashCount > 0) {
                const alpha = (battle.flashCount % 2 === 0) ? 0.8 : 0;
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                return;
            }

            // Âë™Êñá„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            if (spellFlash.active && spellFlash.alpha > 0) {
                // Ëâ≤„Çí„Éë„Éº„Çπ„Åó„Å¶„Ç¢„É´„Éï„Ç°ÂÄ§„ÇíÈÅ©Áî®
                const baseColor = spellFlash.color.replace(/[\d.]+\)$/, `${spellFlash.alpha})`);
                ctx.fillStyle = baseColor;
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            }

            // Ë§áÊï∞„É¢„É≥„Çπ„Çø„ÉºË°®Á§∫
            if (battle.enemies && battle.enemies.length > 0) {
                const enemyCount = battle.enemies.length;
                const spacing = canvasWidth / (enemyCount + 1);
                const spriteSize = enemyCount === 1 ? tileSize * 4 : tileSize * (3 - enemyCount * 0.3);

                battle.enemies.forEach((enemy, idx) => {
                    const x = spacing * (idx + 1);
                    const y = canvasHeight * 0.35;

                    // Ê≠ª‰∫°„Åó„Å¶„ÅÑ„ÇãÊïµ„ÅØËñÑ„ÅèË°®Á§∫
                    const isDead = enemy.currentHp <= 0;
                    if (isDead) {
                        ctx.globalAlpha = 0.3;
                    }

                    // „É¢„É≥„Çπ„Çø„Éº„Çπ„Éó„É©„Ç§„Éà
                    ctx.font = `${spriteSize}px serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    // Ëâ≤ÈÅï„ÅÑ„É¢„É≥„Çπ„Çø„ÉºÂØæÂøúÔºàhueRotate„Éï„Ç£„É´„ÇøÔºâ
                    if (enemy.hueRotate) {
                        ctx.save();
                        ctx.filter = `hue-rotate(${enemy.hueRotate}deg)`;
                        ctx.fillText(enemy.sprite, x, y);
                        ctx.restore();
                    } else {
                        ctx.fillText(enemy.sprite, x, y);
                    }

                    // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû‰∏≠„ÅÆ„Ç´„Éº„ÇΩ„É´Ë°®Á§∫
                    if (battle.isSelectingTarget && idx === battle.targetIndex && !isDead) {
                        ctx.fillStyle = '#ffd700';
                        ctx.font = `${tileSize * 0.8}px serif`;
                        ctx.fillText('üëÜ', x, y - spriteSize / 2 - tileSize * 0.3);
                    }

                    // „É¢„É≥„Çπ„Çø„ÉºÂêç
                    ctx.fillStyle = isDead ? '#888' : '#fff';
                    ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.fillText(enemy.displayName, x, canvasHeight * 0.55);

                    // ÂÄí„Åó„ÅüË°®Á§∫ÔºàHP„ÅØÈùûË°®Á§∫„ÅßÁ∑äÂºµÊÑü„ÇíÊºîÂá∫Ôºâ
                    if (isDead && (battle.phase === 'command' || battle.phase === 'target')) {
                        ctx.fillStyle = '#888';
                        ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                        ctx.fillText('ÂÄí„Åó„Åü', x, canvasHeight * 0.55 + tileSize * 0.45);
                    }

                    // Áä∂ÊÖãÁï∞Â∏∏„Éê„ÉÉ„Ç∏„ÇíÂêçÂâç„ÅÆ‰∏ã„Å´Ë°®Á§∫
                    if (!isDead) {
                        const enemyStatusBadge = getStatusBadges(enemy);
                        if (enemyStatusBadge) {
                            ctx.fillStyle = '#f88';
                            ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                            ctx.fillText(enemyStatusBadge, x, canvasHeight * 0.55 + tileSize * 0.85);
                        }
                    }

                    ctx.globalAlpha = 1.0;
                });
            }

            // „Éë„Éº„ÉÜ„Ç£„Çπ„ÉÜ„Éº„Çø„Çπ„Ç¶„Ç£„É≥„Éâ„Ç¶
            const aliveMembers = getAlivePartyMembers();
            const memberCount = party.length;
            const memberRowH = tileSize * 0.9;
            const statusW = canvasWidth * 0.55;
            const statusH = Math.max(tileSize * 2.5, 20 + memberRowH * memberCount);
            const statusX = 10;
            const statusY = 10;
            drawWindow(statusX, statusY, statusW, statusH);

            ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            // ÂêÑ„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
            party.forEach((member, idx) => {
                const rowY = statusY + 12 + idx * memberRowH;
                const isDead = !member.isAlive || member.hp <= 0;

                // „Ç≥„Éû„É≥„ÉâÂÖ•Âäõ‰∏≠„ÅÆ„É°„É≥„Éê„Éº„Çí„Éè„Ç§„É©„Ç§„Éà
                if (battle.phase === 'command' && idx === battle.currentPartyIndex) {
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.2)';
                    ctx.fillRect(statusX + 5, rowY - 2, statusW - 10, memberRowH - 2);
                }

                // Êà¶Èóò‰∏çËÉΩ„ÅØÊöó„ÅèË°®Á§∫
                ctx.fillStyle = isDead ? '#666' : '#fff';

                // ÂêçÂâç„Å®„É¨„Éô„É´
                const nameText = `${member.name} Lv${member.level}`;
                ctx.fillText(nameText, statusX + 12, rowY);

                // HP/MP
                const hpColor = member.hp <= member.maxHp * 0.25 ? '#f44' : (member.hp <= member.maxHp * 0.5 ? '#ff0' : '#8f8');
                const mpColor = member.mp <= member.maxMp * 0.25 ? '#f88' : '#8cf';

                ctx.fillStyle = isDead ? '#444' : hpColor;
                ctx.fillText(`HP:${member.hp}/${member.maxHp}`, statusX + 12 + tileSize * 3.2, rowY);

                ctx.fillStyle = isDead ? '#444' : mpColor;
                ctx.fillText(`MP:${member.mp}/${member.maxMp}`, statusX + 12 + tileSize * 5.5, rowY);

                // Áä∂ÊÖãÁï∞Â∏∏„Éê„ÉÉ„Ç∏
                const memberBadge = getStatusBadges(member);
                if (memberBadge && !isDead) {
                    ctx.fillStyle = '#f88';
                    ctx.fillText(memberBadge, statusX + statusW - 50, rowY);
                }
            });

            // „Éê„ÉïÁä∂ÊÖã„Éê„ÉÉ„Ç∏Ôºà„Éë„Éº„ÉÜ„Ç£ÂÖ®‰ΩìÔºâ
            const buffBadges = getBuffBadges();
            if (buffBadges) {
                ctx.fillStyle = '#8f8';
                ctx.font = `${tileSize * 0.3}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.fillText(buffBadges, statusX + statusW - 80, statusY + statusH - 18);
            }

            // „É°„ÉÉ„Çª„Éº„Ç∏„Ç¶„Ç£„É≥„Éâ„Ç¶
            const msgPadding = 15;
            const msgWindowWidth = canvasWidth - 20;
            const msgMaxTextWidth = msgWindowWidth - msgPadding * 2;
            const msgFontSize = Math.floor(tileSize * 0.42);
            const msgLineHeight = msgFontSize * 1.4;
            const msgFont = `${msgFontSize}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;

            // Êäò„ÇäËøî„ÅóË°åÊï∞„Å´Âøú„Åò„Å¶„Ç¶„Ç£„É≥„Éâ„Ç¶È´ò„Åï„ÇíË™øÊï¥
            const msgLines = wrapText(battle.message, msgMaxTextWidth, msgFont);
            const msgNumLines = Math.max(2, msgLines.length);
            const msgH = msgPadding * 2 + msgLineHeight * msgNumLines;
            const msgY = canvasHeight - msgH - 180;
            drawWindow(10, msgY, msgWindowWidth, msgH);

            ctx.fillStyle = '#fff';
            ctx.font = msgFont;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            for (let i = 0; i < msgLines.length; i++) {
                ctx.fillText(msgLines[i], 10 + msgPadding, msgY + msgPadding + i * msgLineHeight);
            }

            // „Ç≥„Éû„É≥„Éâ„Ç¶„Ç£„É≥„Éâ„Ç¶
            if (battle.phase === 'command') {
                const cmdW = canvasWidth * 0.45;
                const cmdH = tileSize * 3.7;
                const cmdX = canvasWidth - cmdW - 10;
                const cmdY = canvasHeight - cmdH - 10;
                drawWindow(cmdX, cmdY, cmdW, cmdH);

                const commands = ['„Åü„Åü„Åã„ÅÜ', '„Åò„ÇÖ„ÇÇ„Çì', '„Å©„ÅÜ„Åê', '„Å´„Åí„Çã'];
                ctx.font = `${tileSize * 0.5}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;

                commands.forEach((cmd, i) => {
                    const y = cmdY + 20 + i * tileSize * 0.7;
                    if (i === battle.commandIndex) {
                        ctx.fillStyle = '#ffd700';
                        ctx.fillText('‚ñ∂', cmdX + 15, y);
                    }
                    ctx.fillStyle = '#fff';
                    ctx.fillText(cmd, cmdX + 40, y);
                });

                // Âë™Êñá„Çµ„Éñ„É°„Éã„É•„Éº
                if (battle.showSpells) {
                    const spellW = cmdW * 1.1;
                    const spellH = Math.max(tileSize * 2.5, tileSize * 0.6 * player.spells.length + 30);
                    const spellX = cmdX - spellW - 10;
                    const spellY = cmdY;
                    drawWindow(spellX, spellY, spellW, spellH);

                    player.spells.forEach((spellId, i) => {
                        const spell = spells[spellId];
                        const y = spellY + 20 + i * tileSize * 0.6;
                        const canUse = player.mp >= spell.mp;

                        // ÈÅ∏Êäû„Ç´„Éº„ÇΩ„É´
                        if (i === battle.spellIndex) {
                            ctx.fillStyle = canUse ? '#ffd700' : '#888';
                            ctx.fillText('‚ñ∂', spellX + 10, y);
                        }

                        // Âë™ÊñáÂêç„Å®MPÔºàMP‰∏çË∂≥„ÅØ„Ç∞„É¨„Éº„Ç¢„Ç¶„ÉàÔºâ
                        ctx.fillStyle = canUse ? '#fff' : '#555';
                        ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                        ctx.fillText(`${spell.name}`, spellX + 30, y);

                        // MPÊ∂àË≤ªÈáè
                        ctx.fillStyle = canUse ? '#8cf' : '#444';
                        ctx.fillText(`${spell.mp}`, spellX + spellW - 40, y);
                    });

                    // Êìç‰Ωú„Ç¨„Ç§„Éâ
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = `${tileSize * 0.25}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.fillText('B:„ÇÇ„Å©„Çã', spellX + 10, spellY + spellH - 10);
                }

                // „Ç¢„Ç§„ÉÜ„É†„Çµ„Éñ„É°„Éã„É•„Éº
                if (battle.showItems) {
                    const itemW = cmdW * 1.3;
                    const itemH = Math.max(tileSize * 2.5, tileSize * 0.6 * Math.max(1, player.inventory.length) + 30);
                    const itemX = cmdX - itemW - 10;
                    const itemY = cmdY;
                    drawWindow(itemX, itemY, itemW, itemH);

                    if (player.inventory.length === 0) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                        ctx.fillText('„Å©„ÅÜ„Åê„Åå„Å™„ÅÑ', itemX + 20, itemY + 30);
                    } else {
                        player.inventory.forEach((slot, i) => {
                            const item = items[slot.id];
                            if (!item) return;
                            const y = itemY + 20 + i * tileSize * 0.6;
                            const canUse = item.type !== 'weapon' && item.type !== 'armor';

                            // ÈÅ∏Êäû„Ç´„Éº„ÇΩ„É´
                            if (i === battle.itemCursor) {
                                ctx.fillStyle = canUse ? '#ffd700' : '#888';
                                ctx.fillText('‚ñ∂', itemX + 10, y);
                            }

                            // „Ç¢„Ç§„ÉÜ„É†ÂêçÔºàË£ÖÂÇôÂìÅ„ÅØ„Ç∞„É¨„Éº„Ç¢„Ç¶„ÉàÔºâ
                            ctx.fillStyle = canUse ? '#fff' : '#555';
                            ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                            let displayName = item.name;
                            if (slot.quantity > 1) {
                                displayName += ` x ${slot.quantity}`;
                            }
                            ctx.fillText(displayName, itemX + 30, y);

                            // „Çø„Ç§„Éó„Ç¢„Ç§„Ç≥„É≥
                            if (item.type === 'weapon') {
                                ctx.fillText('‚öîÔ∏è', itemX + itemW - 40, y);
                            } else if (item.type === 'armor') {
                                ctx.fillText('üõ°Ô∏è', itemX + itemW - 40, y);
                            }
                        });
                    }

                    // Êìç‰Ωú„Ç¨„Ç§„Éâ
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = `${tileSize * 0.25}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.fillText('B:„ÇÇ„Å©„Çã', itemX + 10, itemY + itemH - 10);
                }
            }
        }

        // ========================================
        // „É°„Ç§„É≥ÊèèÁîª
        // ========================================
        let drawDebugCount = 0;
        function draw() {
            // „Çø„Ç§„Éà„É´ÁîªÈù¢‰∏≠„ÅØÊèèÁîª„Çí„Çπ„Ç≠„ÉÉ„Éó
            if (gameMode === MODE.TITLE) {
                return;
            }

            // „Éá„Éê„ÉÉ„Ç∞: ÊúÄÂàù„ÅÆÊï∞„Éï„É¨„Éº„É†„Å†„Åë„É≠„Ç∞Âá∫Âäõ
            if (drawDebugCount < 5) {
                console.log('[DEBUG draw] gameMode:', gameMode, 'tileSize:', tileSize, 'canvasWidth:', canvasWidth, 'currentMap.data:', !!currentMap.data);
                drawDebugCount++;
            }

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØÂá¶ÁêÜ
            let shakeX = 0, shakeY = 0;
            if (screenShake.active) {
                shakeX = (Math.random() - 0.5) * screenShake.intensity;
                shakeY = (Math.random() - 0.5) * screenShake.intensity;
                screenShake.duration--;
                if (screenShake.duration <= 0) {
                    screenShake.active = false;
                }
            }

            ctx.save();
            ctx.translate(shakeX, shakeY);

            if (gameMode === MODE.ENDING) {
                drawEnding();
            } else if (gameMode === MODE.BATTLE) {
                drawBattle();
            } else {
                drawMap();
                drawChests();
                drawNPCs();
                drawPlayer();
                drawMessageWindow();
                drawMenu();
                drawInn();
                drawShop();
                drawPartyJoinConfirm();
                drawRuraSelection();
            }

            ctx.restore();

            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÅÆ„Éï„Çß„Éº„ÉâÊèèÁîªÔºàrestoreÂæå„Å´ÊèèÁîªÔºâ
            if (endingState.fadeAlpha > 0 && endingState.phase !== 'staffroll' && endingState.phase !== 'theend' && endingState.phase !== 'none') {
                ctx.fillStyle = `rgba(0, 0, 0, ${endingState.fadeAlpha})`;
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            }
        }

        // ========================================
        // „Éê„Éà„É´„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        function startBattle(monsterTypeOrTable) {
            // Êïµ„Ç∞„É´„Éº„ÉóÁîüÊàêÔºà„Ç®„É≥„Ç´„Ç¶„É≥„Éà„ÉÜ„Éº„Éñ„É´Âêç„ÅåÊ∏°„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„Ç∞„É´„Éº„ÉóÁîüÊàêÔºâ
            let enemies;
            if (encounterTables[monsterTypeOrTable]) {
                // „ÉÜ„Éº„Éñ„É´Âêç„ÅåÊ∏°„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ„Ç∞„É´„Éº„ÉóÁîüÊàê
                enemies = generateEnemyGroup(monsterTypeOrTable);
            } else if (monsters[monsterTypeOrTable]) {
                // Âçò‰Ωì„É¢„É≥„Çπ„Çø„ÉºÂêç„ÅåÊ∏°„Åï„Çå„ÅüÂ†¥Âêà
                const monsterData = monsters[monsterTypeOrTable];
                enemies = [{
                    ...monsterData,
                    id: `${monsterTypeOrTable}_0`,
                    type: monsterTypeOrTable,
                    displayName: monsterData.name,
                    currentHp: monsterData.hp,
                    currentMp: monsterData.mp || 0,
                    status: { sleep: 0, poison: 0, blind: 0 },
                    index: 0
                }];
            } else {
                console.error('Unknown monster or table:', monsterTypeOrTable);
                return;
            }

            battle.active = true;
            battle.enemies = enemies;
            battle.enemy = enemies[0]; // ÂæåÊñπ‰∫íÊèõÁî®
            battle.targetIndex = 0;
            battle.currentEnemyIndex = 0;
            battle.isSelectingTarget = false;
            battle.isSelectingAlly = false;
            battle.allyTargetIndex = 0;
            battle.pendingAction = null;
            battle.phase = 'start';
            battle.commandIndex = 0;
            battle.spellIndex = 0;
            battle.showSpells = false;
            battle.showItems = false;
            battle.itemCursor = 0;
            battle.message = '';
            battle.messageQueue = [];
            battle.result = null;
            battle.flashCount = 6;

            // „Éë„Éº„ÉÜ„Ç£„Éê„Éà„É´Áî®„ÅÆÂàùÊúüÂåñ
            battle.currentPartyIndex = 0;
            battle.partyActions = [];
            battle.executingActionIndex = 0;

            // ÂÖ®„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„ÅÆÁä∂ÊÖãÁï∞Â∏∏„Çí„É™„Çª„ÉÉ„ÉàÔºàÊà¶Èóò„Åî„Å®„Å´„É™„Çª„ÉÉ„ÉàÔºâ
            party.forEach(member => {
                member.status = { sleep: 0, poison: 0, blind: 0 };
                // Êà¶Èóò‰∏çËÉΩÁä∂ÊÖã„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑÔºàHP > 0 „ÅßÂà§ÂÆöÔºâ
                member.isAlive = member.hp > 0;
            });

            // „Éê„Éï„Çí„É™„Çª„ÉÉ„ÉàÔºàÊà¶Èóò„Åî„Å®„Å´„É™„Çª„ÉÉ„ÉàÔºâ
            battle.buffs = { attackUp: 0, defenseUp: 0 };

            gameMode = MODE.BATTLE;

            // „Éê„Éà„É´‰∏≠„ÅØ„Éû„ÉÉ„ÉóÂêç„ÇíÈùûË°®Á§∫
            mapNameArea.style.display = 'none';

            // ÊïµÂá∫Áèæ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîüÊàê
            const enemyMessage = generateEnemyAppearMessage(enemies);

            // „Éï„É©„ÉÉ„Ç∑„É•„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            const flashInterval = setInterval(() => {
                battle.flashCount--;
                if (battle.flashCount <= 0) {
                    clearInterval(flashInterval);
                    showBattleMessage(enemyMessage, () => {
                        battle.phase = 'command';
                        const currentMember = getCurrentPartyMember();
                        battle.message = `${currentMember.name} „ÅÆ „Åì„ÅÜ„Å©„ÅÜÔºü`;
                    });
                }
            }, 100);
        }

        // ÊïµÂá∫Áèæ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîüÊàê
        function generateEnemyAppearMessage(enemies) {
            if (enemies.length === 1) {
                return `${enemies[0].displayName} „Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`;
            } else {
                // „Ç∞„É´„Éº„Éó„É°„ÉÉ„Çª„Éº„Ç∏
                const names = enemies.map(e => e.displayName);
                if (names.length <= 3) {
                    return `${names.join(' „Å® ')} „Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`;
                } else {
                    return `${enemies[0].displayName}„Åü„Å° ${enemies.length}Âåπ„ÅÆ „Åæ„ÇÇ„ÅÆ„Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`;
                }
            }
        }

        function showBattleMessage(msg, callback) {
            battle.message = msg;
            setTimeout(() => {
                if (callback) callback();
            }, 1000);
        }

        // Êïµ„ÅÆËÄêÊÄß„ÇíËÄÉÊÖÆ„Åó„ÅüÊàêÂäüÁéá„ÇíË®àÁÆó
        function getEffectiveSuccessRate(spell, enemy) {
            const baseRate = spell.successRate;
            const resistance = enemy.resistances ? enemy.resistances[spell.statusEffect] : 1.0;
            return baseRate * resistance;
        }

        function executeBattleCommand() {
            // ÁèæÂú®Ë°åÂãï‰∏≠„ÅÆ„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº
            const caster = getCurrentPartyMember();

            if (battle.showSpells) {
                // Âë™ÊñáÂÆüË°å
                const spellId = caster.spells[battle.spellIndex];
                const spell = spells[spellId];
                if (caster.mp < spell.mp) {
                    showBattleMessage('MP„Åå „Åü„Çä„Å™„ÅÑÔºÅ', () => {
                        battle.phase = 'command';
                        battle.message = `${caster.name} „ÅÆ „Åì„ÅÜ„Å©„ÅÜÔºü`;
                    });
                    return;
                }

                // ÊîªÊíÉÂë™Êñá„ÅÆÂ†¥Âêà„ÅØÁâπÂà•Âá¶ÁêÜ
                if (spell.type === 'attack') {
                    battle.showSpells = false;

                    if (spell.target === 'single') {
                        // Âçò‰ΩìÊîªÊíÉÂë™ÊñáÔºöË§áÊï∞Êïµ„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû
                        const aliveCount = getAliveEnemies().length;
                        if (aliveCount > 1) {
                            startTargetSelection('spell', spellId);
                            battle.message = '„Å†„Çå„Å´ „Å§„Åã„ÅÜÔºü';
                            return;
                        } else {
                            // Êïµ„Åå1‰Ωì„ÅÆÂ†¥Âêà„ÅØÁõ¥Êé•ÂÆüË°å
                            caster.mp -= spell.mp;
                            executeSpellOnTarget(spellId, getFirstAliveEnemyIndex());
                            return;
                        }
                    } else if (spell.target === 'all') {
                        // ÂÖ®‰ΩìÊîªÊíÉÂë™ÊñáÔºöÂÖ®„Å¶„ÅÆÊïµ„Å´„ÉÄ„É°„Éº„Ç∏
                        caster.mp -= spell.mp;
                        executeSpellOnAll(spellId);
                        return;
                    }
                }

                caster.mp -= spell.mp;
                battle.showSpells = false;
                battle.phase = 'playerTurn';

                // „Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫„ÇíÈñãÂßãÔºàÁ©∂Ê•µÈ≠îÊ≥ï„ÅØÁâπÂà•ÊºîÂá∫Ôºâ
                if (spell.flashColor) {
                    const isUltimate = ULTIMATE_SPELLS.includes(spell.id);
                    startSpellFlash(spell.flashColor, isUltimate);
                }

                showBattleMessage(`${caster.name} „ÅØ ${spell.name} „Çí „Å®„Å™„Åà„ÅüÔºÅ`, () => {
                    if (spell.type === 'heal') {
                        // ÂõûÂæ©Âë™ÊñáÔºöËá™ÂàÜËá™Ë∫´„ÇíÂõûÂæ©ÔºàÂ∞ÜÊù•ÁöÑ„Å´„ÅØÂë≥ÊñπÈÅ∏Êäû„ÇíËøΩÂä†Ôºâ
                        const healAmount = spell.power;
                        caster.hp = Math.min(caster.maxHp, caster.hp + healAmount);
                        showBattleMessage(`${caster.name} „ÅÆ HP„Åå ${healAmount} „Åã„ÅÑ„Åµ„Åè„Åó„ÅüÔºÅ`, () => {
                            processTurnEnd();
                        });
                    } else if (spell.type === 'status') {
                        // Áä∂ÊÖãÁï∞Â∏∏Âë™ÊñáÔºàÊúÄÂàù„ÅÆÁîüÂ≠òÊïµ„Å´ÂØæ„Åó„Å¶‰ΩøÁî®Ôºâ
                        const targetEnemy = battle.enemies[getFirstAliveEnemyIndex()];
                        const targetName = targetEnemy.displayName || targetEnemy.name;

                        // Êó¢„Å´„Åù„ÅÆÁä∂ÊÖãÁï∞Â∏∏„Å´„Åã„Åã„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
                        if (targetEnemy.status[spell.statusEffect] > 0) {
                            showBattleMessage(`„Åó„Åã„Åó ${targetName} „Å´„ÅØ „Åç„Åã„Å™„Åã„Å£„ÅüÔºÅ`, () => {
                                processTurnEnd();
                            });
                        } else {
                            // ËÄêÊÄß„ÇíËÄÉÊÖÆ„Åó„ÅüÊàêÂäüÁéá
                            const effectiveRate = getEffectiveSuccessRate(spell, targetEnemy);
                            if (effectiveRate <= 0) {
                                // ÂÆåÂÖ®ËÄêÊÄß
                                showBattleMessage(`„Åó„Åã„Åó ${targetName} „Å´„ÅØ „Åæ„Å£„Åü„Åè „Åç„Åã„Å™„Åã„Å£„ÅüÔºÅ`, () => {
                                    processTurnEnd();
                                });
                            } else if (Math.random() < effectiveRate) {
                                // ÊàêÂäü
                                applyStatusEffect(targetEnemy, spell.statusEffect);
                                let successMsg = '';
                                if (spell.statusEffect === 'sleep') {
                                    successMsg = `${targetName} „ÅØ „Å≠„ÇÄ„Çä„Å´„Åä„Å°„ÅüÔºÅ`;
                                } else if (spell.statusEffect === 'blind') {
                                    successMsg = `${targetName} „ÅØ „Åæ„Åº„Çç„Åó„Å´ „Å§„Å§„Åæ„Çå„ÅüÔºÅ`;
                                } else {
                                    const effectName = STATUS_EFFECTS[spell.statusEffect].name;
                                    successMsg = `${targetName} „ÅØ ${effectName}Áä∂ÊÖã„Å´ „Å™„Å£„ÅüÔºÅ`;
                                }
                                showBattleMessage(successMsg, () => {
                                    processTurnEnd();
                                });
                            } else {
                                // Â§±ÊïóÔºàËÄêÊÄß„ÅßÂºæ„Åã„Çå„ÅüÔºâ
                                showBattleMessage(`„Åó„Åã„Åó ${targetName} „Å´„ÅØ „Åç„Åã„Å™„Åã„Å£„ÅüÔºÅ`, () => {
                                    processTurnEnd();
                                });
                            }
                        }
                    } else if (spell.type === 'buff') {
                        // Ë£úÂä©Âë™ÊñáÔºà„Éê„ÉïÔºâ- „Éë„Éº„ÉÜ„Ç£ÂÖ®‰Ωì„Å´ÂäπÊûú
                        if (spell.buffType === 'defense') {
                            // „Çπ„ÇØ„É´„Éà - Èò≤Âæ°Âäõ„Ç¢„ÉÉ„Éó
                            if (battle.buffs.defenseUp >= MAX_BUFF_STACK) {
                                showBattleMessage('„Åó„Åã„Åó „Åì„Çå‰ª•‰∏ä „Åó„ÇÖ„Å≥Âäõ„ÅØ „ÅÇ„Åå„Çâ„Å™„ÅÑÔºÅ', () => {
                                    processTurnEnd();
                                });
                            } else {
                                battle.buffs.defenseUp++;
                                showBattleMessage('„Å™„Åã„Åæ„Åü„Å° „ÅÆ „Åó„ÇÖ„Å≥Âäõ„Åå „ÅÇ„Åå„Å£„ÅüÔºÅ', () => {
                                    processTurnEnd();
                                });
                            }
                        } else if (spell.buffType === 'attack') {
                            // „Éê„Ç§„Ç≠„É´„Éà - ÊîªÊíÉÂäõ„Ç¢„ÉÉ„Éó
                            if (battle.buffs.attackUp >= MAX_BUFF_STACK) {
                                showBattleMessage('„Åó„Åã„Åó „Åì„Çå‰ª•‰∏ä „Åì„ÅÜ„Åí„ÅçÂäõ„ÅØ „ÅÇ„Åå„Çâ„Å™„ÅÑÔºÅ', () => {
                                    processTurnEnd();
                                });
                            } else {
                                battle.buffs.attackUp++;
                                showBattleMessage('„Å™„Åã„Åæ„Åü„Å° „ÅÆ „Åì„ÅÜ„Åí„ÅçÂäõ„Åå „ÅÇ„Åå„Å£„ÅüÔºÅ', () => {
                                    processTurnEnd();
                                });
                            }
                        }
                    } else if (spell.type === 'revive') {
                        // Âæ©Ê¥ªÂë™ÊñáÔºà„Ç∂„Ç™„É©„É´Ôºâ- Êà¶Èóò‰∏çËÉΩ„ÅÆ‰ª≤Èñì„ÇíÂæ©Ê¥ª
                        const deadMembers = party.filter(m => !m.isAlive || m.hp <= 0);
                        if (deadMembers.length === 0) {
                            showBattleMessage('„Åó„Åã„Åó „Å†„Çå„ÇÇ „Åü„Åä„Çå„Å¶„ÅÑ„Å™„ÅÑÔºÅ', () => {
                                processTurnEnd();
                            });
                        } else {
                            // ÊúÄÂàù„ÅÆÊà¶Èóò‰∏çËÉΩ„É°„É≥„Éê„Éº„ÇíÂæ©Ê¥ªÔºà50%ÊàêÂäüÔºâ
                            const target = deadMembers[0];
                            if (Math.random() < 0.5) {
                                target.hp = Math.floor(target.maxHp / 2);
                                target.isAlive = true;
                                showBattleMessage(`${target.name} „ÅØ „ÅÑ„Åç„Åã„Åà„Å£„ÅüÔºÅ`, () => {
                                    processTurnEnd();
                                });
                            } else {
                                showBattleMessage(`„Åó„Åã„Åó ${target.name} „ÅØ „ÅÑ„Åç„Åã„Åà„Çâ„Å™„Åã„Å£„Åü...`, () => {
                                    processTurnEnd();
                                });
                            }
                        }
                    } else if (spell.type === 'escape') {
                        // Êà¶Èóò‰∏≠„ÅÆ„É™„É¨„Éü„Éà„ÅØ‰ΩøÁî®‰∏çÂèØ
                        showBattleMessage('„Åó„Åã„Åó „Åì„ÅÆÂ†¥„Åß„ÅØ „Å§„Åã„Åà„Å™„ÅÑÔºÅ', () => {
                            processTurnEnd();
                        });
                    }
                });
            } else if (battle.showItems) {
                // „Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®
                if (player.inventory.length === 0) {
                    showBattleMessage('„Å©„ÅÜ„Åê„Çí „ÇÇ„Å£„Å¶„ÅÑ„Å™„ÅÑÔºÅ', () => {
                        battle.showItems = false;
                        battle.phase = 'command';
                        battle.message = `${caster.name} „ÅÆ „Åì„ÅÜ„Å©„ÅÜÔºü`;
                    });
                    return;
                }

                const slot = player.inventory[battle.itemCursor];
                if (!slot) return;

                const item = items[slot.id];
                if (!item) return;

                // Ë£ÖÂÇôÂìÅ„ÅØÊà¶Èóò‰∏≠„Å´‰Ωø„Åà„Å™„ÅÑ
                if (item.type === 'weapon' || item.type === 'armor') {
                    showBattleMessage('„Åù„Çå„ÅØ „Åì„Åì„Åß„ÅØ „Å§„Åã„Åà„Å™„ÅÑÔºÅ', () => {
                        battle.phase = 'command';
                        battle.message = `${caster.name} „ÅÆ „Åì„ÅÜ„Å©„ÅÜÔºü`;
                    });
                    return;
                }

                battle.showItems = false;
                battle.phase = 'playerTurn';

                showBattleMessage(`„ÇÜ„ÅÜ„Åó„ÇÉ „ÅØ ${item.name} „Çí „Å§„Åã„Å£„ÅüÔºÅ`, () => {
                    let effectMsg = '';
                    let success = false;

                    switch (item.type) {
                        case 'heal':
                            const healAmount = item.value;
                            player.hp = Math.min(player.maxHp, player.hp + healAmount);
                            effectMsg = `HP„Åå ${healAmount} „Åã„ÅÑ„Åµ„Åè„Åó„ÅüÔºÅ`;
                            success = true;
                            break;
                        case 'cure':
                            // ÊØíÊ∂à„ÅóËçâ
                            if (player.status && player.status.poison > 0) {
                                player.status.poison = 0;
                                effectMsg = '„Å©„Åè„Åå „Å™„Åä„Å£„ÅüÔºÅ';
                                success = true;
                            } else {
                                effectMsg = '„Åó„Åã„Åó „Å™„Å´„ÇÇ „Åä„Åì„Çâ„Å™„Åã„Å£„ÅüÔºÅ';
                            }
                            break;
                        default:
                            effectMsg = '„Åó„Åã„Åó „Å™„Å´„ÇÇ „Åä„Åì„Çâ„Å™„Åã„Å£„ÅüÔºÅ';
                            break;
                    }

                    if (success) {
                        removeItem(slot.id, 1);
                        // „Ç´„Éº„ÇΩ„É´Ë™øÊï¥
                        if (battle.itemCursor >= player.inventory.length && battle.itemCursor > 0) {
                            battle.itemCursor--;
                        }
                    }

                    showBattleMessage(effectMsg, () => {
                        processTurnEnd();
                    });
                });
            } else {
                switch (battle.commandIndex) {
                    case 0: // „Åü„Åü„Åã„ÅÜ
                        // Ë§áÊï∞Êïµ„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû
                        if (getAliveEnemies().length > 1) {
                            startTargetSelection('attack');
                        } else {
                            playerAttack();
                        }
                        break;
                    case 1: // „Åò„ÇÖ„ÇÇ„Çì
                        battle.showSpells = true;
                        battle.spellIndex = 0;
                        break;
                    case 2: // „Å©„ÅÜ„Åê
                        battle.showItems = true;
                        battle.itemCursor = 0;
                        break;
                    case 3: // „Å´„Åí„Çã
                        tryEscape();
                        break;
                }
            }
        }

        // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏ÊäûÈñãÂßã
        function startTargetSelection(actionType, spellId = null) {
            battle.isSelectingTarget = true;
            battle.targetIndex = getFirstAliveEnemyIndex();
            battle.pendingAction = { type: actionType, spellId };
            battle.message = '„Å†„Çå„Çí „Åì„ÅÜ„Åí„Åç„Åô„ÇãÔºü';
        }

        // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏ÊäûÁ¢∫ÂÆö
        function confirmTargetSelection() {
            battle.isSelectingTarget = false;
            const action = battle.pendingAction;
            battle.pendingAction = null;

            if (action.type === 'attack') {
                playerAttack(battle.targetIndex);
            } else if (action.type === 'spell') {
                // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏ÊäûÁ¢∫ÂÆöÊôÇ„Å´MPÊ∂àË≤ª
                const spell = spells[action.spellId];
                player.mp -= spell.mp;
                executeSpellOnTarget(action.spellId, battle.targetIndex);
            }
        }

        // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû„Ç≠„É£„É≥„Çª„É´
        function cancelTargetSelection() {
            battle.isSelectingTarget = false;
            battle.pendingAction = null;
            battle.message = '';
        }

        // Âçò‰ΩìÊîªÊíÉÂë™Êñá„ÇíÁâπÂÆö„Çø„Éº„Ç≤„ÉÉ„Éà„Å´ÂÆüË°å
        function executeSpellOnTarget(spellId, targetIndex) {
            const spell = spells[spellId];
            const enemy = battle.enemies[targetIndex];
            if (!enemy || enemy.currentHp <= 0) {
                // „Çø„Éº„Ç≤„ÉÉ„Éà„ÅåÊó¢„Å´ÂÄí„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÂà•„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÊé¢„Åô
                const newTarget = getFirstAliveEnemyIndex();
                if (newTarget === -1) {
                    checkBattleEnd();
                    return;
                }
                targetIndex = newTarget;
            }
            const target = battle.enemies[targetIndex];
            const targetName = target.displayName || target.name;

            // „Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫„ÇíÈñãÂßã
            if (spell.flashColor) {
                const isUltimate = ULTIMATE_SPELLS.includes(spell.id);
                startSpellFlash(spell.flashColor, isUltimate);
            }

            battle.phase = 'playerTurn';
            showBattleMessage(`„ÇÜ„ÅÜ„Åó„ÇÉ „ÅØ ${spell.name} „Çí „Å®„Å™„Åà„ÅüÔºÅ`, () => {
                const damage = spell.power + Math.floor(Math.random() * 5);
                target.currentHp -= damage;

                showBattleMessage(`${targetName} „Å´ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                    if (target.currentHp <= 0) {
                        target.currentHp = 0;
                        showBattleMessage(`${targetName} „Çí „Åü„Åä„Åó„ÅüÔºÅ`, () => {
                            checkBattleEnd() || processTurnEnd();
                        });
                    } else {
                        checkBattleEnd() || processTurnEnd();
                    }
                });
            });
        }

        // ÂÖ®‰ΩìÊîªÊíÉÂë™Êñá„ÇíÂÆüË°åÔºàÂÖ®„Å¶„ÅÆÊïµ„Å´„ÉÄ„É°„Éº„Ç∏Ôºâ
        function executeSpellOnAll(spellId) {
            const spell = spells[spellId];
            const aliveEnemies = getAliveEnemies();

            if (aliveEnemies.length === 0) {
                checkBattleEnd();
                return;
            }

            // „Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫„ÇíÈñãÂßã
            if (spell.flashColor) {
                const isUltimate = ULTIMATE_SPELLS.includes(spell.id);
                startSpellFlash(spell.flashColor, isUltimate);
            }

            battle.phase = 'playerTurn';
            showBattleMessage(`„ÇÜ„ÅÜ„Åó„ÇÉ „ÅØ ${spell.name} „Çí „Å®„Å™„Åà„ÅüÔºÅ`, () => {
                // ÂÖ®„Å¶„ÅÆÊïµ„Å´„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„ÇãÔºàÈ†ÜÁï™„Å´„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Ôºâ
                processAoeDamage(spell, 0);
            });
        }

        // AOE„ÉÄ„É°„Éº„Ç∏„ÇíÈ†ÜÁï™„Å´Âá¶ÁêÜ
        function processAoeDamage(spell, enemyIndex) {
            // Ê¨°„ÅÆÁîüÂ≠òÊïµ„ÇíÊé¢„Åô
            while (enemyIndex < battle.enemies.length && battle.enemies[enemyIndex].currentHp <= 0) {
                enemyIndex++;
            }

            if (enemyIndex >= battle.enemies.length) {
                // ÂÖ®„Å¶„ÅÆÊïµ„Å∏„ÅÆÊîªÊíÉ„ÅåÂÆå‰∫Ü
                checkBattleEnd() || processTurnEnd();
                return;
            }

            const enemy = battle.enemies[enemyIndex];
            const enemyName = enemy.displayName || enemy.name;
            const damage = spell.power + Math.floor(Math.random() * 5);
            enemy.currentHp -= damage;

            const message = enemy.currentHp <= 0
                ? `${enemyName} „Å´ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ ${enemyName} „Çí „Åü„Åä„Åó„ÅüÔºÅ`
                : `${enemyName} „Å´ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`;

            if (enemy.currentHp <= 0) {
                enemy.currentHp = 0;
            }

            showBattleMessage(message, () => {
                // Ê¨°„ÅÆÊïµ„Å∏
                processAoeDamage(spell, enemyIndex + 1);
            });
        }

        // ÁèæÂú®„ÅÆ„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„ÇíÂèñÂæó
        function getCurrentPartyMember() {
            return party[battle.currentPartyIndex] || party[0];
        }

        // Ê¨°„ÅÆË°åÂãïÂèØËÉΩ„Å™„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó
        function getNextAlivePartyIndex(currentIndex) {
            for (let i = currentIndex + 1; i < party.length; i++) {
                if (party[i].isAlive && party[i].hp > 0 && party[i].status.sleep === 0) {
                    return i;
                }
            }
            return -1; // ÂÖ®Âì°Ë°åÂãïÊ∏à„Åø
        }

        // „Çø„Éº„É≥ÁµÇ‰∫ÜÂá¶ÁêÜÔºàÊØí„ÉÄ„É°„Éº„Ç∏„Å™„Å©Ôºâ
        function processTurnEnd() {
            // ÁèæÂú®„ÅÆ„É°„É≥„Éê„Éº„ÅÆÊØí„ÉÄ„É°„Éº„Ç∏
            const currentMember = getCurrentPartyMember();
            const poisonResult = processPoisonDamage(currentMember, currentMember.name, currentMember.maxHp);

            const continueAfterPoison = () => {
                // Ê¨°„ÅÆ„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„Åå„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const nextIndex = getNextAlivePartyIndex(battle.currentPartyIndex);
                if (nextIndex !== -1) {
                    // Ê¨°„ÅÆ„É°„É≥„Éê„Éº„ÅÆ„Ç≥„Éû„É≥„ÉâÂÖ•Âäõ„Å∏
                    battle.currentPartyIndex = nextIndex;
                    battle.commandIndex = 0;
                    battle.spellIndex = 0;
                    battle.showSpells = false;
                    battle.showItems = false;
                    battle.phase = 'command';
                    const nextMember = getCurrentPartyMember();
                    battle.message = `${nextMember.name} „ÅÆ „Åì„ÅÜ„Å©„ÅÜÔºü`;
                } else {
                    // ÂÖ®Âì°Ë°åÂãïÊ∏à„Åø„ÄÅÊïµ„Çø„Éº„É≥„Å∏
                    processPartyPoisonAndEnemyTurn();
                }
            };

            if (poisonResult) {
                showBattleMessage(poisonResult.message, continueAfterPoison);
            } else {
                continueAfterPoison();
            }
        }

        // „Éë„Éº„ÉÜ„Ç£ÂÖ®Âì°„ÅÆÊØí„ÉÄ„É°„Éº„Ç∏Âá¶ÁêÜÂæå„ÄÅÊïµ„Çø„Éº„É≥„Å∏
        function processPartyPoisonAndEnemyTurn() {
            // ÊÆã„Çä„ÅÆ„É°„É≥„Éê„Éº„ÅÆÊØí„ÉÄ„É°„Éº„Ç∏Âá¶ÁêÜÔºàÁèæÂú®„ÅÆ„É°„É≥„Éê„Éº‰ª•Â§ñÔºâ
            let poisonMessages = [];
            party.forEach((member, idx) => {
                if (idx <= battle.currentPartyIndex) return; // Êó¢„Å´Âá¶ÁêÜÊ∏à„Åø
                if (!member.isAlive || member.hp <= 0) return;
                const result = processPoisonDamage(member, member.name, member.maxHp);
                if (result) {
                    poisonMessages.push(result.message);
                }
            });

            if (poisonMessages.length > 0) {
                // ÊØí„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈ†ÜÊ¨°Ë°®Á§∫
                const showNext = (index) => {
                    if (index >= poisonMessages.length) {
                        enemyTurn();
                        return;
                    }
                    showBattleMessage(poisonMessages[index], () => showNext(index + 1));
                };
                showNext(0);
            } else {
                enemyTurn();
            }
        }

        function playerAttack(targetIndex = 0) {
            battle.phase = 'playerTurn';

            // ÁèæÂú®Ë°åÂãï‰∏≠„ÅÆ„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„ÇíÂèñÂæó
            const attacker = getCurrentPartyMember();

            // „Çø„Éº„Ç≤„ÉÉ„Éà„ÅåÊó¢„Å´ÂÄí„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂà•„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÊé¢„Åô
            if (!battle.enemies[targetIndex] || battle.enemies[targetIndex].currentHp <= 0) {
                const newTarget = getFirstAliveEnemyIndex();
                if (newTarget === -1) {
                    checkBattleEnd();
                    return;
                }
                targetIndex = newTarget;
            }
            const enemy = battle.enemies[targetIndex];

            // ÂπªÊÉëÁä∂ÊÖã„Å™„ÇâÂëΩ‰∏≠Áéá‰Ωé‰∏ã
            const hitRate = getHitRate(attacker);
            if (Math.random() > hitRate) {
                showBattleMessage(`${attacker.name} „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ „Åó„Åã„Åó „Åì„ÅÜ„Åí„Åç„ÅØ „ÅØ„Åö„Çå„ÅüÔºÅ`, () => {
                    processTurnEnd();
                });
                return;
            }

            const atk = attacker.actualAtk;
            let damage = Math.max(1, Math.floor(atk / 2 - enemy.def / 4 + Math.random() * 5));

            // „Éê„Ç§„Ç≠„É´„Éà„Å´„Çà„Çã„ÉÄ„É°„Éº„Ç∏ÂÄçÁéáÈÅ©Áî®
            if (battle.buffs.attackUp > 0) {
                const attackMultiplier = 1 + battle.buffs.attackUp * 0.5; // 1ÊÆµÈöé=1.5ÂÄç, 2ÊÆµÈöé=2ÂÄç
                damage = Math.floor(damage * attackMultiplier);
            }

            enemy.currentHp -= damage;

            // Êïµ„ÅÆÂêçÂâçÔºà„Çµ„Éï„Ç£„ÉÉ„ÇØ„Çπ‰ªò„ÅçÔºâ„ÇíË°®Á§∫
            const enemyName = enemy.displayName || enemy.name;

            showBattleMessage(`${attacker.name} „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ ${enemyName} „Å´ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                // „Åì„ÅÆÊïµ„ÇíÂÄí„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (enemy.currentHp <= 0) {
                    enemy.currentHp = 0;
                    showBattleMessage(`${enemyName} „Çí „Åü„Åä„Åó„ÅüÔºÅ`, () => {
                        checkBattleEnd() || processTurnEnd();
                    });
                } else {
                    checkBattleEnd() || processTurnEnd();
                }
            });
        }

        function enemyTurn() {
            battle.phase = 'enemyTurn';
            // ÊúÄÂàù„ÅÆÁîüÂ≠òÊïµ„Åã„ÇâË°åÂãïÈñãÂßã
            battle.currentEnemyIndex = getFirstAliveEnemyIndex();
            if (battle.currentEnemyIndex === -1) {
                // ÂÖ®„Å¶„ÅÆÊïµ„ÅåÂÄí„Åï„Çå„Å¶„ÅÑ„Çã
                checkBattleEnd();
                return;
            }
            processCurrentEnemyTurn();
        }

        // ÁèæÂú®„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÊïµ„ÅåË°åÂãï„Åô„Çã
        function processCurrentEnemyTurn() {
            const enemy = battle.enemies[battle.currentEnemyIndex];
            if (!enemy || enemy.currentHp <= 0) {
                // „Åì„ÅÆÊïµ„ÅØÊó¢„Å´ÂÄí„Åï„Çå„Å¶„ÅÑ„Çã„ÄÅÊ¨°„Å∏
                nextEnemyTurn();
                return;
            }

            // ÂæåÊñπ‰∫íÊèõÁî®„Å´battle.enemy„ÇíË®≠ÂÆö
            battle.enemy = enemy;

            // „Éú„Çπ„ÅÆÂ†¥Âêà„ÅØÂ∞ÇÁî®„ÅÆË°åÂãï„É≠„Ç∏„ÉÉ„ÇØ„Çí‰ΩøÁî®
            if (enemy.isBoss) {
                maouTurn();
                return;
            }

            // Êïµ„ÅÆÁú†„Çä„ÉÅ„Çß„ÉÉ„ÇØ
            const enemyName = enemy.displayName || enemy.name;
            const wakeResult = checkWakeUp(enemy, enemyName);
            if (!wakeResult.awake) {
                showBattleMessage(wakeResult.message, () => {
                    processCurrentEnemyTurnEnd();
                });
                return;
            }
            if (wakeResult.message) {
                // ÁõÆË¶ö„ÇÅ„Åü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å¶„Åã„ÇâË°åÂãï
                showBattleMessage(wakeResult.message, () => {
                    executeEnemyAttack();
                });
                return;
            }

            executeEnemyAttack();
        }

        // „É©„É≥„ÉÄ„É†„Å™ÁîüÂ≠ò„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„ÇíÂèñÂæó
        function getRandomAlivePartyMember() {
            const aliveMembers = getAlivePartyMembers();
            if (aliveMembers.length === 0) return null;
            return aliveMembers[Math.floor(Math.random() * aliveMembers.length)];
        }

        function executeEnemyAttack() {
            const enemy = battle.enemies[battle.currentEnemyIndex];
            const enemyName = enemy.displayName || enemy.name;

            // Êïµ„ÅÆÂπªÊÉëÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
            const hitRate = getHitRate(enemy);
            if (Math.random() > hitRate) {
                showBattleMessage(`${enemyName} „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ „Åó„Åã„Åó „Åì„ÅÜ„Åí„Åç„ÅØ „ÅØ„Åö„Çå„ÅüÔºÅ`, () => {
                    processCurrentEnemyTurnEnd();
                });
                return;
            }

            // „É©„É≥„ÉÄ„É†„Å™„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„Éº„Çí„Çø„Éº„Ç≤„ÉÉ„Éà
            const target = getRandomAlivePartyMember();
            if (!target) {
                checkBattleEnd();
                return;
            }

            let def = target.actualDef;

            // „Çπ„ÇØ„É´„Éà„Å´„Çà„ÇãÈò≤Âæ°Âäõ„Ç¢„ÉÉ„Éó
            if (battle.buffs.defenseUp > 0) {
                const defenseMultiplier = 1 + battle.buffs.defenseUp * 0.25; // 1ÊÆµÈöé=1.25ÂÄç, 2ÊÆµÈöé=1.5ÂÄç
                def = Math.floor(def * defenseMultiplier);
            }

            const damage = Math.max(1, Math.floor(enemy.atk / 2 - def / 4 + Math.random() * 3));
            target.hp -= damage;

            showBattleMessage(`${enemyName} „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ ${target.name} „Å´ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                if (target.hp <= 0) {
                    target.hp = 0;
                    target.isAlive = false;
                    showBattleMessage(`${target.name} „ÅØ „Åü„Åä„Çå„ÅüÔºÅ`, () => {
                        // „Éë„Éº„ÉÜ„Ç£ÂÖ®ÊªÖ„ÉÅ„Çß„ÉÉ„ÇØ
                        if (!isPartyAlive()) {
                            battleLose();
                        } else {
                            processCurrentEnemyTurnEnd();
                        }
                    });
                } else {
                    processCurrentEnemyTurnEnd();
                }
            });
        }

        // ÁèæÂú®„ÅÆÊïµ„ÅÆ„Çø„Éº„É≥ÁµÇ‰∫Ü„ÄÅÊ¨°„ÅÆÊïµ„Å∏
        function processCurrentEnemyTurnEnd() {
            const enemy = battle.enemies[battle.currentEnemyIndex];
            const enemyName = enemy ? (enemy.displayName || enemy.name) : '';

            // Êïµ„ÅÆÊØí„ÉÄ„É°„Éº„Ç∏
            if (enemy && enemy.currentHp > 0) {
                const poisonResult = processPoisonDamage(enemy, enemyName, enemy.hp);
                if (poisonResult) {
                    showBattleMessage(poisonResult.message, () => {
                        if (checkBattleEnd()) return;
                        nextEnemyTurn();
                    });
                    return;
                }
            }
            nextEnemyTurn();
        }

        // Ê¨°„ÅÆÊïµ„ÅÆ„Çø„Éº„É≥„Å∏ÈÄ≤„ÇÄ
        function nextEnemyTurn() {
            const nextIndex = getNextAliveEnemyIndex(battle.currentEnemyIndex, false);
            if (nextIndex === -1) {
                // ÂÖ®„Å¶„ÅÆÊïµ„ÅåË°åÂãïÂÆå‰∫Ü„ÄÅ„Éó„É¨„Ç§„É§„Éº„Çø„Éº„É≥„Å∏
                startPlayerTurn();
            } else {
                battle.currentEnemyIndex = nextIndex;
                processCurrentEnemyTurn();
            }
        }

        // Êïµ„Çø„Éº„É≥ÁµÇ‰∫ÜÂá¶ÁêÜÔºàÂæåÊñπ‰∫íÊèõÁî®Ôºâ
        function processEnemyTurnEnd() {
            processCurrentEnemyTurnEnd();
        }

        // „Éó„É¨„Ç§„É§„Éº„Çø„Éº„É≥ÈñãÂßã
        function startPlayerTurn() {
            // „Éë„Éº„ÉÜ„Ç£„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí„É™„Çª„ÉÉ„ÉàÔºàÊúÄÂàù„ÅÆÁîüÂ≠ò„É°„É≥„Éê„Éº„Åã„ÇâÈñãÂßãÔºâ
            battle.currentPartyIndex = 0;
            // ÊúÄÂàù„ÅÆË°åÂãïÂèØËÉΩ„Å™„É°„É≥„Éê„Éº„ÇíÊé¢„Åô
            while (battle.currentPartyIndex < party.length) {
                const member = party[battle.currentPartyIndex];
                if (member.isAlive && member.hp > 0) {
                    break;
                }
                battle.currentPartyIndex++;
            }

            if (battle.currentPartyIndex >= party.length) {
                // ÂÖ®Âì°Êà¶Èóò‰∏çËÉΩÔºàÈÄöÂ∏∏„ÅØ„Åì„Åì„Å´Êù•„Å™„ÅÑ„ÅØ„ÅöÔºâ
                battleLose();
                return;
            }

            const currentMember = getCurrentPartyMember();

            // Áú†„Çä„ÉÅ„Çß„ÉÉ„ÇØ
            const wakeResult = checkWakeUp(currentMember, currentMember.name);
            if (!wakeResult.awake) {
                showBattleMessage(wakeResult.message, () => {
                    // Áú†„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØË°åÂãï„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Ê¨°„ÅÆ„É°„É≥„Éê„Éº„Å∏
                    processTurnEnd();
                });
                return;
            }
            if (wakeResult.message) {
                showBattleMessage(wakeResult.message, () => {
                    battle.commandIndex = 0;
                    battle.spellIndex = 0;
                    battle.phase = 'command';
                    battle.message = `${currentMember.name} „ÅÆ „Åì„ÅÜ„Å©„ÅÜÔºü`;
                });
                return;
            }

            battle.commandIndex = 0;
            battle.spellIndex = 0;
            battle.phase = 'command';
            battle.message = `${currentMember.name} „ÅÆ „Åì„ÅÜ„Å©„ÅÜÔºü`;
        }

        function tryEscape() {
            battle.phase = 'playerTurn';

            // È≠îÁéã„Åã„Çâ„ÅØÈÄÉ„Åí„Çâ„Çå„Å™„ÅÑ
            if (battle.enemy.isBoss) {
                showBattleMessage('È≠îÁéã „ÅÆ „Å°„Åã„Çâ „Åå „ÇÜ„ÅÜ„Åó„ÇÉ „Çí „Å´„Åå„Åï„Å™„ÅÑÔºÅ', () => {
                    enemyTurn();
                });
                return;
            }

            // „É¨„Éô„É´Â∑Æ„Å´„Çà„ÇãÈÄÉËµ∞ÊàêÂäüÁéá„ÅÆË®àÁÆó
            const enemyLevel = battle.enemy.level || 1;
            const levelDiff = player.level - enemyLevel;

            let escapeChance;
            if (levelDiff >= 5) {
                // 5„É¨„Éô„É´‰ª•‰∏äÈ´ò„Åë„Çå„Å∞Á¢∫ÂÆöÈÄÉËµ∞
                escapeChance = 1.0;
            } else if (levelDiff >= 3) {
                // 3„É¨„Éô„É´‰ª•‰∏äÈ´ò„Åë„Çå„Å∞È´òÁ¢∫Áéá
                escapeChance = 0.9;
            } else if (levelDiff >= 1) {
                // 1~2„É¨„Éô„É´È´ò„Åë„Çå„Å∞„ÇÑ„ÇÑÊúâÂà©
                escapeChance = 0.7;
            } else {
                // Âêå„É¨„Éô„É´‰ª•‰∏ã„ÅØ„Çπ„Éî„Éº„ÉâÊØî„ÅßÂà§ÂÆö
                escapeChance = player.speed / (player.speed + battle.enemy.speed);
            }

            if (Math.random() < escapeChance) {
                showBattleMessage('„ÅÜ„Åæ„Åè „Å´„Åí„Åç„Çå„ÅüÔºÅ', () => {
                    endBattle('escape');
                });
            } else {
                showBattleMessage('„Åó„Åã„Åó „Åæ„Çè„Çä„Åì„Åæ„Çå„Å¶„Åó„Åæ„Å£„ÅüÔºÅ', () => {
                    enemyTurn();
                });
            }
        }

        function checkBattleEnd() {
            // ÂÖ®„Å¶„ÅÆÊïµ„ÅåÂÄí„Åï„Çå„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const aliveEnemies = getAliveEnemies();
            if (aliveEnemies.length === 0) {
                battleWin();
                return true;
            }
            return false;
        }

        function battleWin() {
            battle.phase = 'result';

            // ÂÖ®Êïµ„ÅÆÂ†±ÈÖ¨„ÇíÂêàÁÆó
            let totalExp = 0;
            let totalGold = 0;
            let defeatedBoss = null;

            for (const enemy of battle.enemies) {
                totalExp += enemy.exp || 0;
                totalGold += enemy.gold || 0;
                if (enemy.isBoss) {
                    defeatedBoss = enemy;
                }
            }

            // ÁµåÈ®ìÂÄ§„ÇíÁîüÂ≠ò„É°„É≥„Éê„ÉºÂÖ®Âì°„Å´‰ªò‰∏é
            const aliveMembers = getAlivePartyMembers();
            aliveMembers.forEach(member => {
                member.exp += totalExp;
            });

            // „Ç¥„Éº„É´„Éâ„ÅØ„Éë„Éº„ÉÜ„Ç£ÂÖ±Êúâ
            partyData.gold += totalGold;

            // „Éú„ÇπÊà¶Âà§ÂÆöÔºàÂæåÊñπ‰∫íÊèõÁî®Ôºâ
            const isBossDefeat = defeatedBoss !== null;
            const isMaou = defeatedBoss && defeatedBoss.name === 'È≠îÁéã';
            const isMidBoss = defeatedBoss && defeatedBoss.name === 'Ê¥ûÁ™ü„ÅÆÁï™‰∫∫';
            const exp = totalExp;
            const gold = totalGold;

            // ÂãùÂà©„É°„ÉÉ„Çª„Éº„Ç∏
            const winMessage = battle.enemies.length === 1
                ? `${battle.enemies[0].displayName || battle.enemies[0].name} „Çí „Åü„Åä„Åó„ÅüÔºÅ`
                : '„Åæ„ÇÇ„ÅÆ„Åü„Å°„Çí „ÇÑ„Å£„Å§„Åë„ÅüÔºÅ';

            showBattleMessage(winMessage, () => {
                // È≠îÁéãË®é‰ºêÊôÇ„ÅØÁâπÂà•„Å™ÊºîÂá∫
                if (isBossDefeat && isMaou) {
                    screenShake.active = true;
                    screenShake.intensity = 15;
                    screenShake.duration = 60;

                    showBattleMessage('„Åê...„Åê„Åä„Åä„Åä„Åä...ÔºÅ', () => {
                        showBattleMessage('„Åæ...„Åæ„Åï„Åã... „Åì„ÅÆÁßÅ„Åå...', () => {
                            showBattleMessage('È≠îÁéã „ÅØ Ê∂àÊªÖ„Åó„ÅüÔºÅ', () => {
                                showBattleMessage(`${exp} „Éù„Ç§„É≥„Éà„ÅÆ „Åë„ÅÑ„Åë„Çì„Å°„Çí „Åã„Åè„Å®„ÅèÔºÅ`, () => {
                                    checkLevelUp(() => {
                                        gameCleared = true;
                                        setBossDefeated('maou', true);
                                        startEnding();
                                    });
                                });
                            });
                        });
                    });
                } else if (isBossDefeat && isMidBoss) {
                    // ‰∏≠„Éú„ÇπÊíÉÁ†¥ÊôÇ„ÅÆÊºîÂá∫
                    screenShake.active = true;
                    screenShake.intensity = 10;
                    screenShake.duration = 40;

                    showBattleMessage('„Åê...„Åê„Åä„Åä...ÔºÅ', () => {
                        showBattleMessage('Ê¥ûÁ™ü„ÅÆÁï™‰∫∫ „ÅØ Â¥©„ÇåÂéª„Å£„ÅüÔºÅ', () => {
                            showBattleMessage(`${exp} „Éù„Ç§„É≥„Éà„ÅÆ „Åë„ÅÑ„Åë„Çì„Å°„Çí „Åã„Åè„Å®„ÅèÔºÅ`, () => {
                                showBattleMessage(`${gold} „Ç¥„Éº„É´„Éâ„Çí „Å¶„Å´„ÅÑ„Çå„ÅüÔºÅ`, () => {
                                    checkLevelUp(() => {
                                        setBossDefeated('midBoss', true);
                                        showBattleMessage('ÁéãÊßò„Å´ Â†±Âëä„Åó„Çà„ÅÜÔºÅ', () => {
                                            endBattle('win');
                                            saveGame();
                                        });
                                    });
                                });
                            });
                        });
                    });
                } else if (isBossDefeat && defeatedBoss.bossId) {
                    // Á†ÇÊº†„Ç®„É™„Ç¢„ÅÆ„Éú„ÇπÊíÉÁ†¥Âá¶ÁêÜ
                    handleDesertBossDefeat(defeatedBoss.bossId, exp, gold);
                } else {
                    showBattleMessage(`${exp} „Éù„Ç§„É≥„Éà„ÅÆ „Åë„ÅÑ„Åë„Çì„Å°„Çí „Åã„Åè„Å®„ÅèÔºÅ`, () => {
                        showBattleMessage(`${gold} „Ç¥„Éº„É´„Éâ„Çí „Å¶„Å´„ÅÑ„Çå„ÅüÔºÅ`, () => {
                            checkLevelUp(() => {
                                endBattle('win');
                            });
                        });
                    });
                }
            });
        }

        // Á†ÇÊº†„Ç®„É™„Ç¢„ÅÆ„Éú„ÇπÊíÉÁ†¥Âá¶ÁêÜ
        function handleDesertBossDefeat(bossId, exp, gold) {
            screenShake.active = true;
            screenShake.intensity = 10;
            screenShake.duration = 40;

            const bossName = battle.enemy.name;

            showBattleMessage('„Åê...„Åê„Åä„Åä...ÔºÅ', () => {
                showBattleMessage(`${bossName} „Çí „Åü„Åä„Åó„ÅüÔºÅ`, () => {
                    showBattleMessage(`${exp} „Éù„Ç§„É≥„Éà„ÅÆ „Åë„ÅÑ„Åë„Çì„Å°„Çí „Åã„Åè„Å®„ÅèÔºÅ`, () => {
                        showBattleMessage(`${gold} „Ç¥„Éº„É´„Éâ„Çí „Å¶„Å´„ÅÑ„Çå„ÅüÔºÅ`, () => {
                            checkLevelUp(() => {
                                // „Éú„Çπ„Åî„Å®„ÅÆ„ÇØ„Ç®„Çπ„ÉàÂá¶ÁêÜ
                                setBossDefeated(bossId, true);

                                let questMessage = '';
                                if (bossId === 'quicksandBoss') {
                                    setQuestFlag('waterShortage', 'bossDefeated', true);
                                    questMessage = 'ÂÆùÁÆ±„Åã„Çâ Ê∏Ö„Çâ„Åã„Å™Ê∞¥ „ÇíÊâã„Å´ÂÖ•„Çå„Çà„ÅÜÔºÅ';
                                } else if (bossId === 'banditKing') {
                                    setQuestFlag('passportRecovery', 'bossDefeated', true);
                                    setQuestFlag('passportRecovery', 'completed', true);
                                    setStoryFlag('bazaarUnlocked', true);
                                    questMessage = '„Éê„Ç∂„Éº„É´„ÅÆÁî∫„Å∏„ÅÆ ÈÄöË°åÊâãÂΩ¢ „ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ';
                                } else if (bossId === 'pyramidGuardian') {
                                    setQuestFlag('royalCrest', 'bossDefeated', true);
                                    setQuestFlag('royalCrest', 'completed', true);
                                    questMessage = 'ÁéãÂÆ∂„ÅÆÁ¥ãÁ´† „ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ';
                                } else if (bossId === 'desertGuardian') {
                                    setStoryFlag('desertPortalUnlocked', true);
                                    questMessage = 'Á†ÇÊº†„ÅÆÁéã„Å´Â†±Âëä„Åó„Çà„ÅÜÔºÅ';
                                }

                                if (questMessage) {
                                    showBattleMessage(questMessage, () => {
                                        endBattle('win');
                                        saveGame();
                                    });
                                } else {
                                    endBattle('win');
                                    saveGame();
                                }
                            });
                        });
                    });
                });
            });
        }

        // „Åì„ÅÆ„É¨„Éô„É´„ÅßÁøíÂæó„Åô„ÇãÂë™Êñá„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkNewSpells(level) {
            const newSpells = [];
            for (const spellId in spells) {
                const spell = spells[spellId];
                if (spell.learnLevel === level && !player.spells.includes(spellId)) {
                    newSpells.push(spellId);
                }
            }
            return newSpells;
        }

        // Âë™ÊñáÁøíÂæó„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        function showSpellLearnMessages(spellList, callback) {
            if (spellList.length === 0) {
                callback();
                return;
            }
            const spellId = spellList.shift();
            const spell = spells[spellId];
            player.spells.push(spellId);
            showBattleMessage(`${spell.name} „Çí „Åä„Åº„Åà„ÅüÔºÅ`, () => {
                showSpellLearnMessages(spellList, callback);
            });
        }

        // ÂÄãÂà•„É°„É≥„Éê„Éº„ÅÆ„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ
        function checkMemberLevelUp(member, callback) {
            if (member.level < expTable.length - 1 && member.exp >= expTable[member.level + 1]) {
                member.level++;

                // „Çπ„ÉÜ„Éº„Çø„Çπ‰∏äÊòá„Çí„É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†Ëæº„Åø„ÅßË®àÁÆó
                const hpUp = 3 + Math.floor(Math.random() * 5); // 3-7
                const mpUp = 1 + Math.floor(Math.random() * 3); // 1-3
                const atkUp = 1 + Math.floor(Math.random() * 2); // 1-2
                const defUp = 1 + Math.floor(Math.random() * 2); // 1-2
                const spdUp = Math.floor(Math.random() * 2); // 0-1

                member.maxHp += hpUp;
                member.maxMp += mpUp;
                member.baseAtk += atkUp;
                member.baseDef += defUp;
                member.speed += spdUp;
                // HP/MP„ÅØÂÖ®ÂõûÂæ©„Åó„Å™„ÅÑÔºàÂÆøÂ±ã„ÅÆÈáçË¶ÅÊÄß„ÇíÈ´ò„ÇÅ„ÇãÔºâ

                // Âü∫Á§é„Çπ„ÉÜ„Éº„Çø„Çπ„Åå‰∏ä„Åå„Å£„Åü„ÅÆ„Åß„Åì„ÅÜ„Åí„ÅçÂäõ„Éª„Åó„ÇÖ„Å≥Âäõ„ÇíÂÜçË®àÁÆó
                updateMemberActualStats(member);

                // „Åì„ÅÆ„É¨„Éô„É´„ÅßÁøíÂæó„Åô„ÇãÂë™Êñá„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const newSpells = checkMemberNewSpells(member, member.level);

                // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈ†ÜÁï™„Å´Ë°®Á§∫
                showBattleMessage(`${member.name} „ÅØ „É¨„Éô„É´„Åå „ÅÇ„Åå„Å£„ÅüÔºÅ Lv${member.level} „Å´„Å™„Å£„ÅüÔºÅ`, () => {
                    showBattleMessage(`„Åï„ÅÑ„Å†„ÅÑHP „Åå ${hpUp} „ÅÇ„Åå„Å£„ÅüÔºÅ`, () => {
                        showBattleMessage(`„Åï„ÅÑ„Å†„ÅÑMP „Åå ${mpUp} „ÅÇ„Åå„Å£„ÅüÔºÅ`, () => {
                            const afterStats = () => {
                                // Âë™ÊñáÁøíÂæó„É°„ÉÉ„Çª„Éº„Ç∏
                                showMemberSpellLearnMessages(member, newSpells, () => {
                                    checkMemberLevelUp(member, callback); // Ë§áÊï∞„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂØæÂøú
                                });
                            };
                            afterStats();
                        });
                    });
                });
            } else {
                callback();
            }
        }

        // „É°„É≥„Éê„Éº„ÅÆÂë™ÊñáÁøíÂæó„ÉÅ„Çß„ÉÉ„ÇØ
        function checkMemberNewSpells(member, level) {
            const newSpells = [];
            for (const spellId in spells) {
                const spell = spells[spellId];
                // „Ç∏„Éß„Éñ„Å´Âøú„Åò„ÅüÂë™ÊñáÁøíÂæóÔºàÂ∞ÜÊù•ÁöÑ„Å™Êã°ÂºµÁî®Ôºâ
                if (spell.learnLevel === level && !member.spells.includes(spellId)) {
                    member.spells.push(spellId);
                    newSpells.push(spell);
                }
            }
            return newSpells;
        }

        // „É°„É≥„Éê„Éº„ÅÆÂë™ÊñáÁøíÂæó„É°„ÉÉ„Çª„Éº„Ç∏
        function showMemberSpellLearnMessages(member, spellList, callback) {
            if (spellList.length === 0) {
                callback();
                return;
            }
            const spell = spellList.shift();
            showBattleMessage(`${member.name} „ÅØ ${spell.name} „Çí „Åä„Åº„Åà„ÅüÔºÅ`, () => {
                showMemberSpellLearnMessages(member, spellList, callback);
            });
        }

        // „Éë„Éº„ÉÜ„Ç£ÂÖ®Âì°„ÅÆ„É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÉÅ„Çß„ÉÉ„ÇØ
        function checkLevelUp(callback) {
            const aliveMembers = getAlivePartyMembers();
            let memberIndex = 0;

            const checkNext = () => {
                if (memberIndex >= aliveMembers.length) {
                    callback();
                    return;
                }
                const member = aliveMembers[memberIndex];
                memberIndex++;
                checkMemberLevelUp(member, checkNext);
            };

            checkNext();
        }

        function battleLose() {
            battle.phase = 'result';
            showBattleMessage('„Éë„Éº„ÉÜ„Ç£„ÅØ „Åú„Çì„ÇÅ„Å§„Åó„Åü...', () => {
                showBattleMessage('„Åä„ÅÜ„Åï„Åæ„Äå„Åù„Å™„Åü„Åü„Å°„Å´ „ÇÇ„ÅÜ‰∏ÄÂ∫¶ „ÉÅ„É£„É≥„Çπ„Çí „ÇÑ„Çç„ÅÜ„Äç', () => {
                    // „Ç¥„Éº„É´„ÉâÂçäÊ∏õ
                    partyData.gold = Math.floor(partyData.gold / 2);
                    // „Éë„Éº„ÉÜ„Ç£ÂÖ®Âì°„ÇíÂæ©Ê¥ª
                    party.forEach(member => {
                        member.hp = member.maxHp;
                        member.mp = member.maxMp;
                        member.isAlive = true;
                        member.status = { sleep: 0, poison: 0, blind: 0 };
                    });
                    partyData.x = 7;
                    partyData.y = 11;
                    currentMapId = 'castle';
                    currentMap = maps[currentMapId];
                    mapNameElement.textContent = currentMap.name;
                    endBattle('lose');
                });
            });
        }

        function endBattle(result) {
            battle.result = result;
            // „Éê„Éà„É´ÁµÇ‰∫ÜÊôÇ„Å´Ê≠©Êï∞„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà
            stepsSinceLastBattle = 0;
            setTimeout(() => {
                gameMode = MODE.FIELD;
                battle.active = false;
                // „Éû„ÉÉ„ÉóÂêç„ÇíÂÜçË°®Á§∫
                mapNameArea.style.display = 'flex';
                updateCamera();
                saveGame();
            }, 500);
        }

        // ========================================
        // „Ç®„É≥„Éá„Ç£„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        let endingState = {
            phase: 'none',      // none, fadeout, castle, talk, staffroll, theend
            fadeAlpha: 0,
            scrollY: 0,
            staffRollComplete: false
        };

        const staffRollText = [
            '',
            '',
            '~ CONGRATULATIONS! ~',
            '',
            '',
            'È≠îÁéã„Çí ÂÄí„Åó',
            '‰∏ñÁïå„Å´ Âπ≥Âíå„Åå Êàª„Å£„Åü',
            '',
            '',
            '',
            '-- STAFF --',
            '',
            '„Ç≤„Éº„É†„Éá„Ç∂„Ç§„É≥',
            '  „ÅÇ„Å™„Åü',
            '',
            '„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞',
            '  „ÅÇ„Å™„Åü',
            '',
            '„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ',
            '  „ÅÇ„Å™„Åü',
            '',
            '',
            '-- SPECIAL THANKS --',
            '',
            'ÊúÄÂæå„Åæ„Åß „Éó„É¨„Ç§„Åó„Å¶„Åè„Çå„Åü',
            '„ÅÇ„Å™„Åü„Å´ ÊÑüË¨ùÔºÅ',
            '',
            '',
            '',
            '',
            'THANK YOU FOR PLAYING!',
            '',
            '',
            '',
            '',
            '~ THE END ~',
            '',
            '',
            ''
        ];

        function startEnding() {
            endingState.phase = 'fadeout';
            endingState.fadeAlpha = 0;
            battle.active = false;

            // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÈñãÂßã
            const fadeInterval = setInterval(() => {
                endingState.fadeAlpha += 0.02;
                if (endingState.fadeAlpha >= 1) {
                    clearInterval(fadeInterval);
                    // Âüé„Å´ÁßªÂãï
                    currentMapId = 'castle';
                    currentMap = maps[currentMapId];
                    player.x = 7;
                    player.y = 9;
                    mapNameElement.textContent = currentMap.name;

                    endingState.phase = 'castle';
                    gameMode = MODE.FIELD;

                    // „Éï„Çß„Éº„Éâ„Ç§„É≥
                    const fadeInInterval = setInterval(() => {
                        endingState.fadeAlpha -= 0.02;
                        if (endingState.fadeAlpha <= 0) {
                            endingState.fadeAlpha = 0;
                            clearInterval(fadeInInterval);
                            // Âá±Êóã„Ç§„Éô„É≥„ÉàÈñãÂßã
                            setTimeout(() => {
                                startTriumphEvent();
                            }, 500);
                        }
                    }, 30);
                }
            }, 30);
        }

        function startTriumphEvent() {
            endingState.phase = 'talk';
            startDialog([
                '„Åä„Åä „ÇÜ„ÅÜ„Åó„ÇÉ„ÇàÔºÅ',
                '„Çà„Åè„Åû È≠îÁéã„Çí „Åü„Åä„Åó„Å¶„Åè„Çå„ÅüÔºÅ',
                '„Åì„Çå„Åß ‰∏ñÁïå„Å´ Âπ≥Âíå„Åå „ÇÇ„Å©„Å£„ÅüÔºÅ',
                '„Åù„Å™„Åü„ÅÆ „ÅÑ„Åï„Åä„Åó„ÅØ „Å™„Åå„Åè Ë™û„ÇäÁ∂ô„Åå„Çå„Çã„Åß„ÅÇ„Çç„ÅÜ',
                '„ÅÇ„Çä„Åå„Å®„ÅÜ „ÇÜ„ÅÜ„Åó„ÇÉ„ÇàÔºÅ',
                '...‰∏ñÁïå„ÅØ Âπ≥Âíå„Å´„Å™„Å£„Åü...'
            ], () => {
                // „Çπ„Çø„ÉÉ„Éï„É≠„Éº„É´„Å∏
                setTimeout(() => {
                    startStaffRoll();
                }, 1000);
            });
        }

        function startStaffRoll() {
            endingState.phase = 'staffroll';
            endingState.scrollY = canvasHeight;
            endingState.staffRollComplete = false;
            gameMode = MODE.ENDING;
        }

        function updateStaffRoll() {
            if (endingState.phase !== 'staffroll') return;

            endingState.scrollY -= 1;

            const textHeight = staffRollText.length * 30 + canvasHeight;
            if (endingState.scrollY < -textHeight + canvasHeight / 2) {
                endingState.phase = 'theend';
                endingState.fadeAlpha = 0;
            }
        }

        function drawEnding() {
            // „Çπ„Çø„ÉÉ„Éï„É≠„Éº„É´ÊèèÁîª
            if (endingState.phase === 'staffroll') {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.font = '20px "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif';

                for (let i = 0; i < staffRollText.length; i++) {
                    const y = endingState.scrollY + i * 30;
                    if (y > -30 && y < canvasHeight + 30) {
                        ctx.fillText(staffRollText[i], canvasWidth / 2, y);
                    }
                }

                ctx.textAlign = 'left';
            }

            // THE END Ë°®Á§∫
            if (endingState.phase === 'theend') {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                endingState.fadeAlpha = Math.min(1, endingState.fadeAlpha + 0.01);

                ctx.fillStyle = `rgba(255, 215, 0, ${endingState.fadeAlpha})`;
                ctx.textAlign = 'center';
                ctx.font = 'bold 48px "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif';
                ctx.fillText('THE END', canvasWidth / 2, canvasHeight / 2);

                ctx.font = '16px "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif';
                ctx.fillStyle = `rgba(255, 255, 255, ${endingState.fadeAlpha * 0.7})`;
                ctx.fillText('Press any key to return to title', canvasWidth / 2, canvasHeight / 2 + 60);

                ctx.textAlign = 'left';
            }
        }

        function handleEndingInput() {
            if (endingState.phase === 'theend' && endingState.fadeAlpha >= 1) {
                // „Ç≤„Éº„É†„É™„Çª„ÉÉ„ÉàÔºà„Çø„Ç§„Éà„É´„Å∏Ôºâ
                resetGame();
            }
        }

        function resetGame() {
            // „Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
            gameCleared = false;
            resetGameProgress();
            endingState.phase = 'none';
            endingState.fadeAlpha = 0;
            endingState.scrollY = 0;

            // „Éó„É¨„Ç§„É§„ÉºÂàùÊúüÂåñ
            player.hp = 30;
            player.maxHp = 30;
            player.mp = 10;
            player.maxMp = 10;
            player.baseAtk = 8;
            player.baseDef = 5;
            player.atk = 8;
            player.def = 5;
            player.speed = 5;
            player.level = 1;
            player.exp = 0;
            player.gold = 100;
            player.x = 7;
            player.y = 11;
            player.dir = 0;
            player.inventory = [];
            player.equipment = { weapon: null, armor: null };
            player.spells = [];
            player.status = { sleep: 0, poison: 0, blind: 0 };

            openedChests = [];
            currentMapId = 'castle';
            currentMap = maps[currentMapId];
            mapNameElement.textContent = currentMap.name;

            gameMode = MODE.FIELD;
            localStorage.removeItem('dragonQuestSave');
        }

        function checkRandomEncounter() {
            // ÂÆâÂÖ®Âú∞Â∏Ø„Åß„ÅØ„Ç®„É≥„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑ
            if (currentMap.isSafe === true) {
                // ÂÆâÂÖ®Âú∞Â∏Ø„Å´ÂÖ•„Å£„Åü„ÇâÊ≠©Êï∞„É™„Çª„ÉÉ„Éà
                if (stepsSinceLastBattle > 0) {
                    stepsSinceLastBattle = 0;
                }
                return;
            }

            // encounterRate=0„ÅÆ„Éû„ÉÉ„Éó„ÇÇ„Çπ„Ç≠„ÉÉ„ÉóÔºàisSafeÊú™ÂÆöÁæ©„ÅÆÊóß„Éû„ÉÉ„Éó‰∫íÊèõÔºâ
            if (currentMap.encounterRate <= 0) return;

            // „Ç®„É≥„Ç´„Ç¶„É≥„Éà„Çø„Ç§„É´‰ª•Â§ñ„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            const tile = currentMap.data[player.y][player.x];
            if (!ENCOUNTER_TILES.includes(tile)) return;

            // Ê≠©Êï∞„Ç´„Ç¶„É≥„Éà
            stepsSinceLastBattle++;

            // ‰∏çÊÑüÂú∞Â∏Ø„ÅÆÂà§ÂÆöÔºàsafeSteps‰ª•‰∏ã„ÅØ„Ç®„É≥„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑÔºâ
            if (stepsSinceLastBattle <= SAFE_STEPS) {
                // console.log(`[DEBUG] ‰∏çÊÑüÂú∞Â∏Ø: ${stepsSinceLastBattle}/${SAFE_STEPS}Ê≠©`);
                return;
            }

            // Á¢∫Áéá„ÅÆË®àÁÆóÔºàÊ≠©„Åè„Åª„Å©‰∏äÊòáÔºâ
            const stepsOverSafe = stepsSinceLastBattle - SAFE_STEPS;
            const currentEncounterRate = Math.min(
                stepsOverSafe * ENCOUNTER_RATE_PER_STEP,
                MAX_ENCOUNTER_RATE
            );

            // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Ôºà„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„ÅßÁÑ°ÂäπÂåñÂèØËÉΩÔºâ
            // console.log(`[DEBUG] Ê≠©Êï∞: ${stepsSinceLastBattle}, Á¢∫Áéá: ${(currentEncounterRate * 100).toFixed(1)}%`);

            // „Ç®„É≥„Ç´„Ç¶„É≥„ÉàÂà§ÂÆö
            if (Math.random() < currentEncounterRate) {
                // „Ç®„É≥„Ç´„Ç¶„É≥„Éà„ÉÜ„Éº„Éñ„É´„ÇíÈÅ∏ÊäûÔºàÂÑ™ÂÖàÈ†Ü‰ΩçÔºâ
                // 1. „Éû„ÉÉ„Éó„Å´Áõ¥Êé•ÊåáÂÆö„Åï„Çå„ÅüencounterTable
                // 2. mapId„Éô„Éº„Çπ
                // 3. type„Éô„Éº„Çπ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                const mapId = currentMap.mapId || '';
                let tableKey = currentMap.encounterTable || mapId;
                if (!encounterTables[tableKey]) {
                    // mapId„ÅßË¶ã„Å§„Åã„Çâ„Å™„Åë„Çå„Å∞type„ÅßÊé¢„Åô
                    tableKey = encounterTableFallback[currentMap.type] || 'field';
                }
                // tableKey„ÇíÊ∏°„Åó„Å¶„Ç∞„É´„Éº„ÉóÁîüÊàê
                startBattle(tableKey);
            }
        }

        // ÁèæÂú®„ÅÆ„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÁ¢∫Áéá„ÇíÂèñÂæóÔºà„Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Áî®Ôºâ
        function getCurrentEncounterRate() {
            if (currentMap.encounterRate <= 0) return 0;
            if (stepsSinceLastBattle <= SAFE_STEPS) return 0;
            const stepsOverSafe = stepsSinceLastBattle - SAFE_STEPS;
            return Math.min(stepsOverSafe * ENCOUNTER_RATE_PER_STEP, MAX_ENCOUNTER_RATE);
        }

        // ========================================
        // NPC„ÉªÂÆùÁÆ±
        // ========================================

        // NPC„ÅÆÊúâÂäπ„Å™‰ΩçÁΩÆ„ÇíÂèñÂæóÔºà„Çπ„Éà„Éº„É™„ÉºÈÄ≤Ë°å„ÅßÁßªÂãï„Åô„ÇãNPCÂØæÂøúÔºâ
        function getNpcEffectivePosition(npc) {
            let x = npc.x;
            let y = npc.y;

            // portal_guard„Çø„Ç§„Éó: ÊóÖ„ÅÆÊââ„ÅåÈñãÊîæ„Åï„Çå„Åü„ÇâÊ®™„Å´„Å©„Åè
            if (npc.type === 'portal_guard' && getStoryFlag('portalRoomUnlocked')) {
                x = npc.x + 1;  // Âè≥„Å´1„Éû„ÇπÁßªÂãï
            }

            // desert_portal_guard„ÅÆÂ†¥ÂêàÔºàÁ†ÇÊº†„Ç®„É™„Ç¢Áî®Ôºâ
            if (npc.id === 'desert_portal_guard' && isBossDefeated('desertGuardian')) {
                x = npc.x + 1;
            }

            return { x, y };
        }

        function getNpcAt(x, y) {
            if (!currentMap.npcs) return null;
            return currentMap.npcs.find(npc => {
                const pos = getNpcEffectivePosition(npc);
                return pos.x === x && pos.y === y;
            }) || null;
        }

        function getChestAt(x, y) {
            if (!currentMap.chests) return null;
            return currentMap.chests.find(chest => chest.x === x && chest.y === y) || null;
        }

        function isNpcBlocking(x, y) { return getNpcAt(x, y) !== null; }
        function isChestBlocking(x, y) { return getChestAt(x, y) !== null; }

        // ========================================
        // ‰ºöË©±„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        function startDialog(messages) {
            dialog.active = true;
            dialog.messages = Array.isArray(messages) ? messages : [messages];
            dialog.currentIndex = 0;
            dialog.displayedText = '';
            dialog.charIndex = 0;
            dialog.isTyping = true;
            typeNextChar();
        }

        function typeNextChar() {
            if (!dialog.active) return;
            const currentMessage = dialog.messages[dialog.currentIndex];
            if (dialog.charIndex < currentMessage.length) {
                dialog.displayedText += currentMessage[dialog.charIndex];
                dialog.charIndex++;
                setTimeout(typeNextChar, dialog.typingSpeed);
            } else {
                dialog.isTyping = false;
            }
        }

        function advanceDialog() {
            if (!dialog.active) return;
            if (dialog.isTyping) {
                dialog.displayedText = dialog.messages[dialog.currentIndex];
                dialog.charIndex = dialog.messages[dialog.currentIndex].length;
                dialog.isTyping = false;
            } else if (dialog.currentIndex < dialog.messages.length - 1) {
                dialog.currentIndex++;
                dialog.displayedText = '';
                dialog.charIndex = 0;
                dialog.isTyping = true;
                typeNextChar();
            } else {
                closeDialog();
            }
        }

        function closeDialog() {
            const callback = dialog.onComplete;
            dialog.active = false;
            dialog.messages = [];
            dialog.currentIndex = 0;
            dialog.displayedText = '';
            dialog.onComplete = null;
            // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„Åå„ÅÇ„Çå„Å∞ÂÆüË°å
            if (callback) {
                callback();
            }
        }

        // ========================================
        // ÂÆùÁÆ±„Éª„É°„Éã„É•„Éº
        // ========================================
        function openChest(chest) {
            if (chest.isOpened) {
                startDialog(['ÂÆùÁÆ±„ÅØ „Åã„Çâ„Å£„ÅΩ„Å†„ÄÇ']);
            } else {
                const item = items[chest.itemId];
                if (item) {
                    chest.isOpened = true;
                    // maps„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂÆùÁÆ±„ÇÇÂêåÊúüÔºà„Çª„Éº„Éñ„Éá„Éº„Çø„Å´ÂèçÊò†„Åï„Åõ„Çã„Åü„ÇÅÔºâ
                    if (maps[currentMapId] && maps[currentMapId].chests) {
                        const mapChest = maps[currentMapId].chests.find(c => c.id === chest.id);
                        if (mapChest) mapChest.isOpened = true;
                    }
                    addItem(item.id, 1);
                    startDialog(['ÂÆùÁÆ±„Çí„ÅÇ„Åë„ÅüÔºÅ', `${item.name} „ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ`]);
                    saveGame();
                }
            }
        }

        function openMenu() {
            if (dialog.active || isTransitioning || gameMode === MODE.BATTLE || inn.active || partyJoinConfirm.active) return;
            menu.active = true;
            menu.mode = 'status'; // „Éá„Éï„Ç©„É´„Éà„Åß„Çπ„ÉÜ„Éº„Çø„ÇπÁîªÈù¢
        }

        function closeMenu() {
            menu.active = false;
            menu.showItemAction = false;
            menu.itemActionIndex = 0;
            menu.selectingMember = false;
            menu.memberCursor = 0;
            menu.targetMemberCursor = 0;
        }

        // „Ç¢„Ç§„ÉÜ„É†„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°å
        function executeItemAction() {
            if (player.inventory.length === 0) return;

            const slot = player.inventory[menu.itemCursor];
            if (!slot) return;
            const selectedItemId = slot.id;
            const selectedItem = items[selectedItemId];
            if (!selectedItem) return;

            const isEquipment = (selectedItem.type === 'weapon' || selectedItem.type === 'armor');

            switch (menu.itemActionIndex) {
                case 0: // „Å§„Åã„ÅÜ or „Åù„ÅÜ„Å≥„Åô„Çã
                    if (isEquipment) {
                        // Ë£ÖÂÇô„Åô„Çã
                        equipItem(selectedItemId);
                        closeMenu();
                        startDialog([`${selectedItem.name}„Çí „Åù„ÅÜ„Å≥„Åó„ÅüÔºÅ`]);
                    } else {
                        // ‰Ωø„ÅÜ
                        useItem(selectedItemId);
                    }
                    break;

                case 1: // „Åô„Å¶„Çã
                    removeItem(selectedItemId, 1);
                    // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆË™øÊï¥
                    if (menu.itemCursor >= player.inventory.length && menu.itemCursor > 0) {
                        menu.itemCursor--;
                    }
                    menu.showItemAction = false;
                    if (player.inventory.length === 0) {
                        closeMenu();
                        startDialog([`${selectedItem.name}„Çí „Åô„Å¶„Åü„ÄÇ`]);
                    }
                    break;

                case 2: // „ÇÑ„ÇÅ„Çã
                    menu.showItemAction = false;
                    break;
            }
        }

        // ========================================
        // ÂÆøÂ±ã„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        function openInn(cost) {
            inn.active = true;
            inn.cost = cost;
            inn.selectedIndex = 0;
        }

        function closeInn() {
            inn.active = false;
        }

        function confirmInn() {
            if (inn.selectedIndex === 0) {
                // „ÅØ„ÅÑ
                if (player.gold >= inn.cost) {
                    player.gold -= inn.cost;
                    closeInn();
                    // ÊöóËª¢ÊºîÂá∫
                    fadeOverlay.classList.add('active');
                    setTimeout(() => {
                        player.hp = player.maxHp;
                        player.mp = player.maxMp;
                        saveGame();
                        setTimeout(() => {
                            fadeOverlay.classList.remove('active');
                            startDialog(['„ÇÜ„Å£„Åè„Çä „Åä„ÇÑ„Åô„Åø„Åè„Å†„Åï„ÅÑ...', '„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ', 'HP„Å®MP„Åå „Åã„ÅÑ„Åµ„Åè„Åó„Åæ„Åó„ÅüÔºÅ']);
                        }, 500);
                    }, 500);
                } else {
                    closeInn();
                    startDialog(['„ÅäÈáë„Åå „Åü„Çä„Å™„ÅÑ„Çà„ÅÜ„Åß„Åô...']);
                }
            } else {
                // „ÅÑ„ÅÑ„Åà
                closeInn();
                startDialog(['„Åæ„Åü„ÅÆ„ÅäË∂ä„Åó„Çí „Åä„Åæ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ']);
            }
        }

        // ========================================
        // „Ç∑„Éß„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        function openShop(shopId = 'default') {
            currentShopId = shopId;
            shop.active = true;
            shop.mode = 'menu';
            shop.phase = 'list';
            shop.menuIndex = 0;
            shop.selectedIndex = 0;
            shop.confirmIndex = 0;
            shop.equipIndex = 0;
            shop.selectedItem = null;
            shop.sellableItems = [];
        }

        // Â£≤Âç¥ÂèØËÉΩ„Å™„Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà„Çí‰ΩúÊàêÔºàË£ÖÂÇô‰∏≠„ÅÆ„ÇÇ„ÅÆ„ÅØÈô§Â§ñÔºâ
        function updateSellableItems() {
            shop.sellableItems = player.inventory.filter(slot => {
                const item = items[slot.id];
                // ‰æ°Ê†º„Åå0„ÅÆ„Ç¢„Ç§„ÉÜ„É†Ôºà‰ºùË™¨„ÅÆÂâ£„Å™„Å©Ôºâ„ÅØÂ£≤„Çå„Å™„ÅÑ
                if (!item || item.price === 0) return false;
                return true;
            });
        }

        function closeShop() {
            shop.active = false;
            startDialog(['„Åæ„Åü„ÅÆ„ÅäË∂ä„Åó„Çí „Åä„Åæ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ']);
        }

        function handleShopInput(action) {
            // „É°„Éã„É•„Éº„É¢„Éº„ÉâÔºà„Åã„ÅÜ/„ÅÜ„Çã/„ÇÑ„ÇÅ„ÇãÔºâ
            if (shop.mode === 'menu') {
                if (action === 'up') {
                    shop.menuIndex = Math.max(0, shop.menuIndex - 1);
                } else if (action === 'down') {
                    shop.menuIndex = Math.min(2, shop.menuIndex + 1);
                } else if (action === 'confirm') {
                    if (shop.menuIndex === 0) {
                        // „Åã„ÅÜ
                        shop.mode = 'buy';
                        shop.phase = 'list';
                        shop.selectedIndex = 0;
                    } else if (shop.menuIndex === 1) {
                        // „ÅÜ„Çã
                        updateSellableItems();
                        shop.mode = 'sell';
                        shop.phase = 'list';
                        shop.selectedIndex = 0;
                    } else {
                        // „ÇÑ„ÇÅ„Çã
                        closeShop();
                    }
                } else if (action === 'cancel') {
                    closeShop();
                }
                return;
            }

            // Ë≥ºÂÖ•„É¢„Éº„Éâ
            if (shop.mode === 'buy') {
                if (shop.phase === 'list') {
                    if (action === 'up') {
                        shop.selectedIndex = Math.max(0, shop.selectedIndex - 1);
                    } else if (action === 'down') {
                        shop.selectedIndex = Math.min(getShopItems().length - 1, shop.selectedIndex + 1);
                    } else if (action === 'confirm') {
                        const itemId = getShopItems()[shop.selectedIndex];
                        const item = items[itemId];
                        if (player.gold >= item.price) {
                            shop.selectedItem = item;
                            shop.phase = 'confirm';
                            shop.confirmIndex = 0;
                        }
                    } else if (action === 'cancel') {
                        shop.mode = 'menu';
                        shop.menuIndex = 0;
                    }
                } else if (shop.phase === 'confirm') {
                    if (action === 'left') {
                        shop.confirmIndex = 0;
                    } else if (action === 'right') {
                        shop.confirmIndex = 1;
                    } else if (action === 'confirm') {
                        if (shop.confirmIndex === 0) {
                            // Ë≥ºÂÖ•
                            player.gold -= shop.selectedItem.price;
                            addItem(shop.selectedItem.id, 1);
                            shop.phase = 'equip';
                            shop.equipIndex = 0;
                        } else {
                            shop.phase = 'list';
                        }
                    } else if (action === 'cancel') {
                        shop.phase = 'list';
                    }
                } else if (shop.phase === 'equip') {
                    if (action === 'left') {
                        shop.equipIndex = 0;
                    } else if (action === 'right') {
                        shop.equipIndex = 1;
                    } else if (action === 'confirm') {
                        if (shop.equipIndex === 0) {
                            equipItem(shop.selectedItem.id);
                        }
                        saveGame();
                        shop.phase = 'list';
                    } else if (action === 'cancel') {
                        saveGame();
                        shop.phase = 'list';
                    }
                }
                return;
            }

            // Â£≤Âç¥„É¢„Éº„Éâ
            if (shop.mode === 'sell') {
                if (shop.phase === 'list') {
                    if (action === 'up') {
                        shop.selectedIndex = Math.max(0, shop.selectedIndex - 1);
                    } else if (action === 'down') {
                        shop.selectedIndex = Math.min(Math.max(0, shop.sellableItems.length - 1), shop.selectedIndex + 1);
                    } else if (action === 'confirm') {
                        if (shop.sellableItems.length > 0) {
                            const slot = shop.sellableItems[shop.selectedIndex];
                            shop.selectedItem = items[slot.id];
                            shop.phase = 'confirm';
                            shop.confirmIndex = 0;
                        }
                    } else if (action === 'cancel') {
                        shop.mode = 'menu';
                        shop.menuIndex = 1;
                    }
                } else if (shop.phase === 'confirm') {
                    if (action === 'left') {
                        shop.confirmIndex = 0;
                    } else if (action === 'right') {
                        shop.confirmIndex = 1;
                    } else if (action === 'confirm') {
                        if (shop.confirmIndex === 0) {
                            // Â£≤Âç¥ÂÆüË°å
                            const sellPrice = Math.floor(shop.selectedItem.price / 2);
                            player.gold += sellPrice;
                            // „Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
                            removeItem(shop.selectedItem.id, 1);
                            shop.phase = 'sold';
                        } else {
                            shop.phase = 'list';
                        }
                    } else if (action === 'cancel') {
                        shop.phase = 'list';
                    }
                } else if (shop.phase === 'sold') {
                    // Â£≤Âç¥ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏Âæå
                    if (action === 'confirm' || action === 'cancel') {
                        updateSellableItems();
                        shop.selectedIndex = Math.min(shop.selectedIndex, Math.max(0, shop.sellableItems.length - 1));
                        shop.phase = 'list';
                        saveGame();
                    }
                }
            }
        }

        // „Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®
        function useItem(itemId) {
            const item = items[itemId];
            if (!item) return false;

            // Ë£ÖÂÇô„Ç¢„Ç§„ÉÜ„É†„ÅØ‰ΩøÁî®„Åß„Åç„Å™„ÅÑÔºàË£ÖÂÇô„Åô„Çã„ÇíÈÅ∏„Å∂ÂøÖË¶Å„Åå„ÅÇ„ÇãÔºâ
            if (item.type === 'weapon' || item.type === 'armor') {
                return false;
            }

            let message = '';
            let success = false;

            switch (item.type) {
                case 'heal':
                    // HPÂõûÂæ©„Ç¢„Ç§„ÉÜ„É†
                    if (player.hp >= player.maxHp) {
                        message = 'HP„ÅØ „Åæ„Çì„Åü„Çì„Å†ÔºÅ';
                    } else {
                        const healAmount = Math.min(item.value, player.maxHp - player.hp);
                        player.hp += healAmount;
                        message = `${item.name}„Çí‰Ωø„Å£„ÅüÔºÅ\nHP„Åå ${healAmount} ÂõûÂæ©„Åó„ÅüÔºÅ`;
                        success = true;
                    }
                    break;

                case 'cure':
                    // Áä∂ÊÖãÁï∞Â∏∏ÂõûÂæ©ÔºàÊØí„Å™„Å©Ôºâ
                    if (player.status && player.status.poison > 0) {
                        player.status.poison = 0;
                        message = `${item.name}„Çí‰Ωø„Å£„ÅüÔºÅ\nÊØí„Åå Ê≤ª„Å£„ÅüÔºÅ`;
                        success = true;
                    } else {
                        message = 'ÊØí„Å´ „Åã„Åã„Å£„Å¶„ÅÑ„Å™„ÅÑÔºÅ';
                    }
                    break;

                case 'holy':
                    // ËÅñÊ∞¥Ôºö„Åó„Å∞„Çâ„Åè„Ç®„É≥„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑÂäπÊûú
                    message = `${item.name}„Çí‰Ωø„Å£„ÅüÔºÅ\n„Åó„Å∞„Çâ„Åè È≠îÁâ©„Åå „Çà„Çä„Å§„Åã„Å™„ÅÑÔºÅ`;
                    stepsSinceLastBattle = -10; // Ê≠©Êï∞„Çí„Éû„Ç§„Éä„Çπ„Å´„Åó„Å¶„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÂõûÈÅø
                    success = true;
                    break;

                case 'escape':
                    // „Ç≠„É°„É©„ÅÆ„Å§„Å∞„ÅïÔºöÁî∫„Å´Êàª„Çã
                    if (currentMap.type === 'town' || currentMap.type === 'castle') {
                        message = '„Åì„Åì„Åß„ÅØ ‰Ωø„Åà„Å™„ÅÑÔºÅ';
                    } else {
                        // „Ç¢„Ç§„ÉÜ„É†Ê∂àË≤ª
                        removeItem(itemId, 1);
                        if (menu.itemCursor >= player.inventory.length && menu.itemCursor > 0) {
                            menu.itemCursor--;
                        }
                        // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Å¶„ÉÄ„Ç§„Ç¢„É≠„Ç∞Ë°®Á§∫„ÄÅÂÆå‰∫ÜÂæå„Å´„ÉØ„Éº„Éó
                        closeMenu();
                        startDialogWithCallback(
                            [`${item.name}„Çí‰Ωø„Å£„ÅüÔºÅ`, `${lastTown.name}„Å´ È£õ„Çì„Åß„ÅÑ„Åè...`],
                            () => {
                                performMapWarp(lastTown.mapPath, lastTown.x, lastTown.y);
                            }
                        );
                        return true;
                    }
                    break;

                case 'key':
                    // ÈçµÔºö„Éï„Ç£„Éº„É´„Éâ„Åß„ÅØ‰Ωø„Åà„Å™„ÅÑ
                    message = '„Åì„Åì„Åß„ÅØ ‰Ωø„Åà„Å™„ÅÑÔºÅ';
                    break;

                default:
                    message = '„Åì„Åì„Åß„ÅØ ‰Ωø„Åà„Å™„ÅÑÔºÅ';
                    break;
            }

            // ‰ΩøÁî®ÊàêÂäüÊôÇ„ÄÅ„Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
            if (success) {
                removeItem(itemId, 1);
                // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆË™øÊï¥
                if (menu.itemCursor >= player.inventory.length && menu.itemCursor > 0) {
                    menu.itemCursor--;
                }
            }

            // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Å¶„ÉÄ„Ç§„Ç¢„É≠„Ç∞Ë°®Á§∫
            closeMenu();
            startDialog(message.split('\n'));
            return success;
        }

        // „Éï„Ç£„Éº„É´„Éâ„ÅßÂë™Êñá„Çí‰ΩøÁî®
        function useSpellInField() {
            const caster = party[menu.memberCursor] || party[0];
            if (caster.spells.length === 0) return;

            const spellId = caster.spells[menu.spellCursor];
            const spell = spells[spellId];
            if (!spell) return;

            // MP‰∏çË∂≥„ÉÅ„Çß„ÉÉ„ÇØ
            if (caster.mp < spell.mp) {
                closeMenu();
                startDialog(['MP„Åå Ë∂≥„Çä„Å™„ÅÑÔºÅ']);
                return;
            }

            // Âë™Êñá„Çø„Ç§„ÉóÂà•Âá¶ÁêÜ
            if (spell.type === 'heal') {
                // ÂõûÂæ©Âë™Êñá - „Éë„Éº„ÉÜ„Ç£„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØÂØæË±°ÈÅ∏Êäû
                if (party.length > 1) {
                    menu.selectingMember = true;
                    menu.targetMemberCursor = 0;
                } else {
                    // „ÇΩ„É≠„Éó„É¨„Ç§ÊôÇ„ÅØËá™ÂàÜ„Å´‰Ωø„ÅÜ
                    if (caster.hp >= caster.maxHp) {
                        closeMenu();
                        startDialog(['HP„ÅØ „Åæ„Çì„Åü„Çì„Å†ÔºÅ']);
                        return;
                    }

                    caster.mp -= spell.mp;
                    const healAmount = Math.min(spell.power, caster.maxHp - caster.hp);
                    caster.hp += healAmount;

                    closeMenu();
                    startDialog([
                        `${caster.name}„ÅØ ${spell.name}„Çí „Å®„Å™„Åà„ÅüÔºÅ`,
                        `HP„Åå ${healAmount} ÂõûÂæ©„Åó„ÅüÔºÅ`
                    ]);
                }

            } else if (spell.type === 'warp') {
                // „É´„Éº„É©ÔºàÊã†ÁÇπ„ÉØ„Éº„ÉóÔºâ
                useRura();

            } else if (spell.type === 'escape') {
                // „É™„É¨„Éü„ÉàÔºà„ÉÄ„É≥„Ç∏„Éß„É≥ËÑ±Âá∫Ôºâ
                useRiremito();

            } else {
                closeMenu();
                startDialog(['„Åì„Åì„Åß„ÅØ ‰Ωø„Åà„Å™„ÅÑÔºÅ']);
            }
        }

        // „Éï„Ç£„Éº„É´„Éâ„ÅßÂë™Êñá„ÇíÂØæË±°„Å´‰ΩøÁî®
        function executeFieldSpellOnTarget() {
            const caster = party[menu.memberCursor] || party[0];
            const target = party[menu.targetMemberCursor];
            if (!target) {
                menu.selectingMember = false;
                return;
            }

            const spellId = caster.spells[menu.spellCursor];
            const spell = spells[spellId];
            if (!spell) {
                menu.selectingMember = false;
                return;
            }

            // ÂõûÂæ©Âë™Êñá„ÅÆÂá¶ÁêÜ
            if (spell.type === 'heal') {
                if (target.hp >= target.maxHp) {
                    menu.selectingMember = false;
                    closeMenu();
                    startDialog([`${target.name}„ÅÆ HP„ÅØ „Åæ„Çì„Åü„Çì„Å†ÔºÅ`]);
                    return;
                }

                caster.mp -= spell.mp;
                const healAmount = Math.min(spell.power, target.maxHp - target.hp);
                target.hp += healAmount;

                menu.selectingMember = false;
                closeMenu();

                if (caster === target) {
                    startDialog([
                        `${caster.name}„ÅØ ${spell.name}„Çí „Å®„Å™„Åà„ÅüÔºÅ`,
                        `HP„Åå ${healAmount} ÂõûÂæ©„Åó„ÅüÔºÅ`
                    ]);
                } else {
                    startDialog([
                        `${caster.name}„ÅØ ${spell.name}„Çí „Å®„Å™„Åà„ÅüÔºÅ`,
                        `${target.name}„ÅÆ HP„Åå ${healAmount} ÂõûÂæ©„Åó„ÅüÔºÅ`
                    ]);
                }
            }
        }

        // „É´„Éº„É©Áî®ÔºöÊã†ÁÇπÈÅ∏ÊäûÁä∂ÊÖã
        let ruraState = {
            active: false,
            cursor: 0,
            casterIndex: 0 // Âë™Êñá„ÇíÂî±„Åà„Çã„É°„É≥„Éê„Éº„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        };

        // „É´„Éº„É©„Çí‰ΩøÁî®ÔºàÊã†ÁÇπÈÅ∏ÊäûUI„ÇíË°®Á§∫Ôºâ
        function useRura() {
            const caster = party[menu.memberCursor] || party[0];
            const spell = spells.rura;

            // Â§©‰∫ïÂà§ÂÆöÔºöÂ±ãÂÜÖ„Åß„ÅØ‰Ωø„Åà„Å™„ÅÑ
            if (currentMap.isOutdoor === false) {
                caster.mp -= spell.mp;
                closeMenu();
                startDialog([
                    `${caster.name}„ÅØ ${spell.name}„Çí „Å®„Å™„Åà„ÅüÔºÅ`,
                    '„Åó„Åã„Åó Â§©‰∫ï„Å´ È†≠„Çí „Å∂„Å§„Åë„Å¶„Åó„Åæ„Å£„ÅüÔºÅ'
                ]);
                return;
            }

            // Ë®™ÂïèÊ∏à„ÅøÊã†ÁÇπ„Åå„Å™„ÅÑÂ†¥Âêà
            if (gameProgress.visitedLocations.length === 0) {
                closeMenu();
                startDialog(['„Åæ„Å† „Å©„Åì„Å´„ÇÇ Ë°å„Å£„Åü„Åì„Å®„Åå„Å™„ÅÑÔºÅ']);
                return;
            }

            // Êã†ÁÇπÈÅ∏ÊäûUI„ÇíË°®Á§∫ÔºàË©†Âî±ËÄÖ„ÇíË®òÊÜ∂Ôºâ
            ruraState.active = true;
            ruraState.cursor = 0;
            ruraState.casterIndex = menu.memberCursor;
            closeMenu();
        }

        // „É´„Éº„É©ÂÆüË°åÔºàÊã†ÁÇπ„ÇíÈÅ∏Êäû„Åó„Å¶ÁßªÂãïÔºâ
        async function executeRura(locationIndex) {
            const spell = spells.rura;
            const location = gameProgress.visitedLocations[locationIndex];
            if (!location) return;

            const caster = party[ruraState.casterIndex] || party[0];
            caster.mp -= spell.mp;
            ruraState.active = false;

            // „É´„Éº„É©ÊºîÂá∫ÔºàÁôΩ„Éï„É©„ÉÉ„Ç∑„É•Ôºâ
            await playRuraAnimation();

            // „ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫„Åó„Å¶„ÉØ„Éº„Éó
            startDialogWithCallback(
                [`${location.displayName}„Å∏ Âêë„Åã„Å£„Å¶ È£õ„Å≥Á´ã„Å£„ÅüÔºÅ`],
                () => {
                    const mapPath = `maps/${location.mapId}.json`;
                    performWarp(mapPath, location.arrivalX, location.arrivalY);
                }
            );
        }

        // „É´„Éº„É©ÊºîÂá∫
        async function playRuraAnimation() {
            return new Promise(resolve => {
                // ÁôΩ„Éï„É©„ÉÉ„Ç∑„É•
                spellFlash.active = true;
                spellFlash.color = 'rgba(100, 200, 255, 0.8)';
                spellFlash.alpha = 1.0;

                setTimeout(() => {
                    spellFlash.active = false;
                    resolve();
                }, 500);
            });
        }

        // „É™„É¨„Éü„Éà„Çí‰ΩøÁî®Ôºà„ÉÄ„É≥„Ç∏„Éß„É≥ËÑ±Âá∫Ôºâ
        function useRiremito() {
            const caster = party[menu.memberCursor] || party[0];
            const spell = spells.riremito;

            // „Éï„Ç£„Éº„É´„Éâ„Åß„ÅØ‰Ωø„Åà„Å™„ÅÑ
            if (currentMap.isOutdoor === true) {
                closeMenu();
                startDialog([
                    `${caster.name}„ÅØ ${spell.name}„Çí „Å®„Å™„Åà„ÅüÔºÅ`,
                    '„Åó„Åã„Åó „Åì„Åì„Åß„ÅØ ÊÑèÂë≥„Åå„Å™„ÅÑÔºÅ'
                ]);
                return;
            }

            // „ÉÄ„É≥„Ç∏„Éß„É≥ÂÖ•Âè£ÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà
            const entrance = getLastEntrance();
            if (!entrance) {
                closeMenu();
                startDialog(['ËÑ±Âá∫ÂÖà„Åå Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÔºÅ']);
                return;
            }

            caster.mp -= spell.mp;
            closeMenu();

            // „É™„É¨„Éü„ÉàÊºîÂá∫ÔºàÁôΩ„Éï„É©„ÉÉ„Ç∑„É•Ôºâ
            playRiremitoAnimation().then(() => {
                startDialogWithCallback(
                    [`${caster.name}„ÅØ Âë™Êñá„Çí „Å®„Å™„Åà„Å¶ ËÑ±Âá∫„Åó„ÅüÔºÅ`],
                    () => {
                        performWarp(entrance.mapPath, entrance.x, entrance.y);
                    }
                );
            });
        }

        // „É™„É¨„Éü„ÉàÊºîÂá∫
        async function playRiremitoAnimation() {
            return new Promise(resolve => {
                spellFlash.active = true;
                spellFlash.color = 'rgba(200, 200, 255, 0.8)';
                spellFlash.alpha = 1.0;

                setTimeout(() => {
                    spellFlash.active = false;
                    resolve();
                }, 400);
            });
        }

        // „É´„Éº„É©Êã†ÁÇπÈÅ∏ÊäûUI„ÅÆÊèèÁîª
        function drawRuraSelection() {
            if (!ruraState.active) return;

            const locations = gameProgress.visitedLocations;
            if (locations.length === 0) return;

            // „Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫Ë®àÁÆó
            const lineHeight = tileSize * 0.5;
            const windowWidth = canvasWidth * 0.6;
            const windowHeight = lineHeight * (locations.length + 2) + 40;
            const windowX = (canvasWidth - windowWidth) / 2;
            const windowY = (canvasHeight - windowHeight) / 2;

            // „Ç¶„Ç£„É≥„Éâ„Ç¶ÊèèÁîª
            drawWindow(windowX, windowY, windowWidth, windowHeight);

            // „Çø„Ç§„Éà„É´
            ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillStyle = '#ffd700';
            ctx.fillText('„Å©„Åì„Å∏ „ÅÑ„Åç„Åæ„Åô„ÅãÔºü', canvasWidth / 2, windowY + 15);

            // Âå∫Âàá„ÇäÁ∑ö
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.moveTo(windowX + 20, windowY + 40);
            ctx.lineTo(windowX + windowWidth - 20, windowY + 40);
            ctx.stroke();

            // Êã†ÁÇπ„É™„Çπ„Éà
            ctx.textAlign = 'left';
            ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            const listStartY = windowY + 55;

            for (let i = 0; i < locations.length; i++) {
                const y = listStartY + i * lineHeight;

                // „Ç´„Éº„ÇΩ„É´Ë°®Á§∫
                if (i === ruraState.cursor) {
                    ctx.fillStyle = '#ffd700';
                    ctx.fillText('‚ñ∂', windowX + 25, y);
                }

                // Êã†ÁÇπÂêç
                ctx.fillStyle = i === ruraState.cursor ? '#fff' : 'rgba(255, 255, 255, 0.7)';
                ctx.fillText(locations[i].displayName, windowX + 50, y);
            }

            // Êìç‰ΩúË™¨Êòé
            ctx.font = `${tileSize * 0.25}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.textAlign = 'center';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.fillText('‚Üë‚Üì:ÈÅ∏Êäû  Enter:Ê±∫ÂÆö  Esc:„Ç≠„É£„É≥„Çª„É´', canvasWidth / 2, windowY + windowHeight - 20);
        }

        // „É´„Éº„É©ÈÅ∏Êäû„Çí„Ç≠„É£„É≥„Çª„É´
        function cancelRuraSelection() {
            ruraState.active = false;
        }

        function equipItem(itemId) {
            const item = items[itemId];
            if (!item) return;

            if (item.type === 'weapon') {
                // ÁèæÂú®„ÅÆÊ≠¶Âô®„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Å´Êàª„ÅôÔºàÂàùÊúüË£ÖÂÇô„Åß„Å™„ÅÑÂ†¥ÂêàÔºâ
                if (player.equipment.weapon && player.equipment.weapon !== 10) {
                    addItem(player.equipment.weapon, 1);
                }
                // Êñ∞„Åó„ÅÑÊ≠¶Âô®„ÇíË£ÖÂÇô
                player.equipment.weapon = itemId;
                // „Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
                removeItem(itemId, 1);
            } else if (item.type === 'armor') {
                // ÁèæÂú®„ÅÆÈò≤ÂÖ∑„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Å´Êàª„ÅôÔºàÂàùÊúüË£ÖÂÇô„Åß„Å™„ÅÑÂ†¥ÂêàÔºâ
                if (player.equipment.armor && player.equipment.armor !== 20) {
                    addItem(player.equipment.armor, 1);
                }
                // Êñ∞„Åó„ÅÑÈò≤ÂÖ∑„ÇíË£ÖÂÇô
                player.equipment.armor = itemId;
                // „Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
                removeItem(itemId, 1);
            }
            // Ë£ÖÂÇôÂ§âÊõ¥Âæå„ÄÅ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂÜçË®àÁÆó
            updateActualStats();
        }

        // ========================================
        // „Éû„ÉÉ„ÉóÈÅ∑ÁßªÔºà„Éû„É´„ÉÅ„Éû„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†ÂØæÂøúÔºâ
        // ========================================

        // ÈùûÂêåÊúü„Éû„ÉÉ„Éó„É≠„Éº„ÉâÔºàÂÆüÈöõ„ÅÆfetch„ÅßJSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄÔºâ
        async function loadMapFromDatabase(mapPath) {
            try {
                // ÂÆüÈöõ„ÅÆJSON„Éï„Ç°„Ç§„É´„Çífetch
                const response = await fetch(mapPath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const mapData = await response.json();
                console.log(`„Éû„ÉÉ„Éó„Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü: ${mapPath}`);
                return mapData;
            } catch (error) {
                console.error(`„Éû„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº (${mapPath}):`, error);

                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÊóßÂΩ¢Âºè„ÅÆ„Éû„ÉÉ„ÉóID„Å´Â§âÊèõ„ÇíË©¶„Åø„Çã
                const mapIdMatch = mapPath.match(/maps\/(.+)\.json/);
                if (mapIdMatch) {
                    const mapId = mapIdMatch[1].replace('_', '');
                    const normalizedId = mapId === 'maou_room' ? 'maouRoom' : mapId;
                    if (maps[normalizedId]) {
                        console.log(`„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂÜÖËîµ„Éû„ÉÉ„Éó ${normalizedId} „Çí‰ΩøÁî®`);
                        return {
                            ...maps[normalizedId],
                            mapId: normalizedId
                        };
                    }
                }

                throw error;
            }
        }

        // „Éû„ÉÉ„Éó„Éë„Çπ„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
        function isMapPath(target) {
            return target.startsWith('maps/') || target.endsWith('.json');
        }

        // „Éû„ÉÉ„Éó„Éë„Çπ„Åã„ÇâÊóßÂΩ¢ÂºèID„Å∏„ÅÆÂ§âÊèõ
        function getMapIdFromPath(mapPath) {
            const match = mapPath.match(/maps\/(.+)\.json/);
            if (match) {
                const id = match[1].replace('_', '');
                return id === 'maou_room' ? 'maouRoom' : id;
            }
            return mapPath;
        }

        // ÊóßÂΩ¢ÂºèID„Åã„Çâ„Éû„ÉÉ„Éó„Éë„Çπ„Å∏„ÅÆÂ§âÊèõ
        function getMapPathFromId(mapId) {
            if (mapId === 'maouRoom') return 'maps/maou_room.json';
            return `maps/${mapId}.json`;
        }

        function checkWarp() {
            // ÊóÖ„ÅÆÊââ„ÉÅ„Çß„ÉÉ„ÇØÔºàÂÖà„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÄÅÁâπÂà•ÊºîÂá∫„ÅÇ„ÇäÔºâ
            if (currentMap.portals) {
                for (const portal of currentMap.portals) {
                    if (player.x === portal.x && player.y === portal.y) {
                        performPortalWarp(portal);
                        return;
                    }
                }
            }

            // ÈÄöÂ∏∏„ÉØ„Éº„Éó„ÉÅ„Çß„ÉÉ„ÇØ
            if (!currentMap.warps) return;
            for (const warp of currentMap.warps) {
                if (player.x === warp.x && player.y === warp.y) {
                    // ÈÄöË°åÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
                    if (warp.requiresFlag && !getStoryFlag(warp.requiresFlag)) {
                        startDialog(['„Åì„ÅÆÂÖà„Å∏„ÅØ „Åæ„Å† Ë°å„Åë„Å™„ÅÑ„Çà„ÅÜ„Å†...']);
                        return;
                    }

                    // ÈöéÊÆµ„Çø„Ç§„Éó„ÅÆÂá¶ÁêÜÔºàstairType: 'up' | 'down'Ôºâ
                    if (warp.stairType) {
                        performStairWarp(warp);
                    } else {
                        performWarp(warp.targetMap, warp.targetX, warp.targetY);
                    }
                    return;
                }
            }
        }

        // ÈöéÊÆµ„ÉØ„Éº„ÉóÔºàÈöéÂ±§ÁßªÂãïÁî®Ôºâ
        async function performStairWarp(stairWarp) {
            if (isTransitioning) return;
            isTransitioning = true;

            // ÈöéÊÆµ„ÅÆÊñπÂêë„Å´Âøú„Åò„Åü„É°„ÉÉ„Çª„Éº„Ç∏
            const direction = stairWarp.stairType === 'up' ? '‰∏ä' : '‰∏ã';

            // Áü≠„ÅÑ„Éï„Çß„Éº„ÉâÊºîÂá∫
            fadeOverlay.classList.add('active');
            await new Promise(resolve => setTimeout(resolve, 200));

            // ÈÄöÂ∏∏„ÅÆ„ÉØ„Éº„ÉóÂá¶ÁêÜ„ÇíÂÆüË°å
            isTransitioning = false;
            await performWarp(stairWarp.targetMap, stairWarp.targetX, stairWarp.targetY);
        }

        // ÊóÖ„ÅÆÊââ„ÉØ„Éº„ÉóÔºàÁâπÂà•ÊºîÂá∫‰ªò„ÅçÔºâ
        async function performPortalWarp(portal) {
            if (isTransitioning) return;

            // ÈÄöË°åÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
            if (portal.requiresFlag && !getStoryFlag(portal.requiresFlag)) {
                startDialog(['„Åì„ÅÆÊââ„ÅØ „Åæ„Å† Èñã„Åã„Å™„ÅÑ...', 'ÁâπÂà•„Å™Ë®±ÂèØ„Åå ÂøÖË¶Å„Å™„Çà„ÅÜ„Å†„ÄÇ']);
                return;
            }

            isTransitioning = true;

            // Ê∏¶Â∑ª„ÅçÔºã„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            await playPortalAnimation();

            // ÈÄöÂ∏∏„ÅÆ„ÉØ„Éº„ÉóÂá¶ÁêÜ„ÇíÂÆüË°å
            isTransitioning = false;  // performWarpÂÜÖ„ÅßÂÜçË®≠ÂÆö„Åï„Çå„Çã„ÅÆ„Åß‰∏ÄÊó¶Ëß£Èô§
            await performWarp(portal.targetMap, portal.targetX, portal.targetY);
        }

        // ÊóÖ„ÅÆÊââÊºîÂá∫
        async function playPortalAnimation() {
            const duration = 800; // 0.8Áßí
            const startTime = Date.now();

            // ÁîªÈù¢„ÇíÁ¥´„Å´„Éï„É©„ÉÉ„Ç∑„É•„Åó„Å™„Åå„ÇâÊ∏¶Â∑ª„Åç
            return new Promise(resolve => {
                function animate() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // „Éï„Çß„Éº„Éâ„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÁ¥´„Å´
                    fadeOverlay.style.background = `rgba(100, 50, 150, ${progress * 0.8})`;
                    fadeOverlay.classList.add('active');

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // ÁôΩ„ÅÑ„Éï„É©„ÉÉ„Ç∑„É•„ÅßÁ∑†„ÇÅ
                        fadeOverlay.style.background = '#fff';
                        setTimeout(() => {
                            fadeOverlay.style.background = '#000';
                            resolve();
                        }, 100);
                    }
                }
                animate();
            });
        }

        async function performWarp(targetMap, targetX, targetY) {
            if (isTransitioning) return;

            // „É™„É¨„Éü„ÉàÁî®ÔºöÈÄ≤ÂÖ•Ââç„ÅÆ„Éû„ÉÉ„ÉóÊÉÖÂ†±„Çí‰øùÂ≠ò
            const prevMapData = currentMap;
            const prevX = player.x;
            const prevY = player.y;
            const prevMapPath = currentMapPath;

            // Êñ∞ÂΩ¢ÂºèÔºàmaps/*.jsonÔºâ„ÅãÊóßÂΩ¢ÂºèÔºàmapIdÔºâ„Åã„ÇíÂà§ÂÆö
            const isNewFormat = isMapPath(targetMap);
            const targetMapPath = isNewFormat ? targetMap : getMapPathFromId(targetMap);
            const targetMapId = isNewFormat ? getMapIdFromPath(targetMap) : targetMap;

            // „Ç≠„É£„ÉÉ„Ç∑„É•Ê∏à„Åø„ÅÆÂ§ñÈÉ®JSON„Éû„ÉÉ„Éó„Åå„ÅÇ„Çå„Å∞ÂÜçÂà©Áî®ÔºàÂÆùÁÆ±Áä∂ÊÖã‰øùÊåÅ„ÅÆ„Åü„ÇÅÔºâ
            if (maps[targetMapId] && maps[targetMapId]._isExternal) {
                performLegacyWarp(targetMapId, targetX, targetY);
                return;
            }

            // ÊóßÂΩ¢ÂºèÔºàÂÜÖËîµ„Éû„ÉÉ„ÉóÔºâ„ÇíÁõ¥Êé•ÂèÇÁÖß„Åß„Åç„Çã„ÅãÁ¢∫Ë™ç
            if (!isNewFormat && maps[targetMapId]) {
                performLegacyWarp(targetMapId, targetX, targetY);
                return;
            }

            // Êñ∞ÂΩ¢Âºè„ÅÆ„Éû„ÉÉ„Éó„É≠„Éº„Éâ
            isTransitioning = true;
            mapLoadState.loading = true;
            fadeOverlay.classList.add('active');

            try {
                // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÂÆå‰∫Ü„ÇíÂæÖ„Å§
                await new Promise(resolve => setTimeout(resolve, 300));

                // „Éû„ÉÉ„Éó„Çí„É≠„Éº„Éâ
                const mapData = await loadMapFromDatabase(targetMapPath);

                // Â§ñÈÉ®JSON„Éû„ÉÉ„Éó„Åß„ÅÇ„Çã„Åì„Å®„Çí„Éû„Éº„ÇØ
                mapData._isExternal = true;

                // „Éû„ÉÉ„Éó„Çímaps„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ËøΩÂä†Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•Ôºâ
                maps[mapData.mapId] = mapData;

                // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„ÇíÊõ¥Êñ∞
                currentMapId = mapData.mapId;
                currentMapPath = targetMapPath;
                currentMap = mapData;
                player.x = targetX;
                player.y = targetY;
                mapNameElement.textContent = currentMap.name;

                // Áô∫Ë¶ãÊ∏à„ÅøÈö†„ÅóÈÄöË∑Ø„ÇíÈÅ©Áî®
                applyOpenedPassages(currentMap);

                // „Çª„Éº„Éñ„Éá„Éº„Çø„Åã„ÇâÂÆùÁÆ±„ÅÆÈñãÂ∞ÅÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
                try {
                    const savedData = localStorage.getItem(SAVE_KEY);
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        if (data.chestStates && data.chestStates[currentMapId] && currentMap.chests) {
                            for (const savedChest of data.chestStates[currentMapId]) {
                                const chest = currentMap.chests.find(c => c.id === savedChest.id);
                                if (chest) chest.isOpened = savedChest.isOpened;
                            }
                        }
                    }
                } catch (e) {
                    console.error('ÂÆùÁÆ±Áä∂ÊÖã„ÅÆÂæ©ÂÖÉ„Å´Â§±Êïó:', e);
                }
                updateMapPinVisibility();
                updateFloorDisplay();
                updateCamera();
                saveGame();

                // ÂÆâÂÖ®„Å™„Éû„ÉÉ„ÉóÔºàË°ó„ÉªÂüé„Å™„Å©Ôºâ„Å´ÂÖ•„Å£„Åü„ÇâÊ≠©Êï∞„É™„Çª„ÉÉ„Éà
                if (currentMap.encounterRate <= 0) {
                    stepsSinceLastBattle = 0;
                }

                // „É´„Éº„É©Áî®ÔºöÊã†ÁÇπ„ÅÆÁôªÈå≤
                registerVisitedLocation(currentMap);

                // „É™„É¨„Éü„ÉàÁî®Ôºö„ÉÄ„É≥„Ç∏„Éß„É≥ÈÄ≤ÂÖ•ÊôÇ„Å´ÂÖ•Âè£„ÇíË®òÊÜ∂
                if (currentMap.isOutdoor === false && prevMapData) {
                    recordDungeonEntrance(prevMapData, prevX, prevY, prevMapPath);
                }

                // Áî∫„ÉªÂüé„Å´ÂÖ•„Å£„Åü„Çâ„Ç≠„É°„É©„ÅÆ„Å§„Å∞„ÅïÁî®„Å´Ë®òÈå≤
                if (currentMap.type === 'town' || currentMap.type === 'castle') {
                    lastTown = {
                        mapPath: targetMapPath,
                        x: targetX,
                        y: targetY,
                        name: currentMap.name
                    };
                }

                // „Éï„Çß„Éº„Éâ„Ç§„É≥
                await new Promise(resolve => setTimeout(resolve, 100));
                fadeOverlay.classList.remove('active');
                await new Promise(resolve => setTimeout(resolve, 300));

            } catch (error) {
                console.error('„Éû„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÊóßÂΩ¢Âºè„ÇíË©¶„Åô
                if (maps[targetMapId]) {
                    currentMapId = targetMapId;
                    currentMap = maps[targetMapId];
                    player.x = targetX;
                    player.y = targetY;
                    mapNameElement.textContent = currentMap.name;
                    updateMapPinVisibility();
                    updateFloorDisplay();
                    updateCamera();
                }
                fadeOverlay.classList.remove('active');
            } finally {
                mapLoadState.loading = false;
                isTransitioning = false;
            }
        }

        // ÊóßÂΩ¢Âºè„ÅÆ„ÉØ„Éº„ÉóÂá¶ÁêÜÔºà‰∫íÊèõÊÄßÁ∂≠ÊåÅÔºâ
        function performLegacyWarp(targetMapId, targetX, targetY) {
            if (isTransitioning || !maps[targetMapId]) return;

            // „É™„É¨„Éü„ÉàÁî®ÔºöÈÄ≤ÂÖ•Ââç„ÅÆ„Éû„ÉÉ„ÉóÊÉÖÂ†±„Çí‰øùÂ≠ò
            const prevMapData = currentMap;
            const prevX = player.x;
            const prevY = player.y;
            const prevMapPath = currentMapPath;

            isTransitioning = true;
            fadeOverlay.classList.add('active');

            setTimeout(() => {
                currentMapId = targetMapId;
                currentMapPath = getMapPathFromId(targetMapId);
                currentMap = maps[targetMapId];
                player.x = targetX;
                player.y = targetY;
                mapNameElement.textContent = currentMap.name;
                applyOpenedPassages(currentMap);
                updateMapPinVisibility();
                updateFloorDisplay();
                updateCamera();
                saveGame();

                // ÂÆâÂÖ®„Å™„Éû„ÉÉ„ÉóÔºàË°ó„ÉªÂüé„Å™„Å©Ôºâ„Å´ÂÖ•„Å£„Åü„ÇâÊ≠©Êï∞„É™„Çª„ÉÉ„Éà
                if (currentMap.encounterRate <= 0) {
                    stepsSinceLastBattle = 0;
                }

                // „É´„Éº„É©Áî®ÔºöÊã†ÁÇπ„ÅÆÁôªÈå≤
                registerVisitedLocation(currentMap);

                // „É™„É¨„Éü„ÉàÁî®Ôºö„ÉÄ„É≥„Ç∏„Éß„É≥ÈÄ≤ÂÖ•ÊôÇ„Å´ÂÖ•Âè£„ÇíË®òÊÜ∂
                if (currentMap.isOutdoor === false && prevMapData) {
                    recordDungeonEntrance(prevMapData, prevX, prevY, prevMapPath);
                }

                // Áî∫„ÉªÂüé„Å´ÂÖ•„Å£„Åü„Çâ„Ç≠„É°„É©„ÅÆ„Å§„Å∞„ÅïÁî®„Å´Ë®òÈå≤
                if (currentMap.type === 'town' || currentMap.type === 'castle') {
                    lastTown = {
                        mapPath: currentMapPath,
                        x: targetX,
                        y: targetY,
                        name: currentMap.name
                    };
                }

                setTimeout(() => {
                    fadeOverlay.classList.remove('active');
                    setTimeout(() => { isTransitioning = false; }, 300);
                }, 100);
            }, 300);
        }

        // ========================================
        // ÁßªÂãï
        // ========================================
        function canMove(x, y) {
            if (x < 0 || x >= currentMap.cols || y < 0 || y >= currentMap.rows) return false;
            const tile = currentMap.data[y][x];
            if (!WALKABLE_TILES.includes(tile)) return false;
            if (isNpcBlocking(x, y) || isChestBlocking(x, y)) return false;
            return true;
        }

        function movePlayer(dx, dy) {
            if (player.moving || isTransitioning || dialog.active || menu.active || inn.active || shop.active || partyJoinConfirm.active || gameMode === MODE.BATTLE) return;

            if (dy < 0) player.direction = 'up';
            else if (dy > 0) player.direction = 'down';
            else if (dx < 0) player.direction = 'left';
            else if (dx > 0) player.direction = 'right';

            const newX = player.x + dx;
            const newY = player.y + dy;

            if (canMove(newX, newY)) {
                player.moving = true;
                player.x = newX;
                player.y = newY;
                updateCamera();

                setTimeout(() => {
                    checkWarp();
                    if (gameMode === MODE.FIELD) {
                        checkRandomEncounter();
                    }
                    player.moving = false;
                }, player.moveDelay);
            }
        }

        function getFrontPosition() {
            let fx = player.x, fy = player.y;
            switch (player.direction) {
                case 'up': fy--; break;
                case 'down': fy++; break;
                case 'left': fx--; break;
                case 'right': fx++; break;
            }
            return { x: fx, y: fy };
        }

        function interact() {
            if (menu.active || gameMode === MODE.BATTLE || inn.active || shop.active || partyJoinConfirm.active) return;
            if (dialog.active) { advanceDialog(); return; }

            const front = getFrontPosition();
            const npc = getNpcAt(front.x, front.y);
            if (npc) {
                if (npc.type === 'inn') {
                    openInn(npc.innCost);
                } else if (npc.type === 'shop' || npc.type === 'shopkeeper') {
                    openShop(npc.shopId || 'default');
                } else if (npc.type === 'maou') {
                    // È≠îÁéãÊà¶ÈñãÂßã
                    if (gameCleared) {
                        // Êó¢„Å´„ÇØ„É™„Ç¢Ê∏à„Åø
                        startDialog(['......„ÄÇ', 'ÔºàÈ≠îÁéã„ÅÆÂßø„ÅØ„ÇÇ„ÅÜ„Å™„ÅÑÔºâ']);
                    } else {
                        startMaouBattle();
                    }
                } else if (npc.type === 'king') {
                    // ÁéãÊßò„Å®„ÅÆ‰ºöË©±ÔºàÊù°‰ª∂ÂàÜÂ≤êÔºâ
                    handleKingDialog(npc);
                } else if (npc.type === 'boss' && npc.bossId) {
                    // „Éú„ÇπNPCÊà¶
                    handleBossNpc(npc);
                } else if (npc.type === 'quest_giver') {
                    // „ÇØ„Ç®„Çπ„ÉàNPC
                    handleQuestGiver(npc);
                } else if (npc.type === 'party_join') {
                    // „Éë„Éº„ÉÜ„Ç£Âä†ÂÖ•NPC
                    handlePartyJoinNpc(npc);
                } else if (npc.type === 'portal_guard') {
                    // ÊóÖ„ÅÆÊââ„ÅÆÁï™ÂÖµ
                    if (getStoryFlag('portalRoomUnlocked') && npc.clearedMessages) {
                        startDialog(npc.clearedMessages);
                    } else {
                        startDialog(npc.messages);
                    }
                } else {
                    // „Ç≤„Éº„É†„ÇØ„É™„Ç¢Âæå„ÅØNPC„ÅÆ„Çª„É™„Éï„ÅåÂ§â„Çè„Çã
                    if (gameCleared && npc.clearedMessages) {
                        startDialog(npc.clearedMessages);
                    } else {
                        startDialog(npc.messages);
                    }
                }
                return;
            }

            const chest = getChestAt(front.x, front.y);
            if (chest) { openChest(chest); return; }

            // Èö†„ÅóÂ£Å„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
            checkHiddenWall(front.x, front.y);
        }

        // Èö†„ÅóÂ£Å„ÇíË™ø„Åπ„Çã
        function checkHiddenWall(x, y) {
            if (x < 0 || y < 0 || y >= currentMap.rows || x >= currentMap.cols) return;

            const tile = currentMap.data[y][x];
            if (tile === TILE.HIDDEN_WALL) {
                // Èö†„ÅóÈÄöË∑Ø„ÇíÁô∫Ë¶ãÔºÅ
                revealHiddenPassage(x, y);
            }
        }

        // Èö†„ÅóÈÄöË∑Ø„ÇíÈñã„Åè
        function revealHiddenPassage(x, y) {
            // „Çø„Ç§„É´„ÇíÈÄöË∑Ø„Å´Â§âÊõ¥
            currentMap.data[y][x] = TILE.FLOOR;

            // ÈÄ≤Ë°åÁä∂Ê≥Å„Å´Ë®òÈå≤
            openPassage(currentMapId, x, y);

            // „Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            flashScreen('#ffffff', 200);

            // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
            startDialogWithCallback(
                ['„Å™„Çì„Å®ÔºÅ', '„Åã„Åè„Åó„Å§„ÅÜ„Çç„Çí „Åø„Å§„Åë„ÅüÔºÅ'],
                () => {
                    saveGame();
                }
            );
        }

        // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
        function flashScreen(color, duration) {
            fadeOverlay.style.backgroundColor = color;
            fadeOverlay.classList.add('active');
            setTimeout(() => {
                fadeOverlay.classList.remove('active');
                fadeOverlay.style.backgroundColor = '';
            }, duration);
        }

        // ÁéãÊßò„Å®„ÅÆ‰ºöË©±Âá¶ÁêÜÔºàÊù°‰ª∂ÂàÜÂ≤êÔºâ
        function handleKingDialog(npc) {
            // È≠îÁéãË®é‰ºêÊ∏à„Åø
            if (gameCleared && npc.clearedMessages) {
                startDialog(npc.clearedMessages);
                return;
            }

            // ‰∏≠„Éú„ÇπÊíÉÁ†¥Âæå„ÄÅ„Åæ„Å†Â†±Âëä„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà
            if (isBossDefeated('midBoss') && !getStoryFlag('reportedMidBossDefeat')) {
                startDialogWithCallback([
                    '„Åä„ÅäÔºÅÂãáËÄÖ„ÇàÔºÅ',
                    '„Å™„Çì„Å®ÔºÅÊ¥ûÁ™ü„ÅÆÁï™‰∫∫„ÇíÂÄí„Åó„Åü„Å®„ÅÑ„ÅÜ„ÅÆ„ÅãÔºÅ',
                    '„Çà„Åè„Åû„ÇÑ„Å£„Å¶„Åè„Çå„ÅüÔºÅ',
                    '„Åì„Çå„ÅßÊóÖ„ÅÆÊââ„ÅÆÈÉ®Â±ã„Å∏Ë°å„Åë„Çã„Çà„ÅÜ„Å´„Åó„Çà„ÅÜ„ÄÇ',
                    'Âüé„ÅÆÂåóÂÅ¥„Å´„ÅÇ„ÇãÈÉ®Â±ã„Åò„ÇÉ„ÄÇ',
                    'ÊóÖ„ÅÆÊââ„ÇíÈÄö„Çå„Å∞„ÄÅÊñ∞„Åü„Å™Â§ßÈô∏„Å∏Ë°å„Åë„Çã„ÄÇ',
                    '„Åï„Çâ„Å™„ÇãÂÜíÈô∫„ÅåÂæÖ„Å£„Å¶„Åä„Çã„ÅûÔºÅ'
                ], () => {
                    setStoryFlag('reportedMidBossDefeat', true);
                    setStoryFlag('portalRoomUnlocked', true);
                    saveGame();
                });
                return;
            }

            // ÊóÖ„ÅÆÊââ„ÅåÈñãÊîæÊ∏à„Åø
            if (getStoryFlag('portalRoomUnlocked')) {
                startDialog([
                    '„Åä„Åä„ÄÅÂãáËÄÖ„ÇàÔºÅ',
                    'ÊóÖ„ÅÆÊââ„ÅÆÈÉ®Â±ã„ÅØÂüé„ÅÆÂåóÂÅ¥„Åò„ÇÉ„ÄÇ',
                    'Êñ∞„Åü„Å™Â§ßÈô∏„ÅßÂº∑Êïµ„ÅåÂæÖ„Å£„Å¶„Åä„Çã„Åû„ÄÇ',
                    'Ê∞ó„Çí„Å§„Åë„Å¶Ë°å„Åè„ÅÆ„Åò„ÇÉÔºÅ'
                ]);
                return;
            }

            // ÈÄöÂ∏∏„ÅÆ‰ºöË©±
            startDialog(npc.messages);
        }

        // „Éú„ÇπNPCÊà¶„ÅÆÂá¶ÁêÜ
        function handleBossNpc(npc) {
            const bossId = npc.bossId;

            // Êó¢„Å´„Éú„Çπ„ÇíÂÄí„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (isBossDefeated(bossId)) {
                if (npc.defeatedMessages) {
                    startDialog(npc.defeatedMessages);
                } else {
                    startDialog(['......„ÄÇ', 'Ôºà„ÇÇ„ÅÜÊà¶„ÅÜÁõ∏Êâã„ÅØ„ÅÑ„Å™„ÅÑÔºâ']);
                }
                return;
            }

            // Á†ÇÊº†„ÅÆÂÆàË≠∑ËÄÖ„ÅØ3„Å§„ÅÆ„ÇØ„Ç®„Çπ„ÉàÂÆå‰∫Ü„ÅåÂøÖË¶Å
            if (npc.requiresAllQuests && !areAllDesertQuestsCompleted()) {
                startDialog([
                    'Êàë„ÅØÁ†ÇÊº†„ÅÆÂÆàË≠∑ËÄÖ...',
                    '‰∏â„Å§„ÅÆË©¶Á∑¥„Çí‰πó„ÇäË∂ä„Åà„ÅüËÄÖ„Å†„Åë„Åå',
                    'Êàë„Å´Êåë„ÇÄË≥áÊ†º„Åå„ÅÇ„Çã„ÄÇ',
                    'Ê∏Ö„Çâ„Åã„Å™Ê∞¥„ÄÅÈÄöË°åÊâãÂΩ¢„ÄÅÁéãÂÆ∂„ÅÆÁ¥ãÁ´†...',
                    'ÂÖ®„Å¶„ÇíÈõÜ„ÇÅ„Å¶Âá∫Áõ¥„Åô„Åå„ÅÑ„ÅÑ„ÄÇ'
                ]);
                return;
            }

            // „Éú„ÇπÊà¶Ââç„ÅÆ‰ºöË©±‚ÜíÊà¶ÈóòÈñãÂßã
            const bossMessages = (npc.messages && npc.messages.length > 0)
                ? npc.messages
                : ['......„ÄÇ'];
            startDialogWithCallback(bossMessages, () => {
                startBossBattle(bossId);
            });
        }

        // „ÇØ„Ç®„Çπ„ÉàNPCÂá¶ÁêÜÔºàÊùëÈï∑„Å™„Å©Ôºâ
        function handleQuestGiver(npc) {
            const questId = npc.questId;

            if (!questId) {
                startDialog(npc.messages);
                return;
            }

            // Ê∞¥‰∏çË∂≥„ÇØ„Ç®„Çπ„ÉàÔºà„Ç™„Ç¢„Ç∑„Çπ„ÅÆÊùëÈï∑Ôºâ
            if (questId === 'waterShortage') {
                handleWaterShortageQuest(npc);
                return;
            }

            // ÈÄöË°åÊâãÂΩ¢„ÇØ„Ç®„Çπ„ÉàÈñ¢ÈÄ£„ÅØÁõóË≥ä„Éú„ÇπÊíÉÁ†¥„ÅßËá™ÂãïÂÆå‰∫Ü
            // ÁéãÂÆ∂„ÅÆÁ¥ãÁ´†„ÇØ„Ç®„Çπ„ÉàÈñ¢ÈÄ£„ÅØ„Éî„É©„Éü„ÉÉ„Éâ„Éú„ÇπÊíÉÁ†¥„ÅßËá™ÂãïÂÆå‰∫Ü

            startDialog(npc.messages);
        }

        // Ê∞¥‰∏çË∂≥„ÇØ„Ç®„Çπ„ÉàÂá¶ÁêÜ
        function handleWaterShortageQuest(npc) {
            // „ÇØ„Ç®„Çπ„ÉàÂÆå‰∫ÜÊ∏à„Åø
            if (isQuestCompleted('waterShortage')) {
                startDialog(npc.completedMessages || [
                    '„Åä„Åã„Åí„ÅßÊùë„Å´Ê∞¥„ÅåÊàª„Å£„Åü„ÄÇ',
                    '„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÅÂãáËÄÖÊßòÔºÅ'
                ]);
                return;
            }

            // Ê∏Ö„Çâ„Åã„Å™Ê∞¥„ÇíÊåÅ„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (hasItem(30)) {
                startDialogWithCallback([
                    '„Åä„ÅäÔºÅ„Åù„Çå„ÅØÊ∏Ö„Çâ„Åã„Å™Ê∞¥ÔºÅ',
                    '„Åì„Çå„ÅßÊùë„ÇíÊïë„Åà„ÇãÔºÅ',
                    '„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÅÂãáËÄÖÊßòÔºÅ',
                    '„Åì„ÅÆÊÅ©„ÅØÂøò„Çå„Å™„ÅÑÔºÅ'
                ], () => {
                    removeItem(30);
                    setQuestFlag('waterShortage', 'completed', true);
                    // Â†±ÈÖ¨
                    player.gold += 500;
                    player.exp += 200;
                    showMessage('500„Ç¥„Éº„É´„Éâ„Å®200EXP„ÇíÁç≤ÂæóÔºÅ');
                    saveGame();
                });
                return;
            }

            // „Éú„ÇπÊíÉÁ†¥Âæå„Å†„ÅåÊ∞¥„ÇíÊåÅ„Å£„Å¶„ÅÑ„Å™„ÅÑ
            if (getQuestFlag('waterShortage', 'bossDefeated')) {
                startDialog([
                    'ÊµÅÁ†Ç„ÅÆÊ¥ûÁ™ü„ÅÆÂ••„Å´Ê∏Ö„Çâ„Åã„Å™Ê∞¥„Åå„ÅÇ„Çã„Å®„ÅÑ„ÅÜ„ÄÇ',
                    '„Éú„Çπ„ÅØÂÄí„Åó„Åü„ÅÆ„ÅãÔºü',
                    'Ê∞¥„ÇíÊåÅ„Å£„Å¶„Åç„Å¶„Åè„ÇåÔºÅ'
                ]);
                return;
            }

            // „ÇØ„Ç®„Çπ„ÉàÈñãÂßãÂâç„Åæ„Åü„ÅØÈÄ≤Ë°å‰∏≠
            if (!getQuestFlag('waterShortage', 'started')) {
                startDialogWithCallback(npc.messages, () => {
                    setQuestFlag('waterShortage', 'started', true);
                    saveGame();
                });
            } else {
                startDialog(npc.messages);
            }
        }

        // „Éë„Éº„ÉÜ„Ç£Âä†ÂÖ•Á¢∫Ë™çÁä∂ÊÖã
        let partyJoinConfirm = {
            active: false,
            npcId: null,
            selectedIndex: 0  // 0: „ÅØ„ÅÑ, 1: „ÅÑ„ÅÑ„Åà
        };

        // „Éë„Éº„ÉÜ„Ç£Âä†ÂÖ•NPCÂá¶ÁêÜ
        function handlePartyJoinNpc(npc) {
            // Êó¢„Å´‰ª≤Èñì„Å´„Å™„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (gameProgress.storyFlags.mageJoined && npc.id === 'oasis_mage') {
                startDialog(npc.alreadyJoinedMessages || ['‰∏ÄÁ∑í„Å´ÂÜíÈô∫„Åß„Åç„Å¶Â¨â„Åó„ÅÑ„Åß„ÅôÔºÅ']);
                return;
            }

            // „Éë„Éº„ÉÜ„Ç£„ÅåÊ∫ÄÂì°„ÅÆÂ†¥Âêà
            if (party.length >= MAX_PARTY_SIZE) {
                startDialog(['Ôºà„Éë„Éº„ÉÜ„Ç£„Åå„ÅÑ„Å£„Å±„ÅÑ„Å†...Ôºâ']);
                return;
            }

            // Âä†ÂÖ•Êù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
            let conditionMet = false;
            if (npc.joinCondition === 'waterShortageCompleted') {
                conditionMet = isQuestCompleted('waterShortage');
            }
            // ‰ªñ„ÅÆÊù°‰ª∂„ÇÇËøΩÂä†ÂèØËÉΩ

            if (!conditionMet) {
                startDialog(npc.conditionNotMetMessages || npc.messages);
                return;
            }

            // Âä†ÂÖ•„Ç™„Éï„Ç°„Éº„ÇíË°®Á§∫„Åó„Å¶Á¢∫Ë™ç
            startDialogWithCallback(npc.joinOfferMessages, () => {
                partyJoinConfirm.active = true;
                partyJoinConfirm.npcId = npc.id;
                partyJoinConfirm.selectedIndex = 0;
            });
        }

        // „Éë„Éº„ÉÜ„Ç£Âä†ÂÖ•ÂÆüË°å
        function executePartyJoin(npcId) {
            const npc = getNpcById(npcId);
            if (!npc) return;

            if (npcId === 'oasis_mage') {
                // „Éû„É™„Ç¢ÔºàÈ≠îÊ≥ï‰Ωø„ÅÑÔºâ„Çí„Éë„Éº„ÉÜ„Ç£„Å´ËøΩÂä†
                const mage = createPartyMember({
                    id: 'mage_maria',
                    name: '„Éû„É™„Ç¢',
                    job: 'mage',
                    sprite: 'üßô',
                    hp: 35,
                    maxHp: 35,
                    mp: 50,
                    maxMp: 50,
                    baseAtk: 8,
                    baseDef: 6,
                    speed: 8,
                    level: 5,
                    exp: 300,
                    spells: ['mera', 'gira', 'hoimi'],
                    equipment: { weapon: null, armor: null }
                });
                party.push(mage);
                gameProgress.storyFlags.mageJoined = true;

                startDialogWithCallback(npc.joinAcceptMessages, () => {
                    saveGame();
                });
            }
        }

        // NPC ID„ÅßÂèñÂæó„Åô„Çã„Éò„É´„Éë„Éº
        function getNpcById(npcId) {
            if (!currentMap || !currentMap.npcs) return null;
            return currentMap.npcs.find(n => n.id === npcId);
        }

        // „Éú„ÇπÊà¶ÈñãÂßãÔºàÊ±éÁî®Ôºâ
        function startBossBattle(bossId) {
            const monsterData = monsters[bossId];
            if (!monsterData) {
                console.error('Boss not found:', bossId);
                return;
            }

            // „Éú„Çπ„ÇíÊïµÈÖçÂàó„Å´ËøΩÂä†
            const bossEnemy = {
                ...monsterData,
                id: `${bossId}_0`,
                type: bossId,
                displayName: monsterData.name,
                currentHp: monsterData.hp,
                currentMp: monsterData.mp || 0,
                status: { sleep: 0, poison: 0, blind: 0 },
                actionCount: 0,
                bossId: bossId,
                index: 0
            };

            battle.active = true;
            battle.enemies = [bossEnemy];
            battle.enemy = bossEnemy; // ÂæåÊñπ‰∫íÊèõÁî®
            battle.targetIndex = 0;
            battle.currentEnemyIndex = 0;
            battle.isSelectingTarget = false;
            battle.isSelectingAlly = false;
            battle.phase = 'start';
            battle.commandIndex = 0;
            battle.spellIndex = 0;
            battle.showSpells = false;
            battle.showItems = false;
            battle.itemCursor = 0;
            battle.message = '';
            battle.messageQueue = [];
            battle.result = null;
            battle.flashCount = 8;

            // „Éë„Éº„ÉÜ„Ç£Èñ¢ÈÄ£„ÅÆÂàùÊúüÂåñ
            battle.currentPartyIndex = 0;
            battle.partyActions = [];
            battle.executingActionIndex = 0;

            // „Éê„Éï„Çí„É™„Çª„ÉÉ„Éà
            if (battle.buffs) {
                battle.buffs.attackUp = 0;
                battle.buffs.defenseUp = 0;
            }

            // „Éë„Éº„ÉÜ„Ç£ÂÖ®Âì°„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„É™„Çª„ÉÉ„Éà
            party.forEach(member => {
                member.status = { sleep: 0, poison: 0, blind: 0 };
            });
            gameMode = MODE.BATTLE;

            // „Éê„Éà„É´‰∏≠„ÅØ„Éû„ÉÉ„ÉóÂêç„ÇíÈùûË°®Á§∫
            mapNameArea.style.display = 'none';

            // „Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            const flashInterval = setInterval(() => {
                battle.flashCount--;
                if (battle.flashCount <= 0) {
                    clearInterval(flashInterval);
                    showBattleMessage(`${monsterData.name} „Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`, () => {
                        battle.phase = 'command';
                        const currentMember = getCurrentPartyMember();
                        battle.message = `${currentMember.name} „ÅÆ „Åì„ÅÜ„Å©„ÅÜÔºü`;
                    });
                }
            }, 80);
        }

        // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØ‰ªò„Åç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        function startDialogWithCallback(messages, onComplete) {
            dialog.active = true;
            dialog.messages = Array.isArray(messages) ? messages : [messages];
            dialog.currentIndex = 0;
            dialog.displayedText = '';
            dialog.charIndex = 0;
            dialog.isTyping = true;
            dialog.onComplete = onComplete;  // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„Çí‰øùÂ≠ò
            typeNextChar();
        }

        // È≠îÁéãÊà¶ÈñãÂßã
        function startMaouBattle() {
            // È≠îÁéãÂ∞ÇÁî®„ÅÆÊºîÂá∫‰ªò„Åç„Éê„Éà„É´ÈñãÂßã
            const monsterData = monsters['maou'];
            battle.active = true;
            battle.enemy = {
                ...monsterData,
                currentHp: monsterData.hp,
                currentMp: monsterData.mp,
                status: { sleep: 0, poison: 0, blind: 0 },
                actionCount: 0  // 2ÂõûË°åÂãïÁî®„Ç´„Ç¶„É≥„Çø„Éº
            };
            battle.phase = 'start';
            battle.commandIndex = 0;
            battle.spellIndex = 0;
            battle.showSpells = false;
            battle.showItems = false;
            battle.itemCursor = 0;
            battle.message = '';
            battle.messageQueue = [];
            battle.result = null;
            battle.flashCount = 12;  // È≠îÁéã„ÅØÊøÄ„Åó„ÅÑ„Éï„É©„ÉÉ„Ç∑„É•

            player.status = { sleep: 0, poison: 0, blind: 0 };
            gameMode = MODE.BATTLE;

            // „Éê„Éà„É´‰∏≠„ÅØ„Éû„ÉÉ„ÉóÂêç„ÇíÈùûË°®Á§∫
            mapNameArea.style.display = 'none';

            // ÊøÄ„Åó„ÅÑ„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            const flashInterval = setInterval(() => {
                battle.flashCount--;
                if (battle.flashCount <= 0) {
                    clearInterval(flashInterval);
                    // È≠îÁéãÂ∞ÇÁî®„É°„ÉÉ„Çª„Éº„Ç∏
                    showBattleMessage('„Å§„ÅÑ„Å´ „Åç„Åü„Åã...', () => {
                        showBattleMessage('ÁßÅ„Åå È≠îÁéã„Å†ÔºÅ', () => {
                            screenShake.active = true;
                            screenShake.intensity = 8;
                            screenShake.duration = 30;
                            showBattleMessage('„Åè„Çâ„ÅàÔºÅ „Åì„ÅÆÂäõ„ÇíÔºÅ', () => {
                                battle.phase = 'command';
                                const currentMember = getCurrentPartyMember();
                                battle.message = `${currentMember.name} „ÅÆ „Åì„ÅÜ„Å©„ÅÜÔºü`;
                            });
                        });
                    });
                }
            }, 80);
        }

        // È≠îÁéã„ÅÆAIË°åÂãïÈÅ∏Êäû
        function selectMaouAction() {
            const hpRatio = battle.enemy.currentHp / battle.enemy.hp;
            const skills = battle.enemy.skills;

            // „Çπ„Ç≠„É´„ÅåÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éú„Çπ„ÅØÈÄöÂ∏∏ÊîªÊíÉ„ÅÆ„Åø
            if (!skills || !Array.isArray(skills) || skills.length === 0) {
                return 'attack';
            }

            // HP50%‰ª•‰∏ã„Åß„Éô„Éõ„Éû„Çí‰Ωø„ÅÜÁ¢∫Áéá„Åå‰∏ä„Åå„Çã
            if (hpRatio < 0.5 && battle.enemy.currentMp >= 50 && skills.includes('behoma') && Math.random() < 0.4) {
                return 'behoma';
            }

            // HP30%‰ª•‰∏ã„ÅßÂº∑Âäõ„Å™ÊîªÊíÉ„ÇíÂ§öÁî®
            if (hpRatio < 0.3) {
                const aggressiveSkills = skills.filter(s => s === 'ionazun' || s === 'hageshiiHonoo');
                if (aggressiveSkills.length > 0) {
                    return aggressiveSkills[Math.floor(Math.random() * aggressiveSkills.length)];
                }
            }

            // ÈÄöÂ∏∏ÊôÇ„ÅØ„É©„É≥„ÉÄ„É†„Å´Ë°åÂãïÔºà„Éô„Éõ„Éû‰ª•Â§ñÔºâ
            const normalSkills = skills.filter(s => s !== 'behoma');
            if (normalSkills.length === 0) {
                return 'attack';
            }
            return normalSkills[Math.floor(Math.random() * normalSkills.length)];
        }

        // „Éú„Çπ„ÅÆ„Çπ„Ç≠„É´ÂÆüË°å
        function executeMaouSkill(skillId, callback) {
            const bossName = battle.enemy.displayName || battle.enemy.name || '„Éú„Çπ';

            if (skillId === 'attack') {
                // ÈÄöÂ∏∏ÊîªÊíÉ
                let def = getPlayerDef();
                // „Çπ„ÇØ„É´„Éà„Å´„Çà„ÇãÈò≤Âæ°Âäõ„Ç¢„ÉÉ„Éó
                if (battle.buffs.defenseUp > 0) {
                    const defenseMultiplier = 1 + battle.buffs.defenseUp * 0.25;
                    def = Math.floor(def * defenseMultiplier);
                }
                const damage = Math.max(1, Math.floor(battle.enemy.atk / 2 - def / 4 + Math.random() * 10));
                player.hp -= damage;

                screenShake.active = true;
                screenShake.intensity = 5;
                screenShake.duration = 15;

                showBattleMessage(`${bossName} „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                    if (player.hp <= 0) {
                        player.hp = 0;
                        battleLose();
                    } else {
                        callback();
                    }
                });
            } else {
                const skill = bossSkills[skillId];
                if (!skill) {
                    callback();
                    return;
                }

                // „Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
                if (skill.flashColor) {
                    startSpellFlash(skill.flashColor);
                }

                // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØÔºàÊîªÊíÉ„Çπ„Ç≠„É´„ÅÆ„ÅøÔºâ
                if (skill.type === 'attack') {
                    screenShake.active = true;
                    screenShake.intensity = 10;
                    screenShake.duration = 20;
                }

                showBattleMessage(`${bossName} „ÅØ ${skill.name} „Çí „ÅØ„Å™„Å£„ÅüÔºÅ`, () => {
                    if (skill.type === 'heal') {
                        battle.enemy.currentHp = Math.min(battle.enemy.hp, battle.enemy.currentHp + skill.power);
                        showBattleMessage(`${bossName} „ÅÆ HP„Åå „Åã„ÅÑ„Åµ„Åè„Åó„ÅüÔºÅ`, () => {
                            callback();
                        });
                    } else if (skill.type === 'attack') {
                        const damage = skill.power + Math.floor(Math.random() * 15);
                        player.hp -= damage;
                        showBattleMessage(`„ÇÜ„ÅÜ„Åó„ÇÉ „Å´ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                            if (player.hp <= 0) {
                                player.hp = 0;
                                battleLose();
                            } else {
                                callback();
                            }
                        });
                    } else {
                        callback();
                    }
                });
            }
        }

        // È≠îÁéã„ÅÆ2ÂõûË°åÂãï„Çø„Éº„É≥
        function maouTurn() {
            battle.phase = 'enemyTurn';
            battle.enemy.actionCount = 0;
            executeMaouActions();
        }

        function executeMaouActions() {
            const bossName = battle.enemy.displayName || battle.enemy.name || '„Éú„Çπ';
            // Áú†„Çä„ÉÅ„Çß„ÉÉ„ÇØ
            const wakeResult = checkWakeUp(battle.enemy, bossName);
            if (!wakeResult.awake) {
                showBattleMessage(wakeResult.message, () => {
                    processEnemyTurnEnd();
                });
                return;
            }
            if (wakeResult.message) {
                showBattleMessage(wakeResult.message, () => {
                    doMaouAction();
                });
                return;
            }
            doMaouAction();
        }

        function doMaouAction() {
            const skillId = selectMaouAction();
            battle.enemy.actionCount++;

            const bossActions = battle.enemy.actions || 1; // „Éá„Éï„Ç©„É´„Éà„ÅØ1ÂõûË°åÂãï
            const bossName = battle.enemy.displayName || battle.enemy.name || '„Éú„Çπ';

            executeMaouSkill(skillId, () => {
                // Ë§áÊï∞ÂõûË°åÂãï„ÉÅ„Çß„ÉÉ„ÇØ
                if (battle.enemy.actionCount < bossActions && player.hp > 0) {
                    showBattleMessage(`${bossName} „ÅØ „Åï„Çâ„Å´ „Åì„ÅÜ„Åí„Åç„Çí „Åó„Åã„Åë„Å¶„Åç„ÅüÔºÅ`, () => {
                        doMaouAction();
                    });
                } else {
                    processEnemyTurnEnd();
                }
            });
        }

        // ========================================
        // ÂÖ•ÂäõÂá¶ÁêÜ
        // ========================================
        document.addEventListener('keydown', (e) => {
            if (isTransitioning) return;

            // „ÉØ„Éº„É´„Éâ„Éû„ÉÉ„ÉóË°®Á§∫‰∏≠
            if (gameMode === MODE.MAP_VIEW) {
                if (e.key === 'm' || e.key === 'M' || e.key === 'Escape' || e.key === 'Enter' || e.key === ' ') {
                    closeWorldMap();
                }
                e.preventDefault();
                return;
            }

            // M„Ç≠„Éº„Åß„Éû„ÉÉ„Éó„ÇíÈñã„ÅèÔºà„Éï„Ç£„Éº„É´„Éâ„ÄÅ„É°„Éã„É•„Éº„ÄÅ„ÉÄ„Ç§„Ç¢„É≠„Ç∞‰∏≠Ôºâ
            if ((e.key === 'm' || e.key === 'M') &&
                (gameMode === MODE.FIELD || gameMode === MODE.MENU || gameMode === MODE.DIALOG)) {
                openWorldMap();
                e.preventDefault();
                return;
            }

            // „Çø„Ç§„Éà„É´ÁîªÈù¢
            if (gameMode === MODE.TITLE) {
                if (!titleMenuActive) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        activateTitleMenu();
                    }
                } else {
                    const menuCount = hasSaveData ? 2 : 1;
                    switch (e.key) {
                        case 'ArrowUp': case 'w': case 'W':
                            titleMenuIndex = Math.max(0, titleMenuIndex - 1);
                            updateTitleMenuSelection();
                            break;
                        case 'ArrowDown': case 's': case 'S':
                            titleMenuIndex = Math.min(menuCount - 1, titleMenuIndex + 1);
                            updateTitleMenuSelection();
                            break;
                        case 'Enter': case ' ': case 'z':
                            selectTitleMenuItem();
                            break;
                    }
                }
                e.preventDefault();
                return;
            }

            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞‰∏≠
            if (gameMode === MODE.ENDING) {
                handleEndingInput();
                return;
            }

            // „Éê„Éà„É´‰∏≠
            if (gameMode === MODE.BATTLE) {
                // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû„É¢„Éº„Éâ
                if (battle.isSelectingTarget) {
                    switch (e.key) {
                        case 'ArrowLeft': case 'a': case 'A':
                            battle.targetIndex = getPrevAliveEnemyIndex(battle.targetIndex);
                            break;
                        case 'ArrowRight': case 'd': case 'D':
                            battle.targetIndex = getNextAliveEnemyIndex(battle.targetIndex);
                            break;
                        case 'Enter': case ' ': case 'z':
                            confirmTargetSelection();
                            break;
                        case 'Escape': case 'x': case 'b': case 'B':
                            cancelTargetSelection();
                            break;
                    }
                    e.preventDefault();
                    return;
                }

                if (battle.phase === 'command') {
                    if (battle.showSpells) {
                        switch (e.key) {
                            case 'ArrowUp': case 'w': case 'W':
                                battle.spellIndex = Math.max(0, battle.spellIndex - 1);
                                break;
                            case 'ArrowDown': case 's': case 'S':
                                battle.spellIndex = Math.min(player.spells.length - 1, battle.spellIndex + 1);
                                break;
                            case 'Enter': case ' ': case 'z':
                                executeBattleCommand();
                                break;
                            case 'Escape': case 'x': case 'b': case 'B':
                                battle.showSpells = false;
                                break;
                        }
                    } else if (battle.showItems) {
                        switch (e.key) {
                            case 'ArrowUp': case 'w': case 'W':
                                battle.itemCursor = Math.max(0, battle.itemCursor - 1);
                                break;
                            case 'ArrowDown': case 's': case 'S':
                                battle.itemCursor = Math.min(Math.max(0, player.inventory.length - 1), battle.itemCursor + 1);
                                break;
                            case 'Enter': case ' ': case 'z':
                                executeBattleCommand();
                                break;
                            case 'Escape': case 'x': case 'b': case 'B':
                                battle.showItems = false;
                                break;
                        }
                    } else {
                        switch (e.key) {
                            case 'ArrowUp': case 'w': case 'W':
                                battle.commandIndex = Math.max(0, battle.commandIndex - 1);
                                break;
                            case 'ArrowDown': case 's': case 'S':
                                battle.commandIndex = Math.min(3, battle.commandIndex + 1);
                                break;
                            case 'Enter': case ' ': case 'z':
                                executeBattleCommand();
                                break;
                        }
                    }
                }
                e.preventDefault();
                return;
            }

            // „Ç∑„Éß„ÉÉ„Éó
            if (shop.active) {
                switch (e.key) {
                    case 'ArrowUp': case 'w': case 'W':
                        handleShopInput('up');
                        break;
                    case 'ArrowDown': case 's': case 'S':
                        handleShopInput('down');
                        break;
                    case 'ArrowLeft': case 'a': case 'A':
                        handleShopInput('left');
                        break;
                    case 'ArrowRight': case 'd': case 'D':
                        handleShopInput('right');
                        break;
                    case 'Enter': case ' ': case 'z':
                        handleShopInput('confirm');
                        break;
                    case 'Escape': case 'x': case 'b': case 'B':
                        handleShopInput('cancel');
                        break;
                }
                e.preventDefault();
                return;
            }

            // ÂÆøÂ±ã
            if (inn.active) {
                switch (e.key) {
                    case 'ArrowLeft': case 'a': case 'A':
                        inn.selectedIndex = 0;
                        break;
                    case 'ArrowRight': case 'd': case 'D':
                        inn.selectedIndex = 1;
                        break;
                    case 'Enter': case ' ': case 'z':
                        confirmInn();
                        break;
                    case 'Escape': case 'x': case 'b': case 'B':
                        closeInn();
                        startDialog(['„Åæ„Åü„ÅÆ„ÅäË∂ä„Åó„Çí „Åä„Åæ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ']);
                        break;
                }
                e.preventDefault();
                return;
            }

            // „Éë„Éº„ÉÜ„Ç£Âä†ÂÖ•Á¢∫Ë™ç
            if (partyJoinConfirm.active) {
                switch (e.key) {
                    case 'ArrowLeft': case 'a': case 'A':
                        partyJoinConfirm.selectedIndex = 0;
                        break;
                    case 'ArrowRight': case 'd': case 'D':
                        partyJoinConfirm.selectedIndex = 1;
                        break;
                    case 'Enter': case ' ': case 'z':
                        if (partyJoinConfirm.selectedIndex === 0) {
                            // „ÅØ„ÅÑ
                            partyJoinConfirm.active = false;
                            executePartyJoin(partyJoinConfirm.npcId);
                        } else {
                            // „ÅÑ„ÅÑ„Åà
                            partyJoinConfirm.active = false;
                            const npc = getNpcById(partyJoinConfirm.npcId);
                            if (npc && npc.joinDeclineMessages) {
                                startDialog(npc.joinDeclineMessages);
                            }
                        }
                        break;
                    case 'Escape': case 'x': case 'b': case 'B':
                        partyJoinConfirm.active = false;
                        const npc = getNpcById(partyJoinConfirm.npcId);
                        if (npc && npc.joinDeclineMessages) {
                            startDialog(npc.joinDeclineMessages);
                        }
                        break;
                }
                e.preventDefault();
                return;
            }

            // „É´„Éº„É©Êã†ÁÇπÈÅ∏Êäû
            if (ruraState.active) {
                const locations = gameProgress.visitedLocations;
                switch (e.key) {
                    case 'ArrowUp': case 'w': case 'W':
                        ruraState.cursor = (ruraState.cursor + locations.length - 1) % locations.length;
                        break;
                    case 'ArrowDown': case 's': case 'S':
                        ruraState.cursor = (ruraState.cursor + 1) % locations.length;
                        break;
                    case 'Enter': case ' ': case 'z': case 'Z':
                        executeRura(ruraState.cursor);
                        break;
                    case 'Escape': case 'x': case 'b': case 'B':
                        cancelRuraSelection();
                        break;
                }
                e.preventDefault();
                return;
            }

            // „Éï„Ç£„Éº„É´„Éâ
            if (menu.active) {
                if (menu.showItemAction) {
                    // „Ç¢„Ç§„ÉÜ„É†„Ç¢„ÇØ„Ç∑„Éß„É≥„Çµ„Éñ„É°„Éã„É•„ÉºÊìç‰Ωú
                    switch (e.key) {
                        case 'ArrowUp': case 'w': case 'W':
                            menu.itemActionIndex = (menu.itemActionIndex + 2) % 3;
                            break;
                        case 'ArrowDown': case 's': case 'S':
                            menu.itemActionIndex = (menu.itemActionIndex + 1) % 3;
                            break;
                        case 'Enter': case ' ': case 'z': case 'Z':
                            executeItemAction();
                            break;
                        case 'Escape': case 'x': case 'b': case 'B':
                            menu.showItemAction = false;
                            break;
                    }
                } else if (menu.mode === 'items' && player.inventory.length > 0) {
                    // „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„ÉàÊìç‰Ωú
                    switch (e.key) {
                        case 'ArrowUp': case 'w': case 'W':
                            menu.itemCursor = (menu.itemCursor + player.inventory.length - 1) % player.inventory.length;
                            break;
                        case 'ArrowDown': case 's': case 'S':
                            menu.itemCursor = (menu.itemCursor + 1) % player.inventory.length;
                            break;
                        case 'ArrowLeft': case 'a': case 'A':
                            menu.mode = 'spells';
                            menu.spellCursor = 0;
                            break;
                        case 'ArrowRight': case 'd': case 'D':
                            menu.mode = 'map';
                            break;
                        case 'Enter': case ' ': case 'z': case 'Z':
                            menu.showItemAction = true;
                            menu.itemActionIndex = 0;
                            break;
                        case 'Escape': case 'x': case 'b': case 'B':
                            closeMenu();
                            break;
                    }
                } else if (menu.mode === 'spells') {
                    const selectedMember = party[menu.memberCursor] || party[0];
                    if (menu.selectingMember) {
                        // Âë™ÊñáÂØæË±°ÈÅ∏Êäû„É¢„Éº„Éâ
                        switch (e.key) {
                            case 'ArrowUp': case 'w': case 'W':
                                menu.targetMemberCursor = (menu.targetMemberCursor + party.length - 1) % party.length;
                                break;
                            case 'ArrowDown': case 's': case 'S':
                                menu.targetMemberCursor = (menu.targetMemberCursor + 1) % party.length;
                                break;
                            case 'Enter': case ' ': case 'z': case 'Z':
                                executeFieldSpellOnTarget();
                                break;
                            case 'Escape': case 'x': case 'b': case 'B':
                                menu.selectingMember = false;
                                break;
                        }
                    } else if (selectedMember.spells.length > 0) {
                        // Âë™Êñá„É™„Çπ„ÉàÊìç‰Ωú
                        switch (e.key) {
                            case 'ArrowUp': case 'w': case 'W':
                                menu.spellCursor = (menu.spellCursor + selectedMember.spells.length - 1) % selectedMember.spells.length;
                                break;
                            case 'ArrowDown': case 's': case 'S':
                                menu.spellCursor = (menu.spellCursor + 1) % selectedMember.spells.length;
                                break;
                            case 'ArrowLeft': case 'a': case 'A':
                                if (party.length > 1) {
                                    menu.memberCursor = (menu.memberCursor + party.length - 1) % party.length;
                                    menu.spellCursor = 0;
                                } else {
                                    menu.mode = 'status';
                                }
                                break;
                            case 'ArrowRight': case 'd': case 'D':
                                if (party.length > 1) {
                                    menu.memberCursor = (menu.memberCursor + 1) % party.length;
                                    menu.spellCursor = 0;
                                } else {
                                    menu.mode = 'items';
                                    menu.itemCursor = 0;
                                }
                                break;
                            case 'Enter': case ' ': case 'z': case 'Z':
                                useSpellInField();
                                break;
                            case 'Escape': case 'x': case 'b': case 'B':
                                closeMenu();
                                break;
                        }
                    } else {
                        // Âë™Êñá„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çø„ÉñÂàá„ÇäÊõø„Åà
                        switch (e.key) {
                            case 'ArrowLeft': case 'a': case 'A':
                                if (party.length > 1) {
                                    menu.memberCursor = (menu.memberCursor + party.length - 1) % party.length;
                                    menu.spellCursor = 0;
                                } else {
                                    menu.mode = 'status';
                                }
                                break;
                            case 'ArrowRight': case 'd': case 'D':
                                if (party.length > 1) {
                                    menu.memberCursor = (menu.memberCursor + 1) % party.length;
                                    menu.spellCursor = 0;
                                } else {
                                    menu.mode = 'items';
                                    menu.itemCursor = 0;
                                }
                                break;
                            case 'Escape': case 'x': case 'b': case 'B':
                                closeMenu();
                                break;
                        }
                    }
                } else if (menu.mode === 'map') {
                    // „Å°„Åö„Çø„Éñ
                    switch (e.key) {
                        case 'ArrowLeft': case 'a': case 'A':
                            menu.mode = 'items';
                            menu.itemCursor = 0;
                            break;
                        case 'ArrowRight': case 'd': case 'D':
                            menu.mode = 'status';
                            break;
                        case 'Enter': case ' ': case 'z': case 'Z':
                            closeMenu();
                            openWorldMap();
                            break;
                        case 'Escape': case 'x': case 'b': case 'B':
                            closeMenu();
                            break;
                    }
                } else if (menu.mode === 'status') {
                    // „Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉâÔºà„Éë„Éº„ÉÜ„Ç£„É°„É≥„Éê„ÉºÈÅ∏ÊäûÂèØËÉΩÔºâ
                    switch (e.key) {
                        case 'ArrowUp': case 'w': case 'W':
                            if (party.length > 1) {
                                menu.memberCursor = (menu.memberCursor + party.length - 1) % party.length;
                            }
                            break;
                        case 'ArrowDown': case 's': case 'S':
                            if (party.length > 1) {
                                menu.memberCursor = (menu.memberCursor + 1) % party.length;
                            }
                            break;
                        case 'ArrowLeft': case 'a': case 'A':
                            menu.mode = 'map';
                            break;
                        case 'ArrowRight': case 'd': case 'D':
                            menu.mode = 'spells';
                            menu.spellCursor = 0;
                            break;
                        case 'Escape': case 'x': case 'b': case 'B':
                            closeMenu();
                            break;
                    }
                } else {
                    // „Çø„ÉñÂàá„ÇäÊõø„Åà„É¢„Éº„ÉâÔºà„Ç¢„Ç§„ÉÜ„É†„ÉªÂë™Êñá„Åå„Å™„ÅÑÂ†¥ÂêàÔºâ
                    switch (e.key) {
                        case 'ArrowLeft': case 'a': case 'A':
                            if (menu.mode === 'spells') {
                                menu.mode = 'status';
                            } else if (menu.mode === 'items') {
                                menu.mode = 'spells';
                                menu.spellCursor = 0;
                            }
                            break;
                        case 'ArrowRight': case 'd': case 'D':
                            if (menu.mode === 'spells') {
                                menu.mode = 'items';
                                menu.itemCursor = 0;
                            } else if (menu.mode === 'items') {
                                menu.mode = 'map';
                            }
                            break;
                        case 'Escape': case 'x': case 'b': case 'B':
                            closeMenu();
                            break;
                    }
                }
                e.preventDefault();
                return;
            }

            if (dialog.active) {
                if (e.key === 'Enter' || e.key === ' ' || e.key === 'z') {
                    advanceDialog();
                    e.preventDefault();
                }
                return;
            }

            switch (e.key) {
                case 'ArrowUp': case 'w': case 'W': startContinuousMove(0, -1); break;
                case 'ArrowDown': case 's': case 'S': startContinuousMove(0, 1); break;
                case 'ArrowLeft': case 'a': case 'A': startContinuousMove(-1, 0); break;
                case 'ArrowRight': case 'd': case 'D': startContinuousMove(1, 0); break;
                case 'Enter': case ' ': case 'z': interact(); break;
                case 'Escape': case 'x': case 'b': case 'B': openMenu(); break;
            }
            e.preventDefault();
        });

        // „Ç≠„Éº„ÇíÈõ¢„Åó„ÅüÊôÇ„Å´ÈÄ£Á∂öÁßªÂãï„ÇíÂÅúÊ≠¢
        document.addEventListener('keyup', (e) => {
            switch (e.key) {
                case 'ArrowUp': case 'w': case 'W':
                case 'ArrowDown': case 's': case 'S':
                case 'ArrowLeft': case 'a': case 'A':
                case 'ArrowRight': case 'd': case 'D':
                    stopContinuousMove();
                    break;
            }
        });

        // ÈÄ£Á∂öÁßªÂãï„ÅÆÈñãÂßã
        function startContinuousMove(dx, dy) {
            // Êó¢Â≠ò„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´„Çí„ÇØ„É™„Ç¢ÔºàÊñπÂêë„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑÔºâ
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            currentMoveDirection = { dx, dy };
            movePlayer(dx, dy);  // Âç≥Â∫ß„Å´1ÂõûÁßªÂãï
            moveInterval = setInterval(() => {
                if (gameMode === MODE.FIELD && !isTransitioning && !dialog.active &&
                    !menu.active && !inn.active && !shop.active) {
                    movePlayer(currentMoveDirection.dx, currentMoveDirection.dy);
                }
            }, CONTINUOUS_MOVE_DELAY);
        }

        // ÈÄ£Á∂öÁßªÂãï„ÅÆÂÅúÊ≠¢
        function stopContinuousMove() {
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            currentMoveDirection = { dx: 0, dy: 0 };
        }

        // „Çø„ÉÉ„ÉÅ„Éú„Çø„É≥
        function setupDpadButton(id, dx, dy) {
            const btn = document.getElementById(id);
            const handlePress = (e) => {
                e.preventDefault();
                // „Éê„Éà„É´‰∏≠ - „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû„É¢„Éº„Éâ
                if (gameMode === MODE.BATTLE && battle.isSelectingTarget) {
                    if (dx < 0) battle.targetIndex = getPrevAliveEnemyIndex(battle.targetIndex);
                    else if (dx > 0) battle.targetIndex = getNextAliveEnemyIndex(battle.targetIndex);
                    return;
                }
                // „Éê„Éà„É´‰∏≠ - „Ç≥„Éû„É≥„ÉâÈÅ∏Êäû
                if (gameMode === MODE.BATTLE && battle.phase === 'command') {
                    if (dy < 0) {
                        if (battle.showSpells) battle.spellIndex = Math.max(0, battle.spellIndex - 1);
                        else if (battle.showItems) battle.itemCursor = Math.max(0, battle.itemCursor - 1);
                        else battle.commandIndex = Math.max(0, battle.commandIndex - 1);
                    } else if (dy > 0) {
                        if (battle.showSpells) battle.spellIndex = Math.min(player.spells.length - 1, battle.spellIndex + 1);
                        else if (battle.showItems) battle.itemCursor = Math.min(Math.max(0, player.inventory.length - 1), battle.itemCursor + 1);
                        else battle.commandIndex = Math.min(3, battle.commandIndex + 1);
                    }
                    return;
                }
                // „Ç∑„Éß„ÉÉ„Éó
                if (shop.active) {
                    if (dy < 0) handleShopInput('up');
                    else if (dy > 0) handleShopInput('down');
                    else if (dx < 0) handleShopInput('left');
                    else if (dx > 0) handleShopInput('right');
                    return;
                }
                // ÂÆøÂ±ã
                if (inn.active) {
                    if (dx < 0) inn.selectedIndex = 0;
                    else if (dx > 0) inn.selectedIndex = 1;
                    return;
                }
                // „É°„Éã„É•„Éº
                if (menu.active) {
                    if (menu.showItemAction) {
                        // „Ç¢„Ç§„ÉÜ„É†„Ç¢„ÇØ„Ç∑„Éß„É≥„Çµ„Éñ„É°„Éã„É•„Éº
                        if (dy < 0) menu.itemActionIndex = (menu.itemActionIndex + 2) % 3;
                        else if (dy > 0) menu.itemActionIndex = (menu.itemActionIndex + 1) % 3;
                    } else if (menu.mode === 'items' && player.inventory.length > 0) {
                        // „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà
                        if (dy < 0) menu.itemCursor = (menu.itemCursor + player.inventory.length - 1) % player.inventory.length;
                        else if (dy > 0) menu.itemCursor = (menu.itemCursor + 1) % player.inventory.length;
                        else if (dx < 0) { menu.mode = 'spells'; menu.spellCursor = 0; }
                        else if (dx > 0) menu.mode = 'map';
                    } else if (menu.mode === 'spells' && player.spells.length > 0) {
                        // Âë™Êñá„É™„Çπ„Éà
                        if (dy < 0) menu.spellCursor = (menu.spellCursor + player.spells.length - 1) % player.spells.length;
                        else if (dy > 0) menu.spellCursor = (menu.spellCursor + 1) % player.spells.length;
                        else if (dx < 0) menu.mode = 'status';
                        else if (dx > 0) { menu.mode = 'items'; menu.itemCursor = 0; }
                    } else if (menu.mode === 'map') {
                        // „Å°„Åö„Çø„Éñ
                        if (dx < 0) { menu.mode = 'items'; menu.itemCursor = 0; }
                        else if (dx > 0) menu.mode = 'status';
                    } else {
                        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÔºàstatus/Âë™Êñá„Å™„Åó/„Ç¢„Ç§„ÉÜ„É†„Å™„Åó„ÅÆÂ†¥ÂêàÔºâ
                        if (dx < 0) {
                            if (menu.mode === 'status') menu.mode = 'map';
                            else if (menu.mode === 'spells') menu.mode = 'status';
                            else if (menu.mode === 'items') { menu.mode = 'spells'; menu.spellCursor = 0; }
                            else if (menu.mode === 'map') { menu.mode = 'items'; menu.itemCursor = 0; }
                        } else if (dx > 0) {
                            if (menu.mode === 'status') { menu.mode = 'spells'; menu.spellCursor = 0; }
                            else if (menu.mode === 'spells') { menu.mode = 'items'; menu.itemCursor = 0; }
                            else if (menu.mode === 'items') menu.mode = 'map';
                            else if (menu.mode === 'map') menu.mode = 'status';
                        }
                    }
                    return;
                }
                if (isTransitioning || dialog.active) return;
                btn.classList.add('pressed');
                // ÈÄ£Á∂öÁßªÂãï„ÇíÈñãÂßã
                startContinuousMove(dx, dy);
            };
            const handleRelease = () => {
                btn.classList.remove('pressed');
                stopContinuousMove();
            };
            btn.addEventListener('touchstart', handlePress, { passive: false });
            btn.addEventListener('touchend', handleRelease);
            btn.addEventListener('mousedown', handlePress);
            btn.addEventListener('mouseup', handleRelease);
            btn.addEventListener('mouseleave', handleRelease);
        }

        setupDpadButton('dpad-up', 0, -1);
        setupDpadButton('dpad-down', 0, 1);
        setupDpadButton('dpad-left', -1, 0);
        setupDpadButton('dpad-right', 1, 0);

        function setupActionButton(id, callback) {
            const btn = document.getElementById(id);
            const handlePress = (e) => { e.preventDefault(); btn.classList.add('pressed'); callback(); };
            const handleRelease = () => { btn.classList.remove('pressed'); };
            btn.addEventListener('touchstart', handlePress, { passive: false });
            btn.addEventListener('touchend', handleRelease);
            btn.addEventListener('mousedown', handlePress);
            btn.addEventListener('mouseup', handleRelease);
            btn.addEventListener('mouseleave', handleRelease);
        }

        function onActionA() {
            if (isTransitioning) return;
            // „Éê„Éà„É´‰∏≠ - „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏ÊäûÁ¢∫ÂÆö
            if (gameMode === MODE.BATTLE && battle.isSelectingTarget) {
                confirmTargetSelection();
                return;
            }
            if (gameMode === MODE.BATTLE && battle.phase === 'command') {
                executeBattleCommand();
            } else if (shop.active) {
                handleShopInput('confirm');
            } else if (inn.active) {
                confirmInn();
            } else if (menu.active) {
                // „É°„Éã„É•„ÉºÂÜÖÊìç‰Ωú
                if (menu.showItemAction) {
                    executeItemAction();
                } else if (menu.mode === 'items' && player.inventory.length > 0) {
                    menu.showItemAction = true;
                    menu.itemActionIndex = 0;
                } else if (menu.mode === 'spells' && player.spells.length > 0) {
                    useSpellInField();
                } else if (menu.mode === 'map') {
                    // „Å°„Åö„Çø„Éñ„ÅßA„Éú„Çø„É≥ ‚Üí „ÉØ„Éº„É´„Éâ„Éû„ÉÉ„Éó„ÇíÈñã„Åè
                    closeMenu();
                    openWorldMap();
                }
            } else {
                interact();
            }
        }

        function onActionB() {
            // „Éê„Éà„É´‰∏≠ - „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû„Ç≠„É£„É≥„Çª„É´
            if (gameMode === MODE.BATTLE && battle.isSelectingTarget) {
                cancelTargetSelection();
                return;
            }
            if (gameMode === MODE.BATTLE && battle.showSpells) {
                battle.showSpells = false;
            } else if (gameMode === MODE.BATTLE && battle.showItems) {
                battle.showItems = false;
            } else if (shop.active) {
                handleShopInput('cancel');
            } else if (inn.active) {
                closeInn();
                startDialog(['„Åæ„Åü„ÅÆ„ÅäË∂ä„Åó„Çí „Åä„Åæ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ']);
            } else if (dialog.active) {
                closeDialog();
            } else if (menu.active) {
                if (menu.showItemAction) {
                    menu.showItemAction = false;
                } else {
                    closeMenu();
                }
            } else {
                openMenu();
            }
        }

        setupActionButton('btn-a', onActionA);
        setupActionButton('btn-b', onActionB);

        // ========================================
        // „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Éª„Éî„É≥„ÉÅ„Ç∫„Éº„É†Èò≤Ê≠¢
        // ========================================

        // „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Å´„Çà„Çã„Ç∫„Éº„É†„ÇíÈò≤Ê≠¢
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        // „Éî„É≥„ÉÅ„Ç∫„Éº„É†„ÇíÈò≤Ê≠¢Ôºà2Êú¨Êåá„Çø„ÉÉ„ÉÅÔºâ
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        // gesture„Ç§„Éô„É≥„ÉàÔºàSafariÔºâ„ÇíÈò≤Ê≠¢
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('gesturechange', (e) => {
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('gestureend', (e) => {
            e.preventDefault();
        }, { passive: false });

        // ========================================
        // „Ç≤„Éº„É†„É´„Éº„Éó
        // ========================================

        // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Êõ¥Êñ∞Ôºà„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„ÅßÁÑ°ÂäπÂåñÂèØËÉΩÔºâ
        const encounterDebugElement = document.getElementById('encounterDebug');
        function updateEncounterDebug() {
            if (!encounterDebugElement) return;
            const rate = getCurrentEncounterRate();
            encounterDebugElement.textContent = `Ê≠©Êï∞: ${stepsSinceLastBattle} | Á¢∫Áéá: ${(rate * 100).toFixed(1)}%`;
        }

        function gameLoop() {
            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÅÆ„Çπ„Çø„ÉÉ„Éï„É≠„Éº„É´Êõ¥Êñ∞
            updateStaffRoll();

            // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Êõ¥Êñ∞
            updateEncounterDebug();

            draw();
            requestAnimationFrame(gameLoop);
        }

        // ========================================
        // „ÉØ„Éº„É´„Éâ„Éû„ÉÉ„ÉóË°®Á§∫„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        const worldMapOverlay = document.getElementById('worldMapOverlay');
        const worldMapCanvas = document.getElementById('worldMapCanvas');
        const worldMapCtx = worldMapCanvas.getContext('2d');
        const worldMapTitle = document.getElementById('worldMapTitle');

        // „Ç™„Éï„Çπ„ÇØ„É™„Éº„É≥„Ç≠„É£„É≥„Éê„ÇπÔºàÂú∞ÂΩ¢ÊèèÁîªÁî®Ôºâ
        let worldMapOffscreen = null;
        let worldMapOffscreenCtx = null;

        // Âú∞Âõ≥„ÅÆËâ≤Ë®≠ÂÆöÔºà„ÉØ„Éº„É´„Éâ„Éû„ÉÉ„ÉóÁî®Ôºâ
        const WORLD_MAP_COLORS = {
            0: '#44aa44', // ËçâÂéü/Âπ≥Âú∞
            1: '#886644', // Â±±/Â≤©Â†¥
            2: '#2244aa', // Êµ∑/Ê∞¥Âüü
            3: '#ffffff', // Âüé
            4: '#ffffff', // Ë°ó/Âª∫Áâ©
            5: '#8866aa', // ÈöéÊÆµ
            6: '#996633', // Â∫äÔºà„ÉÄ„É≥„Ç∏„Éß„É≥Ôºâ
            7: '#555555', // Â£Å
            8: '#aa44aa', // ÊóÖ„ÅÆÊââÔºàÁ¥´Ôºâ
            9: '#8866aa', // ‰∏ä„ÇäÈöéÊÆµ
            10: '#664488', // ‰∏ã„ÇäÈöéÊÆµ
            // Á†ÇÊº†„Çø„Ç§„É´
            11: '#d4a559', // Á†ÇÊº†
            12: '#44aa66', // „Ç™„Ç¢„Ç∑„Çπ
            13: '#c4a040', // „Éî„É©„Éü„ÉÉ„Éâ
            14: '#b89050'  // ÊµÅÁ†Ç
        };

        // Âú∞Âõ≥Ë°®Á§∫„ÅÆÁä∂ÊÖã
        let worldMapAnimationId = null;
        let playerBlinkState = true;

        function openWorldMap() {
            if (gameMode === MODE.BATTLE || gameMode === MODE.TITLE || gameMode === MODE.ENDING) {
                return;
            }

            const previousMode = gameMode;
            gameMode = MODE.MAP_VIEW;

            // „Éû„ÉÉ„Éó„Çø„Ç§„Éà„É´„ÇíË®≠ÂÆö
            worldMapTitle.textContent = currentMap.name || '„ÉØ„Éº„É´„Éâ„Éû„ÉÉ„Éó';

            // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíË°®Á§∫
            worldMapOverlay.classList.add('active');

            // Âú∞Âõ≥„ÇíÊèèÁîª
            renderWorldMap();

            // ÁÇπÊªÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
            startPlayerMarkerAnimation();
        }

        function closeWorldMap() {
            gameMode = MODE.FIELD;
            worldMapOverlay.classList.remove('active');

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÅúÊ≠¢ÔºàsetTimeout„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅclearTimeout„ÅßÂÅúÊ≠¢Ôºâ
            if (worldMapAnimationId) {
                clearTimeout(worldMapAnimationId);
                worldMapAnimationId = null;
            }
        }

        // Â∫ÉÂ§ß„Éû„ÉÉ„ÉóÁî®„ÅÆÈÉ®ÂàÜË°®Á§∫Ë®≠ÂÆö
        let worldMapViewport = {
            usePartialView: false,
            viewSize: 100,      // ÈÉ®ÂàÜË°®Á§∫ÊôÇ„ÅÆË°®Á§∫ÁØÑÂõ≤Ôºà„Çø„Ç§„É´Êï∞Ôºâ
            offsetX: 0,
            offsetY: 0,
            tileSize: 4
        };

        function renderWorldMap() {
            const mapData = currentMap.data;
            const rows = currentMap.rows;
            const cols = currentMap.cols;

            // Ë°®Á§∫„Çµ„Ç§„Ç∫„ÇíË®àÁÆóÔºàÊúÄÂ§ß„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆöÔºâ
            const maxWidth = Math.min(window.innerWidth * 0.7, 500);
            const maxHeight = Math.min(window.innerHeight * 0.5, 400);

            // Â∫ÉÂ§ß„Éû„ÉÉ„ÉóÂà§ÂÆöÔºà100x100‰ª•‰∏ä„ÅØÈÉ®ÂàÜË°®Á§∫„É¢„Éº„ÉâÔºâ
            const isLargeMap = cols > 100 || rows > 100;
            worldMapViewport.usePartialView = isLargeMap;

            let displayCols, displayRows, tileSize;

            if (isLargeMap) {
                // Â∫ÉÂ§ß„Éû„ÉÉ„Éó: „Éó„É¨„Ç§„É§„ÉºÂë®Ëæ∫„ÅÆ„ÅøË°®Á§∫
                const viewSize = worldMapViewport.viewSize;
                displayCols = Math.min(cols, viewSize);
                displayRows = Math.min(rows, viewSize);

                // „Éó„É¨„Ç§„É§„Éº„Çí‰∏≠ÂøÉ„Å´„Ç™„Éï„Çª„ÉÉ„ÉàË®àÁÆó
                worldMapViewport.offsetX = Math.max(0, Math.min(cols - displayCols, player.x - Math.floor(displayCols / 2)));
                worldMapViewport.offsetY = Math.max(0, Math.min(rows - displayRows, player.y - Math.floor(displayRows / 2)));

                // „Çø„Ç§„É´„Çµ„Ç§„Ç∫Ë®àÁÆóÔºàÊúÄÂ∞è1pxÔºâ
                const tileW = Math.floor(maxWidth / displayCols);
                const tileH = Math.floor(maxHeight / displayRows);
                tileSize = Math.max(1, Math.min(tileW, tileH, 6));
            } else {
                // ÈÄöÂ∏∏„Éû„ÉÉ„Éó: ÂÖ®‰ΩìË°®Á§∫
                displayCols = cols;
                displayRows = rows;
                worldMapViewport.offsetX = 0;
                worldMapViewport.offsetY = 0;

                // „Çø„Ç§„É´„Çµ„Ç§„Ç∫„ÇíËá™ÂãïË®àÁÆóÔºàÊúÄÂ∞è1px„ÄÅÂ§ß„Åç„ÅÑ„Éû„ÉÉ„Éó„ÅØÁ∏ÆÂ∞èÔºâ
                const tileW = Math.floor(maxWidth / cols);
                const tileH = Math.floor(maxHeight / rows);
                tileSize = Math.max(1, Math.min(tileW, tileH, 10));
            }

            worldMapViewport.tileSize = tileSize;

            const canvasW = displayCols * tileSize;
            const canvasH = displayRows * tileSize;

            // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
            worldMapCanvas.width = canvasW;
            worldMapCanvas.height = canvasH;

            // „Ç™„Éï„Çπ„ÇØ„É™„Éº„É≥„Ç≠„É£„É≥„Éê„Çπ„Çí‰ΩúÊàêÔºàÂú∞ÂΩ¢„Çí‰∏ÄÂ∫¶„Å†„ÅëÊèèÁîªÔºâ
            worldMapOffscreen = document.createElement('canvas');
            worldMapOffscreen.width = canvasW;
            worldMapOffscreen.height = canvasH;
            worldMapOffscreenCtx = worldMapOffscreen.getContext('2d');

            // Âú∞ÂΩ¢„ÇíÊèèÁîªÔºàË°®Á§∫ÁØÑÂõ≤„ÅÆ„ÅøÔºâ
            const startCol = worldMapViewport.offsetX;
            const startRow = worldMapViewport.offsetY;
            const endCol = startCol + displayCols;
            const endRow = startRow + displayRows;

            for (let row = startRow; row < endRow && row < rows; row++) {
                for (let col = startCol; col < endCol && col < cols; col++) {
                    const tile = mapData[row][col];
                    const color = WORLD_MAP_COLORS[tile] || '#333333';
                    worldMapOffscreenCtx.fillStyle = color;
                    const drawX = (col - startCol) * tileSize;
                    const drawY = (row - startRow) * tileSize;
                    worldMapOffscreenCtx.fillRect(drawX, drawY, tileSize, tileSize);
                }
            }

            // „Ç∞„É™„ÉÉ„ÉâÁ∑öÔºàÂ∞è„Åï„ÅÑ„Éû„ÉÉ„Éó„Åã„Å§„Çø„Ç§„É´„Åå4px‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (displayCols <= 30 && displayRows <= 30 && tileSize >= 4) {
                worldMapOffscreenCtx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                worldMapOffscreenCtx.lineWidth = 0.5;
                for (let row = 0; row <= displayRows; row++) {
                    worldMapOffscreenCtx.beginPath();
                    worldMapOffscreenCtx.moveTo(0, row * tileSize);
                    worldMapOffscreenCtx.lineTo(canvasW, row * tileSize);
                    worldMapOffscreenCtx.stroke();
                }
                for (let col = 0; col <= displayCols; col++) {
                    worldMapOffscreenCtx.beginPath();
                    worldMapOffscreenCtx.moveTo(col * tileSize, 0);
                    worldMapOffscreenCtx.lineTo(col * tileSize, canvasH);
                    worldMapOffscreenCtx.stroke();
                }
            }

            // Â∫ÉÂ§ß„Éû„ÉÉ„Éó„ÅÆÂ†¥Âêà„ÄÅË°®Á§∫ÁØÑÂõ≤„ÅÆÂ¢ÉÁïå„ÇíÁ§∫„ÅôÊû†„ÇíÊèèÁîª
            if (isLargeMap) {
                worldMapOffscreenCtx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
                worldMapOffscreenCtx.lineWidth = 2;
                worldMapOffscreenCtx.strokeRect(1, 1, canvasW - 2, canvasH - 2);

                // „Éû„ÉÉ„ÉóÂÖ®‰Ωì„Åß„ÅÆ‰ΩçÁΩÆ„ÇíÁ§∫„Åô„Éü„Éã„Éû„ÉÉ„ÉóÔºàÂè≥‰∏ä„Å´Â∞è„Åï„ÅèÔºâ
                const miniSize = 50;
                const miniTileW = miniSize / cols;
                const miniTileH = miniSize / rows;
                const miniX = canvasW - miniSize - 5;
                const miniY = 5;

                // „Éü„Éã„Éû„ÉÉ„ÉóËÉåÊôØ
                worldMapOffscreenCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                worldMapOffscreenCtx.fillRect(miniX - 2, miniY - 2, miniSize + 4, miniSize + 4);

                // „Éü„Éã„Éû„ÉÉ„Éó‰∏ä„ÅÆÁèæÂú®Ë°®Á§∫ÁØÑÂõ≤
                worldMapOffscreenCtx.fillStyle = 'rgba(100, 100, 100, 0.8)';
                worldMapOffscreenCtx.fillRect(miniX, miniY, miniSize, miniSize);

                worldMapOffscreenCtx.fillStyle = 'rgba(255, 255, 0, 0.5)';
                worldMapOffscreenCtx.fillRect(
                    miniX + startCol * miniTileW,
                    miniY + startRow * miniTileH,
                    displayCols * miniTileW,
                    displayRows * miniTileH
                );

                // „Éó„É¨„Ç§„É§„Éº‰ΩçÁΩÆÔºàËµ§ÁÇπÔºâ
                worldMapOffscreenCtx.fillStyle = '#ff3333';
                worldMapOffscreenCtx.beginPath();
                worldMapOffscreenCtx.arc(
                    miniX + player.x * miniTileW,
                    miniY + player.y * miniTileH,
                    2, 0, Math.PI * 2
                );
                worldMapOffscreenCtx.fill();
            }

            // „Ç™„Éï„Çπ„ÇØ„É™„Éº„É≥„Åã„ÇâËª¢ÈÄÅ
            worldMapCtx.drawImage(worldMapOffscreen, 0, 0);
        }

        function startPlayerMarkerAnimation() {
            const tileSize = worldMapViewport.tileSize;

            function animateMarker() {
                // „Ç™„Éï„Çπ„ÇØ„É™„Éº„É≥„ÇíÂÜçÊèèÁîª
                worldMapCtx.drawImage(worldMapOffscreen, 0, 0);

                // „Éó„É¨„Ç§„É§„Éº‰ΩçÁΩÆ„ÇíÊèèÁîªÔºàÁÇπÊªÖÔºâ- ÈÉ®ÂàÜË°®Á§∫„É¢„Éº„ÉâÂØæÂøú
                if (playerBlinkState) {
                    // ÈÉ®ÂàÜË°®Á§∫„ÅÆÂ†¥Âêà„ÅØ„Ç™„Éï„Çª„ÉÉ„Éà„ÇíËÄÉÊÖÆ
                    const displayX = player.x - worldMapViewport.offsetX;
                    const displayY = player.y - worldMapViewport.offsetY;

                    // Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÊèèÁîª
                    const cols = worldMapViewport.usePartialView ? worldMapViewport.viewSize : currentMap.cols;
                    const rows = worldMapViewport.usePartialView ? worldMapViewport.viewSize : currentMap.rows;

                    if (displayX >= 0 && displayX < cols && displayY >= 0 && displayY < rows) {
                        const px = displayX * tileSize + tileSize / 2;
                        const py = displayY * tileSize + tileSize / 2;
                        const radius = Math.max(2, tileSize * 0.6);

                        // Â§ñÂÅ¥„ÅÆÂÖâÂΩ©
                        worldMapCtx.beginPath();
                        worldMapCtx.arc(px, py, radius + 2, 0, Math.PI * 2);
                        worldMapCtx.fillStyle = 'rgba(255, 100, 100, 0.5)';
                        worldMapCtx.fill();

                        // ‰∏≠ÂøÉ„ÅÆ„Éû„Éº„Ç´„Éº
                        worldMapCtx.beginPath();
                        worldMapCtx.arc(px, py, radius, 0, Math.PI * 2);
                        worldMapCtx.fillStyle = '#ff3333';
                        worldMapCtx.fill();
                        worldMapCtx.strokeStyle = '#ffffff';
                        worldMapCtx.lineWidth = 1;
                        worldMapCtx.stroke();
                    }
                }

                playerBlinkState = !playerBlinkState;

                if (gameMode === MODE.MAP_VIEW) {
                    worldMapAnimationId = setTimeout(() => {
                        requestAnimationFrame(animateMarker);
                    }, 400); // 400ms„Åî„Å®„Å´ÁÇπÊªÖ
                }
            }

            animateMarker();
        }

        // „ÉØ„Éº„É´„Éâ„Éû„ÉÉ„Éó„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        worldMapOverlay.addEventListener('click', () => {
            if (gameMode === MODE.MAP_VIEW) {
                closeWorldMap();
            }
        });

        // üìç„Éú„Çø„É≥„ÅÆË¶ÅÁ¥†„Å®„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        const mapPinBtn = document.getElementById('mapPinBtn');

        mapPinBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (gameMode === MODE.FIELD || gameMode === MODE.MENU || gameMode === MODE.DIALOG) {
                openWorldMap();
            }
        });

        // „Éû„ÉÉ„Éó„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶üìç„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateMapPinVisibility() {
            // „Éï„Ç£„Éº„É´„Éâ„Çø„Ç§„Éó„ÅÆ„Éû„ÉÉ„Éó„Åß„ÅÆ„Åøüìç„ÇíË°®Á§∫
            const showPin = currentMap && (currentMap.type === 'field' || currentMap.cols >= 20 || currentMap.rows >= 20);
            if (showPin) {
                mapPinBtn.classList.remove('hidden');
            } else {
                mapPinBtn.classList.add('hidden');
            }
        }

        // „Éï„É≠„Ç¢Ë°®Á§∫„ÇíÊõ¥Êñ∞
        const floorDisplayElement = document.getElementById('floorDisplay');
        function updateFloorDisplay() {
            if (!currentMap || currentMap.floor === undefined) {
                floorDisplayElement.textContent = '';
                return;
            }

            const floor = currentMap.floor;
            if (floor > 0) {
                // Â°î„Å™„Å©„ÅÆ‰∏äÂ±§Èöé
                floorDisplayElement.textContent = `${floor}F`;
            } else if (floor < 0) {
                // Âú∞‰∏ãÈöé
                floorDisplayElement.textContent = `B${Math.abs(floor)}F`;
            } else {
                // 0ÈöéÔºàÂú∞‰∏äÔºâ
                floorDisplayElement.textContent = '';
            }
        }

        // ========================================
        // „Çø„Ç§„Éà„É´ÁîªÈù¢
        // ========================================
        const titleScreen = document.getElementById('titleScreen');
        const menuContinue = document.getElementById('menu-continue');
        const menuNewGame = document.getElementById('menu-newgame');
        const pressStart = document.getElementById('pressStart');
        const titleMenu = document.querySelector('.title-menu');

        function checkSaveData() {
            const savedData = localStorage.getItem(SAVE_KEY);
            hasSaveData = savedData !== null;
            return hasSaveData;
        }

        function initTitleScreen() {
            checkSaveData();

            if (hasSaveData) {
                menuContinue.style.display = 'flex';
                titleMenuIndex = 0; // Á∂ö„Åç„Åã„Çâ„Åå„Éá„Éï„Ç©„É´„Éà
            } else {
                menuContinue.style.display = 'none';
                titleMenuIndex = 0;
            }

            titleMenuActive = false;
            pressStart.style.display = 'block';
            titleMenu.classList.remove('active');
            updateTitleMenuSelection();
        }

        function updateTitleMenuSelection() {
            const items = titleMenu.querySelectorAll('.menu-item');
            items.forEach((item, index) => {
                if (item.style.display !== 'none') {
                    const actualIndex = hasSaveData ? index : index - 1;
                    item.classList.toggle('selected', actualIndex === titleMenuIndex || (!hasSaveData && index === 1 && titleMenuIndex === 0));
                }
            });
        }

        function activateTitleMenu() {
            if (titleMenuActive) return;
            titleMenuActive = true;
            pressStart.style.display = 'none';
            titleMenu.classList.add('active');
            updateTitleMenuSelection();
        }

        async function selectTitleMenuItem() {
            if (!titleMenuActive) {
                activateTitleMenu();
                return;
            }

            console.log('[DEBUG] selectTitleMenuItemÈñãÂßã');
            console.log('[DEBUG] hasSaveData:', hasSaveData, 'titleMenuIndex:', titleMenuIndex);

            // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
            const fadeOverlay = document.getElementById('fadeOverlay');
            fadeOverlay.classList.add('active');

            await new Promise(resolve => setTimeout(resolve, 300));

            // „Çø„Ç§„Éà„É´ÁîªÈù¢„ÇíÈùûË°®Á§∫
            titleScreen.classList.add('hidden');
            gameMode = MODE.FIELD;
            console.log('[DEBUG] gameModeÂ§âÊõ¥:', gameMode);

            if (hasSaveData && titleMenuIndex === 0) {
                // Á∂ö„Åç„Åã„Çâ
                console.log('[DEBUG] Á∂ö„Åç„Åã„Çâ„ÇíÈÅ∏Êäû');
                await loadGame();
            } else {
                // „ÅØ„Åò„ÇÅ„Åã„ÇâÔºà„Çª„Éº„Éñ„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢Ôºâ
                console.log('[DEBUG] „ÅØ„Åò„ÇÅ„Åã„Çâ„ÇíÈÅ∏Êäû');
                localStorage.removeItem(SAVE_KEY);
                await resetGameState();
                updateActualStats();
                console.log('[DEBUG] resetGameStateÂÆå‰∫Ü');
                console.log('[DEBUG] currentMap:', currentMap);
                console.log('[DEBUG] currentMap.dataÂ≠òÂú®:', !!currentMap.data, 'rows:', currentMap.rows, 'cols:', currentMap.cols);
                console.log('[DEBUG] player:', player.x, player.y);
            }

            // „Éû„ÉÉ„ÉóÂêç„ÇíÊõ¥Êñ∞
            document.getElementById('mapName').textContent = currentMap.name || '„Éï„Ç£„Éº„É´„Éâ';
            updateMapPinVisibility();
            updateFloorDisplay();

            console.log('[DEBUG] resizeÂâç tileSize:', tileSize, 'canvasWidth:', canvasWidth);
            resize();
            console.log('[DEBUG] resizeÂæå tileSize:', tileSize, 'canvasWidth:', canvasWidth);
            updateCamera();
            console.log('[DEBUG] updateCameraÂæå cameraX:', cameraX, 'cameraY:', cameraY);

            // „Éï„Çß„Éº„Éâ„Ç§„É≥
            await new Promise(resolve => setTimeout(resolve, 100));
            fadeOverlay.classList.remove('active');
            console.log('[DEBUG] „Éï„Çß„Éº„Éâ„Ç§„É≥ÂÆå‰∫Ü, gameMode:', gameMode);
        }

        async function resetGameState() {
            // „Éë„Éº„ÉÜ„Ç£„Çí„É™„Çª„ÉÉ„ÉàÔºà„Éí„Éº„É≠„Éº„ÅÆ„ÅøÔºâ
            party.length = 0;
            const hero = createPartyMember({
                id: 'hero',
                name: '„ÇÜ„ÅÜ„Åó„ÇÉ',
                job: 'hero',
                sprite: 'üßô',
                hp: 30,
                maxHp: 30,
                mp: 10,
                maxMp: 10,
                baseAtk: 12,
                baseDef: 8,
                speed: 6,
                level: 1,
                exp: 0,
                spells: [],
                equipment: { weapon: 10, armor: 20 }
            });
            party.push(hero);
            player = party[0];
            setupPlayerProxy();

            // partyData„Çí„É™„Çª„ÉÉ„Éà
            partyData.x = 4;
            partyData.y = 11;
            partyData.direction = 'down';
            partyData.moving = false;
            partyData.gold = 50;
            partyData.inventory = [{ id: 1, quantity: 3 }];

            // „Çπ„ÉÜ„Éº„Çø„ÇπÂÜçË®àÁÆó
            updateActualStats();

            // „Éû„ÉÉ„Éó„Çí„É™„Çª„ÉÉ„ÉàÔºàÂ§ñÈÉ®JSON„ÇíÂÑ™ÂÖà„Åó„Å¶„É≠„Éº„ÉâÔºâ
            currentMapId = 'field';
            currentMapPath = 'maps/field.json';

            try {
                const mapData = await loadMapFromDatabase(currentMapPath);
                // Â§ñÈÉ®JSON„Éû„ÉÉ„Éó„Åß„ÅÇ„Çã„Åì„Å®„Çí„Éû„Éº„ÇØ
                mapData._isExternal = true;
                currentMap = {
                    data: mapData.data.map(row => [...row]),
                    cols: mapData.cols,
                    rows: mapData.rows,
                    npcs: JSON.parse(JSON.stringify(mapData.npcs || [])),
                    chests: JSON.parse(JSON.stringify(mapData.chests || [])),
                    warps: mapData.warps ? [...mapData.warps] : [],
                    name: mapData.name,
                    type: mapData.type,
                    encounterRate: mapData.encounterRate,
                    mapId: mapData.mapId,
                    _isExternal: true
                };
                maps[mapData.mapId] = mapData;
            } catch (err) {
                console.error('„Éû„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº„ÄÅÂÜÖËîµ„Éû„ÉÉ„Éó„Çí‰ΩøÁî®:', err);
                const fieldMap = maps.field;
                currentMap = {
                    data: fieldMap.data.map(row => [...row]),
                    cols: fieldMap.cols,
                    rows: fieldMap.rows,
                    npcs: JSON.parse(JSON.stringify(fieldMap.npcs)),
                    chests: JSON.parse(JSON.stringify(fieldMap.chests)),
                    warps: fieldMap.warps ? [...fieldMap.warps] : [],
                    name: fieldMap.name,
                    type: fieldMap.type,
                    encounterRate: fieldMap.encounterRate
                };
            }

            // ÂÆùÁÆ±„ÅÆÈñãÂ∞ÅÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÂÜÖÈÉ®„Éû„ÉÉ„ÉóÁî®Ôºâ
            for (const mapId in maps) {
                if (maps[mapId].chests) {
                    maps[mapId].chests.forEach(chest => chest.isOpened = false);
                }
            }

            // „Ç≤„Éº„É†„ÇØ„É™„Ç¢„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
            if (typeof gameCleared !== 'undefined') {
                gameCleared = false;
            }
            // „Ç≤„Éº„É†ÈÄ≤Ë°å„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
            resetGameProgress();
        }

        // „Çø„Ç§„Éà„É´ÁîªÈù¢„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        menuContinue.addEventListener('click', () => {
            if (gameMode === MODE.TITLE) {
                titleMenuIndex = 0;
                updateTitleMenuSelection();
                selectTitleMenuItem();
            }
        });

        menuNewGame.addEventListener('click', () => {
            if (gameMode === MODE.TITLE) {
                titleMenuIndex = hasSaveData ? 1 : 0;
                updateTitleMenuSelection();
                selectTitleMenuItem();
            }
        });

        titleScreen.addEventListener('click', (e) => {
            if (gameMode === MODE.TITLE && !titleMenuActive) {
                activateTitleMenu();
            }
        });

        // ========================================
        // ÂàùÊúüÂåñ
        // ========================================
        window.addEventListener('resize', resize);

        // ÈùûÂêåÊúüÂàùÊúüÂåñ
        async function initGame() {
            initTitleScreen();
            resize();
            gameLoop();
        }

        initGame();
        document.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
</body>
</html>
