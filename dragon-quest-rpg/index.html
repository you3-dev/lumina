<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éâ„É©„ÇØ„Ç®È¢®RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background: #000;
            font-family: 'MS Gothic', 'Courier New', monospace;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #fadeOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.3s ease-in-out;
        }

        #fadeOverlay.active {
            opacity: 1;
        }

        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #mapName {
            position: absolute;
            top: 10px;
            right: 10px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 12px;
            border-radius: 4px;
            pointer-events: none;
        }

        #dpad {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            pointer-events: auto;
        }

        .dpad-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: background 0.1s;
        }

        .dpad-btn:active, .dpad-btn.pressed {
            background: rgba(255, 255, 255, 0.4);
        }

        #dpad-up { top: 0; left: 50px; }
        #dpad-down { bottom: 0; left: 50px; }
        #dpad-left { top: 50px; left: 0; }
        #dpad-right { top: 50px; right: 0; }

        #dpad-center {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
        }

        #action-buttons {
            position: absolute;
            bottom: 30px;
            right: 20px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }

        .action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: background 0.1s;
        }

        .action-btn:active, .action-btn.pressed {
            background: rgba(255, 255, 255, 0.4);
        }

        #btn-b {
            margin-top: 30px;
        }

        /* „Çø„Ç§„Éà„É´ÁîªÈù¢ */
        #titleScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #0a0a2e 0%, #1a1a4e 50%, #2a2a6e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #titleScreen.hidden {
            display: none;
        }

        .title-content {
            text-align: center;
            color: #fff;
        }

        .game-title {
            font-size: 2.5rem;
            color: #ffd700;
            text-shadow:
                0 0 10px #ffd700,
                0 0 20px #ff8c00,
                3px 3px 0 #8b4513;
            margin-bottom: 10px;
            animation: titleGlow 2s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00, 3px 3px 0 #8b4513; }
            50% { text-shadow: 0 0 20px #ffd700, 0 0 40px #ff8c00, 3px 3px 0 #8b4513; }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #87ceeb;
            margin-bottom: 60px;
        }

        .title-menu {
            margin-bottom: 40px;
        }

        .menu-item {
            font-size: 1.4rem;
            padding: 15px 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .menu-item:hover {
            color: #ffd700;
            transform: scale(1.05);
        }

        .menu-item .cursor {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .menu-item.selected .cursor,
        .menu-item:hover .cursor {
            opacity: 1;
        }

        .menu-item.selected {
            color: #ffd700;
        }

        .press-start {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .title-menu.active ~ .press-start {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="fadeOverlay"></div>

    <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
    <div id="titleScreen">
        <div class="title-content">
            <h1 class="game-title">„Éâ„É©„Ç¥„É≥„ÇØ„Ç®„Çπ„Éà</h1>
            <p class="subtitle">„Äú ÂãáËÄÖ„ÅÆÂÜíÈô∫ „Äú</p>
            <div class="title-menu">
                <div class="menu-item" id="menu-continue" style="display: none;">
                    <span class="cursor">‚ñ∂</span>
                    <span>„Å§„Å•„Åç„Åã„Çâ</span>
                </div>
                <div class="menu-item" id="menu-newgame">
                    <span class="cursor">‚ñ∂</span>
                    <span>„ÅØ„Åò„ÇÅ„Åã„Çâ</span>
                </div>
            </div>
            <p class="press-start" id="pressStart">Press ENTER or Tap to Start</p>
        </div>
    </div>

    <div id="hud">
        <div id="mapName">„Éï„Ç£„Éº„É´„Éâ</div>

        <!-- „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫ÔºàÈñãÁô∫Áî®„ÄÅ„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„ÅßÈùûË°®Á§∫Ôºâ
        <div id="encounterDebug" style="position: fixed; top: 40px; right: 10px; background: rgba(0,0,0,0.7); color: #0f0; padding: 5px 10px; font-size: 12px; font-family: monospace; border-radius: 4px; z-index: 1000;"></div>
        -->

        <div id="dpad">
            <div class="dpad-btn" id="dpad-up">‚ñ≤</div>
            <div class="dpad-btn" id="dpad-left">‚óÄ</div>
            <div id="dpad-center"></div>
            <div class="dpad-btn" id="dpad-right">‚ñ∂</div>
            <div class="dpad-btn" id="dpad-down">‚ñº</div>
        </div>

        <div id="action-buttons">
            <div class="action-btn" id="btn-b">B</div>
            <div class="action-btn" id="btn-a">A</div>
        </div>
    </div>

    <script>
        // ========================================
        // „Ç≤„Éº„É†Ë®≠ÂÆö
        // ========================================
        const VISIBLE_TILES = 10;
        const SAVE_KEY = 'dragonquest_rpg_save';

        // „Ç≤„Éº„É†„É¢„Éº„Éâ
        const MODE = {
            TITLE: 'title',
            FIELD: 'field',
            BATTLE: 'battle',
            MENU: 'menu',
            INN: 'inn',
            SHOP: 'shop',
            DIALOG: 'dialog',
            ENDING: 'ending'
        };

        let gameMode = MODE.TITLE;
        let titleMenuIndex = 0;
        let titleMenuActive = false;
        let hasSaveData = false;

        // „Çø„Ç§„É´„Çø„Ç§„Éó
        const TILE = {
            GRASS: 0,
            MOUNTAIN: 1,
            SEA: 2,
            CASTLE: 3,
            TOWN: 4,
            STAIRS: 5,
            FLOOR: 6,
            WALL: 7
        };

        // „Éû„ÉÉ„Éó„Çø„Ç§„ÉóÂà•„ÅÆ„Çø„Ç§„É´Ëâ≤
        const MAP_TILE_COLORS = {
            field: {
                [TILE.GRASS]: '#2d5a27',
                [TILE.MOUNTAIN]: '#6b4423',
                [TILE.SEA]: '#1a4a7a',
                [TILE.CASTLE]: '#2d5a27',
                [TILE.TOWN]: '#2d5a27',
                [TILE.STAIRS]: '#4a4a4a',
                [TILE.FLOOR]: '#8b7355',
                [TILE.WALL]: '#4a4a5a'
            },
            castle: {
                [TILE.FLOOR]: '#5a5a6a',
                [TILE.WALL]: '#3a3a4a',
                [TILE.STAIRS]: '#4a4a4a'
            },
            town: {
                [TILE.FLOOR]: '#a0a0a0',
                [TILE.WALL]: '#6a6a7a',
                [TILE.STAIRS]: '#4a4a4a'
            },
            dungeon: {
                [TILE.FLOOR]: '#4a4a3a',
                [TILE.WALL]: '#2a2a2a',
                [TILE.STAIRS]: '#5a5a4a'
            }
        };

        const DEFAULT_TILE_COLORS = {
            [TILE.GRASS]: '#2d5a27',
            [TILE.MOUNTAIN]: '#6b4423',
            [TILE.SEA]: '#1a4a7a',
            [TILE.CASTLE]: '#2d5a27',
            [TILE.TOWN]: '#2d5a27',
            [TILE.STAIRS]: '#4a4a4a',
            [TILE.FLOOR]: '#8b7355',
            [TILE.WALL]: '#4a4a5a'
        };

        const WALKABLE_TILES = [TILE.GRASS, TILE.CASTLE, TILE.TOWN, TILE.STAIRS, TILE.FLOOR];
        const ENCOUNTER_TILES = [TILE.GRASS]; // „Ç®„É≥„Ç´„Ç¶„É≥„Éà„ÅåÁô∫Áîü„Åô„Çã„Çø„Ç§„É´

        // ========================================
        // „Ç¢„Ç§„ÉÜ„É†„Éá„Éº„Çø
        // ========================================
        const items = {
            // Ê∂àË≤ª„Ç¢„Ç§„ÉÜ„É†
            1: { id: 1, name: 'Ëñ¨Ëçâ', description: 'HP„Çí30ÂõûÂæ©„Åô„Çã', type: 'heal', value: 30, price: 8 },
            2: { id: 2, name: 'ÊØíÊ∂à„ÅóËçâ', description: 'ÊØí„ÇíÊ≤ªÁôÇ„Åô„Çã', type: 'cure', price: 10 },
            3: { id: 3, name: 'ËÅñÊ∞¥', description: 'Âº±„ÅÑÊïµ„ÇíÈÄÄ„Åë„Çã', type: 'holy', price: 20 },
            8: { id: 8, name: 'È≠îÊ≥ï„ÅÆÈçµ', description: 'Êââ„ÇíÈñã„Åë„Çã„Åì„Å®„Åå„Åß„Åç„Çã', type: 'key', price: 0 },
            // Ê≠¶Âô® (equippable: Ë£ÖÂÇôÂèØËÉΩ„Å™„Ç∏„Éß„Éñ„É™„Çπ„Éà)
            10: { id: 10, name: '„Åì„Çì„Åº„ÅÜ', type: 'weapon', value: 2, price: 10, equippable: ['hero'] },
            11: { id: 11, name: '„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 10, price: 100, equippable: ['hero'] },
            12: { id: 12, name: '„Å¶„Å§„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 20, price: 300, equippable: ['hero'] },
            13: { id: 13, name: '„ÅØ„Åå„Å≠„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 35, price: 700, equippable: ['hero'] },
            14: { id: 14, name: '„Åß„Çì„Åõ„Å§„ÅÆ„Å§„Çã„Åé', type: 'weapon', value: 50, price: 0, equippable: ['hero'] },
            // Èò≤ÂÖ∑
            20: { id: 20, name: '„Åü„Å≥„Å≥„Å®„ÅÆ„Åµ„Åè', type: 'armor', value: 1, price: 10, equippable: ['hero'] },
            21: { id: 21, name: '„Åã„Çè„ÅÆ„Çà„Çç„ÅÑ', type: 'armor', value: 5, price: 80, equippable: ['hero'] },
            22: { id: 22, name: '„Åè„Åï„Çä„Åã„Åü„Å≥„Çâ', type: 'armor', value: 12, price: 250, equippable: ['hero'] },
            23: { id: 23, name: '„Å¶„Å§„ÅÆ„Çà„Çç„ÅÑ', type: 'armor', value: 22, price: 600, equippable: ['hero'] },
            24: { id: 24, name: '„Åæ„Åª„ÅÜ„ÅÆ„Çà„Çç„ÅÑ', type: 'armor', value: 35, price: 1200, equippable: ['hero'] }
        };

        // „Ç∑„Éß„ÉÉ„ÉóÂïÜÂìÅ„É™„Çπ„Éà
        const shopItems = [11, 12, 13, 21, 22, 23, 24]; // „Å©„ÅÜ„ÅÆ„Å§„Çã„Åé„Äú„Åæ„Åª„ÅÜ„ÅÆ„Çà„Çç„ÅÑ

        // ========================================
        // „É¢„É≥„Çπ„Çø„Éº„Éá„Éº„Çø
        // ========================================
        const monsters = {
            // ===== Â∫èÁõ§„ÅÆÊïµÔºà„Éï„Ç£„Éº„É´„Éâ„ÉªÊ£Æ Lv1~3ÊÉ≥ÂÆöÔºâ=====
            slime: {
                name: '„Çπ„É©„Ç§„É†',
                sprite: 'üü¢',
                level: 1,
                hp: 8,
                atk: 5,
                def: 2,
                speed: 3,
                exp: 2,
                gold: 2,
                resistances: { sleep: 1.0, blind: 1.0, poison: 1.0 }
            },
            dracky: {
                name: '„Éâ„É©„Ç≠„Éº',
                sprite: 'ü¶á',
                level: 2,
                hp: 10,
                atk: 7,
                def: 3,
                speed: 6,
                exp: 3,
                gold: 3,
                resistances: { sleep: 0.8, blind: 0.6, poison: 1.0 }
            },
            bat: {
                name: '„Åä„Åä„Åì„ÅÜ„ÇÇ„Çä',
                sprite: 'ü¶á',
                hueRotate: 180, // Ëâ≤ÈÅï„ÅÑÔºàÈùíÁ≥ªÔºâ
                level: 3,
                hp: 14,
                atk: 9,
                def: 4,
                speed: 8,
                exp: 5,
                gold: 5,
                resistances: { sleep: 0.8, blind: 0.5, poison: 1.0 }
            },
            // ===== ‰∏≠Áõ§„ÅÆÊïµÔºàÊ¥ûÁ™üB1„ÉªÊ£Æ„ÅÆÂ•• Lv4~6ÊÉ≥ÂÆöÔºâ=====
            ghost: {
                name: '„Ç¥„Éº„Çπ„Éà',
                sprite: 'üëª',
                level: 4,
                hp: 18,
                atk: 12,
                def: 5,
                speed: 5,
                exp: 10,
                gold: 8,
                resistances: { sleep: 0.3, blind: 1.0, poison: 0 }
            },
            scorpion: {
                name: '„Åä„Åä„Åï„Åù„Çä',
                sprite: 'ü¶Ç',
                level: 5,
                hp: 22,
                atk: 14,
                def: 8,
                speed: 7,
                exp: 15,
                gold: 12,
                resistances: { sleep: 0.7, blind: 0.8, poison: 0 } // ÊØíÁÑ°Âäπ
            },
            // ===== ÂæåÂçä„ÅÆÊïµÔºàÊ¥ûÁ™üÊ∑±ÈÉ® Lv7~9ÊÉ≥ÂÆöÔºâ=====
            skeleton: {
                name: '„Åå„ÅÑ„Åì„Å§',
                sprite: 'üíÄ',
                level: 6,
                hp: 28,
                atk: 18,
                def: 10,
                speed: 4,
                exp: 25,
                gold: 20,
                resistances: { sleep: 0, blind: 0.8, poison: 0 }
            },
            armoredKnight: {
                name: '„Åï„Åæ„Çà„ÅÜ„Çà„Çç„ÅÑ',
                sprite: 'üõ°Ô∏è',
                level: 7,
                hp: 40,
                atk: 22,
                def: 18,
                speed: 3,
                exp: 35,
                gold: 30,
                resistances: { sleep: 0.2, blind: 0.5, poison: 0 }
            },
            deathKnight: {
                name: '„Åó„Çä„Çá„ÅÜ„ÅÆ„Åç„Åó',
                sprite: 'üõ°Ô∏è',
                hueRotate: 270, // Ëâ≤ÈÅï„ÅÑÔºàÁ¥´Á≥ªÔºâ
                level: 8,
                hp: 55,
                atk: 28,
                def: 22,
                speed: 5,
                exp: 50,
                gold: 45,
                resistances: { sleep: 0, blind: 0.3, poison: 0 }
            },
            // ===== „Éú„ÇπÁ¥ö =====
            dragon: {
                name: '„Éâ„É©„Ç¥„É≥',
                sprite: 'üêâ',
                level: 10,
                hp: 80,
                atk: 35,
                def: 20,
                speed: 10,
                exp: 100,
                gold: 150,
                resistances: { sleep: 0.1, blind: 0.3, poison: 0.5 }
            },
            maou: {
                name: 'È≠îÁéã',
                sprite: 'üëø',
                hp: 200,
                mp: 100,
                atk: 50,
                def: 30,
                speed: 15,
                exp: 500,
                gold: 0,
                isBoss: true,
                actions: 2, // 2ÂõûË°åÂãï
                resistances: { sleep: 0, blind: 0, poison: 0 }, // ÂÆåÂÖ®ËÄêÊÄß
                // È≠îÁéãÂ∞ÇÁî®„Çπ„Ç≠„É´
                skills: ['attack', 'hageshiiHonoo', 'behoma', 'ionazun']
            }
        };

        // È≠îÁéãÂ∞ÇÁî®„Çπ„Ç≠„É´
        const bossSkills = {
            hageshiiHonoo: { name: '„ÅØ„Åí„Åó„ÅÑ„Åª„ÅÆ„Åä', type: 'attack', power: 40, flashColor: 'rgba(255, 50, 0, 0.7)' },
            behoma: { name: '„Éô„Éõ„Éû', type: 'heal', power: 9999, flashColor: 'rgba(0, 255, 100, 0.5)' },
            ionazun: { name: '„Ç§„Ç™„Éä„Ç∫„É≥', type: 'attack', power: 55, flashColor: 'rgba(255, 255, 0, 0.7)' }
        };

        // „Ç®„É™„Ç¢Âà•„Ç®„É≥„Ç´„Ç¶„É≥„Éà„ÉÜ„Éº„Éñ„É´ÔºàmapId„Éô„Éº„ÇπÔºâ
        // Âêå„Åò„É¢„É≥„Çπ„Çø„Éº„ÇíË§áÊï∞ÂõûÂÖ•„Çå„Çã„Å®Âá∫ÁèæÁéá„Åå‰∏ä„Åå„Çã
        const encounterTables = {
            // „Éï„Ç£„Éº„É´„ÉâÔºàLv1~3Ôºâ- ÂàùÂøÉËÄÖÂêë„Åë
            field: ['slime', 'slime', 'slime', 'dracky', 'dracky', 'bat'],
            // Ê∑±„ÅÑÊ£ÆÔºàLv3~5Ôºâ- „ÇÑ„ÇÑÂº∑„ÇÅ
            forest: ['dracky', 'bat', 'bat', 'ghost', 'scorpion'],
            // ÊöóÈªí„ÅÆÊ¥ûÁ™üÔºàLv5~8Ôºâ- ‰∏≠Áõ§„ÄúÂæåÂçä
            dungeon: ['ghost', 'scorpion', 'skeleton', 'skeleton', 'armoredKnight', 'deathKnight']
        };

        // ÊóßtypeÂêç„Å®„ÅÆ‰∫íÊèõÁî®„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        const encounterTableFallback = {
            field: 'field',
            dungeon: 'dungeon'
        };

        // ========================================
        // Âë™Êñá„Éá„Éº„Çø
        // ========================================
        const spells = {
            // ÂõûÂæ©Âë™Êñá
            hoimi: { id: 'hoimi', name: '„Éõ„Ç§„Éü', mp: 3, type: 'heal', power: 30, learnLevel: 1, element: 'heal', flashColor: 'rgba(0, 255, 100, 0.5)' },
            // ÊîªÊíÉÂë™Êñá
            mera: { id: 'mera', name: '„É°„É©', mp: 2, type: 'attack', power: 15, learnLevel: 1, element: 'fire', flashColor: 'rgba(255, 100, 0, 0.6)' },
            hyado: { id: 'hyado', name: '„Éí„É£„Éâ', mp: 4, type: 'attack', power: 25, learnLevel: 4, element: 'ice', flashColor: 'rgba(100, 200, 255, 0.6)' },
            gira: { id: 'gira', name: '„ÇÆ„É©', mp: 5, type: 'attack', power: 35, learnLevel: 6, element: 'light', flashColor: 'rgba(255, 255, 100, 0.6)' },
            // Áä∂ÊÖãÁï∞Â∏∏Âë™Êñá
            rariho: { id: 'rariho', name: '„É©„É™„Éõ„Éº', mp: 3, type: 'status', statusEffect: 'sleep', successRate: 0.7, learnLevel: 2, element: 'status', flashColor: 'rgba(150, 100, 200, 0.5)' },
            manusa: { id: 'manusa', name: '„Éû„Éå„Éº„Çµ', mp: 4, type: 'status', statusEffect: 'blind', successRate: 0.6, learnLevel: 5, element: 'status', flashColor: 'rgba(150, 100, 200, 0.5)' }
        };

        // Áä∂ÊÖãÁï∞Â∏∏„ÅÆÂÆöÁæ©
        const STATUS_EFFECTS = {
            sleep: { name: 'Áú†„Çä', icon: 'üí§', badge: 'Áú†', duration: { min: 2, max: 3 } },
            poison: { name: 'ÊØí', icon: '‚ò†Ô∏è', badge: 'ÊØí', damageRate: 0.1 },
            blind: { name: 'ÂπªÊÉë', icon: 'üí´', badge: 'Âπª', hitRateModifier: 0.5 }
        };

        // Âë™Êñá„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫Áî®
        let spellFlash = { active: false, color: '', alpha: 0 };

        // „Éú„ÇπÊà¶ÊºîÂá∫Áî®
        let screenShake = { active: false, intensity: 0, duration: 0 };
        let gameCleared = false;  // È≠îÁéãË®é‰ºê„Éï„É©„Ç∞
        let endingPhase = null;   // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÈÄ≤Ë°åÁä∂ÊÖã

        // ========================================
        // „Éû„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†ÔºàÂ§ñÈÉ®JSON„Éï„Ç°„Ç§„É´ÈÄ£Êê∫Ôºâ
        // ========================================

        // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„Éë„Çπ„Çí‰øùÊåÅ
        let currentMapPath = 'maps/castle.json';

        // „Éû„ÉÉ„Éó„É≠„Éº„ÉâÁä∂ÊÖã
        let mapLoadState = {
            loading: false,
            fadeAlpha: 0,
            targetMapPath: null,
            targetX: 0,
            targetY: 0
        };

        // „É≠„Éº„ÉâÊ∏à„Åø„Éû„ÉÉ„Éó„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
        const maps = {
            field: {
                mapId: 'field',
                name: '„Éï„Ç£„Éº„É´„Éâ',
                type: 'field',
                cols: 20,
                rows: 20,
                encounterRate: 0.08,
                isSafe: false,
                data: [
                    [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
                    [2,2,2,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,2,2],
                    [2,2,0,0,0,0,0,0,0,2,2,0,0,0,0,1,1,0,0,2],
                    [2,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,1,0,0,2],
                    [2,0,0,1,1,1,1,0,0,0,0,0,0,0,0,1,0,0,0,2],
                    [2,0,0,0,1,1,0,0,0,3,0,0,0,0,0,0,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
                    [2,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,2],
                    [2,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
                    [2,0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,2],
                    [2,0,0,1,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,2],
                    [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
                    [2,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,2],
                    [2,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,2,2],
                    [2,2,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,2,2,2],
                    [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]
                ],
                warps: [
                    { x: 9, y: 5, targetMap: 'maps/castle.json', targetX: 7, targetY: 12 },
                    { x: 4, y: 10, targetMap: 'maps/town.json', targetX: 7, targetY: 13 },
                    { x: 16, y: 10, targetMap: 'maps/dungeon.json', targetX: 1, targetY: 1 }
                ],
                npcs: [],
                chests: []
            },
            castle: {
                mapId: 'castle',
                name: 'Âüé',
                type: 'castle',
                cols: 15,
                rows: 15,
                encounterRate: 0,
                isSafe: true,
                data: [
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,7,7,7,6,6,6,7,7,7,6,6,7],
                    [7,6,6,7,6,6,6,6,6,6,6,7,6,6,7],
                    [7,6,6,7,6,6,6,6,6,6,6,7,6,6,7],
                    [7,6,6,7,6,6,6,6,6,6,6,7,6,6,7],
                    [7,6,6,7,7,6,6,6,6,6,7,7,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,5,6,6,6,6,6,6,7],
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7]
                ],
                warps: [
                    { x: 7, y: 12, targetMap: 'maps/field.json', targetX: 9, targetY: 6 }
                ],
                npcs: [
                    { id: 'king', x: 7, y: 2, sprite: 'üëë', type: 'king', messages: ['„Åä„Åä„ÄÅÂãáËÄÖ„ÇàÔºÅ', '„Çà„Åè„ÅûÂèÇ„Å£„Åü„ÄÇ', 'È≠îÁéã„Åå‰∏ñÁïå„ÇíÈóá„ÅßË¶Ü„Åä„ÅÜ„Å®„Åó„Å¶„Åä„Çã„ÄÇ', '„Å©„ÅÜ„Åã‰∏ñÁïå„ÇíÊïë„Å£„Å¶„Åè„ÇåÔºÅ', 'Êù±„ÅÆÊ¥ûÁ™ü„Å´‰ºùË™¨„ÅÆÂâ£„Åå„ÅÇ„Çã„Å®„ÅÑ„ÅÜ„ÄÇ', 'ÊóÖÁ´ã„Å§„Åå„Çà„ÅÑÔºÅ'], clearedMessages: ['„Åä„Åä„ÄÅÂãáËÄÖ„ÇàÔºÅ', '„Çà„Åè„ÅûÈ≠îÁéã„ÇíÂÄí„Åó„Å¶„Åè„Çå„ÅüÔºÅ', '„Åì„Çå„Åß‰∏ñÁïå„Å´Âπ≥Âíå„ÅåÊàª„Å£„Åü„ÄÇ', '„Åù„Å™„Åü„ÅØÁúü„ÅÆËã±ÈõÑ„Åò„ÇÉÔºÅ'] },
                    { id: 'guard1', x: 3, y: 10, sprite: 'üíÇ', type: 'guard', messages: ['ÁéãÊßò„Çí„ÅäÂÆà„Çä„Åô„Çã„ÅÆ„Åå', 'Êàë„ÄÖ„ÅÆÂãô„ÇÅ„Åß„Åô„ÄÇ'], clearedMessages: ['ÂãáËÄÖÊßòÔºÅ', '„ÅÇ„Å™„Åü„ÅÆ„Åä„Åã„Åí„ÅßÂπ≥Âíå„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ'] },
                    { id: 'guard2', x: 11, y: 10, sprite: 'üíÇ', type: 'guard', messages: ['„Åì„ÅÆÂüé„ÅØÂÆâÂÖ®„Åß„Åô„ÄÇ', '„ÅîÂÆâÂøÉ„Åè„Å†„Åï„ÅÑ„ÄÇ'], clearedMessages: ['È≠îÁéã„ÅåÂÄí„Åï„Çå„Åü„Å®ËÅû„Åç„Åæ„Åó„ÅüÔºÅ', '„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÅÂãáËÄÖÊßòÔºÅ'] }
                ],
                chests: [
                    { id: 'castle_chest1', x: 4, y: 5, itemId: 8, isOpened: false }
                ]
            },
            town: {
                mapId: 'town',
                name: 'Ë°ó',
                type: 'town',
                cols: 15,
                rows: 15,
                encounterRate: 0,
                isSafe: true,
                data: [
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,7,7,6,6,6,6,6,6,6,7,7,6,7],
                    [7,6,7,7,6,6,6,6,6,6,6,7,7,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,7,7,7,6,6,6,6,6,7],
                    [7,6,6,6,6,6,7,7,7,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,7,7,6,6,6,6,6,6,6,7,7,6,7],
                    [7,6,7,7,6,6,6,6,6,6,6,7,7,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,5,6,6,6,6,6,6,7],
                    [7,7,7,7,7,7,7,7,7,7,7,7,7,7,7]
                ],
                warps: [
                    { x: 7, y: 13, targetMap: 'maps/field.json', targetX: 4, targetY: 11 }
                ],
                npcs: [
                    { id: 'villager1', x: 5, y: 4, sprite: 'üë®', type: 'villager', messages: ['„Çà„ÅÜ„Åì„ÅùÊàë„ÅåË°ó„Å∏ÔºÅ', 'Êù±„ÅÆÊ¥ûÁ™ü„Å´„ÅØÈ≠îÁâ©„Åå„ÅÑ„Çã„Çâ„Åó„ÅÑ„ÄÇ', 'Ê∞ó„Çí„Å§„Åë„Å¶„Å™„ÄÇ'], clearedMessages: ['Âπ≥Âíå„Å´„Å™„Å£„Åü„Å™„ÅÇÔºÅ', '„Åì„Çå„ÇÇ„ÅÇ„Çì„Åü„ÅÆ„Åä„Åã„Åí„Å†ÔºÅ', '„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÅÂãáËÄÖ„Åï„ÅæÔºÅ'] },
                    { id: 'villager2', x: 10, y: 4, sprite: 'üë©', type: 'villager', messages: ['„ÅÇ„Çâ„ÄÅÊóÖ„ÅÆÊñπÔºü', 'Âüé„ÅÆÁéãÊßò„Å´‰ºö„ÅÑ„Åæ„Åó„Åü„ÅãÔºü', 'Â§ßÂàá„Å™Ë©±„Åå„ÅÇ„Çã„Åù„ÅÜ„Åß„Åô„Çà„ÄÇ'], clearedMessages: ['„ÅÇ„Çâ„ÄÅÂãáËÄÖÊßòÔºÅ', 'È≠îÁéã„ÇíÂÄí„Åó„Åü„Å£„Å¶Êú¨ÂΩìÔºü', '„Åô„Åî„ÅÑ„ÇèÔºÅ„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ'] },
                    { id: 'innkeeper', x: 12, y: 2, sprite: 'üè®', type: 'inn', innCost: 10, messages: [] },
                    { id: 'shopkeeper', x: 2, y: 2, sprite: '‚öîÔ∏è', type: 'shop', messages: [] },
                    { id: 'child', x: 3, y: 11, sprite: 'üë¶', type: 'villager', messages: ['„Å≠„Åà„Å≠„Åà„ÄÅÂãáËÄÖ„Åï„ÇìÔºü', '„Åº„Åè„ÇÇÂ§ß„Åç„Åè„Å™„Å£„Åü„Çâ', 'ÂãáËÄÖ„Å´„Å™„Çä„Åü„ÅÑ„Å™ÔºÅ'], clearedMessages: ['„Çè„ÅÇÔºÅÊú¨Áâ©„ÅÆÂãáËÄÖ„Å†ÔºÅ', 'È≠îÁéã„ÇíÂÄí„Åó„Åü„Çì„Åß„Åó„ÇáÔºü', '„Åã„Å£„Åì„ÅÑ„ÅÑÔΩûÔºÅ'] }
                ],
                chests: [
                    { id: 'town_chest1', x: 13, y: 1, itemId: 1, isOpened: false },
                    { id: 'town_chest2', x: 1, y: 12, itemId: 2, isOpened: false }
                ]
            },
            dungeon: {
                mapId: 'dungeon',
                name: 'Ê¥ûÁ™ü',
                type: 'dungeon',
                cols: 12,
                rows: 12,
                encounterRate: 0.12,
                isSafe: false,
                data: [
                    [7,7,7,7,7,7,7,7,7,7,7,7],
                    [7,5,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,7,7,7,6,6,7,7,6,7],
                    [7,6,6,7,6,6,6,6,6,7,6,7],
                    [7,6,6,7,6,7,7,7,6,7,6,7],
                    [7,6,6,6,6,6,6,6,6,6,5,7],
                    [7,7,7,7,6,7,7,7,6,6,6,7],
                    [7,6,6,6,6,6,6,7,6,7,6,7],
                    [7,6,7,7,7,7,6,7,6,7,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,6,7],
                    [7,7,7,7,7,7,7,7,7,7,7,7]
                ],
                warps: [
                    { x: 1, y: 1, targetMap: 'maps/field.json', targetX: 16, targetY: 11 },
                    { x: 10, y: 5, targetMap: 'maps/maou_room.json', targetX: 7, targetY: 12 }
                ],
                npcs: [
                    { id: 'hermit', x: 10, y: 10, sprite: 'üßô', type: 'hermit', messages: ['„Åª„Åª„ÅÜ„ÄÅ„Åì„Åì„Åæ„ÅßÊù•„Åü„Åã„ÄÇ', '„Çè„Åó„ÅØÊòî„ÄÅÂãáËÄÖ„Å†„Å£„Åü„ÄÇ', '„Åì„ÅÆÂ••„Å´‰ºùË™¨„ÅÆÂâ£„Åå„ÅÇ„Çã„ÄÇ', 'È≠îÁéã„ÇíÂÄí„Åô„ÅÆ„Å´ÂøÖË¶Å„Åò„ÇÉ„ÄÇ', 'ÂøÉ„Åó„Å¶ÈÄ≤„ÇÄ„Åå„Çà„ÅÑ„ÄÇ'] }
                ],
                chests: [
                    { id: 'dungeon_chest1', x: 4, y: 3, itemId: 3, isOpened: false },
                    { id: 'dungeon_chest2', x: 1, y: 7, itemId: 14, isOpened: false }  // „Åß„Çì„Åõ„Å§„ÅÆ„Å§„Çã„Åé
                ]
            },
            maouRoom: {
                mapId: 'maouRoom',
                name: 'È≠îÁéã„ÅÆÈñì',
                type: 'dungeon',
                cols: 11,
                rows: 10,
                encounterRate: 0,
                isSafe: false,
                data: [
                    [7,7,7,7,7,7,7,7,7,7,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,6,6,6,6,6,7],
                    [7,6,6,6,6,5,6,6,6,6,7],
                    [7,7,7,7,7,7,7,7,7,7,7]
                ],
                warps: [
                    { x: 5, y: 8, targetMap: 'maps/dungeon.json', targetX: 23, targetY: 21 }
                ],
                npcs: [
                    { id: 'maou', x: 5, y: 2, sprite: 'üëø', type: 'maou', messages: [] }
                ],
                chests: []
            }
        };

        // ========================================
        // „Ç≤„Éº„É†Áä∂ÊÖã
        // ========================================
        let currentMapId = 'field';
        let currentMap = maps[currentMapId];
        let isTransitioning = false;

        // „Ç®„É≥„Ç´„Ç¶„É≥„Éà„Ç∑„Çπ„ÉÜ„É†
        let stepsSinceLastBattle = 0;  // ÂâçÂõû„Éê„Éà„É´Âæå„Åã„Çâ„ÅÆÊ≠©Êï∞
        const SAFE_STEPS = 5;          // ‰∏çÊÑüÂú∞Â∏ØÔºà„Åì„ÅÆÊ≠©Êï∞„Åæ„Åß„ÅØ„Ç®„É≥„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑÔºâ
        const ENCOUNTER_RATE_PER_STEP = 0.02;  // Ê≠©Êï∞„ÅÇ„Åü„Çä„ÅÆÁ¢∫Áéá‰∏äÊòáÁéáÔºà2%Ôºâ
        const MAX_ENCOUNTER_RATE = 0.95;       // ÊúÄÂ§ß„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÁéá

        // ÈÄ£Á∂öÁßªÂãï„Ç∑„Çπ„ÉÜ„É†ÔºàÊäº„ÅóÁ∂ö„Åë„Å¶ÁßªÂãïÔºâ
        let moveInterval = null;
        let currentMoveDirection = { dx: 0, dy: 0 };
        const CONTINUOUS_MOVE_DELAY = 150;  // ÈÄ£Á∂öÁßªÂãï„ÅÆÈñìÈöîÔºà„Éü„É™ÁßíÔºâ

        // „Éó„É¨„Ç§„É§„Éº
        const player = {
            x: 3,
            y: 3,
            direction: 'down',
            moving: false,
            moveDelay: 120,
            hp: 50,
            maxHp: 50,
            mp: 20,
            maxMp: 20,
            baseAtk: 10,  // „Å°„Åã„ÇâÔºàÂü∫Á§éÊîªÊíÉÂäõÔºâ
            baseDef: 5,   // „Åø„ÅÆ„Åæ„ÇÇ„ÇäÔºàÂü∫Á§éÈò≤Âæ°ÂäõÔºâ
            speed: 6,
            level: 1,
            exp: 0,
            gold: 0,
            inventory: [],
            spells: ['hoimi', 'mera'],
            job: 'hero',  // Â∞ÜÊù•„ÅÆ„Éë„Éº„ÉÜ„Ç£„Ç∑„Çπ„ÉÜ„É†Áî®
            equipment: {
                weapon: 10,  // „Åì„Çì„Åº„ÅÜÔºàÂàùÊúüË£ÖÂÇôÔºâ
                armor: 20    // „Åü„Å≥„Å≥„Å®„ÅÆ„Åµ„ÅèÔºàÂàùÊúüË£ÖÂÇôÔºâ
            },
            // Ë®àÁÆóÊ∏à„Åø„Çπ„ÉÜ„Éº„Çø„ÇπÔºàupdateActualStats„ÅßÊõ¥Êñ∞Ôºâ
            actualAtk: 12,
            actualDef: 6,
            // Áä∂ÊÖãÁï∞Â∏∏ÔºàÊÆã„Çä„Çø„Éº„É≥Êï∞„ÄÅ0„Å™„ÇâÊ≠£Â∏∏Ôºâ
            status: {
                sleep: 0,
                poison: 0,
                blind: 0
            }
        };

        // Ë£ÖÂÇôËæº„Åø„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®àÁÆó„Åó„Å¶Êõ¥Êñ∞
        function updateActualStats() {
            const weapon = items[player.equipment.weapon];
            const armor = items[player.equipment.armor];
            player.actualAtk = player.baseAtk + (weapon ? weapon.value : 0);
            player.actualDef = player.baseDef + (armor ? armor.value : 0);
        }

        // Ë£ÖÂÇôËæº„Åø„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèñÂæó
        function getPlayerAtk() {
            return player.actualAtk;
        }

        function getPlayerDef() {
            return player.actualDef;
        }

        // ========================================
        // Áä∂ÊÖãÁï∞Â∏∏„Ç∑„Çπ„ÉÜ„É†
        // ========================================

        // Áä∂ÊÖãÁï∞Â∏∏„Çí‰ªò‰∏é
        function applyStatusEffect(target, effect) {
            if (effect === 'sleep') {
                const duration = STATUS_EFFECTS.sleep.duration;
                target.status.sleep = duration.min + Math.floor(Math.random() * (duration.max - duration.min + 1));
                return true;
            } else if (effect === 'poison') {
                target.status.poison = 99; // ÊØí„ÅØÊà¶ÈóòÁµÇ‰∫Ü„Åæ„ÅßÁ∂ôÁ∂ö
                return true;
            } else if (effect === 'blind') {
                target.status.blind = 99; // ÂπªÊÉë„ÅØÊà¶ÈóòÁµÇ‰∫Ü„Åæ„ÅßÁ∂ôÁ∂ö
                return true;
            }
            return false;
        }

        // Áä∂ÊÖãÁï∞Â∏∏„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
        function getStatusIcons(target) {
            let icons = '';
            if (target.status.sleep > 0) icons += STATUS_EFFECTS.sleep.icon;
            if (target.status.poison > 0) icons += STATUS_EFFECTS.poison.icon;
            if (target.status.blind > 0) icons += STATUS_EFFECTS.blind.icon;
            return icons;
        }

        // „Éê„ÉÉ„Ç∏ÂΩ¢Âºè„ÅÆÁä∂ÊÖãÁï∞Â∏∏Ë°®Á§∫Ôºà„ÄåÁú†„Äç„ÄåÊØí„Äç„Å™„Å©Ôºâ
        function getStatusBadges(target) {
            let badges = [];
            if (target.status.sleep > 0) badges.push(STATUS_EFFECTS.sleep.badge);
            if (target.status.poison > 0) badges.push(STATUS_EFFECTS.poison.badge);
            if (target.status.blind > 0) badges.push(STATUS_EFFECTS.blind.badge);
            return badges.length > 0 ? 'Ôºà' + badges.join('') + 'Ôºâ' : '';
        }

        // Áú†„Çä„Åã„ÇâËµ∑„Åç„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çø„Éº„É≥ÈñãÂßãÊôÇÔºâ
        function checkWakeUp(target, name) {
            if (target.status.sleep > 0) {
                target.status.sleep--;
                if (target.status.sleep <= 0) {
                    return { awake: true, message: `${name} „ÅØ „ÇÅ„Çí„Åï„Åæ„Åó„ÅüÔºÅ` };
                } else {
                    return { awake: false, message: `${name} „ÅØ „Å≠„ÇÄ„Å£„Å¶„ÅÑ„Çã...` };
                }
            }
            return { awake: true, message: null };
        }

        // ÊØí„ÉÄ„É°„Éº„Ç∏„ÇíÂá¶ÁêÜÔºà„Çø„Éº„É≥ÁµÇ‰∫ÜÊôÇÔºâ
        function processPoisonDamage(target, name, maxHp) {
            if (target.status.poison > 0) {
                const damage = Math.max(1, Math.floor(maxHp * STATUS_EFFECTS.poison.damageRate));
                target.hp = Math.max(1, target.hp - damage); // ÊØí„Åß„ÅØÊ≠ª„Å™„Å™„ÅÑ
                return { damage, message: `${name} „ÅØ „Å©„Åè„ÅÆ „ÉÄ„É°„Éº„Ç∏„Çí „ÅÜ„Åë„ÅüÔºÅÔºà${damage}Ôºâ` };
            }
            return null;
        }

        // ÊîªÊíÉÂëΩ‰∏≠Áéá„ÇíÂèñÂæóÔºàÂπªÊÉëËÄÉÊÖÆÔºâ
        function getHitRate(attacker) {
            const baseRate = 0.9; // ÈÄöÂ∏∏90%
            if (attacker.status && attacker.status.blind > 0) {
                return baseRate * STATUS_EFFECTS.blind.hitRateModifier;
            }
            return baseRate;
        }

        // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Å´ÂøÖË¶Å„Å™ÁµåÈ®ìÂÄ§ÔºàÊåáÊï∞Èñ¢Êï∞ÁöÑÂ¢óÂä†Ôºâ
        // Ë®àÁÆóÂºè: Math.floor(10 * Math.pow(2.5, level-1))
        function getExpForLevel(level) {
            if (level <= 1) return 0;
            return Math.floor(10 * Math.pow(2.5, level - 2));
        }

        // „É¨„Éô„É´1-10„ÅÆÂøÖË¶ÅÁµåÈ®ìÂÄ§„ÉÜ„Éº„Éñ„É´ÔºàÁ¥ØÁ©çÔºâ
        const expTable = [];
        let totalExp = 0;
        for (let i = 0; i <= 10; i++) {
            expTable[i] = totalExp;
            totalExp += getExpForLevel(i + 1);
        }
        // expTable = [0, 0, 10, 35, 97, 253, 643, 1618, 4056, 10150, 25386]

        // ‰ºöË©±Áä∂ÊÖã
        const dialog = {
            active: false,
            messages: [],
            currentIndex: 0,
            displayedText: '',
            charIndex: 0,
            isTyping: false,
            typingSpeed: 50
        };

        // „É°„Éã„É•„ÉºÁä∂ÊÖã
        const menu = {
            active: false,
            selectedIndex: 0,
            mode: 'status', // 'status' or 'items'
            itemCursor: 0,  // „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà‰∏ä„ÅÆ„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ
            showItemAction: false, // „Ç¢„Ç§„ÉÜ„É†„Ç¢„ÇØ„Ç∑„Éß„É≥„Çµ„Éñ„É°„Éã„É•„ÉºË°®Á§∫
            itemActionIndex: 0 // 0: „Å§„Åã„ÅÜ/„Åù„ÅÜ„Å≥„Åô„Çã, 1: „Åô„Å¶„Çã, 2: „ÇÑ„ÇÅ„Çã
        };

        // ÂÆøÂ±ãÁä∂ÊÖã
        const inn = {
            active: false,
            cost: 0,
            selectedIndex: 0 // 0: „ÅØ„ÅÑ, 1: „ÅÑ„ÅÑ„Åà
        };

        // „Ç∑„Éß„ÉÉ„ÉóÁä∂ÊÖã
        const shop = {
            active: false,
            mode: 'menu',  // 'menu', 'buy', 'sell'
            phase: 'list', // 'list', 'confirm', 'equip', 'sold'
            menuIndex: 0,  // 0: „Åã„ÅÜ, 1: „ÅÜ„Çã, 2: „ÇÑ„ÇÅ„Çã
            selectedIndex: 0,
            confirmIndex: 0, // 0: „ÅØ„ÅÑ, 1: „ÅÑ„ÅÑ„Åà
            equipIndex: 0,   // 0: „ÅØ„ÅÑ, 1: „ÅÑ„ÅÑ„Åà
            selectedItem: null,
            sellableItems: [] // Â£≤Âç¥ÂèØËÉΩ„Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà
        };

        // „Éê„Éà„É´Áä∂ÊÖã
        const battle = {
            active: false,
            enemy: null,
            phase: 'start', // start, command, playerTurn, enemyTurn, result
            commandIndex: 0,
            spellIndex: 0,
            showSpells: false,
            message: '',
            messageQueue: [],
            animationFrame: 0,
            flashCount: 0,
            result: null // 'win', 'lose', 'escape'
        };

        // ========================================
        // Canvas & „Ç´„É°„É©
        // ========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const fadeOverlay = document.getElementById('fadeOverlay');
        const mapNameElement = document.getElementById('mapName');

        let tileSize = 32;
        let cameraX = 0;
        let cameraY = 0;
        let canvasWidth = 0;
        let canvasHeight = 0;

        function resize() {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            tileSize = Math.floor(canvasWidth / VISIBLE_TILES);
            updateCamera();
        }

        function updateCamera() {
            cameraX = player.x * tileSize - canvasWidth / 2 + tileSize / 2;
            cameraY = player.y * tileSize - canvasHeight / 2 + tileSize / 2;
            const mapPixelWidth = currentMap.cols * tileSize;
            const mapPixelHeight = currentMap.rows * tileSize;
            cameraX = Math.max(0, Math.min(cameraX, mapPixelWidth - canvasWidth));
            cameraY = Math.max(0, Math.min(cameraY, mapPixelHeight - canvasHeight));
        }

        // ========================================
        // „Çª„Éº„Éñ/„É≠„Éº„Éâ
        // ========================================
        function saveGame() {
            const chestStates = {};
            for (const mapId in maps) {
                if (maps[mapId].chests) {
                    chestStates[mapId] = maps[mapId].chests.map(c => ({ id: c.id, isOpened: c.isOpened }));
                }
            }

            const saveData = {
                player: {
                    x: player.x, y: player.y, direction: player.direction,
                    hp: player.hp, maxHp: player.maxHp, mp: player.mp, maxMp: player.maxMp,
                    baseAtk: player.baseAtk, baseDef: player.baseDef, speed: player.speed,
                    level: player.level, exp: player.exp, gold: player.gold,
                    inventory: player.inventory, spells: player.spells,
                    equipment: player.equipment  // Êñ∞ÂΩ¢Âºè
                },
                currentMapId: currentMapId,
                currentMapPath: currentMapPath,  // „Éû„É´„ÉÅ„Éû„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†Áî®
                chestStates: chestStates,
                gameCleared: gameCleared  // È≠îÁéãË®é‰ºê„Éï„É©„Ç∞
            };

            try {
                localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
            } catch (e) {
                console.error('„Çª„Éº„Éñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', e);
            }
        }

        async function loadGame() {
            try {
                const savedData = localStorage.getItem(SAVE_KEY);
                if (!savedData) return false;

                const data = JSON.parse(savedData);

                // Êóß„Çª„Éº„Éñ„Éá„Éº„Çø„Å®„ÅÆ‰∫íÊèõÊÄßÔºàatk/def„ÇíbaseAtk/baseDef„Å´Â§âÊèõÔºâ
                if (data.player.atk !== undefined && data.player.baseAtk === undefined) {
                    data.player.baseAtk = data.player.atk;
                    delete data.player.atk;
                }
                if (data.player.def !== undefined && data.player.baseDef === undefined) {
                    data.player.baseDef = data.player.def;
                    delete data.player.def;
                }

                // ÊóßË£ÖÂÇôÂΩ¢Âºè„Åã„Çâ„ÅÆÂ§âÊèõÔºàequippedWeapon/equippedArmor ‚Üí equipmentÔºâ
                if (data.player.equipment === undefined) {
                    data.player.equipment = {
                        weapon: data.player.equippedWeapon || 10,  // „Åì„Çì„Åº„ÅÜ
                        armor: data.player.equippedArmor || 20     // „Åü„Å≥„Å≥„Å®„ÅÆ„Åµ„Åè
                    };
                    delete data.player.equippedWeapon;
                    delete data.player.equippedArmor;
                }

                Object.assign(player, data.player);
                currentMapId = data.currentMapId;

                // „Éû„ÉÉ„Éó„Éë„Çπ„ÅÆË™≠„ÅøËæº„ÅøÔºàÊñ∞ÂΩ¢ÂºèÂØæÂøúÔºâ
                if (data.currentMapPath) {
                    currentMapPath = data.currentMapPath;
                } else {
                    // Êóß„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆÂ†¥Âêà„ÅØID„Åã„Çâ„Éë„Çπ„ÇíÁîüÊàê
                    currentMapPath = `maps/${currentMapId}.json`;
                }

                // „Éû„ÉÉ„Éó„ÅÆË™≠„ÅøËæº„ÅøÔºàÂ§ñÈÉ®JSON„ÇíÂÑ™ÂÖà„Åó„Å¶„É≠„Éº„ÉâÔºâ
                try {
                    const mapData = await loadMapFromDatabase(currentMapPath);
                    // Â§ñÈÉ®JSON„Éû„ÉÉ„Éó„Åß„ÅÇ„Çã„Åì„Å®„Çí„Éû„Éº„ÇØ
                    mapData._isExternal = true;
                    currentMap = {
                        data: mapData.data.map(row => [...row]),
                        cols: mapData.cols,
                        rows: mapData.rows,
                        npcs: JSON.parse(JSON.stringify(mapData.npcs || [])),
                        chests: JSON.parse(JSON.stringify(mapData.chests || [])),
                        warps: mapData.warps ? [...mapData.warps] : [],
                        name: mapData.name,
                        type: mapData.type,
                        encounterRate: mapData.encounterRate,
                        mapId: mapData.mapId,
                        _isExternal: true
                    };
                    maps[mapData.mapId] = mapData;
                    currentMapId = mapData.mapId;
                } catch (err) {
                    console.error('„Éû„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº„ÄÅÂÜÖËîµ„Éû„ÉÉ„Éó„Çí‰ΩøÁî®:', err);
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂÜÖËîµ„Éû„ÉÉ„Éó„Çí‰ΩøÁî®
                    if (maps[currentMapId]) {
                        const sourceMap = maps[currentMapId];
                        currentMap = {
                            data: sourceMap.data.map(row => [...row]),
                            cols: sourceMap.cols,
                            rows: sourceMap.rows,
                            npcs: JSON.parse(JSON.stringify(sourceMap.npcs || [])),
                            chests: JSON.parse(JSON.stringify(sourceMap.chests || [])),
                            warps: sourceMap.warps ? [...sourceMap.warps] : [],
                            name: sourceMap.name,
                            type: sourceMap.type,
                            encounterRate: sourceMap.encounterRate
                        };
                    } else {
                        const fieldMap = maps['field'];
                        currentMap = {
                            data: fieldMap.data.map(row => [...row]),
                            cols: fieldMap.cols,
                            rows: fieldMap.rows,
                            npcs: JSON.parse(JSON.stringify(fieldMap.npcs || [])),
                            chests: JSON.parse(JSON.stringify(fieldMap.chests || [])),
                            warps: fieldMap.warps ? [...fieldMap.warps] : [],
                            name: fieldMap.name,
                            type: fieldMap.type,
                            encounterRate: fieldMap.encounterRate
                        };
                        currentMapId = 'field';
                    }
                }
                mapNameElement.textContent = currentMap.name;

                if (data.chestStates) {
                    for (const mapId in data.chestStates) {
                        if (maps[mapId] && maps[mapId].chests) {
                            for (const savedChest of data.chestStates[mapId]) {
                                const chest = maps[mapId].chests.find(c => c.id === savedChest.id);
                                if (chest) chest.isOpened = savedChest.isOpened;
                            }
                        }
                    }
                }

                // È≠îÁéãË®é‰ºê„Éï„É©„Ç∞„ÅÆË™≠„ÅøËæº„Åø
                if (data.gameCleared !== undefined) {
                    gameCleared = data.gameCleared;
                }

                // „É≠„Éº„ÉâÂæå„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂÜçË®àÁÆó
                updateActualStats();
                return true;
            } catch (e) {
                console.error('„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', e);
                return false;
            }
        }

        // ========================================
        // ÊèèÁîªÈñ¢Êï∞
        // ========================================
        function getTileColor(tile) {
            const mapColors = MAP_TILE_COLORS[currentMap.type];
            if (mapColors && mapColors[tile] !== undefined) return mapColors[tile];
            return DEFAULT_TILE_COLORS[tile] || '#333';
        }

        let drawMapDebugCount = 0;
        function drawMap() {
            if (drawMapDebugCount < 3) {
                console.log('[DEBUG drawMap] tileSize:', tileSize, 'cameraX:', cameraX, 'cameraY:', cameraY);
                console.log('[DEBUG drawMap] currentMap.cols:', currentMap.cols, 'currentMap.rows:', currentMap.rows);
                drawMapDebugCount++;
            }

            // tileSize„Åå0„ÅÆÂ†¥Âêà„ÅØÊèèÁîª„Åó„Å™„ÅÑ
            if (tileSize <= 0) {
                console.warn('[DEBUG drawMap] tileSize is 0 or negative!');
                return;
            }

            const startCol = Math.floor(cameraX / tileSize);
            const startRow = Math.floor(cameraY / tileSize);
            const endCol = Math.min(currentMap.cols, startCol + Math.ceil(canvasWidth / tileSize) + 2);
            const endRow = Math.min(currentMap.rows, startRow + Math.ceil(canvasHeight / tileSize) + 2);

            for (let row = Math.max(0, startRow); row < endRow; row++) {
                for (let col = Math.max(0, startCol); col < endCol; col++) {
                    const tile = currentMap.data[row][col];
                    const screenX = col * tileSize - cameraX;
                    const screenY = row * tileSize - cameraY;
                    ctx.fillStyle = getTileColor(tile);
                    ctx.fillRect(screenX, screenY, tileSize + 1, tileSize + 1);
                    drawTileDecoration(tile, screenX, screenY, col, row);
                }
            }
        }

        function drawTileDecoration(tile, x, y, col, row) {
            ctx.save();
            ctx.font = `${tileSize * 0.7}px serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            if (tile === TILE.GRASS) {
                const seed = (col * 7 + row * 13) % 100;
                if (seed < 25) {
                    ctx.font = `${tileSize * 0.3}px serif`;
                    ctx.fillText('üåø', x + tileSize * 0.5, y + tileSize * 0.5);
                }
            } else if (tile === TILE.MOUNTAIN) {
                ctx.fillText('‚õ∞Ô∏è', x + tileSize / 2, y + tileSize / 2);
            } else if (tile === TILE.SEA) {
                ctx.strokeStyle = 'rgba(100, 180, 255, 0.4)';
                ctx.lineWidth = 2;
                const waveOffset = (Date.now() / 500) % (Math.PI * 2);
                for (let i = 0; i < 3; i++) {
                    const waveY = y + tileSize * (0.3 + i * 0.25);
                    ctx.beginPath();
                    ctx.moveTo(x, waveY);
                    for (let wx = 0; wx <= tileSize; wx += 4) {
                        ctx.lineTo(x + wx, waveY + Math.sin(waveOffset + wx * 0.1 + i) * 2);
                    }
                    ctx.stroke();
                }
            } else if (tile === TILE.CASTLE) {
                ctx.fillText('üè∞', x + tileSize / 2, y + tileSize / 2);
            } else if (tile === TILE.TOWN) {
                ctx.fillText('üèòÔ∏è', x + tileSize / 2, y + tileSize / 2);
            } else if (tile === TILE.STAIRS) {
                ctx.fillText('ü™ú', x + tileSize / 2, y + tileSize / 2);
            } else if (tile === TILE.FLOOR) {
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.15)';
                ctx.strokeRect(x + 2, y + 2, tileSize - 4, tileSize - 4);
            } else if (tile === TILE.WALL) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(x, y + tileSize - 4, tileSize, 4);
            }
            ctx.restore();
        }

        function drawChests() {
            if (!currentMap.chests) return;
            for (const chest of currentMap.chests) {
                const screenX = chest.x * tileSize - cameraX;
                const screenY = chest.y * tileSize - cameraY;
                if (screenX < -tileSize || screenX > canvasWidth || screenY < -tileSize || screenY > canvasHeight) continue;
                ctx.font = `${tileSize * 0.7}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(chest.isOpened ? 'üì¶' : 'üéÅ', screenX + tileSize / 2, screenY + tileSize / 2);
            }
        }

        function drawNPCs() {
            if (!currentMap.npcs) return;
            for (const npc of currentMap.npcs) {
                const screenX = npc.x * tileSize - cameraX;
                const screenY = npc.y * tileSize - cameraY;
                if (screenX < -tileSize || screenX > canvasWidth || screenY < -tileSize || screenY > canvasHeight) continue;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.ellipse(screenX + tileSize / 2, screenY + tileSize * 0.9, tileSize * 0.3, tileSize * 0.1, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = `${tileSize * 0.7}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(npc.sprite, screenX + tileSize / 2, screenY + tileSize / 2);
            }
        }

        function drawPlayer() {
            const screenX = player.x * tileSize - cameraX;
            const screenY = player.y * tileSize - cameraY;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.ellipse(screenX + tileSize / 2, screenY + tileSize * 0.9, tileSize * 0.35, tileSize * 0.12, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#ffcc00';
            ctx.fillRect(screenX + tileSize * 0.25, screenY + tileSize * 0.2, tileSize * 0.5, tileSize * 0.6);
            ctx.fillStyle = '#000';
            if (player.direction !== 'up') {
                ctx.fillRect(screenX + tileSize * 0.35, screenY + tileSize * 0.35, tileSize * 0.08, tileSize * 0.08);
                ctx.fillRect(screenX + tileSize * 0.55, screenY + tileSize * 0.35, tileSize * 0.08, tileSize * 0.08);
            }
            ctx.font = `${tileSize * 0.4}px serif`;
            ctx.textAlign = 'center';
            ctx.fillText('‚öîÔ∏è', screenX + tileSize / 2, screenY + tileSize * 0.15);
        }

        function drawMessageWindow() {
            if (!dialog.active) return;
            const padding = 20;
            const windowHeight = tileSize * 2.5;
            const windowY = canvasHeight - windowHeight - 180;
            const windowX = padding;
            const windowWidth = canvasWidth - padding * 2;

            drawWindow(windowX, windowY, windowWidth, windowHeight);

            ctx.fillStyle = '#fff';
            ctx.font = `${Math.floor(tileSize * 0.45)}px 'MS Gothic', monospace`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(dialog.displayedText, windowX + 20, windowY + 20);

            if (!dialog.isTyping && dialog.currentIndex < dialog.messages.length - 1) {
                const blinkAlpha = Math.sin(Date.now() / 200) * 0.5 + 0.5;
                ctx.fillStyle = `rgba(255, 255, 255, ${blinkAlpha})`;
                ctx.font = `${tileSize * 0.4}px serif`;
                ctx.textAlign = 'right';
                ctx.fillText('‚ñº', windowX + windowWidth - 20, windowY + windowHeight - 25);
            }
        }

        function drawWindow(x, y, w, h) {
            ctx.fillStyle = 'rgba(0, 0, 50, 0.95)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.strokeRect(x + 2, y + 2, w - 4, h - 4);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.strokeRect(x + 8, y + 8, w - 16, h - 16);
        }

        function drawMenu() {
            if (!menu.active) return;
            const menuWidth = canvasWidth * 0.85;
            const menuHeight = canvasHeight * 0.75;
            const menuX = (canvasWidth - menuWidth) / 2;
            const menuY = (canvasHeight - menuHeight) / 2;

            drawWindow(menuX, menuY, menuWidth, menuHeight);

            // „Çø„ÉñË°®Á§∫
            const tabY = menuY + 10;
            ctx.font = `${tileSize * 0.4}px 'MS Gothic', monospace`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            // „Å§„Çà„Åï„Çø„Éñ
            ctx.fillStyle = menu.mode === 'status' ? '#ffd700' : 'rgba(255, 255, 255, 0.5)';
            ctx.fillText('„Å§„Çà„Åï', menuX + menuWidth * 0.25, tabY);

            // „ÇÇ„Å°„ÇÇ„ÅÆ„Çø„Éñ
            ctx.fillStyle = menu.mode === 'items' ? '#ffd700' : 'rgba(255, 255, 255, 0.5)';
            ctx.fillText('„ÇÇ„Å°„ÇÇ„ÅÆ', menuX + menuWidth * 0.75, tabY);

            // Âå∫Âàá„ÇäÁ∑ö
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.moveTo(menuX + 15, tabY + tileSize * 0.5);
            ctx.lineTo(menuX + menuWidth - 15, tabY + tileSize * 0.5);
            ctx.stroke();

            const contentY = tabY + tileSize * 0.7;
            const lineHeight = tileSize * 0.5;

            if (menu.mode === 'status') {
                // „Å§„Çà„ÅïÔºà„Çπ„ÉÜ„Éº„Çø„ÇπÁîªÈù¢Ôºâ
                ctx.fillStyle = '#fff';
                ctx.font = `${tileSize * 0.4}px 'MS Gothic', monospace`;
                ctx.textAlign = 'left';

                const col1X = menuX + 20;
                const col2X = menuX + menuWidth * 0.55;
                let y = contentY + 10;

                ctx.fillStyle = '#ffd700';
                ctx.fillText('„ÇÜ„ÅÜ„Åó„ÇÉ', col1X, y);
                ctx.fillStyle = '#fff';
                ctx.fillText(`Lv ${player.level}`, col2X, y);
                y += lineHeight * 1.3;

                ctx.fillText(`HP`, col1X, y);
                ctx.fillText(`${player.hp} / ${player.maxHp}`, col2X, y);
                y += lineHeight;

                ctx.fillText(`MP`, col1X, y);
                ctx.fillText(`${player.mp} / ${player.maxMp}`, col2X, y);
                y += lineHeight * 1.3;

                ctx.fillText(`„Å°„Åã„Çâ`, col1X, y);
                ctx.fillText(`${player.baseAtk}`, col2X, y);
                y += lineHeight;

                ctx.fillText(`„Åø„ÅÆ„Åæ„ÇÇ„Çä`, col1X, y);
                ctx.fillText(`${player.baseDef}`, col2X, y);
                y += lineHeight;

                ctx.fillText(`„Åô„Å∞„ÇÑ„Åï`, col1X, y);
                ctx.fillText(`${player.speed}`, col2X, y);
                y += lineHeight;

                // „Åì„ÅÜ„Åí„ÅçÂäõ„Éª„Åó„ÇÖ„Å≥ÂäõÔºàË£ÖÂÇôËæº„ÅøÔºâ
                ctx.fillStyle = '#4f4';
                ctx.fillText(`„Åì„ÅÜ„Åí„ÅçÂäõ`, col1X, y);
                ctx.fillText(`${getPlayerAtk()}`, col2X, y);
                y += lineHeight;

                ctx.fillText(`„Åó„ÇÖ„Å≥Âäõ`, col1X, y);
                ctx.fillText(`${getPlayerDef()}`, col2X, y);
                y += lineHeight * 0.8;

                ctx.fillText(`„Åë„ÅÑ„Åë„Çì„Å°`, col1X, y);
                ctx.fillText(`${player.exp}`, col2X, y);
                y += lineHeight;

                // Ê¨°„ÅÆ„É¨„Éô„É´„Åæ„Åß„ÅÆÁµåÈ®ìÂÄ§
                const nextLevelExp = player.level < expTable.length - 1 ? expTable[player.level + 1] : null;
                if (nextLevelExp !== null) {
                    const needed = nextLevelExp - player.exp;
                    ctx.fillText(`„Å§„Åé„ÅÆLv„Åæ„Åß`, col1X, y);
                    ctx.fillText(`„ÅÇ„Å® ${needed}`, col2X, y);
                } else {
                    ctx.fillText(`„Åï„ÅÑ„Å†„ÅÑ„É¨„Éô„É´`, col1X, y);
                }
                y += lineHeight * 1.3;

                ctx.fillStyle = '#ffd700';
                ctx.fillText(`„Ç¥„Éº„É´„Éâ`, col1X, y);
                ctx.fillStyle = '#fff';
                ctx.fillText(`${player.gold} G`, col2X, y);
                y += lineHeight * 1.5;

                // Ë£ÖÂÇôË°®Á§∫
                ctx.fillStyle = '#aaa';
                ctx.fillText('‚îÄ „Åù„ÅÜ„Å≥ ‚îÄ', col1X, y);
                y += lineHeight;

                const weapon = items[player.equipment.weapon];
                const armor = items[player.equipment.armor];
                ctx.fillStyle = '#fff';
                ctx.fillText(`‚öîÔ∏è E: ${weapon ? weapon.name : '„Å™„Åó'}`, col1X, y);
                y += lineHeight;
                ctx.fillText(`üõ°Ô∏è E: ${armor ? armor.name : '„Å™„Åó'}`, col1X, y);

            } else {
                // „ÇÇ„Å°„ÇÇ„ÅÆÔºà„Ç¢„Ç§„ÉÜ„É†ÁîªÈù¢Ôºâ
                ctx.fillStyle = '#fff';
                ctx.font = `${tileSize * 0.4}px 'MS Gothic', monospace`;
                ctx.textAlign = 'left';
                const itemStartY = contentY + 10;

                if (player.inventory.length === 0) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.textAlign = 'center';
                    ctx.fillText('„Ç¢„Ç§„ÉÜ„É†„ÇíÊåÅ„Å£„Å¶„ÅÑ„Å™„ÅÑ', canvasWidth / 2, itemStartY);
                } else {
                    player.inventory.forEach((itemId, i) => {
                        const item = items[itemId];
                        if (item) {
                            // ÈÅ∏Êäû‰∏≠„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅØ„Éè„Ç§„É©„Ç§„Éà
                            const isSelected = (i === menu.itemCursor);
                            ctx.fillStyle = isSelected ? '#ffd700' : '#fff';
                            const cursor = isSelected ? '‚ñ∂' : '„Éª';
                            ctx.fillText(`${cursor}${item.name}`, menuX + 30, itemStartY + i * lineHeight);

                            // Ë£ÖÂÇôÂìÅ„Å´„ÅØ„Çø„Ç§„ÉóË°®Á§∫
                            if (item.type === 'weapon') {
                                ctx.fillStyle = '#88f';
                                ctx.fillText('‚öîÔ∏è', menuX + menuWidth - 50, itemStartY + i * lineHeight);
                            } else if (item.type === 'armor') {
                                ctx.fillStyle = '#8f8';
                                ctx.fillText('üõ°Ô∏è', menuX + menuWidth - 50, itemStartY + i * lineHeight);
                            }
                        }
                    });

                    // „Ç¢„Ç§„ÉÜ„É†„Ç¢„ÇØ„Ç∑„Éß„É≥„Çµ„Éñ„É°„Éã„É•„Éº
                    if (menu.showItemAction && player.inventory.length > 0) {
                        const selectedItemId = player.inventory[menu.itemCursor];
                        const selectedItem = items[selectedItemId];
                        if (selectedItem) {
                            const subMenuWidth = tileSize * 3.5;
                            const subMenuHeight = tileSize * 2;
                            const subMenuX = menuX + menuWidth - subMenuWidth - 20;
                            const subMenuY = itemStartY + menu.itemCursor * lineHeight - 5;

                            drawWindow(subMenuX, subMenuY, subMenuWidth, subMenuHeight);

                            ctx.font = `${tileSize * 0.35}px 'MS Gothic', monospace`;
                            ctx.textAlign = 'left';

                            // „Ç¢„ÇØ„Ç∑„Éß„É≥ÈÅ∏ÊäûËÇ¢
                            let actions = [];
                            if (selectedItem.type === 'weapon' || selectedItem.type === 'armor') {
                                actions = ['„Åù„ÅÜ„Å≥„Åô„Çã', '„Åô„Å¶„Çã', '„ÇÑ„ÇÅ„Çã'];
                            } else {
                                actions = ['„Å§„Åã„ÅÜ', '„Åô„Å¶„Çã', '„ÇÑ„ÇÅ„Çã'];
                            }

                            actions.forEach((action, i) => {
                                const isActionSelected = (i === menu.itemActionIndex);
                                ctx.fillStyle = isActionSelected ? '#ffd700' : '#fff';
                                const actionCursor = isActionSelected ? '‚ñ∂' : ' ';
                                ctx.fillText(`${actionCursor}${action}`, subMenuX + 15, subMenuY + 20 + i * (tileSize * 0.45));
                            });
                        }
                    }
                }
            }

            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = `${tileSize * 0.3}px 'MS Gothic', monospace`;
            ctx.textAlign = 'center';
            if (menu.mode === 'items' && player.inventory.length > 0) {
                ctx.fillText('‚Üë‚ÜìÈÅ∏Êäû / AÊ±∫ÂÆö / BÊàª„Çã', canvasWidth / 2, menuY + menuHeight - 25);
            } else {
                ctx.fillText('‚Üê ‚Üí „Çø„ÉñÂàáÊõø / B„ÅßÈñâ„Åò„Çã', canvasWidth / 2, menuY + menuHeight - 25);
            }
        }

        function drawInn() {
            if (!inn.active) return;

            const windowWidth = canvasWidth * 0.8;
            const windowHeight = tileSize * 3.5;
            const windowX = (canvasWidth - windowWidth) / 2;
            const windowY = (canvasHeight - windowHeight) / 2;

            drawWindow(windowX, windowY, windowWidth, windowHeight);

            ctx.fillStyle = '#fff';
            ctx.font = `${tileSize * 0.45}px 'MS Gothic', monospace`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            ctx.fillText(`„Åä„Å®„Åæ„Çä„Åß„Åô„ÅãÔºüÔºà${inn.cost}„Ç¥„Éº„É´„ÉâÔºâ`, windowX + 20, windowY + 20);

            // ÈÅ∏ÊäûËÇ¢
            const choiceY = windowY + tileSize * 1.5;
            const choices = ['„ÅØ„ÅÑ', '„ÅÑ„ÅÑ„Åà'];

            choices.forEach((choice, i) => {
                const choiceX = windowX + 40 + i * tileSize * 2.5;
                if (i === inn.selectedIndex) {
                    ctx.fillStyle = '#ffd700';
                    ctx.fillText('‚ñ∂', choiceX - tileSize * 0.5, choiceY);
                }
                ctx.fillStyle = '#fff';
                ctx.fillText(choice, choiceX, choiceY);
            });

            // ÊâÄÊåÅÈáëË°®Á§∫
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = `${tileSize * 0.35}px 'MS Gothic', monospace`;
            ctx.fillText(`ÊâÄÊåÅÈáë: ${player.gold} G`, windowX + 20, windowY + windowHeight - tileSize * 0.6);
        }

        function drawShop() {
            if (!shop.active) return;

            const windowWidth = canvasWidth * 0.9;
            const windowHeight = canvasHeight * 0.75;
            const windowX = (canvasWidth - windowWidth) / 2;
            const windowY = (canvasHeight - windowHeight) / 2;

            drawWindow(windowX, windowY, windowWidth, windowHeight);

            ctx.fillStyle = '#ffd700';
            ctx.font = `${tileSize * 0.5}px 'MS Gothic', monospace`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText('‚öîÔ∏è „Å∂„Åç„Åº„ÅÜ„Åê„ÇÑ üõ°Ô∏è', canvasWidth / 2, windowY + 15);

            // ÊâÄÊåÅÈáëË°®Á§∫
            ctx.fillStyle = '#fff';
            ctx.font = `${tileSize * 0.35}px 'MS Gothic', monospace`;
            ctx.textAlign = 'right';
            ctx.fillText(`üí∞ ${player.gold} G`, windowX + windowWidth - 20, windowY + 15);

            const listY = windowY + tileSize * 1.2;
            const lineHeight = tileSize * 0.55;

            if (shop.mode === 'menu') {
                // „É°„Éã„É•„ÉºÈÅ∏Êäû
                ctx.font = `${tileSize * 0.45}px 'MS Gothic', monospace`;
                ctx.textAlign = 'left';
                const menuItems = ['„Åã„ÅÜ', '„ÅÜ„Çã', '„ÇÑ„ÇÅ„Çã'];
                menuItems.forEach((menuItem, i) => {
                    const y = listY + i * lineHeight * 1.5;
                    if (i === shop.menuIndex) {
                        ctx.fillStyle = '#ffd700';
                        ctx.fillText('‚ñ∂', windowX + 30, y);
                    }
                    ctx.fillStyle = '#fff';
                    ctx.fillText(menuItem, windowX + 60, y);
                });

            } else if (shop.mode === 'buy') {
                if (shop.phase === 'list') {
                    // Ë≥ºÂÖ•„É™„Çπ„Éà
                    ctx.font = `${tileSize * 0.4}px 'MS Gothic', monospace`;
                    ctx.textAlign = 'left';

                    shopItems.forEach((itemId, i) => {
                        const item = items[itemId];
                        const y = listY + i * lineHeight;

                        if (i === shop.selectedIndex) {
                            ctx.fillStyle = '#ffd700';
                            ctx.fillText('‚ñ∂', windowX + 15, y);
                        }

                        const icon = item.type === 'weapon' ? '‚öîÔ∏è' : 'üõ°Ô∏è';
                        ctx.fillStyle = player.gold >= item.price ? '#fff' : '#666';
                        ctx.fillText(`${icon} ${item.name}`, windowX + 40, y);
                        ctx.fillText(`${item.price} G`, windowX + windowWidth * 0.55, y);

                        if (i === shop.selectedIndex) {
                            const statChange = getStatChangePreview(item);
                            ctx.fillStyle = statChange > 0 ? '#4f4' : (statChange < 0 ? '#f44' : '#fff');
                            const sign = statChange > 0 ? '+' : '';
                            const statLabel = item.type === 'weapon' ? '„Åì„ÅÜ„Åí„Åç' : '„Åó„ÇÖ„Å≥';
                            ctx.fillText(`${statLabel} ${sign}${statChange}`, windowX + windowWidth * 0.78, y);
                        }
                    });

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.font = `${tileSize * 0.3}px 'MS Gothic', monospace`;
                    ctx.textAlign = 'center';
                    ctx.fillText('‚Üë‚Üì ÈÅ∏Êäû / A Ë≥ºÂÖ• / B Êàª„Çã', canvasWidth / 2, windowY + windowHeight - 25);

                } else if (shop.phase === 'confirm') {
                    const item = shop.selectedItem;
                    ctx.fillStyle = '#fff';
                    ctx.font = `${tileSize * 0.45}px 'MS Gothic', monospace`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${item.name} „Çí „Åã„ÅÑ„Åæ„Åô„ÅãÔºü`, windowX + 30, listY);
                    ctx.fillText(`Ôºà${item.price} „Ç¥„Éº„É´„ÉâÔºâ`, windowX + 30, listY + lineHeight);

                    const choiceY = listY + lineHeight * 3;
                    ['„ÅØ„ÅÑ', '„ÅÑ„ÅÑ„Åà'].forEach((choice, i) => {
                        const choiceX = windowX + 50 + i * tileSize * 2.5;
                        if (i === shop.confirmIndex) {
                            ctx.fillStyle = '#ffd700';
                            ctx.fillText('‚ñ∂', choiceX - tileSize * 0.5, choiceY);
                        }
                        ctx.fillStyle = '#fff';
                        ctx.fillText(choice, choiceX, choiceY);
                    });

                } else if (shop.phase === 'equip') {
                    const item = shop.selectedItem;
                    ctx.fillStyle = '#fff';
                    ctx.font = `${tileSize * 0.45}px 'MS Gothic', monospace`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${item.name} „Çí „Å¶„Å´„ÅÑ„Çå„ÅüÔºÅ`, windowX + 30, listY);
                    ctx.fillText('„Åù„ÅÜ„Å≥ „Åó„Åæ„Åô„ÅãÔºü', windowX + 30, listY + lineHeight);

                    const choiceY = listY + lineHeight * 3;
                    ['„ÅØ„ÅÑ', '„ÅÑ„ÅÑ„Åà'].forEach((choice, i) => {
                        const choiceX = windowX + 50 + i * tileSize * 2.5;
                        if (i === shop.equipIndex) {
                            ctx.fillStyle = '#ffd700';
                            ctx.fillText('‚ñ∂', choiceX - tileSize * 0.5, choiceY);
                        }
                        ctx.fillStyle = '#fff';
                        ctx.fillText(choice, choiceX, choiceY);
                    });
                }

            } else if (shop.mode === 'sell') {
                if (shop.phase === 'list') {
                    // Â£≤Âç¥„É™„Çπ„Éà
                    ctx.font = `${tileSize * 0.4}px 'MS Gothic', monospace`;
                    ctx.textAlign = 'left';

                    if (shop.sellableItems.length === 0) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.textAlign = 'center';
                        ctx.fillText('„ÅÜ„Çå„Çã„ÇÇ„ÅÆ„Åå „ÅÇ„Çä„Åæ„Åõ„Çì', canvasWidth / 2, listY + lineHeight);
                    } else {
                        shop.sellableItems.forEach((itemId, i) => {
                            const item = items[itemId];
                            const y = listY + i * lineHeight;
                            const sellPrice = Math.floor(item.price / 2);

                            if (i === shop.selectedIndex) {
                                ctx.fillStyle = '#ffd700';
                                ctx.fillText('‚ñ∂', windowX + 15, y);
                            }

                            const icon = item.type === 'weapon' ? '‚öîÔ∏è' : (item.type === 'armor' ? 'üõ°Ô∏è' : 'üì¶');
                            ctx.fillStyle = '#fff';
                            ctx.fillText(`${icon} ${item.name}`, windowX + 40, y);
                            ctx.fillText(`${sellPrice} G`, windowX + windowWidth * 0.65, y);
                        });
                    }

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.font = `${tileSize * 0.3}px 'MS Gothic', monospace`;
                    ctx.textAlign = 'center';
                    ctx.fillText('‚Üë‚Üì ÈÅ∏Êäû / A Â£≤Âç¥ / B Êàª„Çã', canvasWidth / 2, windowY + windowHeight - 25);

                } else if (shop.phase === 'confirm') {
                    const item = shop.selectedItem;
                    const sellPrice = Math.floor(item.price / 2);
                    ctx.fillStyle = '#fff';
                    ctx.font = `${tileSize * 0.45}px 'MS Gothic', monospace`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${item.name} „Çí „ÅÜ„Çä„Åæ„Åô„ÅãÔºü`, windowX + 30, listY);
                    ctx.fillText(`Ôºà${sellPrice} „Ç¥„Éº„É´„ÉâÔºâ`, windowX + 30, listY + lineHeight);

                    const choiceY = listY + lineHeight * 3;
                    ['„ÅØ„ÅÑ', '„ÅÑ„ÅÑ„Åà'].forEach((choice, i) => {
                        const choiceX = windowX + 50 + i * tileSize * 2.5;
                        if (i === shop.confirmIndex) {
                            ctx.fillStyle = '#ffd700';
                            ctx.fillText('‚ñ∂', choiceX - tileSize * 0.5, choiceY);
                        }
                        ctx.fillStyle = '#fff';
                        ctx.fillText(choice, choiceX, choiceY);
                    });

                } else if (shop.phase === 'sold') {
                    const item = shop.selectedItem;
                    const sellPrice = Math.floor(item.price / 2);
                    ctx.fillStyle = '#fff';
                    ctx.font = `${tileSize * 0.45}px 'MS Gothic', monospace`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${item.name} „Çí „ÅÜ„Çä„Åæ„Åó„ÅüÔºÅ`, windowX + 30, listY);
                    ctx.fillText(`${sellPrice} „Ç¥„Éº„É´„Éâ „Å¶„Å´„ÅÑ„Çå„ÅüÔºÅ`, windowX + 30, listY + lineHeight);
                }
            }
        }

        // Ë£ÖÂÇôÂ§âÊõ¥ÊôÇ„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÂåñ„Çí„Éó„É¨„Éì„É•„Éº
        function getStatChangePreview(item) {
            if (item.type === 'weapon') {
                const currentWeapon = items[player.equipment.weapon];
                const currentValue = currentWeapon ? currentWeapon.value : 0;
                return item.value - currentValue;
            } else if (item.type === 'armor') {
                const currentArmor = items[player.equipment.armor];
                const currentValue = currentArmor ? currentArmor.value : 0;
                return item.value - currentValue;
            }
            return 0;
        }

        // ========================================
        // „Éê„Éà„É´ÊèèÁîª
        // ========================================
        // Âë™Êñá„Éï„É©„ÉÉ„Ç∑„É•„ÇíÈñãÂßã
        function startSpellFlash(color) {
            spellFlash.active = true;
            spellFlash.color = color;
            spellFlash.alpha = 1.0;

            // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
            const fadeOut = () => {
                spellFlash.alpha -= 0.1;
                if (spellFlash.alpha <= 0) {
                    spellFlash.active = false;
                    spellFlash.alpha = 0;
                } else {
                    setTimeout(fadeOut, 50);
                }
            };
            setTimeout(fadeOut, 100);
        }

        function drawBattle() {
            // ËÉåÊôØ
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Êà¶ÈóòÈñãÂßã„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            if (battle.flashCount > 0) {
                const alpha = (battle.flashCount % 2 === 0) ? 0.8 : 0;
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                return;
            }

            // Âë™Êñá„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            if (spellFlash.active && spellFlash.alpha > 0) {
                // Ëâ≤„Çí„Éë„Éº„Çπ„Åó„Å¶„Ç¢„É´„Éï„Ç°ÂÄ§„ÇíÈÅ©Áî®
                const baseColor = spellFlash.color.replace(/[\d.]+\)$/, `${spellFlash.alpha})`);
                ctx.fillStyle = baseColor;
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            }

            // „É¢„É≥„Çπ„Çø„ÉºË°®Á§∫
            if (battle.enemy) {
                ctx.font = `${tileSize * 4}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // Ëâ≤ÈÅï„ÅÑ„É¢„É≥„Çπ„Çø„ÉºÂØæÂøúÔºàhueRotate„Éï„Ç£„É´„ÇøÔºâ
                if (battle.enemy.hueRotate) {
                    ctx.save();
                    ctx.filter = `hue-rotate(${battle.enemy.hueRotate}deg)`;
                    ctx.fillText(battle.enemy.sprite, canvasWidth / 2, canvasHeight * 0.35);
                    ctx.restore();
                } else {
                    ctx.fillText(battle.enemy.sprite, canvasWidth / 2, canvasHeight * 0.35);
                }

                // „É¢„É≥„Çπ„Çø„ÉºÂêç„Å®Áä∂ÊÖãÁï∞Â∏∏„Éê„ÉÉ„Ç∏
                ctx.fillStyle = '#fff';
                ctx.font = `${tileSize * 0.5}px 'MS Gothic', monospace`;
                ctx.fillText(battle.enemy.name, canvasWidth / 2, canvasHeight * 0.55);

                // Áä∂ÊÖãÁï∞Â∏∏„Éê„ÉÉ„Ç∏„ÇíÂêçÂâç„ÅÆ‰∏ã„Å´Ë°®Á§∫
                const enemyStatusBadge = getStatusBadges(battle.enemy);
                if (enemyStatusBadge) {
                    ctx.fillStyle = '#f88';
                    ctx.font = `${tileSize * 0.4}px 'MS Gothic', monospace`;
                    ctx.fillText(enemyStatusBadge, canvasWidth / 2, canvasHeight * 0.55 + tileSize * 0.5);
                }
            }

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Ç¶„Ç£„É≥„Éâ„Ç¶
            const statusW = canvasWidth * 0.5;
            const statusH = tileSize * 2.5;
            const statusX = 10;
            const statusY = 10;
            drawWindow(statusX, statusY, statusW, statusH);

            ctx.fillStyle = '#fff';
            ctx.font = `${tileSize * 0.4}px 'MS Gothic', monospace`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            // „Éó„É¨„Ç§„É§„ÉºÂêç„Å®Áä∂ÊÖãÁï∞Â∏∏„Éê„ÉÉ„Ç∏
            const playerStatusBadge = getStatusBadges(player);
            ctx.fillText(`„ÇÜ„ÅÜ„Åó„ÇÉ  Lv${player.level}`, statusX + 15, statusY + 15);
            if (playerStatusBadge) {
                ctx.fillStyle = '#f88';  // Áä∂ÊÖãÁï∞Â∏∏„ÅØËµ§Á≥ª„ÅßË°®Á§∫
                ctx.fillText(playerStatusBadge, statusX + statusW - 70, statusY + 15);
                ctx.fillStyle = '#fff';
            }
            ctx.fillText(`HP: ${player.hp}/${player.maxHp}`, statusX + 15, statusY + 15 + tileSize * 0.5);
            ctx.fillText(`MP: ${player.mp}/${player.maxMp}`, statusX + 15, statusY + 15 + tileSize * 1.0);

            // „É°„ÉÉ„Çª„Éº„Ç∏„Ç¶„Ç£„É≥„Éâ„Ç¶
            const msgH = tileSize * 2;
            const msgY = canvasHeight - msgH - 180;
            drawWindow(10, msgY, canvasWidth - 20, msgH);

            ctx.fillStyle = '#fff';
            ctx.font = `${tileSize * 0.45}px 'MS Gothic', monospace`;
            ctx.textAlign = 'left';
            ctx.fillText(battle.message, 30, msgY + 25);

            // „Ç≥„Éû„É≥„Éâ„Ç¶„Ç£„É≥„Éâ„Ç¶
            if (battle.phase === 'command') {
                const cmdW = canvasWidth * 0.45;
                const cmdH = tileSize * 3;
                const cmdX = canvasWidth - cmdW - 10;
                const cmdY = canvasHeight - cmdH - 10;
                drawWindow(cmdX, cmdY, cmdW, cmdH);

                const commands = ['„Åü„Åü„Åã„ÅÜ', '„Åò„ÇÖ„ÇÇ„Çì', '„Å´„Åí„Çã'];
                ctx.font = `${tileSize * 0.5}px 'MS Gothic', monospace`;

                commands.forEach((cmd, i) => {
                    const y = cmdY + 20 + i * tileSize * 0.7;
                    if (i === battle.commandIndex) {
                        ctx.fillStyle = '#ffd700';
                        ctx.fillText('‚ñ∂', cmdX + 15, y);
                    }
                    ctx.fillStyle = '#fff';
                    ctx.fillText(cmd, cmdX + 40, y);
                });

                // Âë™Êñá„Çµ„Éñ„É°„Éã„É•„Éº
                if (battle.showSpells) {
                    const spellW = cmdW * 1.1;
                    const spellH = Math.max(tileSize * 2.5, tileSize * 0.6 * player.spells.length + 30);
                    const spellX = cmdX - spellW - 10;
                    const spellY = cmdY;
                    drawWindow(spellX, spellY, spellW, spellH);

                    player.spells.forEach((spellId, i) => {
                        const spell = spells[spellId];
                        const y = spellY + 20 + i * tileSize * 0.6;
                        const canUse = player.mp >= spell.mp;

                        // ÈÅ∏Êäû„Ç´„Éº„ÇΩ„É´
                        if (i === battle.spellIndex) {
                            ctx.fillStyle = canUse ? '#ffd700' : '#888';
                            ctx.fillText('‚ñ∂', spellX + 10, y);
                        }

                        // Âë™ÊñáÂêç„Å®MPÔºàMP‰∏çË∂≥„ÅØ„Ç∞„É¨„Éº„Ç¢„Ç¶„ÉàÔºâ
                        ctx.fillStyle = canUse ? '#fff' : '#555';
                        ctx.font = `${tileSize * 0.4}px 'MS Gothic', monospace`;
                        ctx.fillText(`${spell.name}`, spellX + 30, y);

                        // MPÊ∂àË≤ªÈáè
                        ctx.fillStyle = canUse ? '#8cf' : '#444';
                        ctx.fillText(`${spell.mp}`, spellX + spellW - 40, y);
                    });

                    // Êìç‰Ωú„Ç¨„Ç§„Éâ
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = `${tileSize * 0.25}px 'MS Gothic', monospace`;
                    ctx.fillText('B:„ÇÇ„Å©„Çã', spellX + 10, spellY + spellH - 10);
                }
            }
        }

        // ========================================
        // „É°„Ç§„É≥ÊèèÁîª
        // ========================================
        let drawDebugCount = 0;
        function draw() {
            // „Çø„Ç§„Éà„É´ÁîªÈù¢‰∏≠„ÅØÊèèÁîª„Çí„Çπ„Ç≠„ÉÉ„Éó
            if (gameMode === MODE.TITLE) {
                return;
            }

            // „Éá„Éê„ÉÉ„Ç∞: ÊúÄÂàù„ÅÆÊï∞„Éï„É¨„Éº„É†„Å†„Åë„É≠„Ç∞Âá∫Âäõ
            if (drawDebugCount < 5) {
                console.log('[DEBUG draw] gameMode:', gameMode, 'tileSize:', tileSize, 'canvasWidth:', canvasWidth, 'currentMap.data:', !!currentMap.data);
                drawDebugCount++;
            }

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØÂá¶ÁêÜ
            let shakeX = 0, shakeY = 0;
            if (screenShake.active) {
                shakeX = (Math.random() - 0.5) * screenShake.intensity;
                shakeY = (Math.random() - 0.5) * screenShake.intensity;
                screenShake.duration--;
                if (screenShake.duration <= 0) {
                    screenShake.active = false;
                }
            }

            ctx.save();
            ctx.translate(shakeX, shakeY);

            if (gameMode === MODE.ENDING) {
                drawEnding();
            } else if (gameMode === MODE.BATTLE) {
                drawBattle();
            } else {
                drawMap();
                drawChests();
                drawNPCs();
                drawPlayer();
                drawMessageWindow();
                drawMenu();
                drawInn();
                drawShop();
            }

            ctx.restore();

            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÅÆ„Éï„Çß„Éº„ÉâÊèèÁîªÔºàrestoreÂæå„Å´ÊèèÁîªÔºâ
            if (endingState.fadeAlpha > 0 && endingState.phase !== 'staffroll' && endingState.phase !== 'theend' && endingState.phase !== 'none') {
                ctx.fillStyle = `rgba(0, 0, 0, ${endingState.fadeAlpha})`;
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            }
        }

        // ========================================
        // „Éê„Éà„É´„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        function startBattle(monsterType) {
            const monsterData = monsters[monsterType];
            battle.active = true;
            battle.enemy = {
                ...monsterData,
                currentHp: monsterData.hp,
                // Êïµ„ÅÆÁä∂ÊÖãÁï∞Â∏∏
                status: {
                    sleep: 0,
                    poison: 0,
                    blind: 0
                }
            };
            battle.phase = 'start';
            battle.commandIndex = 0;
            battle.spellIndex = 0;
            battle.showSpells = false;
            battle.message = '';
            battle.messageQueue = [];
            battle.result = null;
            battle.flashCount = 6;

            // „Éó„É¨„Ç§„É§„Éº„ÅÆÁä∂ÊÖãÁï∞Â∏∏„Çí„É™„Çª„ÉÉ„ÉàÔºàÊà¶Èóò„Åî„Å®„Å´„É™„Çª„ÉÉ„ÉàÔºâ
            player.status = { sleep: 0, poison: 0, blind: 0 };

            gameMode = MODE.BATTLE;

            // „Éï„É©„ÉÉ„Ç∑„É•„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            const flashInterval = setInterval(() => {
                battle.flashCount--;
                if (battle.flashCount <= 0) {
                    clearInterval(flashInterval);
                    showBattleMessage(`${battle.enemy.name} „Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`, () => {
                        battle.phase = 'command';
                    });
                }
            }, 100);
        }

        function showBattleMessage(msg, callback) {
            battle.message = msg;
            setTimeout(() => {
                if (callback) callback();
            }, 1000);
        }

        // Êïµ„ÅÆËÄêÊÄß„ÇíËÄÉÊÖÆ„Åó„ÅüÊàêÂäüÁéá„ÇíË®àÁÆó
        function getEffectiveSuccessRate(spell, enemy) {
            const baseRate = spell.successRate;
            const resistance = enemy.resistances ? enemy.resistances[spell.statusEffect] : 1.0;
            return baseRate * resistance;
        }

        function executeBattleCommand() {
            if (battle.showSpells) {
                // Âë™ÊñáÂÆüË°å
                const spell = spells[player.spells[battle.spellIndex]];
                if (player.mp < spell.mp) {
                    showBattleMessage('MP„Åå „Åü„Çä„Å™„ÅÑÔºÅ', () => {
                        battle.phase = 'command';
                    });
                    return;
                }

                player.mp -= spell.mp;
                battle.showSpells = false;
                battle.phase = 'playerTurn';

                // „Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫„ÇíÈñãÂßã
                if (spell.flashColor) {
                    startSpellFlash(spell.flashColor);
                }

                showBattleMessage(`„ÇÜ„ÅÜ„Åó„ÇÉ „ÅØ ${spell.name} „Çí „Å®„Å™„Åà„ÅüÔºÅ`, () => {
                    if (spell.type === 'heal') {
                        const healAmount = spell.power;
                        player.hp = Math.min(player.maxHp, player.hp + healAmount);
                        showBattleMessage(`HP„Åå ${healAmount} „Åã„ÅÑ„Åµ„Åè„Åó„ÅüÔºÅ`, () => {
                            processTurnEnd();
                        });
                    } else if (spell.type === 'attack') {
                        const damage = spell.power + Math.floor(Math.random() * 5);
                        battle.enemy.currentHp -= damage;
                        showBattleMessage(`${battle.enemy.name} „Å´ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                            checkBattleEnd() || processTurnEnd();
                        });
                    } else if (spell.type === 'status') {
                        // Áä∂ÊÖãÁï∞Â∏∏Âë™Êñá
                        // Êó¢„Å´„Åù„ÅÆÁä∂ÊÖãÁï∞Â∏∏„Å´„Åã„Åã„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
                        if (battle.enemy.status[spell.statusEffect] > 0) {
                            showBattleMessage(`„Åó„Åã„Åó ${battle.enemy.name} „Å´„ÅØ „Åç„Åã„Å™„Åã„Å£„ÅüÔºÅ`, () => {
                                processTurnEnd();
                            });
                        } else {
                            // ËÄêÊÄß„ÇíËÄÉÊÖÆ„Åó„ÅüÊàêÂäüÁéá
                            const effectiveRate = getEffectiveSuccessRate(spell, battle.enemy);
                            if (effectiveRate <= 0) {
                                // ÂÆåÂÖ®ËÄêÊÄß
                                showBattleMessage(`„Åó„Åã„Åó ${battle.enemy.name} „Å´„ÅØ „Åæ„Å£„Åü„Åè „Åç„Åã„Å™„Åã„Å£„ÅüÔºÅ`, () => {
                                    processTurnEnd();
                                });
                            } else if (Math.random() < effectiveRate) {
                                // ÊàêÂäü
                                applyStatusEffect(battle.enemy, spell.statusEffect);
                                let successMsg = '';
                                if (spell.statusEffect === 'sleep') {
                                    successMsg = `${battle.enemy.name} „ÅØ „Å≠„ÇÄ„Çä„Å´„Åä„Å°„ÅüÔºÅ`;
                                } else if (spell.statusEffect === 'blind') {
                                    successMsg = `${battle.enemy.name} „ÅØ „Åæ„Åº„Çç„Åó„Å´ „Å§„Å§„Åæ„Çå„ÅüÔºÅ`;
                                } else {
                                    const effectName = STATUS_EFFECTS[spell.statusEffect].name;
                                    successMsg = `${battle.enemy.name} „ÅØ ${effectName}Áä∂ÊÖã„Å´ „Å™„Å£„ÅüÔºÅ`;
                                }
                                showBattleMessage(successMsg, () => {
                                    processTurnEnd();
                                });
                            } else {
                                // Â§±ÊïóÔºàËÄêÊÄß„ÅßÂºæ„Åã„Çå„ÅüÔºâ
                                showBattleMessage(`„Åó„Åã„Åó ${battle.enemy.name} „Å´„ÅØ „Åç„Åã„Å™„Åã„Å£„ÅüÔºÅ`, () => {
                                    processTurnEnd();
                                });
                            }
                        }
                    }
                });
            } else {
                switch (battle.commandIndex) {
                    case 0: // „Åü„Åü„Åã„ÅÜ
                        playerAttack();
                        break;
                    case 1: // „Åò„ÇÖ„ÇÇ„Çì
                        battle.showSpells = true;
                        battle.spellIndex = 0;
                        break;
                    case 2: // „Å´„Åí„Çã
                        tryEscape();
                        break;
                }
            }
        }

        // „Çø„Éº„É≥ÁµÇ‰∫ÜÂá¶ÁêÜÔºàÊØí„ÉÄ„É°„Éº„Ç∏„Å™„Å©Ôºâ
        function processTurnEnd() {
            // „Éó„É¨„Ç§„É§„Éº„ÅÆÊØí„ÉÄ„É°„Éº„Ç∏
            const poisonResult = processPoisonDamage(player, '„ÇÜ„ÅÜ„Åó„ÇÉ', player.maxHp);
            if (poisonResult) {
                showBattleMessage(poisonResult.message, () => {
                    if (player.hp <= 1) {
                        // ÊØí„Åß„ÅØÊ≠ª„Å™„Å™„ÅÑ„ÅåÊ¨°„ÅÆË°åÂãï„Å∏
                    }
                    enemyTurn();
                });
            } else {
                enemyTurn();
            }
        }

        function playerAttack() {
            battle.phase = 'playerTurn';

            // ÂπªÊÉëÁä∂ÊÖã„Å™„ÇâÂëΩ‰∏≠Áéá‰Ωé‰∏ã
            const hitRate = getHitRate(player);
            if (Math.random() > hitRate) {
                showBattleMessage('„ÇÜ„ÅÜ„Åó„ÇÉ „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ „Åó„Åã„Åó „Åì„ÅÜ„Åí„Åç„ÅØ „ÅØ„Åö„Çå„ÅüÔºÅ', () => {
                    processTurnEnd();
                });
                return;
            }

            const atk = getPlayerAtk();
            const damage = Math.max(1, Math.floor(atk / 2 - battle.enemy.def / 4 + Math.random() * 5));
            battle.enemy.currentHp -= damage;

            showBattleMessage(`„ÇÜ„ÅÜ„Åó„ÇÉ „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                checkBattleEnd() || processTurnEnd();
            });
        }

        function enemyTurn() {
            // È≠îÁéã„ÅÆÂ†¥Âêà„ÅØÂ∞ÇÁî®„ÅÆË°åÂãï„É≠„Ç∏„ÉÉ„ÇØ„Çí‰ΩøÁî®
            if (battle.enemy.isBoss) {
                maouTurn();
                return;
            }

            battle.phase = 'enemyTurn';

            // Êïµ„ÅÆÁú†„Çä„ÉÅ„Çß„ÉÉ„ÇØ
            const wakeResult = checkWakeUp(battle.enemy, battle.enemy.name);
            if (!wakeResult.awake) {
                showBattleMessage(wakeResult.message, () => {
                    processEnemyTurnEnd();
                });
                return;
            }
            if (wakeResult.message) {
                // ÁõÆË¶ö„ÇÅ„Åü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å¶„Åã„ÇâË°åÂãï
                showBattleMessage(wakeResult.message, () => {
                    executeEnemyAttack();
                });
                return;
            }

            executeEnemyAttack();
        }

        function executeEnemyAttack() {
            // Êïµ„ÅÆÂπªÊÉëÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
            const hitRate = getHitRate(battle.enemy);
            if (Math.random() > hitRate) {
                showBattleMessage(`${battle.enemy.name} „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ „Åó„Åã„Åó „Åì„ÅÜ„Åí„Åç„ÅØ „ÅØ„Åö„Çå„ÅüÔºÅ`, () => {
                    processEnemyTurnEnd();
                });
                return;
            }

            const def = getPlayerDef();
            const damage = Math.max(1, Math.floor(battle.enemy.atk / 2 - def / 4 + Math.random() * 3));
            player.hp -= damage;

            showBattleMessage(`${battle.enemy.name} „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                if (player.hp <= 0) {
                    player.hp = 0;
                    battleLose();
                } else {
                    processEnemyTurnEnd();
                }
            });
        }

        // Êïµ„Çø„Éº„É≥ÁµÇ‰∫ÜÂá¶ÁêÜ
        function processEnemyTurnEnd() {
            // Êïµ„ÅÆÊØí„ÉÄ„É°„Éº„Ç∏
            const poisonResult = processPoisonDamage(battle.enemy, battle.enemy.name, battle.enemy.hp);
            if (poisonResult) {
                showBattleMessage(poisonResult.message, () => {
                    if (checkBattleEnd()) return;
                    startPlayerTurn();
                });
            } else {
                startPlayerTurn();
            }
        }

        // „Éó„É¨„Ç§„É§„Éº„Çø„Éº„É≥ÈñãÂßã
        function startPlayerTurn() {
            // „Éó„É¨„Ç§„É§„Éº„ÅÆÁú†„Çä„ÉÅ„Çß„ÉÉ„ÇØ
            const wakeResult = checkWakeUp(player, '„ÇÜ„ÅÜ„Åó„ÇÉ');
            if (!wakeResult.awake) {
                showBattleMessage(wakeResult.message, () => {
                    // Áú†„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØË°åÂãï„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Êïµ„Çø„Éº„É≥„Å∏
                    processTurnEnd();
                });
                return;
            }
            if (wakeResult.message) {
                showBattleMessage(wakeResult.message, () => {
                    battle.phase = 'command';
                });
                return;
            }

            battle.phase = 'command';
        }

        function tryEscape() {
            battle.phase = 'playerTurn';

            // È≠îÁéã„Åã„Çâ„ÅØÈÄÉ„Åí„Çâ„Çå„Å™„ÅÑ
            if (battle.enemy.isBoss) {
                showBattleMessage('È≠îÁéã „ÅÆ „Å°„Åã„Çâ „Åå „ÇÜ„ÅÜ„Åó„ÇÉ „Çí „Å´„Åå„Åï„Å™„ÅÑÔºÅ', () => {
                    enemyTurn();
                });
                return;
            }

            // „É¨„Éô„É´Â∑Æ„Å´„Çà„ÇãÈÄÉËµ∞ÊàêÂäüÁéá„ÅÆË®àÁÆó
            const enemyLevel = battle.enemy.level || 1;
            const levelDiff = player.level - enemyLevel;

            let escapeChance;
            if (levelDiff >= 5) {
                // 5„É¨„Éô„É´‰ª•‰∏äÈ´ò„Åë„Çå„Å∞Á¢∫ÂÆöÈÄÉËµ∞
                escapeChance = 1.0;
            } else if (levelDiff >= 3) {
                // 3„É¨„Éô„É´‰ª•‰∏äÈ´ò„Åë„Çå„Å∞È´òÁ¢∫Áéá
                escapeChance = 0.9;
            } else if (levelDiff >= 1) {
                // 1~2„É¨„Éô„É´È´ò„Åë„Çå„Å∞„ÇÑ„ÇÑÊúâÂà©
                escapeChance = 0.7;
            } else {
                // Âêå„É¨„Éô„É´‰ª•‰∏ã„ÅØ„Çπ„Éî„Éº„ÉâÊØî„ÅßÂà§ÂÆö
                escapeChance = player.speed / (player.speed + battle.enemy.speed);
            }

            if (Math.random() < escapeChance) {
                showBattleMessage('„ÅÜ„Åæ„Åè „Å´„Åí„Åç„Çå„ÅüÔºÅ', () => {
                    endBattle('escape');
                });
            } else {
                showBattleMessage('„Åó„Åã„Åó „Åæ„Çè„Çä„Åì„Åæ„Çå„Å¶„Åó„Åæ„Å£„ÅüÔºÅ', () => {
                    enemyTurn();
                });
            }
        }

        function checkBattleEnd() {
            if (battle.enemy.currentHp <= 0) {
                battle.enemy.currentHp = 0;
                battleWin();
                return true;
            }
            return false;
        }

        function battleWin() {
            battle.phase = 'result';
            const isBossDefeat = battle.enemy.isBoss;
            const exp = battle.enemy.exp;
            const gold = battle.enemy.gold;
            player.exp += exp;
            player.gold += gold;

            showBattleMessage(`${battle.enemy.name} „Çí „Åü„Åä„Åó„ÅüÔºÅ`, () => {
                // È≠îÁéãË®é‰ºêÊôÇ„ÅØÁâπÂà•„Å™ÊºîÂá∫
                if (isBossDefeat) {
                    screenShake.active = true;
                    screenShake.intensity = 15;
                    screenShake.duration = 60;

                    showBattleMessage('„Åê...„Åê„Åä„Åä„Åä„Åä...ÔºÅ', () => {
                        showBattleMessage('„Åæ...„Åæ„Åï„Åã... „Åì„ÅÆÁßÅ„Åå...', () => {
                            showBattleMessage('È≠îÁéã „ÅØ Ê∂àÊªÖ„Åó„ÅüÔºÅ', () => {
                                showBattleMessage(`${exp} „Éù„Ç§„É≥„Éà„ÅÆ „Åë„ÅÑ„Åë„Çì„Å°„Çí „Åã„Åè„Å®„ÅèÔºÅ`, () => {
                                    checkLevelUp(() => {
                                        gameCleared = true;
                                        startEnding();
                                    });
                                });
                            });
                        });
                    });
                } else {
                    showBattleMessage(`${exp} „Éù„Ç§„É≥„Éà„ÅÆ „Åë„ÅÑ„Åë„Çì„Å°„Çí „Åã„Åè„Å®„ÅèÔºÅ`, () => {
                        showBattleMessage(`${gold} „Ç¥„Éº„É´„Éâ„Çí „Å¶„Å´„ÅÑ„Çå„ÅüÔºÅ`, () => {
                            checkLevelUp(() => {
                                endBattle('win');
                            });
                        });
                    });
                }
            });
        }

        // „Åì„ÅÆ„É¨„Éô„É´„ÅßÁøíÂæó„Åô„ÇãÂë™Êñá„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkNewSpells(level) {
            const newSpells = [];
            for (const spellId in spells) {
                const spell = spells[spellId];
                if (spell.learnLevel === level && !player.spells.includes(spellId)) {
                    newSpells.push(spellId);
                }
            }
            return newSpells;
        }

        // Âë™ÊñáÁøíÂæó„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        function showSpellLearnMessages(spellList, callback) {
            if (spellList.length === 0) {
                callback();
                return;
            }
            const spellId = spellList.shift();
            const spell = spells[spellId];
            player.spells.push(spellId);
            showBattleMessage(`${spell.name} „Çí „Åä„Åº„Åà„ÅüÔºÅ`, () => {
                showSpellLearnMessages(spellList, callback);
            });
        }

        function checkLevelUp(callback) {
            if (player.level < expTable.length - 1 && player.exp >= expTable[player.level + 1]) {
                player.level++;

                // „Çπ„ÉÜ„Éº„Çø„Çπ‰∏äÊòá„Çí„É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†Ëæº„Åø„ÅßË®àÁÆó
                const hpUp = 3 + Math.floor(Math.random() * 5); // 3-7
                const mpUp = 1 + Math.floor(Math.random() * 3); // 1-3
                const atkUp = 1 + Math.floor(Math.random() * 2); // 1-2
                const defUp = 1 + Math.floor(Math.random() * 2); // 1-2
                const spdUp = Math.floor(Math.random() * 2); // 0-1

                player.maxHp += hpUp;
                player.maxMp += mpUp;
                player.baseAtk += atkUp;
                player.baseDef += defUp;
                player.speed += spdUp;
                // HP/MP„ÅØÂÖ®ÂõûÂæ©„Åó„Å™„ÅÑÔºàÂÆøÂ±ã„ÅÆÈáçË¶ÅÊÄß„ÇíÈ´ò„ÇÅ„ÇãÔºâ

                // Âü∫Á§é„Çπ„ÉÜ„Éº„Çø„Çπ„Åå‰∏ä„Åå„Å£„Åü„ÅÆ„Åß„Åì„ÅÜ„Åí„ÅçÂäõ„Éª„Åó„ÇÖ„Å≥Âäõ„ÇíÂÜçË®àÁÆó
                updateActualStats();

                // „Åì„ÅÆ„É¨„Éô„É´„ÅßÁøíÂæó„Åô„ÇãÂë™Êñá„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const newSpells = checkNewSpells(player.level);

                // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈ†ÜÁï™„Å´Ë°®Á§∫
                showBattleMessage(`„É¨„Éô„É´„Åå „ÅÇ„Åå„Å£„ÅüÔºÅ Lv${player.level} „Å´„Å™„Å£„ÅüÔºÅ`, () => {
                    showBattleMessage(`„Åï„ÅÑ„Å†„ÅÑHP „Åå ${hpUp} „ÅÇ„Åå„Å£„ÅüÔºÅ`, () => {
                        showBattleMessage(`„Åï„ÅÑ„Å†„ÅÑMP „Åå ${mpUp} „ÅÇ„Åå„Å£„ÅüÔºÅ`, () => {
                            showBattleMessage(`„Å°„Åã„Çâ „Åå ${atkUp} „ÅÇ„Åå„Å£„ÅüÔºÅ`, () => {
                                showBattleMessage(`„Åø„ÅÆ„Åæ„ÇÇ„Çä „Åå ${defUp} „ÅÇ„Åå„Å£„ÅüÔºÅ`, () => {
                                    const afterStats = () => {
                                        // Âë™ÊñáÁøíÂæó„É°„ÉÉ„Çª„Éº„Ç∏
                                        showSpellLearnMessages(newSpells, () => {
                                            checkLevelUp(callback); // Ë§áÊï∞„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂØæÂøú
                                        });
                                    };
                                    if (spdUp > 0) {
                                        showBattleMessage(`„Åô„Å∞„ÇÑ„Åï „Åå ${spdUp} „ÅÇ„Åå„Å£„ÅüÔºÅ`, afterStats);
                                    } else {
                                        afterStats();
                                    }
                                });
                            });
                        });
                    });
                });
            } else {
                callback();
            }
        }

        function battleLose() {
            battle.phase = 'result';
            showBattleMessage('„ÇÜ„ÅÜ„Åó„ÇÉ „ÅØ „Åó„Çì„Åß„Åó„Åæ„Å£„Åü...', () => {
                showBattleMessage('„Åä„ÅÜ„Åï„Åæ„Äå„Åù„Å™„Åü„Å´ „ÇÇ„ÅÜ‰∏ÄÂ∫¶ „ÉÅ„É£„É≥„Çπ„Çí „ÇÑ„Çç„ÅÜ„Äç', () => {
                    player.gold = Math.floor(player.gold / 2);
                    player.hp = player.maxHp;
                    player.mp = player.maxMp;
                    player.x = 7;
                    player.y = 11;
                    currentMapId = 'castle';
                    currentMap = maps[currentMapId];
                    mapNameElement.textContent = currentMap.name;
                    endBattle('lose');
                });
            });
        }

        function endBattle(result) {
            battle.result = result;
            // „Éê„Éà„É´ÁµÇ‰∫ÜÊôÇ„Å´Ê≠©Êï∞„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà
            stepsSinceLastBattle = 0;
            setTimeout(() => {
                gameMode = MODE.FIELD;
                battle.active = false;
                updateCamera();
                saveGame();
            }, 500);
        }

        // ========================================
        // „Ç®„É≥„Éá„Ç£„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        let endingState = {
            phase: 'none',      // none, fadeout, castle, talk, staffroll, theend
            fadeAlpha: 0,
            scrollY: 0,
            staffRollComplete: false
        };

        const staffRollText = [
            '',
            '',
            '~ CONGRATULATIONS! ~',
            '',
            '',
            'È≠îÁéã„Çí ÂÄí„Åó',
            '‰∏ñÁïå„Å´ Âπ≥Âíå„Åå Êàª„Å£„Åü',
            '',
            '',
            '',
            '-- STAFF --',
            '',
            '„Ç≤„Éº„É†„Éá„Ç∂„Ç§„É≥',
            '  „ÅÇ„Å™„Åü',
            '',
            '„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞',
            '  „ÅÇ„Å™„Åü',
            '',
            '„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ',
            '  „ÅÇ„Å™„Åü',
            '',
            '',
            '-- SPECIAL THANKS --',
            '',
            'ÊúÄÂæå„Åæ„Åß „Éó„É¨„Ç§„Åó„Å¶„Åè„Çå„Åü',
            '„ÅÇ„Å™„Åü„Å´ ÊÑüË¨ùÔºÅ',
            '',
            '',
            '',
            '',
            'THANK YOU FOR PLAYING!',
            '',
            '',
            '',
            '',
            '~ THE END ~',
            '',
            '',
            ''
        ];

        function startEnding() {
            endingState.phase = 'fadeout';
            endingState.fadeAlpha = 0;
            battle.active = false;

            // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÈñãÂßã
            const fadeInterval = setInterval(() => {
                endingState.fadeAlpha += 0.02;
                if (endingState.fadeAlpha >= 1) {
                    clearInterval(fadeInterval);
                    // Âüé„Å´ÁßªÂãï
                    currentMapId = 'castle';
                    currentMap = maps[currentMapId];
                    player.x = 7;
                    player.y = 9;
                    mapNameElement.textContent = currentMap.name;

                    endingState.phase = 'castle';
                    gameMode = MODE.FIELD;

                    // „Éï„Çß„Éº„Éâ„Ç§„É≥
                    const fadeInInterval = setInterval(() => {
                        endingState.fadeAlpha -= 0.02;
                        if (endingState.fadeAlpha <= 0) {
                            endingState.fadeAlpha = 0;
                            clearInterval(fadeInInterval);
                            // Âá±Êóã„Ç§„Éô„É≥„ÉàÈñãÂßã
                            setTimeout(() => {
                                startTriumphEvent();
                            }, 500);
                        }
                    }, 30);
                }
            }, 30);
        }

        function startTriumphEvent() {
            endingState.phase = 'talk';
            startDialog([
                '„Åä„Åä „ÇÜ„ÅÜ„Åó„ÇÉ„ÇàÔºÅ',
                '„Çà„Åè„Åû È≠îÁéã„Çí „Åü„Åä„Åó„Å¶„Åè„Çå„ÅüÔºÅ',
                '„Åì„Çå„Åß ‰∏ñÁïå„Å´ Âπ≥Âíå„Åå „ÇÇ„Å©„Å£„ÅüÔºÅ',
                '„Åù„Å™„Åü„ÅÆ „ÅÑ„Åï„Åä„Åó„ÅØ „Å™„Åå„Åè Ë™û„ÇäÁ∂ô„Åå„Çå„Çã„Åß„ÅÇ„Çç„ÅÜ',
                '„ÅÇ„Çä„Åå„Å®„ÅÜ „ÇÜ„ÅÜ„Åó„ÇÉ„ÇàÔºÅ',
                '...‰∏ñÁïå„ÅØ Âπ≥Âíå„Å´„Å™„Å£„Åü...'
            ], () => {
                // „Çπ„Çø„ÉÉ„Éï„É≠„Éº„É´„Å∏
                setTimeout(() => {
                    startStaffRoll();
                }, 1000);
            });
        }

        function startStaffRoll() {
            endingState.phase = 'staffroll';
            endingState.scrollY = canvasHeight;
            endingState.staffRollComplete = false;
            gameMode = MODE.ENDING;
        }

        function updateStaffRoll() {
            if (endingState.phase !== 'staffroll') return;

            endingState.scrollY -= 1;

            const textHeight = staffRollText.length * 30 + canvasHeight;
            if (endingState.scrollY < -textHeight + canvasHeight / 2) {
                endingState.phase = 'theend';
                endingState.fadeAlpha = 0;
            }
        }

        function drawEnding() {
            // „Çπ„Çø„ÉÉ„Éï„É≠„Éº„É´ÊèèÁîª
            if (endingState.phase === 'staffroll') {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.font = '20px "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif';

                for (let i = 0; i < staffRollText.length; i++) {
                    const y = endingState.scrollY + i * 30;
                    if (y > -30 && y < canvasHeight + 30) {
                        ctx.fillText(staffRollText[i], canvasWidth / 2, y);
                    }
                }

                ctx.textAlign = 'left';
            }

            // THE END Ë°®Á§∫
            if (endingState.phase === 'theend') {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                endingState.fadeAlpha = Math.min(1, endingState.fadeAlpha + 0.01);

                ctx.fillStyle = `rgba(255, 215, 0, ${endingState.fadeAlpha})`;
                ctx.textAlign = 'center';
                ctx.font = 'bold 48px "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif';
                ctx.fillText('THE END', canvasWidth / 2, canvasHeight / 2);

                ctx.font = '16px "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif';
                ctx.fillStyle = `rgba(255, 255, 255, ${endingState.fadeAlpha * 0.7})`;
                ctx.fillText('Press any key to return to title', canvasWidth / 2, canvasHeight / 2 + 60);

                ctx.textAlign = 'left';
            }
        }

        function handleEndingInput() {
            if (endingState.phase === 'theend' && endingState.fadeAlpha >= 1) {
                // „Ç≤„Éº„É†„É™„Çª„ÉÉ„ÉàÔºà„Çø„Ç§„Éà„É´„Å∏Ôºâ
                resetGame();
            }
        }

        function resetGame() {
            // „Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
            gameCleared = false;
            endingState.phase = 'none';
            endingState.fadeAlpha = 0;
            endingState.scrollY = 0;

            // „Éó„É¨„Ç§„É§„ÉºÂàùÊúüÂåñ
            player.hp = 30;
            player.maxHp = 30;
            player.mp = 10;
            player.maxMp = 10;
            player.baseAtk = 8;
            player.baseDef = 5;
            player.atk = 8;
            player.def = 5;
            player.speed = 5;
            player.level = 1;
            player.exp = 0;
            player.gold = 100;
            player.x = 7;
            player.y = 11;
            player.dir = 0;
            player.inventory = [];
            player.equipment = { weapon: null, armor: null };
            player.spells = ['hoimi', 'mera'];
            player.status = { sleep: 0, poison: 0, blind: 0 };

            openedChests = [];
            currentMapId = 'castle';
            currentMap = maps[currentMapId];
            mapNameElement.textContent = currentMap.name;

            gameMode = MODE.FIELD;
            localStorage.removeItem('dragonQuestSave');
        }

        function checkRandomEncounter() {
            // ÂÆâÂÖ®Âú∞Â∏Ø„Åß„ÅØ„Ç®„É≥„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑ
            if (currentMap.isSafe === true) {
                // ÂÆâÂÖ®Âú∞Â∏Ø„Å´ÂÖ•„Å£„Åü„ÇâÊ≠©Êï∞„É™„Çª„ÉÉ„Éà
                if (stepsSinceLastBattle > 0) {
                    stepsSinceLastBattle = 0;
                }
                return;
            }

            // encounterRate=0„ÅÆ„Éû„ÉÉ„Éó„ÇÇ„Çπ„Ç≠„ÉÉ„ÉóÔºàisSafeÊú™ÂÆöÁæ©„ÅÆÊóß„Éû„ÉÉ„Éó‰∫íÊèõÔºâ
            if (currentMap.encounterRate <= 0) return;

            // „Ç®„É≥„Ç´„Ç¶„É≥„Éà„Çø„Ç§„É´‰ª•Â§ñ„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            const tile = currentMap.data[player.y][player.x];
            if (!ENCOUNTER_TILES.includes(tile)) return;

            // Ê≠©Êï∞„Ç´„Ç¶„É≥„Éà
            stepsSinceLastBattle++;

            // ‰∏çÊÑüÂú∞Â∏Ø„ÅÆÂà§ÂÆöÔºàsafeSteps‰ª•‰∏ã„ÅØ„Ç®„É≥„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑÔºâ
            if (stepsSinceLastBattle <= SAFE_STEPS) {
                // console.log(`[DEBUG] ‰∏çÊÑüÂú∞Â∏Ø: ${stepsSinceLastBattle}/${SAFE_STEPS}Ê≠©`);
                return;
            }

            // Á¢∫Áéá„ÅÆË®àÁÆóÔºàÊ≠©„Åè„Åª„Å©‰∏äÊòáÔºâ
            const stepsOverSafe = stepsSinceLastBattle - SAFE_STEPS;
            const currentEncounterRate = Math.min(
                stepsOverSafe * ENCOUNTER_RATE_PER_STEP,
                MAX_ENCOUNTER_RATE
            );

            // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Ôºà„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„ÅßÁÑ°ÂäπÂåñÂèØËÉΩÔºâ
            // console.log(`[DEBUG] Ê≠©Êï∞: ${stepsSinceLastBattle}, Á¢∫Áéá: ${(currentEncounterRate * 100).toFixed(1)}%`);

            // „Ç®„É≥„Ç´„Ç¶„É≥„ÉàÂà§ÂÆö
            if (Math.random() < currentEncounterRate) {
                // mapId„Éô„Éº„Çπ„Åß„Ç®„É≥„Ç´„Ç¶„É≥„Éà„ÉÜ„Éº„Éñ„É´„ÇíÈÅ∏ÊäûÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ‰ªò„ÅçÔºâ
                const mapId = currentMap.mapId || '';
                let table = encounterTables[mapId];
                if (!table) {
                    // mapId„ÅßË¶ã„Å§„Åã„Çâ„Å™„Åë„Çå„Å∞type„ÅßÊé¢„Åô
                    const fallbackType = encounterTableFallback[currentMap.type] || 'field';
                    table = encounterTables[fallbackType] || encounterTables.field;
                }
                const monsterType = table[Math.floor(Math.random() * table.length)];
                startBattle(monsterType);
            }
        }

        // ÁèæÂú®„ÅÆ„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÁ¢∫Áéá„ÇíÂèñÂæóÔºà„Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Áî®Ôºâ
        function getCurrentEncounterRate() {
            if (currentMap.encounterRate <= 0) return 0;
            if (stepsSinceLastBattle <= SAFE_STEPS) return 0;
            const stepsOverSafe = stepsSinceLastBattle - SAFE_STEPS;
            return Math.min(stepsOverSafe * ENCOUNTER_RATE_PER_STEP, MAX_ENCOUNTER_RATE);
        }

        // ========================================
        // NPC„ÉªÂÆùÁÆ±
        // ========================================
        function getNpcAt(x, y) {
            if (!currentMap.npcs) return null;
            return currentMap.npcs.find(npc => npc.x === x && npc.y === y) || null;
        }

        function getChestAt(x, y) {
            if (!currentMap.chests) return null;
            return currentMap.chests.find(chest => chest.x === x && chest.y === y) || null;
        }

        function isNpcBlocking(x, y) { return getNpcAt(x, y) !== null; }
        function isChestBlocking(x, y) { return getChestAt(x, y) !== null; }

        // ========================================
        // ‰ºöË©±„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        function startDialog(messages) {
            dialog.active = true;
            dialog.messages = Array.isArray(messages) ? messages : [messages];
            dialog.currentIndex = 0;
            dialog.displayedText = '';
            dialog.charIndex = 0;
            dialog.isTyping = true;
            typeNextChar();
        }

        function typeNextChar() {
            if (!dialog.active) return;
            const currentMessage = dialog.messages[dialog.currentIndex];
            if (dialog.charIndex < currentMessage.length) {
                dialog.displayedText += currentMessage[dialog.charIndex];
                dialog.charIndex++;
                setTimeout(typeNextChar, dialog.typingSpeed);
            } else {
                dialog.isTyping = false;
            }
        }

        function advanceDialog() {
            if (!dialog.active) return;
            if (dialog.isTyping) {
                dialog.displayedText = dialog.messages[dialog.currentIndex];
                dialog.charIndex = dialog.messages[dialog.currentIndex].length;
                dialog.isTyping = false;
            } else if (dialog.currentIndex < dialog.messages.length - 1) {
                dialog.currentIndex++;
                dialog.displayedText = '';
                dialog.charIndex = 0;
                dialog.isTyping = true;
                typeNextChar();
            } else {
                closeDialog();
            }
        }

        function closeDialog() {
            dialog.active = false;
            dialog.messages = [];
            dialog.currentIndex = 0;
            dialog.displayedText = '';
        }

        // ========================================
        // ÂÆùÁÆ±„Éª„É°„Éã„É•„Éº
        // ========================================
        function openChest(chest) {
            if (chest.isOpened) {
                startDialog(['ÂÆùÁÆ±„ÅØ „Åã„Çâ„Å£„ÅΩ„Å†„ÄÇ']);
            } else {
                const item = items[chest.itemId];
                if (item) {
                    chest.isOpened = true;
                    // maps„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂÆùÁÆ±„ÇÇÂêåÊúüÔºà„Çª„Éº„Éñ„Éá„Éº„Çø„Å´ÂèçÊò†„Åï„Åõ„Çã„Åü„ÇÅÔºâ
                    if (maps[currentMapId] && maps[currentMapId].chests) {
                        const mapChest = maps[currentMapId].chests.find(c => c.id === chest.id);
                        if (mapChest) mapChest.isOpened = true;
                    }
                    player.inventory.push(item.id);
                    startDialog(['ÂÆùÁÆ±„Çí„ÅÇ„Åë„ÅüÔºÅ', `${item.name} „ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ`]);
                    saveGame();
                }
            }
        }

        function openMenu() {
            if (dialog.active || isTransitioning || gameMode === MODE.BATTLE || inn.active) return;
            menu.active = true;
            menu.mode = 'status'; // „Éá„Éï„Ç©„É´„Éà„Åß„Çπ„ÉÜ„Éº„Çø„ÇπÁîªÈù¢
        }

        function closeMenu() {
            menu.active = false;
            menu.showItemAction = false;
            menu.itemActionIndex = 0;
        }

        // „Ç¢„Ç§„ÉÜ„É†„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°å
        function executeItemAction() {
            if (player.inventory.length === 0) return;

            const selectedItemId = player.inventory[menu.itemCursor];
            const selectedItem = items[selectedItemId];
            if (!selectedItem) return;

            const isEquipment = (selectedItem.type === 'weapon' || selectedItem.type === 'armor');

            switch (menu.itemActionIndex) {
                case 0: // „Å§„Åã„ÅÜ or „Åù„ÅÜ„Å≥„Åô„Çã
                    if (isEquipment) {
                        // Ë£ÖÂÇô„Åô„Çã
                        equipItem(selectedItemId);
                        closeMenu();
                        startDialog([`${selectedItem.name}„Çí „Åù„ÅÜ„Å≥„Åó„ÅüÔºÅ`]);
                    } else {
                        // ‰Ωø„ÅÜ
                        useItem(selectedItemId);
                    }
                    break;

                case 1: // „Åô„Å¶„Çã
                    const idx = player.inventory.indexOf(selectedItemId);
                    if (idx !== -1) {
                        player.inventory.splice(idx, 1);
                        // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆË™øÊï¥
                        if (menu.itemCursor >= player.inventory.length && menu.itemCursor > 0) {
                            menu.itemCursor--;
                        }
                    }
                    menu.showItemAction = false;
                    if (player.inventory.length === 0) {
                        closeMenu();
                        startDialog([`${selectedItem.name}„Çí „Åô„Å¶„Åü„ÄÇ`]);
                    }
                    break;

                case 2: // „ÇÑ„ÇÅ„Çã
                    menu.showItemAction = false;
                    break;
            }
        }

        // ========================================
        // ÂÆøÂ±ã„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        function openInn(cost) {
            inn.active = true;
            inn.cost = cost;
            inn.selectedIndex = 0;
        }

        function closeInn() {
            inn.active = false;
        }

        function confirmInn() {
            if (inn.selectedIndex === 0) {
                // „ÅØ„ÅÑ
                if (player.gold >= inn.cost) {
                    player.gold -= inn.cost;
                    closeInn();
                    // ÊöóËª¢ÊºîÂá∫
                    fadeOverlay.classList.add('active');
                    setTimeout(() => {
                        player.hp = player.maxHp;
                        player.mp = player.maxMp;
                        saveGame();
                        setTimeout(() => {
                            fadeOverlay.classList.remove('active');
                            startDialog(['„ÇÜ„Å£„Åè„Çä „Åä„ÇÑ„Åô„Åø„Åè„Å†„Åï„ÅÑ...', '„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ', 'HP„Å®MP„Åå „Åã„ÅÑ„Åµ„Åè„Åó„Åæ„Åó„ÅüÔºÅ']);
                        }, 500);
                    }, 500);
                } else {
                    closeInn();
                    startDialog(['„ÅäÈáë„Åå „Åü„Çä„Å™„ÅÑ„Çà„ÅÜ„Åß„Åô...']);
                }
            } else {
                // „ÅÑ„ÅÑ„Åà
                closeInn();
                startDialog(['„Åæ„Åü„ÅÆ„ÅäË∂ä„Åó„Çí „Åä„Åæ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ']);
            }
        }

        // ========================================
        // „Ç∑„Éß„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†
        // ========================================
        function openShop() {
            shop.active = true;
            shop.mode = 'menu';
            shop.phase = 'list';
            shop.menuIndex = 0;
            shop.selectedIndex = 0;
            shop.confirmIndex = 0;
            shop.equipIndex = 0;
            shop.selectedItem = null;
            shop.sellableItems = [];
        }

        // Â£≤Âç¥ÂèØËÉΩ„Å™„Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà„Çí‰ΩúÊàêÔºàË£ÖÂÇô‰∏≠„ÅÆ„ÇÇ„ÅÆ„ÅØÈô§Â§ñÔºâ
        function updateSellableItems() {
            shop.sellableItems = player.inventory.filter(itemId => {
                const item = items[itemId];
                // ‰æ°Ê†º„Åå0„ÅÆ„Ç¢„Ç§„ÉÜ„É†Ôºà‰ºùË™¨„ÅÆÂâ£„Å™„Å©Ôºâ„ÅØÂ£≤„Çå„Å™„ÅÑ
                if (!item || item.price === 0) return false;
                return true;
            });
        }

        function closeShop() {
            shop.active = false;
            startDialog(['„Åæ„Åü„ÅÆ„ÅäË∂ä„Åó„Çí „Åä„Åæ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ']);
        }

        function handleShopInput(action) {
            // „É°„Éã„É•„Éº„É¢„Éº„ÉâÔºà„Åã„ÅÜ/„ÅÜ„Çã/„ÇÑ„ÇÅ„ÇãÔºâ
            if (shop.mode === 'menu') {
                if (action === 'up') {
                    shop.menuIndex = Math.max(0, shop.menuIndex - 1);
                } else if (action === 'down') {
                    shop.menuIndex = Math.min(2, shop.menuIndex + 1);
                } else if (action === 'confirm') {
                    if (shop.menuIndex === 0) {
                        // „Åã„ÅÜ
                        shop.mode = 'buy';
                        shop.phase = 'list';
                        shop.selectedIndex = 0;
                    } else if (shop.menuIndex === 1) {
                        // „ÅÜ„Çã
                        updateSellableItems();
                        shop.mode = 'sell';
                        shop.phase = 'list';
                        shop.selectedIndex = 0;
                    } else {
                        // „ÇÑ„ÇÅ„Çã
                        closeShop();
                    }
                } else if (action === 'cancel') {
                    closeShop();
                }
                return;
            }

            // Ë≥ºÂÖ•„É¢„Éº„Éâ
            if (shop.mode === 'buy') {
                if (shop.phase === 'list') {
                    if (action === 'up') {
                        shop.selectedIndex = Math.max(0, shop.selectedIndex - 1);
                    } else if (action === 'down') {
                        shop.selectedIndex = Math.min(shopItems.length - 1, shop.selectedIndex + 1);
                    } else if (action === 'confirm') {
                        const itemId = shopItems[shop.selectedIndex];
                        const item = items[itemId];
                        if (player.gold >= item.price) {
                            shop.selectedItem = item;
                            shop.phase = 'confirm';
                            shop.confirmIndex = 0;
                        }
                    } else if (action === 'cancel') {
                        shop.mode = 'menu';
                        shop.menuIndex = 0;
                    }
                } else if (shop.phase === 'confirm') {
                    if (action === 'left') {
                        shop.confirmIndex = 0;
                    } else if (action === 'right') {
                        shop.confirmIndex = 1;
                    } else if (action === 'confirm') {
                        if (shop.confirmIndex === 0) {
                            // Ë≥ºÂÖ•
                            player.gold -= shop.selectedItem.price;
                            player.inventory.push(shop.selectedItem.id);
                            shop.phase = 'equip';
                            shop.equipIndex = 0;
                        } else {
                            shop.phase = 'list';
                        }
                    } else if (action === 'cancel') {
                        shop.phase = 'list';
                    }
                } else if (shop.phase === 'equip') {
                    if (action === 'left') {
                        shop.equipIndex = 0;
                    } else if (action === 'right') {
                        shop.equipIndex = 1;
                    } else if (action === 'confirm') {
                        if (shop.equipIndex === 0) {
                            equipItem(shop.selectedItem.id);
                        }
                        saveGame();
                        shop.phase = 'list';
                    } else if (action === 'cancel') {
                        saveGame();
                        shop.phase = 'list';
                    }
                }
                return;
            }

            // Â£≤Âç¥„É¢„Éº„Éâ
            if (shop.mode === 'sell') {
                if (shop.phase === 'list') {
                    if (action === 'up') {
                        shop.selectedIndex = Math.max(0, shop.selectedIndex - 1);
                    } else if (action === 'down') {
                        shop.selectedIndex = Math.min(Math.max(0, shop.sellableItems.length - 1), shop.selectedIndex + 1);
                    } else if (action === 'confirm') {
                        if (shop.sellableItems.length > 0) {
                            const itemId = shop.sellableItems[shop.selectedIndex];
                            shop.selectedItem = items[itemId];
                            shop.phase = 'confirm';
                            shop.confirmIndex = 0;
                        }
                    } else if (action === 'cancel') {
                        shop.mode = 'menu';
                        shop.menuIndex = 1;
                    }
                } else if (shop.phase === 'confirm') {
                    if (action === 'left') {
                        shop.confirmIndex = 0;
                    } else if (action === 'right') {
                        shop.confirmIndex = 1;
                    } else if (action === 'confirm') {
                        if (shop.confirmIndex === 0) {
                            // Â£≤Âç¥ÂÆüË°å
                            const sellPrice = Math.floor(shop.selectedItem.price / 2);
                            player.gold += sellPrice;
                            // „Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
                            const idx = player.inventory.indexOf(shop.selectedItem.id);
                            if (idx !== -1) {
                                player.inventory.splice(idx, 1);
                            }
                            shop.phase = 'sold';
                        } else {
                            shop.phase = 'list';
                        }
                    } else if (action === 'cancel') {
                        shop.phase = 'list';
                    }
                } else if (shop.phase === 'sold') {
                    // Â£≤Âç¥ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏Âæå
                    if (action === 'confirm' || action === 'cancel') {
                        updateSellableItems();
                        shop.selectedIndex = Math.min(shop.selectedIndex, Math.max(0, shop.sellableItems.length - 1));
                        shop.phase = 'list';
                        saveGame();
                    }
                }
            }
        }

        // „Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®
        function useItem(itemId) {
            const item = items[itemId];
            if (!item) return false;

            // Ë£ÖÂÇô„Ç¢„Ç§„ÉÜ„É†„ÅØ‰ΩøÁî®„Åß„Åç„Å™„ÅÑÔºàË£ÖÂÇô„Åô„Çã„ÇíÈÅ∏„Å∂ÂøÖË¶Å„Åå„ÅÇ„ÇãÔºâ
            if (item.type === 'weapon' || item.type === 'armor') {
                return false;
            }

            let message = '';
            let success = false;

            switch (item.type) {
                case 'heal':
                    // HPÂõûÂæ©„Ç¢„Ç§„ÉÜ„É†
                    if (player.hp >= player.maxHp) {
                        message = 'HP„ÅØ „Åæ„Çì„Åü„Çì„Å†ÔºÅ';
                    } else {
                        const healAmount = Math.min(item.value, player.maxHp - player.hp);
                        player.hp += healAmount;
                        message = `${item.name}„Çí‰Ωø„Å£„ÅüÔºÅ\nHP„Åå ${healAmount} ÂõûÂæ©„Åó„ÅüÔºÅ`;
                        success = true;
                    }
                    break;

                case 'cure':
                    // Áä∂ÊÖãÁï∞Â∏∏ÂõûÂæ©ÔºàÊØí„Å™„Å©Ôºâ
                    if (player.status && player.status.poison > 0) {
                        player.status.poison = 0;
                        message = `${item.name}„Çí‰Ωø„Å£„ÅüÔºÅ\nÊØí„Åå Ê≤ª„Å£„ÅüÔºÅ`;
                        success = true;
                    } else {
                        message = 'ÊØí„Å´ „Åã„Åã„Å£„Å¶„ÅÑ„Å™„ÅÑÔºÅ';
                    }
                    break;

                case 'holy':
                    // ËÅñÊ∞¥Ôºö„Åó„Å∞„Çâ„Åè„Ç®„É≥„Ç´„Ç¶„É≥„Éà„Åó„Å™„ÅÑÂäπÊûú
                    message = `${item.name}„Çí‰Ωø„Å£„ÅüÔºÅ\n„Åó„Å∞„Çâ„Åè È≠îÁâ©„Åå „Çà„Çä„Å§„Åã„Å™„ÅÑÔºÅ`;
                    stepsSinceLastBattle = -10; // Ê≠©Êï∞„Çí„Éû„Ç§„Éä„Çπ„Å´„Åó„Å¶„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÂõûÈÅø
                    success = true;
                    break;

                case 'key':
                    // ÈçµÔºö„Éï„Ç£„Éº„É´„Éâ„Åß„ÅØ‰Ωø„Åà„Å™„ÅÑ
                    message = '„Åì„Åì„Åß„ÅØ ‰Ωø„Åà„Å™„ÅÑÔºÅ';
                    break;

                default:
                    message = '„Åì„Åì„Åß„ÅØ ‰Ωø„Åà„Å™„ÅÑÔºÅ';
                    break;
            }

            // ‰ΩøÁî®ÊàêÂäüÊôÇ„ÄÅ„Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
            if (success) {
                const idx = player.inventory.indexOf(itemId);
                if (idx !== -1) {
                    player.inventory.splice(idx, 1);
                }
                // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆË™øÊï¥
                if (menu.itemCursor >= player.inventory.length && menu.itemCursor > 0) {
                    menu.itemCursor--;
                }
            }

            // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Å¶„ÉÄ„Ç§„Ç¢„É≠„Ç∞Ë°®Á§∫
            closeMenu();
            startDialog(message.split('\n'));
            return success;
        }

        function equipItem(itemId) {
            const item = items[itemId];
            if (!item) return;

            if (item.type === 'weapon') {
                // ÁèæÂú®„ÅÆÊ≠¶Âô®„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Å´Êàª„ÅôÔºàÂàùÊúüË£ÖÂÇô„Åß„Å™„ÅÑÂ†¥ÂêàÔºâ
                if (player.equipment.weapon && player.equipment.weapon !== 10) {
                    const idx = player.inventory.indexOf(player.equipment.weapon);
                    if (idx === -1) {
                        player.inventory.push(player.equipment.weapon);
                    }
                }
                // Êñ∞„Åó„ÅÑÊ≠¶Âô®„ÇíË£ÖÂÇô
                player.equipment.weapon = itemId;
                // „Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
                const removeIdx = player.inventory.indexOf(itemId);
                if (removeIdx !== -1) {
                    player.inventory.splice(removeIdx, 1);
                }
            } else if (item.type === 'armor') {
                // ÁèæÂú®„ÅÆÈò≤ÂÖ∑„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Å´Êàª„ÅôÔºàÂàùÊúüË£ÖÂÇô„Åß„Å™„ÅÑÂ†¥ÂêàÔºâ
                if (player.equipment.armor && player.equipment.armor !== 20) {
                    const idx = player.inventory.indexOf(player.equipment.armor);
                    if (idx === -1) {
                        player.inventory.push(player.equipment.armor);
                    }
                }
                // Êñ∞„Åó„ÅÑÈò≤ÂÖ∑„ÇíË£ÖÂÇô
                player.equipment.armor = itemId;
                // „Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
                const removeIdx = player.inventory.indexOf(itemId);
                if (removeIdx !== -1) {
                    player.inventory.splice(removeIdx, 1);
                }
            }
            // Ë£ÖÂÇôÂ§âÊõ¥Âæå„ÄÅ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂÜçË®àÁÆó
            updateActualStats();
        }

        // ========================================
        // „Éû„ÉÉ„ÉóÈÅ∑ÁßªÔºà„Éû„É´„ÉÅ„Éû„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†ÂØæÂøúÔºâ
        // ========================================

        // ÈùûÂêåÊúü„Éû„ÉÉ„Éó„É≠„Éº„ÉâÔºàÂÆüÈöõ„ÅÆfetch„ÅßJSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄÔºâ
        async function loadMapFromDatabase(mapPath) {
            try {
                // ÂÆüÈöõ„ÅÆJSON„Éï„Ç°„Ç§„É´„Çífetch
                const response = await fetch(mapPath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const mapData = await response.json();
                console.log(`„Éû„ÉÉ„Éó„Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü: ${mapPath}`);
                return mapData;
            } catch (error) {
                console.error(`„Éû„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº (${mapPath}):`, error);

                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÊóßÂΩ¢Âºè„ÅÆ„Éû„ÉÉ„ÉóID„Å´Â§âÊèõ„ÇíË©¶„Åø„Çã
                const mapIdMatch = mapPath.match(/maps\/(.+)\.json/);
                if (mapIdMatch) {
                    const mapId = mapIdMatch[1].replace('_', '');
                    const normalizedId = mapId === 'maou_room' ? 'maouRoom' : mapId;
                    if (maps[normalizedId]) {
                        console.log(`„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂÜÖËîµ„Éû„ÉÉ„Éó ${normalizedId} „Çí‰ΩøÁî®`);
                        return {
                            ...maps[normalizedId],
                            mapId: normalizedId
                        };
                    }
                }

                throw error;
            }
        }

        // „Éû„ÉÉ„Éó„Éë„Çπ„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
        function isMapPath(target) {
            return target.startsWith('maps/') || target.endsWith('.json');
        }

        // „Éû„ÉÉ„Éó„Éë„Çπ„Åã„ÇâÊóßÂΩ¢ÂºèID„Å∏„ÅÆÂ§âÊèõ
        function getMapIdFromPath(mapPath) {
            const match = mapPath.match(/maps\/(.+)\.json/);
            if (match) {
                const id = match[1].replace('_', '');
                return id === 'maou_room' ? 'maouRoom' : id;
            }
            return mapPath;
        }

        // ÊóßÂΩ¢ÂºèID„Åã„Çâ„Éû„ÉÉ„Éó„Éë„Çπ„Å∏„ÅÆÂ§âÊèõ
        function getMapPathFromId(mapId) {
            if (mapId === 'maouRoom') return 'maps/maou_room.json';
            return `maps/${mapId}.json`;
        }

        function checkWarp() {
            if (!currentMap.warps) return;
            for (const warp of currentMap.warps) {
                if (player.x === warp.x && player.y === warp.y) {
                    performWarp(warp.targetMap, warp.targetX, warp.targetY);
                    return;
                }
            }
        }

        async function performWarp(targetMap, targetX, targetY) {
            if (isTransitioning) return;

            // Êñ∞ÂΩ¢ÂºèÔºàmaps/*.jsonÔºâ„ÅãÊóßÂΩ¢ÂºèÔºàmapIdÔºâ„Åã„ÇíÂà§ÂÆö
            const isNewFormat = isMapPath(targetMap);
            const targetMapPath = isNewFormat ? targetMap : getMapPathFromId(targetMap);
            const targetMapId = isNewFormat ? getMapIdFromPath(targetMap) : targetMap;

            // „Ç≠„É£„ÉÉ„Ç∑„É•Ê∏à„Åø„ÅÆÂ§ñÈÉ®JSON„Éû„ÉÉ„Éó„Åå„ÅÇ„Çå„Å∞ÂÜçÂà©Áî®ÔºàÂÆùÁÆ±Áä∂ÊÖã‰øùÊåÅ„ÅÆ„Åü„ÇÅÔºâ
            if (maps[targetMapId] && maps[targetMapId]._isExternal) {
                performLegacyWarp(targetMapId, targetX, targetY);
                return;
            }

            // ÊóßÂΩ¢ÂºèÔºàÂÜÖËîµ„Éû„ÉÉ„ÉóÔºâ„ÇíÁõ¥Êé•ÂèÇÁÖß„Åß„Åç„Çã„ÅãÁ¢∫Ë™ç
            if (!isNewFormat && maps[targetMapId]) {
                performLegacyWarp(targetMapId, targetX, targetY);
                return;
            }

            // Êñ∞ÂΩ¢Âºè„ÅÆ„Éû„ÉÉ„Éó„É≠„Éº„Éâ
            isTransitioning = true;
            mapLoadState.loading = true;
            fadeOverlay.classList.add('active');

            try {
                // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÂÆå‰∫Ü„ÇíÂæÖ„Å§
                await new Promise(resolve => setTimeout(resolve, 300));

                // „Éû„ÉÉ„Éó„Çí„É≠„Éº„Éâ
                const mapData = await loadMapFromDatabase(targetMapPath);

                // Â§ñÈÉ®JSON„Éû„ÉÉ„Éó„Åß„ÅÇ„Çã„Åì„Å®„Çí„Éû„Éº„ÇØ
                mapData._isExternal = true;

                // „Éû„ÉÉ„Éó„Çímaps„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ËøΩÂä†Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•Ôºâ
                maps[mapData.mapId] = mapData;

                // ÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„ÇíÊõ¥Êñ∞
                currentMapId = mapData.mapId;
                currentMapPath = targetMapPath;
                currentMap = mapData;
                player.x = targetX;
                player.y = targetY;
                mapNameElement.textContent = currentMap.name;
                updateCamera();
                saveGame();

                // ÂÆâÂÖ®„Å™„Éû„ÉÉ„ÉóÔºàË°ó„ÉªÂüé„Å™„Å©Ôºâ„Å´ÂÖ•„Å£„Åü„ÇâÊ≠©Êï∞„É™„Çª„ÉÉ„Éà
                if (currentMap.encounterRate <= 0) {
                    stepsSinceLastBattle = 0;
                }

                // „Éï„Çß„Éº„Éâ„Ç§„É≥
                await new Promise(resolve => setTimeout(resolve, 100));
                fadeOverlay.classList.remove('active');
                await new Promise(resolve => setTimeout(resolve, 300));

            } catch (error) {
                console.error('„Éû„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÊóßÂΩ¢Âºè„ÇíË©¶„Åô
                if (maps[targetMapId]) {
                    currentMapId = targetMapId;
                    currentMap = maps[targetMapId];
                    player.x = targetX;
                    player.y = targetY;
                    mapNameElement.textContent = currentMap.name;
                    updateCamera();
                }
                fadeOverlay.classList.remove('active');
            } finally {
                mapLoadState.loading = false;
                isTransitioning = false;
            }
        }

        // ÊóßÂΩ¢Âºè„ÅÆ„ÉØ„Éº„ÉóÂá¶ÁêÜÔºà‰∫íÊèõÊÄßÁ∂≠ÊåÅÔºâ
        function performLegacyWarp(targetMapId, targetX, targetY) {
            if (isTransitioning || !maps[targetMapId]) return;
            isTransitioning = true;
            fadeOverlay.classList.add('active');

            setTimeout(() => {
                currentMapId = targetMapId;
                currentMapPath = getMapPathFromId(targetMapId);
                currentMap = maps[targetMapId];
                player.x = targetX;
                player.y = targetY;
                mapNameElement.textContent = currentMap.name;
                updateCamera();
                saveGame();

                // ÂÆâÂÖ®„Å™„Éû„ÉÉ„ÉóÔºàË°ó„ÉªÂüé„Å™„Å©Ôºâ„Å´ÂÖ•„Å£„Åü„ÇâÊ≠©Êï∞„É™„Çª„ÉÉ„Éà
                if (currentMap.encounterRate <= 0) {
                    stepsSinceLastBattle = 0;
                }

                setTimeout(() => {
                    fadeOverlay.classList.remove('active');
                    setTimeout(() => { isTransitioning = false; }, 300);
                }, 100);
            }, 300);
        }

        // ========================================
        // ÁßªÂãï
        // ========================================
        function canMove(x, y) {
            if (x < 0 || x >= currentMap.cols || y < 0 || y >= currentMap.rows) return false;
            const tile = currentMap.data[y][x];
            if (!WALKABLE_TILES.includes(tile)) return false;
            if (isNpcBlocking(x, y) || isChestBlocking(x, y)) return false;
            return true;
        }

        function movePlayer(dx, dy) {
            if (player.moving || isTransitioning || dialog.active || menu.active || inn.active || shop.active || gameMode === MODE.BATTLE) return;

            if (dy < 0) player.direction = 'up';
            else if (dy > 0) player.direction = 'down';
            else if (dx < 0) player.direction = 'left';
            else if (dx > 0) player.direction = 'right';

            const newX = player.x + dx;
            const newY = player.y + dy;

            if (canMove(newX, newY)) {
                player.moving = true;
                player.x = newX;
                player.y = newY;
                updateCamera();

                setTimeout(() => {
                    checkWarp();
                    if (gameMode === MODE.FIELD) {
                        checkRandomEncounter();
                    }
                    player.moving = false;
                }, player.moveDelay);
            }
        }

        function getFrontPosition() {
            let fx = player.x, fy = player.y;
            switch (player.direction) {
                case 'up': fy--; break;
                case 'down': fy++; break;
                case 'left': fx--; break;
                case 'right': fx++; break;
            }
            return { x: fx, y: fy };
        }

        function interact() {
            if (menu.active || gameMode === MODE.BATTLE || inn.active || shop.active) return;
            if (dialog.active) { advanceDialog(); return; }

            const front = getFrontPosition();
            const npc = getNpcAt(front.x, front.y);
            if (npc) {
                if (npc.type === 'inn') {
                    openInn(npc.innCost);
                } else if (npc.type === 'shop') {
                    openShop();
                } else if (npc.type === 'maou') {
                    // È≠îÁéãÊà¶ÈñãÂßã
                    if (gameCleared) {
                        // Êó¢„Å´„ÇØ„É™„Ç¢Ê∏à„Åø
                        startDialog(['......„ÄÇ', 'ÔºàÈ≠îÁéã„ÅÆÂßø„ÅØ„ÇÇ„ÅÜ„Å™„ÅÑÔºâ']);
                    } else {
                        startMaouBattle();
                    }
                } else {
                    // „Ç≤„Éº„É†„ÇØ„É™„Ç¢Âæå„ÅØNPC„ÅÆ„Çª„É™„Éï„ÅåÂ§â„Çè„Çã
                    if (gameCleared && npc.clearedMessages) {
                        startDialog(npc.clearedMessages);
                    } else {
                        startDialog(npc.messages);
                    }
                }
                return;
            }

            const chest = getChestAt(front.x, front.y);
            if (chest) { openChest(chest); }
        }

        // È≠îÁéãÊà¶ÈñãÂßã
        function startMaouBattle() {
            // È≠îÁéãÂ∞ÇÁî®„ÅÆÊºîÂá∫‰ªò„Åç„Éê„Éà„É´ÈñãÂßã
            const monsterData = monsters['maou'];
            battle.active = true;
            battle.enemy = {
                ...monsterData,
                currentHp: monsterData.hp,
                currentMp: monsterData.mp,
                status: { sleep: 0, poison: 0, blind: 0 },
                actionCount: 0  // 2ÂõûË°åÂãïÁî®„Ç´„Ç¶„É≥„Çø„Éº
            };
            battle.phase = 'start';
            battle.commandIndex = 0;
            battle.spellIndex = 0;
            battle.showSpells = false;
            battle.message = '';
            battle.messageQueue = [];
            battle.result = null;
            battle.flashCount = 12;  // È≠îÁéã„ÅØÊøÄ„Åó„ÅÑ„Éï„É©„ÉÉ„Ç∑„É•

            player.status = { sleep: 0, poison: 0, blind: 0 };
            gameMode = MODE.BATTLE;

            // ÊøÄ„Åó„ÅÑ„Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            const flashInterval = setInterval(() => {
                battle.flashCount--;
                if (battle.flashCount <= 0) {
                    clearInterval(flashInterval);
                    // È≠îÁéãÂ∞ÇÁî®„É°„ÉÉ„Çª„Éº„Ç∏
                    showBattleMessage('„Å§„ÅÑ„Å´ „Åç„Åü„Åã...', () => {
                        showBattleMessage('ÁßÅ„Åå È≠îÁéã„Å†ÔºÅ', () => {
                            screenShake.active = true;
                            screenShake.intensity = 8;
                            screenShake.duration = 30;
                            showBattleMessage('„Åè„Çâ„ÅàÔºÅ „Åì„ÅÆÂäõ„ÇíÔºÅ', () => {
                                battle.phase = 'command';
                            });
                        });
                    });
                }
            }, 80);
        }

        // È≠îÁéã„ÅÆAIË°åÂãïÈÅ∏Êäû
        function selectMaouAction() {
            const hpRatio = battle.enemy.currentHp / battle.enemy.hp;
            const skills = battle.enemy.skills;

            // HP50%‰ª•‰∏ã„Åß„Éô„Éõ„Éû„Çí‰Ωø„ÅÜÁ¢∫Áéá„Åå‰∏ä„Åå„Çã
            if (hpRatio < 0.5 && battle.enemy.currentMp >= 50 && Math.random() < 0.4) {
                return 'behoma';
            }

            // HP30%‰ª•‰∏ã„ÅßÂº∑Âäõ„Å™ÊîªÊíÉ„ÇíÂ§öÁî®
            if (hpRatio < 0.3) {
                const aggressiveSkills = ['ionazun', 'hageshiiHonoo'];
                return aggressiveSkills[Math.floor(Math.random() * aggressiveSkills.length)];
            }

            // ÈÄöÂ∏∏ÊôÇ„ÅØ„É©„É≥„ÉÄ„É†„Å´Ë°åÂãïÔºà„Éô„Éõ„Éû‰ª•Â§ñÔºâ
            const normalSkills = skills.filter(s => s !== 'behoma');
            return normalSkills[Math.floor(Math.random() * normalSkills.length)];
        }

        // È≠îÁéã„ÅÆ„Çπ„Ç≠„É´ÂÆüË°å
        function executeMaouSkill(skillId, callback) {
            if (skillId === 'attack') {
                // ÈÄöÂ∏∏ÊîªÊíÉ
                const def = getPlayerDef();
                const damage = Math.max(1, Math.floor(battle.enemy.atk / 2 - def / 4 + Math.random() * 10));
                player.hp -= damage;

                screenShake.active = true;
                screenShake.intensity = 5;
                screenShake.duration = 15;

                showBattleMessage(`È≠îÁéã „ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                    if (player.hp <= 0) {
                        player.hp = 0;
                        battleLose();
                    } else {
                        callback();
                    }
                });
            } else {
                const skill = bossSkills[skillId];
                if (!skill) {
                    callback();
                    return;
                }

                // „Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
                if (skill.flashColor) {
                    startSpellFlash(skill.flashColor);
                }

                // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØÔºàÊîªÊíÉ„Çπ„Ç≠„É´„ÅÆ„ÅøÔºâ
                if (skill.type === 'attack') {
                    screenShake.active = true;
                    screenShake.intensity = 10;
                    screenShake.duration = 20;
                }

                showBattleMessage(`È≠îÁéã „ÅØ ${skill.name} „Çí „ÅØ„Å™„Å£„ÅüÔºÅ`, () => {
                    if (skill.type === 'heal') {
                        battle.enemy.currentHp = Math.min(battle.enemy.hp, battle.enemy.currentHp + skill.power);
                        showBattleMessage(`È≠îÁéã „ÅÆ HP„Åå „Åã„ÅÑ„Åµ„Åè„Åó„ÅüÔºÅ`, () => {
                            callback();
                        });
                    } else if (skill.type === 'attack') {
                        const damage = skill.power + Math.floor(Math.random() * 15);
                        player.hp -= damage;
                        showBattleMessage(`„ÇÜ„ÅÜ„Åó„ÇÉ „Å´ ${damage} „ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`, () => {
                            if (player.hp <= 0) {
                                player.hp = 0;
                                battleLose();
                            } else {
                                callback();
                            }
                        });
                    } else {
                        callback();
                    }
                });
            }
        }

        // È≠îÁéã„ÅÆ2ÂõûË°åÂãï„Çø„Éº„É≥
        function maouTurn() {
            battle.phase = 'enemyTurn';
            battle.enemy.actionCount = 0;
            executeMaouActions();
        }

        function executeMaouActions() {
            // Áú†„Çä„ÉÅ„Çß„ÉÉ„ÇØ
            const wakeResult = checkWakeUp(battle.enemy, 'È≠îÁéã');
            if (!wakeResult.awake) {
                showBattleMessage(wakeResult.message, () => {
                    processEnemyTurnEnd();
                });
                return;
            }
            if (wakeResult.message) {
                showBattleMessage(wakeResult.message, () => {
                    doMaouAction();
                });
                return;
            }
            doMaouAction();
        }

        function doMaouAction() {
            const skillId = selectMaouAction();
            battle.enemy.actionCount++;

            executeMaouSkill(skillId, () => {
                // 2ÂõûË°åÂãï„ÉÅ„Çß„ÉÉ„ÇØ
                if (battle.enemy.actionCount < battle.enemy.actions && player.hp > 0) {
                    showBattleMessage('È≠îÁéã „ÅØ „Åï„Çâ„Å´ „Åì„ÅÜ„Åí„Åç„Çí „Åó„Åã„Åë„Å¶„Åç„ÅüÔºÅ', () => {
                        doMaouAction();
                    });
                } else {
                    processEnemyTurnEnd();
                }
            });
        }

        // ========================================
        // ÂÖ•ÂäõÂá¶ÁêÜ
        // ========================================
        document.addEventListener('keydown', (e) => {
            if (isTransitioning) return;

            // „Çø„Ç§„Éà„É´ÁîªÈù¢
            if (gameMode === MODE.TITLE) {
                if (!titleMenuActive) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        activateTitleMenu();
                    }
                } else {
                    const menuCount = hasSaveData ? 2 : 1;
                    switch (e.key) {
                        case 'ArrowUp': case 'w': case 'W':
                            titleMenuIndex = Math.max(0, titleMenuIndex - 1);
                            updateTitleMenuSelection();
                            break;
                        case 'ArrowDown': case 's': case 'S':
                            titleMenuIndex = Math.min(menuCount - 1, titleMenuIndex + 1);
                            updateTitleMenuSelection();
                            break;
                        case 'Enter': case ' ': case 'z':
                            selectTitleMenuItem();
                            break;
                    }
                }
                e.preventDefault();
                return;
            }

            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞‰∏≠
            if (gameMode === MODE.ENDING) {
                handleEndingInput();
                return;
            }

            // „Éê„Éà„É´‰∏≠
            if (gameMode === MODE.BATTLE) {
                if (battle.phase === 'command') {
                    if (battle.showSpells) {
                        switch (e.key) {
                            case 'ArrowUp': case 'w': case 'W':
                                battle.spellIndex = Math.max(0, battle.spellIndex - 1);
                                break;
                            case 'ArrowDown': case 's': case 'S':
                                battle.spellIndex = Math.min(player.spells.length - 1, battle.spellIndex + 1);
                                break;
                            case 'Enter': case ' ': case 'z':
                                executeBattleCommand();
                                break;
                            case 'Escape': case 'x': case 'b': case 'B':
                                battle.showSpells = false;
                                break;
                        }
                    } else {
                        switch (e.key) {
                            case 'ArrowUp': case 'w': case 'W':
                                battle.commandIndex = Math.max(0, battle.commandIndex - 1);
                                break;
                            case 'ArrowDown': case 's': case 'S':
                                battle.commandIndex = Math.min(2, battle.commandIndex + 1);
                                break;
                            case 'Enter': case ' ': case 'z':
                                executeBattleCommand();
                                break;
                        }
                    }
                }
                e.preventDefault();
                return;
            }

            // „Ç∑„Éß„ÉÉ„Éó
            if (shop.active) {
                switch (e.key) {
                    case 'ArrowUp': case 'w': case 'W':
                        handleShopInput('up');
                        break;
                    case 'ArrowDown': case 's': case 'S':
                        handleShopInput('down');
                        break;
                    case 'ArrowLeft': case 'a': case 'A':
                        handleShopInput('left');
                        break;
                    case 'ArrowRight': case 'd': case 'D':
                        handleShopInput('right');
                        break;
                    case 'Enter': case ' ': case 'z':
                        handleShopInput('confirm');
                        break;
                    case 'Escape': case 'x': case 'b': case 'B':
                        handleShopInput('cancel');
                        break;
                }
                e.preventDefault();
                return;
            }

            // ÂÆøÂ±ã
            if (inn.active) {
                switch (e.key) {
                    case 'ArrowLeft': case 'a': case 'A':
                        inn.selectedIndex = 0;
                        break;
                    case 'ArrowRight': case 'd': case 'D':
                        inn.selectedIndex = 1;
                        break;
                    case 'Enter': case ' ': case 'z':
                        confirmInn();
                        break;
                    case 'Escape': case 'x': case 'b': case 'B':
                        closeInn();
                        startDialog(['„Åæ„Åü„ÅÆ„ÅäË∂ä„Åó„Çí „Åä„Åæ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ']);
                        break;
                }
                e.preventDefault();
                return;
            }

            // „Éï„Ç£„Éº„É´„Éâ
            if (menu.active) {
                if (menu.showItemAction) {
                    // „Ç¢„Ç§„ÉÜ„É†„Ç¢„ÇØ„Ç∑„Éß„É≥„Çµ„Éñ„É°„Éã„É•„ÉºÊìç‰Ωú
                    switch (e.key) {
                        case 'ArrowUp': case 'w': case 'W':
                            menu.itemActionIndex = (menu.itemActionIndex + 2) % 3;
                            break;
                        case 'ArrowDown': case 's': case 'S':
                            menu.itemActionIndex = (menu.itemActionIndex + 1) % 3;
                            break;
                        case 'Enter': case ' ': case 'z': case 'Z':
                            executeItemAction();
                            break;
                        case 'Escape': case 'x': case 'b': case 'B':
                            menu.showItemAction = false;
                            break;
                    }
                } else if (menu.mode === 'items' && player.inventory.length > 0) {
                    // „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„ÉàÊìç‰Ωú
                    switch (e.key) {
                        case 'ArrowUp': case 'w': case 'W':
                            menu.itemCursor = (menu.itemCursor + player.inventory.length - 1) % player.inventory.length;
                            break;
                        case 'ArrowDown': case 's': case 'S':
                            menu.itemCursor = (menu.itemCursor + 1) % player.inventory.length;
                            break;
                        case 'ArrowLeft': case 'a': case 'A':
                            menu.mode = 'status';
                            break;
                        case 'ArrowRight': case 'd': case 'D':
                            // Êó¢„Å´items„É¢„Éº„Éâ„Å™„ÅÆ„Åß‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                            break;
                        case 'Enter': case ' ': case 'z': case 'Z':
                            menu.showItemAction = true;
                            menu.itemActionIndex = 0;
                            break;
                        case 'Escape': case 'x': case 'b': case 'B':
                            closeMenu();
                            break;
                    }
                } else {
                    // „Çø„ÉñÂàá„ÇäÊõø„Åà„É¢„Éº„Éâ
                    switch (e.key) {
                        case 'ArrowLeft': case 'a': case 'A':
                            menu.mode = 'status';
                            break;
                        case 'ArrowRight': case 'd': case 'D':
                            menu.mode = 'items';
                            menu.itemCursor = 0;
                            break;
                        case 'Escape': case 'x': case 'b': case 'B':
                            closeMenu();
                            break;
                    }
                }
                e.preventDefault();
                return;
            }

            if (dialog.active) {
                if (e.key === 'Enter' || e.key === ' ' || e.key === 'z') {
                    advanceDialog();
                    e.preventDefault();
                }
                return;
            }

            switch (e.key) {
                case 'ArrowUp': case 'w': case 'W': startContinuousMove(0, -1); break;
                case 'ArrowDown': case 's': case 'S': startContinuousMove(0, 1); break;
                case 'ArrowLeft': case 'a': case 'A': startContinuousMove(-1, 0); break;
                case 'ArrowRight': case 'd': case 'D': startContinuousMove(1, 0); break;
                case 'Enter': case ' ': case 'z': interact(); break;
                case 'Escape': case 'x': case 'b': case 'B': openMenu(); break;
            }
            e.preventDefault();
        });

        // „Ç≠„Éº„ÇíÈõ¢„Åó„ÅüÊôÇ„Å´ÈÄ£Á∂öÁßªÂãï„ÇíÂÅúÊ≠¢
        document.addEventListener('keyup', (e) => {
            switch (e.key) {
                case 'ArrowUp': case 'w': case 'W':
                case 'ArrowDown': case 's': case 'S':
                case 'ArrowLeft': case 'a': case 'A':
                case 'ArrowRight': case 'd': case 'D':
                    stopContinuousMove();
                    break;
            }
        });

        // ÈÄ£Á∂öÁßªÂãï„ÅÆÈñãÂßã
        function startContinuousMove(dx, dy) {
            // Êó¢Â≠ò„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´„Çí„ÇØ„É™„Ç¢ÔºàÊñπÂêë„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑÔºâ
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            currentMoveDirection = { dx, dy };
            movePlayer(dx, dy);  // Âç≥Â∫ß„Å´1ÂõûÁßªÂãï
            moveInterval = setInterval(() => {
                if (gameMode === MODE.FIELD && !isTransitioning && !dialog.active &&
                    !menu.active && !inn.active && !shop.active) {
                    movePlayer(currentMoveDirection.dx, currentMoveDirection.dy);
                }
            }, CONTINUOUS_MOVE_DELAY);
        }

        // ÈÄ£Á∂öÁßªÂãï„ÅÆÂÅúÊ≠¢
        function stopContinuousMove() {
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            currentMoveDirection = { dx: 0, dy: 0 };
        }

        // „Çø„ÉÉ„ÉÅ„Éú„Çø„É≥
        function setupDpadButton(id, dx, dy) {
            const btn = document.getElementById(id);
            const handlePress = (e) => {
                e.preventDefault();
                // „Éê„Éà„É´‰∏≠
                if (gameMode === MODE.BATTLE && battle.phase === 'command') {
                    if (dy < 0) {
                        if (battle.showSpells) battle.spellIndex = Math.max(0, battle.spellIndex - 1);
                        else battle.commandIndex = Math.max(0, battle.commandIndex - 1);
                    } else if (dy > 0) {
                        if (battle.showSpells) battle.spellIndex = Math.min(player.spells.length - 1, battle.spellIndex + 1);
                        else battle.commandIndex = Math.min(2, battle.commandIndex + 1);
                    }
                    return;
                }
                // „Ç∑„Éß„ÉÉ„Éó
                if (shop.active) {
                    if (dy < 0) handleShopInput('up');
                    else if (dy > 0) handleShopInput('down');
                    else if (dx < 0) handleShopInput('left');
                    else if (dx > 0) handleShopInput('right');
                    return;
                }
                // ÂÆøÂ±ã
                if (inn.active) {
                    if (dx < 0) inn.selectedIndex = 0;
                    else if (dx > 0) inn.selectedIndex = 1;
                    return;
                }
                // „É°„Éã„É•„Éº
                if (menu.active) {
                    if (dx < 0) menu.mode = 'status';
                    else if (dx > 0) menu.mode = 'items';
                    return;
                }
                if (isTransitioning || dialog.active) return;
                btn.classList.add('pressed');
                // ÈÄ£Á∂öÁßªÂãï„ÇíÈñãÂßã
                startContinuousMove(dx, dy);
            };
            const handleRelease = () => {
                btn.classList.remove('pressed');
                stopContinuousMove();
            };
            btn.addEventListener('touchstart', handlePress, { passive: false });
            btn.addEventListener('touchend', handleRelease);
            btn.addEventListener('mousedown', handlePress);
            btn.addEventListener('mouseup', handleRelease);
            btn.addEventListener('mouseleave', handleRelease);
        }

        setupDpadButton('dpad-up', 0, -1);
        setupDpadButton('dpad-down', 0, 1);
        setupDpadButton('dpad-left', -1, 0);
        setupDpadButton('dpad-right', 1, 0);

        function setupActionButton(id, callback) {
            const btn = document.getElementById(id);
            const handlePress = (e) => { e.preventDefault(); btn.classList.add('pressed'); callback(); };
            const handleRelease = () => { btn.classList.remove('pressed'); };
            btn.addEventListener('touchstart', handlePress, { passive: false });
            btn.addEventListener('touchend', handleRelease);
            btn.addEventListener('mousedown', handlePress);
            btn.addEventListener('mouseup', handleRelease);
            btn.addEventListener('mouseleave', handleRelease);
        }

        function onActionA() {
            if (isTransitioning) return;
            if (gameMode === MODE.BATTLE && battle.phase === 'command') {
                executeBattleCommand();
            } else if (shop.active) {
                handleShopInput('confirm');
            } else if (inn.active) {
                confirmInn();
            } else {
                interact();
            }
        }

        function onActionB() {
            if (gameMode === MODE.BATTLE && battle.showSpells) {
                battle.showSpells = false;
            } else if (shop.active) {
                handleShopInput('cancel');
            } else if (inn.active) {
                closeInn();
                startDialog(['„Åæ„Åü„ÅÆ„ÅäË∂ä„Åó„Çí „Åä„Åæ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ']);
            } else if (dialog.active) {
                closeDialog();
            } else if (menu.active) {
                closeMenu();
            } else {
                openMenu();
            }
        }

        setupActionButton('btn-a', onActionA);
        setupActionButton('btn-b', onActionB);

        // ========================================
        // „Ç≤„Éº„É†„É´„Éº„Éó
        // ========================================

        // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Êõ¥Êñ∞Ôºà„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„ÅßÁÑ°ÂäπÂåñÂèØËÉΩÔºâ
        const encounterDebugElement = document.getElementById('encounterDebug');
        function updateEncounterDebug() {
            if (!encounterDebugElement) return;
            const rate = getCurrentEncounterRate();
            encounterDebugElement.textContent = `Ê≠©Êï∞: ${stepsSinceLastBattle} | Á¢∫Áéá: ${(rate * 100).toFixed(1)}%`;
        }

        function gameLoop() {
            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÅÆ„Çπ„Çø„ÉÉ„Éï„É≠„Éº„É´Êõ¥Êñ∞
            updateStaffRoll();

            // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Êõ¥Êñ∞
            updateEncounterDebug();

            draw();
            requestAnimationFrame(gameLoop);
        }

        // ========================================
        // „Çø„Ç§„Éà„É´ÁîªÈù¢
        // ========================================
        const titleScreen = document.getElementById('titleScreen');
        const menuContinue = document.getElementById('menu-continue');
        const menuNewGame = document.getElementById('menu-newgame');
        const pressStart = document.getElementById('pressStart');
        const titleMenu = document.querySelector('.title-menu');

        function checkSaveData() {
            const savedData = localStorage.getItem(SAVE_KEY);
            hasSaveData = savedData !== null;
            return hasSaveData;
        }

        function initTitleScreen() {
            checkSaveData();

            if (hasSaveData) {
                menuContinue.style.display = 'flex';
                titleMenuIndex = 0; // Á∂ö„Åç„Åã„Çâ„Åå„Éá„Éï„Ç©„É´„Éà
            } else {
                menuContinue.style.display = 'none';
                titleMenuIndex = 0;
            }

            titleMenuActive = false;
            pressStart.style.display = 'block';
            titleMenu.classList.remove('active');
            updateTitleMenuSelection();
        }

        function updateTitleMenuSelection() {
            const items = titleMenu.querySelectorAll('.menu-item');
            items.forEach((item, index) => {
                if (item.style.display !== 'none') {
                    const actualIndex = hasSaveData ? index : index - 1;
                    item.classList.toggle('selected', actualIndex === titleMenuIndex || (!hasSaveData && index === 1 && titleMenuIndex === 0));
                }
            });
        }

        function activateTitleMenu() {
            if (titleMenuActive) return;
            titleMenuActive = true;
            pressStart.style.display = 'none';
            titleMenu.classList.add('active');
            updateTitleMenuSelection();
        }

        async function selectTitleMenuItem() {
            if (!titleMenuActive) {
                activateTitleMenu();
                return;
            }

            console.log('[DEBUG] selectTitleMenuItemÈñãÂßã');
            console.log('[DEBUG] hasSaveData:', hasSaveData, 'titleMenuIndex:', titleMenuIndex);

            // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
            const fadeOverlay = document.getElementById('fadeOverlay');
            fadeOverlay.classList.add('active');

            await new Promise(resolve => setTimeout(resolve, 300));

            // „Çø„Ç§„Éà„É´ÁîªÈù¢„ÇíÈùûË°®Á§∫
            titleScreen.classList.add('hidden');
            gameMode = MODE.FIELD;
            console.log('[DEBUG] gameModeÂ§âÊõ¥:', gameMode);

            if (hasSaveData && titleMenuIndex === 0) {
                // Á∂ö„Åç„Åã„Çâ
                console.log('[DEBUG] Á∂ö„Åç„Åã„Çâ„ÇíÈÅ∏Êäû');
                await loadGame();
            } else {
                // „ÅØ„Åò„ÇÅ„Åã„ÇâÔºà„Çª„Éº„Éñ„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢Ôºâ
                console.log('[DEBUG] „ÅØ„Åò„ÇÅ„Åã„Çâ„ÇíÈÅ∏Êäû');
                localStorage.removeItem(SAVE_KEY);
                await resetGameState();
                updateActualStats();
                console.log('[DEBUG] resetGameStateÂÆå‰∫Ü');
                console.log('[DEBUG] currentMap:', currentMap);
                console.log('[DEBUG] currentMap.dataÂ≠òÂú®:', !!currentMap.data, 'rows:', currentMap.rows, 'cols:', currentMap.cols);
                console.log('[DEBUG] player:', player.x, player.y);
            }

            // „Éû„ÉÉ„ÉóÂêç„ÇíÊõ¥Êñ∞
            document.getElementById('mapName').textContent = currentMap.name || '„Éï„Ç£„Éº„É´„Éâ';

            console.log('[DEBUG] resizeÂâç tileSize:', tileSize, 'canvasWidth:', canvasWidth);
            resize();
            console.log('[DEBUG] resizeÂæå tileSize:', tileSize, 'canvasWidth:', canvasWidth);
            updateCamera();
            console.log('[DEBUG] updateCameraÂæå cameraX:', cameraX, 'cameraY:', cameraY);

            // „Éï„Çß„Éº„Éâ„Ç§„É≥
            await new Promise(resolve => setTimeout(resolve, 100));
            fadeOverlay.classList.remove('active');
            console.log('[DEBUG] „Éï„Çß„Éº„Éâ„Ç§„É≥ÂÆå‰∫Ü, gameMode:', gameMode);
        }

        async function resetGameState() {
            // „Éó„É¨„Ç§„É§„Éº„ÇíÂàùÊúüÁä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà
            player.x = 4;
            player.y = 11;
            player.hp = 30;
            player.maxHp = 30;
            player.mp = 10;
            player.maxMp = 10;
            player.level = 1;
            player.exp = 0;
            player.gold = 50;
            player.baseAttack = 5;
            player.baseDefense = 3;
            player.attack = 5;
            player.defense = 3;
            player.weapon = null;
            player.armor = null;
            player.shield = null;
            player.helmet = null;
            player.accessory = null;
            player.spells = [];
            player.statusEffects = [];

            // „Ç§„É≥„Éô„É≥„Éà„É™„Çí„É™„Çª„ÉÉ„Éà
            player.inventory = [{ id: 1, quantity: 3 }];

            // „Éû„ÉÉ„Éó„Çí„É™„Çª„ÉÉ„ÉàÔºàÂ§ñÈÉ®JSON„ÇíÂÑ™ÂÖà„Åó„Å¶„É≠„Éº„ÉâÔºâ
            currentMapId = 'field';
            currentMapPath = 'maps/field.json';

            try {
                const mapData = await loadMapFromDatabase(currentMapPath);
                // Â§ñÈÉ®JSON„Éû„ÉÉ„Éó„Åß„ÅÇ„Çã„Åì„Å®„Çí„Éû„Éº„ÇØ
                mapData._isExternal = true;
                currentMap = {
                    data: mapData.data.map(row => [...row]),
                    cols: mapData.cols,
                    rows: mapData.rows,
                    npcs: JSON.parse(JSON.stringify(mapData.npcs || [])),
                    chests: JSON.parse(JSON.stringify(mapData.chests || [])),
                    warps: mapData.warps ? [...mapData.warps] : [],
                    name: mapData.name,
                    type: mapData.type,
                    encounterRate: mapData.encounterRate,
                    mapId: mapData.mapId,
                    _isExternal: true
                };
                maps[mapData.mapId] = mapData;
            } catch (err) {
                console.error('„Éû„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº„ÄÅÂÜÖËîµ„Éû„ÉÉ„Éó„Çí‰ΩøÁî®:', err);
                const fieldMap = maps.field;
                currentMap = {
                    data: fieldMap.data.map(row => [...row]),
                    cols: fieldMap.cols,
                    rows: fieldMap.rows,
                    npcs: JSON.parse(JSON.stringify(fieldMap.npcs)),
                    chests: JSON.parse(JSON.stringify(fieldMap.chests)),
                    warps: fieldMap.warps ? [...fieldMap.warps] : [],
                    name: fieldMap.name,
                    type: fieldMap.type,
                    encounterRate: fieldMap.encounterRate
                };
            }

            // ÂÆùÁÆ±„ÅÆÈñãÂ∞ÅÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÂÜÖÈÉ®„Éû„ÉÉ„ÉóÁî®Ôºâ
            for (const mapId in maps) {
                if (maps[mapId].chests) {
                    maps[mapId].chests.forEach(chest => chest.isOpened = false);
                }
            }

            // „Ç≤„Éº„É†„ÇØ„É™„Ç¢„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
            if (typeof gameCleared !== 'undefined') {
                gameCleared = false;
            }
        }

        // „Çø„Ç§„Éà„É´ÁîªÈù¢„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        menuContinue.addEventListener('click', () => {
            if (gameMode === MODE.TITLE) {
                titleMenuIndex = 0;
                updateTitleMenuSelection();
                selectTitleMenuItem();
            }
        });

        menuNewGame.addEventListener('click', () => {
            if (gameMode === MODE.TITLE) {
                titleMenuIndex = hasSaveData ? 1 : 0;
                updateTitleMenuSelection();
                selectTitleMenuItem();
            }
        });

        titleScreen.addEventListener('click', (e) => {
            if (gameMode === MODE.TITLE && !titleMenuActive) {
                activateTitleMenu();
            }
        });

        // ========================================
        // ÂàùÊúüÂåñ
        // ========================================
        window.addEventListener('resize', resize);

        // ÈùûÂêåÊúüÂàùÊúüÂåñ
        async function initGame() {
            initTitleScreen();
            resize();
            gameLoop();
        }

        initGame();
        document.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
</body>
</html>
