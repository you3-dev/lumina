// This is the complete drawBattle implementation extracted from index_6c69ad3.html
// To be inserted into renderer.js at line 635

export function drawBattle() {
    if (!battle.active) return;

    // ãƒãƒˆãƒ«èƒŒæ™¯
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, canvasWidth, canvasHeight);

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³æ¼”å‡º
    if (battle.fadeAlpha > 0) {
        ctx.fillStyle = `rgba(0, 0, 0, ${battle.fadeAlpha})`;
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    // å‘ªæ–‡ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º
    const spellFlash = { active: false, color: '', alpha: 0 };
    if (spellFlash.active && spellFlash.alpha > 0) {
        const baseColor = spellFlash.color.replace(/[\d.]+\)$/, `${spellFlash.alpha})`);
        ctx.fillStyle = baseColor;
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    // è¤‡æ•°ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¡¨ç¤º
    if (battle.enemies && battle.enemies.length > 0) {
        const enemyCount = battle.enemies.length;
        const spacing = canvasWidth / (enemyCount + 1);
        const spriteSize = enemyCount === 1 ? tileSize * 4 : tileSize * (3 - enemyCount * 0.3);

        battle.enemies.forEach((enemy, idx) => {
            const x = spacing * (idx + 1);
            const y = canvasHeight * 0.35;

            // æ­»äº¡ã—ã¦ã„ã‚‹æ•µã¯è–„ãè¡¨ç¤º
            const isDead = enemy.currentHp <= 0;
            if (isDead) {
                ctx.globalAlpha = 0.3;
            }

            // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ
            ctx.font = `${spriteSize}px serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // è‰²é•ã„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å¯¾å¿œï¼ˆhueRotateãƒ•ã‚£ãƒ«ã‚¿ï¼‰
            if (enemy.hueRotate) {
                ctx.save();
                ctx.filter = `hue-rotate(${enemy.hueRotate}deg)`;
                ctx.fillText(enemy.sprite, x, y);
                ctx.restore();
            } else {
                ctx.fillText(enemy.sprite, x, y);
            }

            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠä¸­ã®ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤º
            if (battle.isSelectingTarget && idx === battle.targetIndex && !isDead) {
                ctx.fillStyle = '#ffd700';
                ctx.font = `${tileSize * 0.8}px serif`;
                ctx.fillText('ğŸ‘†', x, y - spriteSize / 2 - tileSize * 0.3);
            }

            // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åï¼ˆå„æ•µã®ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®ä¸‹ã«å€‹åˆ¥è¡¨ç¤ºã€å¥‡æ•°ãƒ»å¶æ•°ã§Yåº§æ¨™ã‚’ãšã‚‰ã™ï¼‰
            const nameYOffset = idx % 2 === 0 ? 0 : tileSize * 0.5;
            const nameY = y + spriteSize / 2 + tileSize * 0.4 + nameYOffset;
            ctx.fillStyle = isDead ? '#888' : '#fff';
            ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.fillText(enemy.displayName, x, nameY);

            // å€’ã—ãŸè¡¨ç¤ºï¼ˆHPã¯éè¡¨ç¤ºã§ç·Šå¼µæ„Ÿã‚’æ¼”å‡ºï¼‰
            if (isDead && (battle.phase === 'command' || battle.phase === 'target')) {
                ctx.fillStyle = '#888';
                ctx.font = `${tileSize * 0.3}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.fillText('å€’ã—ãŸ', x, nameY + tileSize * 0.4);
            }

            // çŠ¶æ…‹ç•°å¸¸ãƒãƒƒã‚¸ã‚’åå‰ã®ä¸‹ã«è¡¨ç¤º
            if (!isDead) {
                const enemyStatusBadge = getStatusBadges(enemy);
                if (enemyStatusBadge) {
                    ctx.fillStyle = '#f88';
                    ctx.font = `${tileSize * 0.3}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    ctx.fillText(enemyStatusBadge, x, nameY + tileSize * 0.4);
                }
            }

            ctx.globalAlpha = 1.0;
        });
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
    const aliveMembers = getAlivePartyMembers();
    const memberCount = party.length;
    const memberRowH = tileSize * 0.9;
    const statusW = canvasWidth * 0.85;
    const statusH = Math.max(tileSize * 2.5, 20 + memberRowH * memberCount);
    const statusX = 10;
    const statusY = 10;
    drawWindow(statusX, statusY, statusW, statusH);

    ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';

    // å„ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    party.forEach((member, idx) => {
        const rowY = statusY + 12 + idx * memberRowH;
        const isDead = !member.isAlive || member.hp <= 0;

        // ã‚³ãƒãƒ³ãƒ‰å…¥åŠ›ä¸­ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        if (battle.phase === 'command' && idx === battle.currentPartyIndex) {
            ctx.fillStyle = 'rgba(255, 215, 0, 0.2)';
            ctx.fillRect(statusX + 5, rowY - 2, statusW - 10, memberRowH - 2);
        }

        // å‘³æ–¹é¸æŠä¸­ã®ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤º
        if (battle.isSelectingAlly && idx === battle.allyTargetIndex) {
            ctx.fillStyle = 'rgba(0, 255, 100, 0.3)';
            ctx.fillRect(statusX + 5, rowY - 2, statusW - 10, memberRowH - 2);
            ctx.fillStyle = '#ffd700';
            ctx.font = `${tileSize * 0.4}px serif`;
            ctx.fillText('â–¶', statusX + 2, rowY);
        }

        // æˆ¦é—˜ä¸èƒ½ã¯æš—ãè¡¨ç¤º
        ctx.fillStyle = isDead ? '#666' : '#fff';

        // åå‰ã¨ãƒ¬ãƒ™ãƒ«
        const nameText = `${member.name} Lv${member.level}`;
        ctx.fillText(nameText, statusX + 12, rowY);

        // HP/MP
        const hpColor = member.hp <= member.maxHp * 0.25 ? '#f44' : (member.hp <= member.maxHp * 0.5 ? '#ff0' : '#8f8');
        const mpColor = member.mp <= member.maxMp * 0.25 ? '#f88' : '#8cf';

        ctx.fillStyle = isDead ? '#444' : hpColor;
        ctx.fillText(`HP:${member.hp}/${member.maxHp}`, statusX + 12 + tileSize * 3.2, rowY);

        ctx.fillStyle = isDead ? '#444' : mpColor;
        ctx.fillText(`MP:${member.mp}/${member.maxMp}`, statusX + 12 + tileSize * 5.5, rowY);

        // çŠ¶æ…‹ç•°å¸¸ãƒãƒƒã‚¸
        const memberBadge = getStatusBadges(member);
        if (memberBadge && !isDead) {
            ctx.fillStyle = '#f88';
            ctx.fillText(memberBadge, statusX + statusW - 50, rowY);
        }
    });

    // ãƒãƒ•çŠ¶æ…‹ãƒãƒƒã‚¸ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£å…¨ä½“ï¼‰
    const buffBadges = getBuffBadges();
    if (buffBadges) {
        ctx.fillStyle = '#8f8';
        ctx.font = `${tileSize * 0.3}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
        ctx.fillText(buffBadges, statusX + statusW - 80, statusY + statusH - 18);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
    const msgPadding = 15;
    const msgWindowWidth = canvasWidth - 20;
    const msgMaxTextWidth = msgWindowWidth - msgPadding * 2;
    const msgFontSize = Math.floor(tileSize * 0.42);
    const msgLineHeight = msgFontSize * 1.4;
    const msgFont = `${msgFontSize}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;

    // æŠ˜ã‚Šè¿”ã—è¡Œæ•°ã«å¿œã˜ã¦ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é«˜ã•ã‚’èª¿æ•´
    const msgLines = wrapText(battle.message || '', msgMaxTextWidth, msgFont);
    const msgNumLines = Math.max(2, msgLines.length);
    const msgH = msgPadding * 2 + msgLineHeight * msgNumLines;
    const msgY = canvasHeight - msgH - 180;
    drawWindow(10, msgY, msgWindowWidth, msgH);

    ctx.fillStyle = '#fff';
    ctx.font = msgFont;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    for (let i = 0; i < msgLines.length; i++) {
        ctx.fillText(msgLines[i], 10 + msgPadding, msgY + msgPadding + i * msgLineHeight);
    }

    // ã‚³ãƒãƒ³ãƒ‰ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
    if (battle.phase === 'command') {
        const cmdW = canvasWidth * 0.45;
        const cmdH = tileSize * 3.7;
        const cmdX = canvasWidth - cmdW - 10;
        const cmdY = canvasHeight - cmdH - 10;
        drawWindow(cmdX, cmdY, cmdW, cmdH);

        const commands = ['ãŸãŸã‹ã†', 'ã˜ã‚…ã‚‚ã‚“', 'ã©ã†ã', 'ã«ã’ã‚‹'];
        ctx.font = `${tileSize * 0.5}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;

        commands.forEach((cmd, i) => {
            const y = cmdY + 20 + i * tileSize * 0.7;
            if (i === battle.commandIndex) {
                ctx.fillStyle = '#ffd700';
                ctx.fillText('â–¶', cmdX + 15, y);
            }
            ctx.fillStyle = '#fff';
            ctx.fillText(cmd, cmdX + 40, y);
        });

        // å‘ªæ–‡ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œï¼‰
        if (battle.showSpells) {
            const currentMember = getCurrentPartyMember();
            const validSpells = currentMember.spells.filter(id => spells[id]);
            const maxVisibleSpells = 5; // æœ€å¤§è¡¨ç¤ºä»¶æ•°
            const spellW = cmdW * 1.1;
            const rowHeight = tileSize * 0.6;
            const visibleCount = Math.min(validSpells.length, maxVisibleSpells);
            const spellH = rowHeight * visibleCount + 40; // ä¸Šä¸‹ä½™ç™½å«ã‚€
            const spellX = cmdX - spellW - 10;
            const spellY = cmdY;
            drawWindow(spellX, spellY, spellW, spellH);

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—ï¼ˆã‚«ãƒ¼ã‚½ãƒ«ãŒå¸¸ã«è¡¨ç¤ºç¯„å›²å†…ã«ãªã‚‹ã‚ˆã†èª¿æ•´ï¼‰
            let scrollOffset = 0;
            if (validSpells.length > maxVisibleSpells) {
                // ã‚«ãƒ¼ã‚½ãƒ«ãŒä¸‹ç«¯ã‚’è¶…ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (battle.spellIndex >= maxVisibleSpells) {
                    scrollOffset = Math.min(
                        battle.spellIndex - maxVisibleSpells + 1,
                        validSpells.length - maxVisibleSpells
                    );
                }
            }

            // ä¸ŠçŸ¢å°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªå ´åˆï¼‰
            if (scrollOffset > 0) {
                ctx.fillStyle = '#ffd700';
                ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.textAlign = 'center';
                ctx.fillText('â–²', spellX + spellW / 2, spellY + 12);
                ctx.textAlign = 'left';
            }

            // å‘ªæ–‡ãƒªã‚¹ãƒˆæç”»
            for (let i = 0; i < visibleCount; i++) {
                const spellIdx = i + scrollOffset;
                if (spellIdx >= validSpells.length) break;

                const spellId = validSpells[spellIdx];
                const spell = spells[spellId];
                const y = spellY + 22 + i * rowHeight;
                const canUse = currentMember.mp >= spell.mp;

                // é¸æŠã‚«ãƒ¼ã‚½ãƒ«
                if (spellIdx === battle.spellIndex) {
                    ctx.fillStyle = canUse ? '#ffd700' : '#888';
                    ctx.fillText('â–¶', spellX + 10, y);
                }

                // å‘ªæ–‡åã¨MPï¼ˆMPä¸è¶³ã¯ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
                ctx.fillStyle = canUse ? '#fff' : '#555';
                ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.fillText(`${spell.name}`, spellX + 30, y);

                // MPæ¶ˆè²»é‡
                ctx.fillStyle = canUse ? '#8cf' : '#444';
                ctx.fillText(`${spell.mp}`, spellX + spellW - 40, y);
            }

            // ä¸‹çŸ¢å°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªå ´åˆï¼‰
            if (scrollOffset + maxVisibleSpells < validSpells.length) {
                ctx.fillStyle = '#ffd700';
                ctx.font = `${tileSize * 0.35}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.textAlign = 'center';
                ctx.fillText('â–¼', spellX + spellW / 2, spellY + spellH - 18);
                ctx.textAlign = 'left';
            }

            // æ“ä½œã‚¬ã‚¤ãƒ‰
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.font = `${tileSize * 0.25}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.fillText('B:ã‚‚ã©ã‚‹', spellX + 10, spellY + spellH - 8);
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œï¼‰
        if (battle.showItems) {
            // æœ‰åŠ¹ãªã‚¢ã‚¤ãƒ†ãƒ ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆéš™é–“é˜²æ­¢ï¼‰
            const validItems = player.inventory.filter(slot => items[slot.id]);
            const maxVisibleItems = 5; // æœ€å¤§è¡¨ç¤ºä»¶æ•°
            const itemW = cmdW * 1.3;
            const rowHeight = tileSize * 0.6;
            const visibleCount = Math.min(validItems.length, maxVisibleItems);
            const itemH = rowHeight * Math.max(1, visibleCount) + 40;
            const itemX = cmdX - itemW - 10;
            const itemY = cmdY;
            drawWindow(itemX, itemY, itemW, itemH);

            if (validItems.length === 0) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                ctx.fillText('ã©ã†ããŒãªã„', itemX + 20, itemY + 30);
            } else {
                // ã‚«ãƒ¼ã‚½ãƒ«ãŒæœ‰åŠ¹ç¯„å›²ã‚’è¶…ãˆãªã„ã‚ˆã†èª¿æ•´
                if (battle.itemCursor >= validItems.length) {
                    battle.itemCursor = Math.max(0, validItems.length - 1);
                }

                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—
                let itemScrollOffset = 0;
                if (validItems.length > maxVisibleItems) {
                    if (battle.itemCursor >= maxVisibleItems) {
                        itemScrollOffset = Math.min(
                            battle.itemCursor - maxVisibleItems + 1,
                            validItems.length - maxVisibleItems
                        );
                    }
                }

                // ä¸ŠçŸ¢å°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªå ´åˆï¼‰
                if (itemScrollOffset > 0) {
                    ctx.fillStyle = '#ffd700';
                    ctx.textAlign = 'center';
                    ctx.fillText('â–²', itemX + itemW / 2, itemY + 12);
                    ctx.textAlign = 'left';
                }

                for (let i = 0; i < visibleCount; i++) {
                    const itemIdx = i + itemScrollOffset;
                    if (itemIdx >= validItems.length) break;

                    const slot = validItems[itemIdx];
                    const item = items[slot.id];
                    const y = itemY + 22 + i * rowHeight;
                    const canUse = item.type !== 'weapon' && item.type !== 'armor';

                    // é¸æŠã‚«ãƒ¼ã‚½ãƒ«
                    if (itemIdx === battle.itemCursor) {
                        ctx.fillStyle = canUse ? '#ffd700' : '#888';
                        ctx.fillText('â–¶', itemX + 10, y);
                    }

                    // ã‚¢ã‚¤ãƒ†ãƒ åï¼ˆè£…å‚™å“ã¯ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
                    ctx.fillStyle = canUse ? '#fff' : '#555';
                    ctx.font = `${tileSize * 0.4}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
                    let displayName = item.name;
                    if (slot.quantity > 1) {
                        displayName += ` x ${slot.quantity}`;
                    }
                    ctx.fillText(displayName, itemX + 30, y);

                    // ã‚¿ã‚¤ãƒ—ã‚¢ã‚¤ã‚³ãƒ³
                    if (item.type === 'weapon') {
                        ctx.fillText('âš”ï¸', itemX + itemW - 40, y);
                    } else if (item.type === 'armor') {
                        ctx.fillText('ğŸ›¡ï¸', itemX + itemW - 40, y);
                    }
                }

                // ä¸‹çŸ¢å°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªå ´åˆï¼‰
                if (itemScrollOffset + maxVisibleItems < validItems.length) {
                    ctx.fillStyle = '#ffd700';
                    ctx.textAlign = 'center';
                    ctx.fillText('â–¼', itemX + itemW / 2, itemY + itemH - 18);
                    ctx.textAlign = 'left';
                }
            }

            // æ“ä½œã‚¬ã‚¤ãƒ‰
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.font = `${tileSize * 0.25}px 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif`;
            ctx.fillText('B:ã‚‚ã©ã‚‹', itemX + 10, itemY + itemH - 10);
        }
    }
}
